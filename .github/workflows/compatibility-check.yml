name: ðŸ›¡ï¸ í˜¸í™˜ì„± ê²€ì¦ (Compatibility Guardian)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ ìžë™ ê²€ì¦

jobs:
  compatibility-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ðŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        # í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜
        sudo apt-get update
        sudo apt-get install -y jq curl bc
        
    - name: ðŸš€ ì„œë²„ ì‹œìž‘
      run: |
        # HTTP ì„œë²„ ì‹œìž‘
        cd src/frontend && python3 -m http.server 8080 &
        echo $! > /tmp/http_server.pid
        
        # API ì„œë²„ ì‹œìž‘
        cd ../.. && python3 src/backend/api_server.py &
        echo $! > /tmp/api_server.pid
        
        # ì„œë²„ ì‹œìž‘ ëŒ€ê¸°
        sleep 5
        
    - name: ðŸ›¡ï¸ í˜¸í™˜ì„± ê²€ì¦ ì‹¤í–‰
      run: |
        chmod +x scripts/compatibility-check.sh
        ./scripts/compatibility-check.sh
        
    - name: ðŸ§¹ ì„œë²„ ì •ë¦¬
      if: always()
      run: |
        # ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
        if [ -f /tmp/http_server.pid ]; then
          kill $(cat /tmp/http_server.pid) 2>/dev/null || true
        fi
        if [ -f /tmp/api_server.pid ]; then
          kill $(cat /tmp/api_server.pid) 2>/dev/null || true
        fi
        
    - name: ðŸ“Š ê²°ê³¼ ì—…ë¡œë“œ
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: compatibility-check-results
        path: |
          /tmp/http_server.pid
          /tmp/api_server.pid
        retention-days: 1
