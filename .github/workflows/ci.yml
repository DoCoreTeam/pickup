# GitHub Actions CI íŒŒì´í”„ë¼ì¸
# Zero-404 ë³´ì¥ì„ ìœ„í•œ ìë™í™”ëœ í…ŒìŠ¤íŠ¸ ë° ë°°í¬
#
# @author DOCORE

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, refactor/* ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'
  POSTGRES_PASSWORD: 'test_password'
  POSTGRES_DB: 'pickup_test'
  DATABASE_URL: 'postgresql://postgres:test_password@localhost:5432/pickup_test'

jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: pnpm ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: íƒ€ì… ì²´í¬
        run: pnpm run type-check
        
      - name: ë¦°íŠ¸ ê²€ì‚¬
        run: pnpm run lint
        
      - name: í¬ë§· ê²€ì‚¬
        run: pnpm run format:check

  # 2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-tests:
    name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: pnpm ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: pnpm run test:unit

  # 3. í†µí•© í…ŒìŠ¤íŠ¸ (PostgreSQL í¬í•¨)
  integration-tests:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: quality-check
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: pnpm ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DATABASE_URL=${{ env.DATABASE_URL }}" >> $GITHUB_ENV
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "DATA_BACKEND=postgres" >> $GITHUB_ENV
          
      - name: Prisma ë§ˆì´ê·¸ë ˆì´ì…˜
        run: |
          cd packages/db
          pnpm prisma migrate deploy
          pnpm prisma db seed
          
      - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: pnpm run test:integration

  # 4. E2E í…ŒìŠ¤íŠ¸ (Playwright)
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: pnpm ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DATABASE_URL=${{ env.DATABASE_URL }}" >> $GITHUB_ENV
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "DATA_BACKEND=postgres" >> $GITHUB_ENV
          
      - name: Prisma ë§ˆì´ê·¸ë ˆì´ì…˜
        run: |
          cd packages/db
          pnpm prisma migrate deploy
          pnpm prisma db seed
          
      - name: Playwright ì„¤ì¹˜
        run: pnpm exec playwright install --with-deps
        
      - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: pnpm run test:e2e

  # 5. 404 ì²´í¬ (Zero-404 ë³´ì¥)
  zero-404-check:
    name: Zero-404 ì²´í¬
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: pnpm ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DATABASE_URL=${{ env.DATABASE_URL }}" >> $GITHUB_ENV
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "DATA_BACKEND=postgres" >> $GITHUB_ENV
          echo "PORT=3001" >> $GITHUB_ENV
          
      - name: Prisma ë§ˆì´ê·¸ë ˆì´ì…˜
        run: |
          cd packages/db
          pnpm prisma migrate deploy
          pnpm prisma db seed
          
      - name: API ì„œë²„ ì‹œì‘
        run: |
          cd apps/api
          pnpm run start:prod &
          sleep 10
          
      - name: 404 ì²´í¬ ì‹¤í–‰
        run: pnpm run check:404
        
      - name: ì„œë²„ ì¢…ë£Œ
        run: pkill -f "apps/api"

  # 6. ìŠ¤í‚¤ë§ˆ diff ì²´í¬ (ê¸°ì¡´ ë¼ìš°íŠ¸/ì‘ë‹µí¬ë§· ë³€ê²½ ë°©ì§€)
  schema-diff-check:
    name: ìŠ¤í‚¤ë§ˆ diff ì²´í¬
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: pnpm ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: ìŠ¤í‚¤ë§ˆ diff ì²´í¬ ì‹¤í–‰
        run: pnpm run check:schema-diff

  # 7. ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build-test:
    name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: pnpm ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
        
      - name: ë¹Œë“œ ì‹¤í–‰
        run: pnpm run build
        
      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            apps/*/dist
            packages/*/dist

  # 8. ìµœì¢… ê²°ê³¼
  ci-success:
    name: CI ì„±ê³µ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, zero-404-check, schema-diff-check, build-test]
    if: always()
    
    steps:
      - name: CI ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ‰ CI/CD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!"
          echo "âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼"
          echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼"
          echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼"
          echo "âœ… E2E í…ŒìŠ¤íŠ¸ í†µê³¼"
          echo "âœ… Zero-404 ì²´í¬ í†µê³¼"
          echo "âœ… ìŠ¤í‚¤ë§ˆ diff ì²´í¬ í†µê³¼"
          echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼"
