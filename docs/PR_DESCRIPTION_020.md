# PR: Phase 3 안전 마이그레이션 및 듀얼라이트 구현

## 📋 요약

JSON 파일 기반 데이터를 PostgreSQL로 안전하게 마이그레이션하는 Phase 3를 구현했습니다. 듀얼라이트를 통한 점진적 전환과 즉시 롤백이 가능한 안전한 마이그레이션 시스템을 구축했습니다.

## 🎯 목표

- 현행 JSON 구조를 반영한 최소 스키마 설계
- JSON to PostgreSQL 백필 스크립트 구현
- 듀얼라이트 기능으로 안전한 전환 지원
- 전환 스위치 및 롤백 메커니즘 구축
- 포괄적인 테스트 커버리지 확보

## 🏗️ 주요 변경사항

### 1. 최소 스키마 설계
- **현행 JSON 구조 반영**: 기존 데이터 구조를 그대로 유지
- **표준 컬럼 추가**: id/created_at/updated_at 자동 관리
- **인덱스 최소화**: 핵심 쿼리 기준으로 최적화
- **마이그레이션 파일**: Prisma 마이그레이션 자동 생성

### 2. 백필 스크립트
- **파일**: `scripts/backfill-json-to-postgres.ts`
- **스트리밍 읽기**: 대용량 JSON 파일 효율적 처리
- **배치 처리**: 트랜잭션 단위로 안전한 처리
- **재시도 큐**: 실패한 작업 자동 재시도
- **진행 로그**: 실시간 진행 상황 모니터링

### 3. 듀얼라이트 기능
- **파일**: `packages/db/src/adapters/dual-write-adapter.ts`
- **동시 기록**: JSON + PostgreSQL 동시 쓰기
- **읽기 분리**: DATA_BACKEND 기준으로 읽기
- **에러 처리**: PostgreSQL 우선, JSON 실패 허용
- **성공률 모니터링**: 듀얼라이트 성공률 추적

### 4. 전환 스위치
- **파일**: `scripts/switch-database.ts`
- **카나리 배포**: 소수 트래픽만 PostgreSQL 사용
- **즉시 롤백**: 문제 발생 시 즉시 JSON으로 전환
- **환경변수 관리**: 런타임 백엔드 전환
- **전환 히스토리**: 모든 전환 기록 추적

### 5. 검증 시스템
- **파일**: `scripts/validate-migration.ts`
- **데이터 일관성**: JSON vs PostgreSQL 비교
- **자동 검증**: 모든 테이블 일괄 검증
- **차이점 리포트**: 상세한 불일치 분석
- **성공률 측정**: 마이그레이션 품질 평가

## 🧪 테스트 커버리지

### 유닛 테스트
- **어댑터 동치성**: JSON vs PostgreSQL 결과 비교
- **에러 처리**: 각종 예외 상황 테스트
- **데이터 변환**: 날짜 형식, 타입 변환 검증

### 통합 테스트
- **API 비교**: 엔드포인트별 응답 일치성
- **성능 비교**: 응답 시간, 처리량 측정
- **에러 처리**: 404, 5xx 에러 일관성

### E2E 테스트
- **Playwright**: 주요 플로우 녹화 테스트
- **어드민 플로우**: 대시보드, 관리 기능
- **가게페이지 플로우**: 모바일 최적화, 반응형
- **듀얼라이트 플로우**: 동시 기록, 일관성 검증

## 🔧 기술 스택

### 백엔드
- **Prisma**: ORM 및 마이그레이션 관리
- **PostgreSQL**: 메인 데이터베이스
- **Node.js**: 백필 및 전환 스크립트

### 테스트
- **Jest**: 유닛 및 통합 테스트
- **Playwright**: E2E 테스트
- **TypeScript**: 타입 안전성

### 도구
- **Docker Compose**: 로컬 PostgreSQL
- **Turbo**: 모노레포 빌드 시스템
- **ESLint + Prettier**: 코드 품질

## 🛡️ 안전성 보장

### 1. 데이터 무결성
- **원자적 처리**: 트랜잭션 단위 처리
- **중복 방지**: upsert로 안전한 처리
- **검증 시스템**: 마이그레이션 후 자동 검증

### 2. 롤백 전략
- **즉시 롤백**: 환경변수 변경으로 즉시 전환
- **데이터 보존**: 기존 JSON 파일 유지
- **서비스 연속성**: 다운타임 없는 전환

### 3. 모니터링
- **실시간 로그**: 진행 상황 실시간 추적
- **성공률 측정**: 듀얼라이트 성공률 모니터링
- **성능 지표**: 응답 시간, 처리량 측정

## 📊 성능 최적화

### 1. 배치 처리
- **배치 크기**: 100개씩 처리 (설정 가능)
- **메모리 효율**: 스트리밍 읽기로 메모리 절약
- **병렬 처리**: 비동기 처리로 성능 향상

### 2. 재시도 메커니즘
- **지수 백오프**: 실패 시 점진적 지연
- **최대 재시도**: 3회 재시도 후 포기
- **에러 분류**: 복구 가능/불가능 에러 구분

### 3. 모니터링
- **진행률 표시**: 실시간 진행 상황
- **성능 지표**: 처리 속도, 성공률
- **에러 추적**: 실패 원인 상세 분석

## 🚀 사용법

### 기본 마이그레이션
```bash
# 1. 환경 준비
npm run setup:dev

# 2. 데이터베이스 설정
npm run db:push
npm run db:seed

# 3. 백필 실행
npm run backfill:json-to-postgres

# 4. 검증
npm run validate:migration
```

### 듀얼라이트 테스트
```bash
# 1. 듀얼라이트 활성화
export DUAL_WRITE=true
export DATA_BACKEND=json

# 2. 서버 시작
npm run dev

# 3. 테스트 실행
npm run test:e2e:dual-write
```

### 전환 실행
```bash
# 1. 카나리 배포 (10%)
npm run switch:db canary:enable "X-Canary" "canary=true" 10

# 2. 전체 전환
npm run switch:db switch postgres "Full migration"

# 3. 롤백 (필요시)
npm run switch:db rollback "Emergency rollback"
```

## 📋 체크리스트

- [x] 최소 스키마 설계 및 마이그레이션 파일 생성
- [x] JSON to PostgreSQL 백필 스크립트 구현
- [x] 듀얼라이트 어댑터 구현
- [x] 전환 스위치 및 롤백 메커니즘 구축
- [x] 검증 시스템 구현
- [x] 유닛/통합/E2E 테스트 작성
- [x] 실행 가이드 및 문서 작성
- [x] 성능 최적화 및 모니터링 구현

## 🔄 다음 단계

1. **Phase 4**: 최적화 및 정리
2. **프로덕션 배포**: 실제 환경 적용
3. **모니터링 강화**: 실시간 대시보드 구축
4. **자동화**: CI/CD 파이프라인 통합

## ⚠️ 주의사항

- 이 PR은 마이그레이션 도구만 제공합니다
- 실제 데이터 마이그레이션은 별도 실행 필요
- 백업 필수: 마이그레이션 전 데이터 백업
- 테스트 필수: 스테이징 환경에서 충분한 테스트

## 📚 관련 문서

- [마이그레이션 가이드](./MIGRATION_GUIDE.md)
- [마이그레이션 계획서](./plan.md)
- [라우트 매니페스트](./route-manifest.json)
- [환경변수 가이드](./env-keys.md)
- [성능 감사 보고서](./perf-audit.md)

---

**Co-authored-by: DOCORE**
