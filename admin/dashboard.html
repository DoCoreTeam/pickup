<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지</title>
    <!-- 즉시 실행: 점주 계정 메뉴 필터링 (스크립트 로드 전에 실행) -->
    <script>
        (function() {
            try {
                const userRole = sessionStorage.getItem('user_role');
                const isOwner = userRole === 'owner' && sessionStorage.getItem('owner_logged_in') === 'true';
                const isSuperAdmin = userRole !== 'owner' && sessionStorage.getItem('superadmin_logged_in') === 'true';
                
                // 즉시 body에 클래스 추가 (HTML 파싱 전에 실행 가능하도록)
                if (document.body) {
                    if (isOwner) {
                        document.body.classList.add('owner-mode');
                    }
                    if (isSuperAdmin) {
                        document.body.classList.add('superadmin-mode');
                    }
                } else {
                    // body가 아직 없으면 DOMContentLoaded 이벤트에서 실행
                    document.addEventListener('DOMContentLoaded', function() {
                        if (isOwner) {
                            document.body.classList.add('owner-mode');
                        }
                        if (isSuperAdmin) {
                            document.body.classList.add('superadmin-mode');
                        }
                    }, { once: true });
                }
            } catch(e) {
                // sessionStorage 접근 실패 시 무시 (초기 로드 시)
            }
        })();
    </script>
    <style>
        /* 초기 상태: 슈퍼어드민 전용 메뉴는 숨김 (슈퍼어드민 모드일 때만 표시) */
        .menu-item[data-role="superadmin-only"],
        .menu-section-title[data-role="superadmin-only"] {
            display: none !important;
        }
        
        /* 슈퍼어드민 전용 요소는 기본적으로 숨김 (메뉴 제외, 섹션 내부 요소는 나중에 처리) */
        .superadmin-only {
            display: none !important;
        }
        
        /* 슈퍼어드민 모드일 때만 슈퍼어드민 전용 메뉴 표시 */
        body.superadmin-mode .menu-item[data-role="superadmin-only"],
        body.superadmin-mode .menu-section-title[data-role="superadmin-only"] {
            display: block !important;
        }
        
        /* 슈퍼어드민 모드일 때 슈퍼어드민 전용 요소 표시 (섹션 내부 컨트롤 등) */
        /* flex 컨테이너인 경우 flex 유지 */
        body.superadmin-mode .superadmin-only.dashboard-controls,
        body.superadmin-mode .dashboard-controls.superadmin-only,
        body.superadmin-mode .superadmin-only[class*="flex"],
        body.superadmin-mode .superadmin-only[class*="controls"],
        body.superadmin-mode .dashboard-controls {
            display: flex !important;
        }
        
        /* 테이블 관련 요소 */
        body.superadmin-mode .superadmin-only[class*="table"],
        body.superadmin-mode .superadmin-only.dashboard-store-table {
            display: table !important;
        }
        
        body.superadmin-mode .superadmin-only[class*="table-row"] {
            display: table-row !important;
        }
        
        /* 일반 요소는 block */
        body.superadmin-mode .superadmin-only {
            display: block !important;
        }
        
        /* 인라인 요소 */
        body.superadmin-mode .superadmin-only[class*="inline"] {
            display: inline !important;
        }
        
        /* 버튼 요소는 inline-block */
        body.superadmin-mode .superadmin-only.store-view-btn,
        body.superadmin-mode .store-view-btn.superadmin-only,
        body.superadmin-mode button.superadmin-only.store-view-btn,
        body.superadmin-mode .superadmin-only[type="button"],
        body.superadmin-mode .superadmin-only.btn {
            display: inline-block !important;
        }
        
        /* select 요소는 inline-block 또는 block */
        body.superadmin-mode .superadmin-only select,
        body.superadmin-mode select.superadmin-only,
        body.superadmin-mode #storeOwnerFilter.superadmin-only {
            display: inline-block !important;
        }
        
        /* select와 button은 일반 block 규칙보다 우선순위 높음 */
        body.superadmin-mode select.superadmin-only,
        body.superadmin-mode button.superadmin-only {
            display: inline-block !important;
        }
        
        /* store-filters와 store-view-toggle 내부 요소에 대한 더 구체적인 선택자 */
        body.superadmin-mode .store-filters select.superadmin-only,
        body.superadmin-mode .store-filters #storeOwnerFilter.superadmin-only,
        body.superadmin-mode .store-view-toggle button.superadmin-only,
        body.superadmin-mode .store-view-toggle .store-view-btn.superadmin-only,
        body.superadmin-mode .store-view-toggle button[data-view="owner"] {
            display: inline-block !important;
        }
        
        /* 슈퍼어드민 전용 섹션은 기본적으로 숨김 (showSection으로 표시/숨김 제어) */
        .admin-section.superadmin-only {
            display: none !important;
        }
        
        /* 슈퍼어드민 모드이고 현재 선택된 섹션일 때만 표시 */
        body.superadmin-mode .admin-section.superadmin-only[style*="display: block"] {
            display: block !important;
        }
        
        /* 점주 계정 모드일 때는 슈퍼어드민 전용 메뉴 숨김 (우선순위 높음) */
        body.owner-mode .menu-item[data-role="superadmin-only"],
        body.owner-mode .superadmin-only,
        body.owner-mode .menu-section-title[data-role="superadmin-only"] {
            display: none !important;
        }
        
        /* 초기 상태: 점주 전용 메뉴는 숨김 (점주 모드일 때만 표시) */
        .menu-section-title.owner-only,
        .menu-item.owner-only {
            display: none !important;
        }
        
        /* 점주 모드일 때만 점주 전용 메뉴 표시 */
        body.owner-mode .menu-section-title.owner-only,
        body.owner-mode .menu-item.owner-only {
            display: block !important;
        }
        
        /* 슈퍼어드민 모드일 때 점주 전용 버튼 숨김 (설정 가이드 등) */
        body.superadmin-mode .owner-only {
            display: none !important;
        }
        
        /* 점주 전용 버튼도 기본적으로 숨김 */
        .owner-only {
            display: none !important;
        }
        
        /* 점주 모드일 때만 점주 전용 버튼 표시 */
        body.owner-mode .owner-only {
            display: block !important;
        }
        
        body:not(.owner-mode) .menu-section-title.owner-only {
            display: none !important;
        }
    </style>
    <!-- SortableJS 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- 카카오 주소 검색 API -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }

/* 점주 계정 메뉴 숨김은 위의 <head> 스타일에서 처리됨 */

body.owner-mode #bulkManagementBtn,
body.owner-mode #stores .button-group {
    display: none !important;
}

.owner-only {
    display: none;
}

body.owner-mode .owner-only {
    display: block;
}

body.owner-mode .owner-store-actions {
    display: flex !important;
}

        .admin-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        .address-search-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .address-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

.owner-store-actions {
    display: none;
    margin-top: 16px;
    padding: 16px;
    border-radius: 12px;
    border: 1px dashed #cbd5f5;
    background: #f8fafc;
    flex-direction: column;
    gap: 12px;
}

.owner-store-actions p {
    margin: 0;
    color: #64748b;
    font-size: 13px;
}

.owner-action-btn {
    align-self: flex-start;
}

.store-view-toolbar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.store-owner-select {
    min-width: 200px;
}

.store-pagination button {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid #cbd5f5;
    background: #f8fafc;
    color: #475569;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s, color 0.2s;
}

.store-pagination button:hover:not(:disabled) {
    background: #e0e7ff;
}

.store-pagination button:disabled {
    opacity: 0.45;
    cursor: not-allowed;
}

.owner-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    margin: 2px;
    border-radius: 999px;
    background: #eef2ff;
    color: #1e293b;
    font-size: 12px;
    font-weight: 600;
}

.owner-tag.empty {
    background: #fee2e2;
    color: #b91c1c;
}

.owner-group-container {
    display: none;
    margin-top: 20px;
}

.owner-group-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 15px 30px rgba(15, 23, 42, 0.08);
}

.owner-group-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 16px;
}

.owner-group-title {
    font-size: 17px;
    font-weight: 700;
    color: #1f2937;
}

.owner-group-meta {
    font-size: 13px;
    color: #64748b;
}

.owner-group-store {
    border-top: 1px solid #e2e8f0;
    padding: 12px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}

.owner-group-store:first-of-type {
    border-top: none;
}

.owner-group-store button {
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: #3b82f6;
    color: #ffffff;
}

.owner-group-empty {
    padding: 24px;
    border: 1px dashed #cbd5f5;
    border-radius: 12px;
    background: #f8fafc;
    color: #94a3b8;
    text-align: center;
    font-size: 14px;
}

.owner-manage-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}

.owner-manage-subtitle {
    margin: 6px 0 0;
    font-size: 13px;
    color: #64748b;
}

.owner-manage-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
}

.owner-manage-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    background: #f8fafc;
}

.owner-manage-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    color: #1f2937;
}

.owner-manage-info span {
    font-size: 13px;
    color: #64748b;
}

.owner-manage-empty {
    padding: 24px;
    background: #f8fafc;
    border: 1px dashed #cbd5f5;
    border-radius: 12px;
    text-align: center;
    color: #475569;
    font-size: 14px;
}

.owner-manage-add {
    display: flex;
    gap: 12px;
    align-items: center;
}

.owner-manage-add select {
    flex: 1;
}

.owner-profile-card {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
}

.profile-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    margin-bottom: 6px;
}

.profile-value {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    word-break: break-word;
}

.basic-summary-intro {
    margin-bottom: 16px;
}

.summary-highlight {
    display: flex;
    gap: 8px;
    align-items: center;
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    border-left: 4px solid #667eea;
    padding: 12px 16px;
    border-radius: 8px;
    color: #4c51bf;
    font-size: 14px;
    font-weight: 600;
}

.basic-summary-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    margin-bottom: 24px;
}

.basic-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.basic-summary-header h3 {
    font-size: 18px;
    color: #1e293b;
    font-weight: 700;
}

.basic-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
}

.summary-item {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-height: 90px;
}

.summary-label {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: #64748b;
}

.summary-value {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    line-height: 1.4;
    word-break: break-word;
    white-space: pre-line;
}

.summary-item.summary-domain {
    position: relative;
    padding-bottom: 56px;
}

.summary-qr-btn {
    position: absolute;
    left: 16px;
    right: 16px;
    bottom: 16px;
    width: calc(100% - 32px);
}

.summary-domain-notice {
    margin: 16px 0 0;
    font-size: 13px;
    line-height: 1.6;
    color: #64748b;
}
.menu-section-title {
    margin: 20px 0 8px;
    font-size: 11px;
    letter-spacing: 0.08em;
    font-weight: 700;
    color: #94a3b8;
    text-transform: uppercase;
}
body:not(.owner-mode) .menu-section-title.owner-only {
    display: none !important;
}
.store-toolbar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}
.store-filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    flex: 1;
}
.store-filters input,
.store-filters select {
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
    color: #1f2937;
}
.store-filters input {
    min-width: 220px;
    flex: 1 1 260px;
}
.store-filters select {
    cursor: pointer;
}
.store-view-toggle {
    display: inline-flex;
    border: 1px solid #e2e8f0;
    border-radius: 999px;
    background: #f8fafc;
    padding: 3px;
}
.store-view-btn {
    border: none;
    background: transparent;
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
}
.store-view-btn.active {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    box-shadow: 0 4px 10px rgba(79, 70, 229, 0.25);
}
.store-pagination {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    margin: 16px 0;
}
.store-pagination-info {
    font-size: 13px;
    color: #475569;
}

.summary-action {
    font-weight: 600;
    padding: 10px 18px;
}

.hidden-basic-inputs {
    display: none;
}

.basic-info-wizard-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.35);
    backdrop-filter: blur(2px);
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 24px;
}

.basic-wizard-card {
    width: min(640px, 100%);
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.18);
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    max-height: 90vh;
}

.basic-wizard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
}

.basic-wizard-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
}

.wizard-close-btn {
    background: transparent;
    border: none;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    color: #64748b;
}

.wizard-stepper {
    display: flex;
    gap: 8px;
    padding: 16px 24px;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
}

.wizard-step-indicator {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    background: #ffffff;
}

.wizard-step-indicator.active {
    border-color: #6366f1;
    background: #eef2ff;
    color: #4338ca;
}

.wizard-step-indicator span {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #475569;
}

.wizard-step-indicator.active span {
    background: #6366f1;
    color: #fff;
}

.basic-wizard-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
}

.wizard-step {
    display: none;
    flex-direction: column;
    gap: 16px;
}

.wizard-step.active {
    display: flex;
}

.wizard-footer {
    padding: 20px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: #f8fafc;
    border-radius: 0 0 16px 16px;
}

.wizard-review-card {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    background: #f8fafc;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
}

.wizard-review-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.wizard-review-label {
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    letter-spacing: 0.04em;
}

.wizard-review-value {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    word-break: break-word;
}

.wizard-address-group .address-row {
    flex-wrap: nowrap;
}

.wizard-secondary-info {
    background: #f8fafc;
    border-radius: 10px;
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    font-size: 13px;
    color: #475569;
}

        .address-row input {
            flex: 1;
            min-width: 0;
        }

        .address-row button {
            flex-shrink: 0;
        }

        .admin-sidebar {
            width: 248px;
            background: #2c3e50;
            color: white;
            padding: 16px 0 14px;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            transition: transform 0.3s ease;
            height: 100vh;
            max-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .sidebar-toggle:hover {
            background: #34495e;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .sidebar-footer {
            flex-shrink: 0;
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: #2c3e50;
        }
        
        .version-info {
            text-align: center;
            margin-bottom: 12px;
        }
        
        /* 설정 가이드 스타일 */
        .setup-guide-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .setup-guide-step {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .setup-guide-step.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .setup-guide-step.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .setup-guide-step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .setup-guide-step-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .setup-guide-step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .setup-guide-step.completed .setup-guide-step-number {
            background: #10b981;
        }
        
        .setup-guide-step-status {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .setup-guide-step-status.required {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .setup-guide-step-status.optional {
            background: #f0f9ff;
            color: #0284c7;
        }
        
        .setup-guide-step-status.completed {
            background: #f0fdf4;
            color: #16a34a;
        }
        
        .setup-guide-step-content {
            margin-bottom: 16px;
        }
        
        .setup-guide-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e5e7eb;
        }
        
        .setup-guide-item.completed {
            background: #f0fdf4;
            border-color: #10b981;
        }
        
        .setup-guide-item-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #d1d5db;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .setup-guide-item.completed .setup-guide-item-checkbox {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .setup-guide-item-label {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }
        
        .setup-guide-item-label strong {
            color: #1f2937;
            font-weight: 600;
        }
        
        .setup-guide-item-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .setup-guide-item-badge.required {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .setup-guide-item-badge.optional {
            background: #dbeafe;
            color: #0284c7;
        }
        
        .setup-guide-item-action {
            padding: 6px 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .setup-guide-item-action:hover {
            background: #2563eb;
        }
        
        .setup-guide-example {
            margin-top: 8px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            font-size: 13px;
            color: #6b7280;
        }
        
        .setup-guide-example strong {
            color: #1f2937;
        }
        
        .setup-guide-step-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .setup-guide-preview {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed #d1d5db;
        }
        
        .setup-guide-preview iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 8px;
        }
        
        .setup-guide-progress {
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .setup-guide-progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 12px;
        }
        
        .setup-guide-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            transition: width 0.3s ease;
        }
        
        .setup-guide-progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .setup-guide-progress-label {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .setup-guide-progress-percent {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
        }
        
        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.1);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }
        
        .release-notes-btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .release-notes-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .admin-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .header-info p {
            color: #666;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .admin-content {
            flex: 1;
            padding: 30px;
            margin-left: 250px;
            min-height: 100vh;
            overflow-x: hidden;
            max-width: calc(100vw - 250px);
            box-sizing: border-box;
        }

        .status-message {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none; /* 초기에는 모든 섹션 숨김 */
            overflow-x: hidden;
            max-width: 100%;
            box-sizing: border-box;
        }

        .section-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 32px 0;
        }





        .section-title {
            font-size: 1.5em;
            margin-bottom: 24px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        
        .section-title svg {
            color: #667eea;
            flex-shrink: 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* AI 생성 버튼 스타일 */
        .ai-generate-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .ai-generate-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .ai-generate-btn:active {
            transform: translateY(0);
        }

        .ai-generate-btn:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .activity-logs-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        .log-entry {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
            position: relative;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .log-entry:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .log-entry.critical {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        .log-entry.critical:hover {
            background: #fee2e2;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-action {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .log-type {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .log-type.basic { background: #dbeafe; color: #1e40af; }
        .log-type.settings { background: #dcfce7; color: #166534; }
        .log-type.image { background: #fef3c7; color: #92400e; }
        .log-type.qr { background: #e0e7ff; color: #3730a3; }
        .log-type.store { background: #fce7f3; color: #be185d; }

        .log-timestamp {
            font-size: 12px;
            color: #64748b;
        }

        .log-description {
            color: #475569;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .log-changes {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .log-changes-title {
            font-weight: 600;
            color: #374151;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .log-change-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .log-change-item:last-child {
            border-bottom: none;
        }

        .log-change-field {
            font-weight: 500;
            color: #374151;
            font-size: 12px;
        }

        .log-change-values {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .log-change-before {
            color: #dc2626;
            background: #fef2f2;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .log-change-after {
            color: #059669;
            background: #f0fdf4;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .log-arrow {
            color: #6b7280;
            font-weight: bold;
        }

        /* 도메인 설정 스타일 */
        .input-suffix {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 14px;
            pointer-events: none;
        }
        
        .input-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 14px;
            pointer-events: none;
            font-weight: 500;
        }
        
        .input-wrapper input:has(~ .input-prefix),
        .input-wrapper input {
            padding-left: 110px;
        }
        .domain-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .domain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .domain-item:last-child {
            border-bottom: none;
        }

        .domain-label {
            font-weight: 600;
            color: #374151;
        }

        .domain-value {
            color: #6b7280;
            font-family: monospace;
        }

        .qr-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
        }

        .qr-preview h4 {
            margin: 0 0 16px 0;
            color: #374151;
        }

        .qr-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        .btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-outline:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .log-action {
            font-weight: 600;
            color: #2c3e50;
        }

        .log-time {
            font-size: 12px;
            color: #666;
        }

        .log-description {
            color: #555;
            font-size: 14px;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .log-description-short {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }
        
        .log-description-full {
            display: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            max-height: 300px;
            overflow-y: auto;
            padding: 12px;
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            border-radius: 4px;
            margin-top: 8px;
            position: relative;
        }
        
        .log-description-full.expanded {
            display: block;
        }
        .log-details {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 4px;
            margin-top: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.5;
            border-left: 3px solid #95a5a6;
        }

        .log-type-store { border-left: 4px solid #3498db; }
        .log-type-settings { border-left: 4px solid #9b59b6; }
        .log-type-image { border-left: 4px solid #e67e22; }
        .log-type-system { border-left: 4px solid #95a5a6; }
        .log-type-qr { border-left: 4px solid #27ae60; }
        .log-type-ai { border-left: 4px solid #f39c12; }
        .log-type-admin { border-left: 4px solid #e74c3c; }

        .log-toggle-btn {
            background: transparent;
            color: #3498db;
            border: 1px solid #3498db;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s;
            display: inline-block;
        }

        .log-toggle-btn:hover {
            background: #3498db;
            color: white;
        }
        
        .log-toggle-btn::before {
            content: '▼ ';
            font-size: 10px;
            margin-right: 4px;
        }
        
        .log-toggle-btn.expanded::before {
            content: '▲ ';
        }

        .subtitle-toggle-btn {
            background: transparent;
            color: #3498db;
            border: 1px solid #e0e0e0;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.3s;
            vertical-align: middle;
        }

        .subtitle-toggle-btn:hover {
            background: #f0f0f0;
            border-color: #3498db;
        }
        
        .subtitle-toggle-btn::after {
            content: ' ▼';
            font-size: 9px;
        }
        
        .subtitle-toggle-btn.expanded::after {
            content: ' ▲';
        }

        .store-subtitle {
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.5;
        }
        
        .subtitle-short {
            display: inline;
            color: #555;
        }
        
        .subtitle-full {
            display: none;
            color: #555;
            padding: 8px 12px;
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            border-radius: 4px;
            margin-top: 8px;
            line-height: 1.6;
        }
        
        .subtitle-full.expanded {
            display: block;
        }
        
        .store-status {
            text-align: center;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .table-actions .btn {
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-ai:active {
            transform: translateY(0);
        }
        
        .btn-ai span {
            font-size: 16px;
            animation: sparkle 2s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .owner-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .owner-tabs {
            display: inline-flex;
            background: #eef2ff;
            padding: 4px;
            border-radius: 999px;
        }

        .owner-tab {
            border: none;
            background: transparent;
            padding: 8px 18px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .owner-tab.active {
            background: white;
            color: #1f2937;
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.15);
        }

        .owner-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(17, 24, 39, 0.05);
        }

        .owner-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .owner-name {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .owner-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .owner-badge.pending {
            background: #fef3c7;
            color: #b45309;
        }

        .owner-badge.approved {
            background: #dcfce7;
            color: #15803d;
        }

        .owner-badge.rejected {
            background: #fee2e2;
            color: #b91c1c;
        }

        .owner-badge.paused {
            background: #e0f2fe;
            color: #0369a1;
        }

        .owner-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 14px;
            color: #475569;
            font-size: 13px;
        }

        .owner-meta span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .owner-meta strong {
            color: #1f2937;
        }

        .owner-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .owner-actions button {
            border: none;
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .owner-actions .btn-approve {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .owner-actions .btn-reject {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }

        .owner-actions .btn-copy {
            background: #e2e8f0;
            color: #1f2937;
        }

        .owner-empty {
            padding: 36px;
            text-align: center;
            border-radius: 16px;
            background: #f8fafc;
            border: 1px dashed #cbd5f5;
            color: #64748b;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-backdrop.active {
            display: flex;
        }
        .modal-card {
            background: #ffffff;
            border-radius: 16px;
            width: min(420px, 90vw);
            padding: 24px;
            box-shadow: 0 32px 64px rgba(15, 23, 42, 0.3);
        }

        .modal-card h3 {
            margin: 0 0 16px;
            font-size: 20px;
            color: #111827;
        }

        .modal-card .form-group {
            margin-top: 16px;
        }

        .modal-info {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
        }

        .modal-info strong {
            color: #1f2937;
        }

        .modal-highlight {
            margin-top: 16px;
            background: #f8fafc;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 16px;
            color: #1f2937;
            font-size: 13px;
            line-height: 1.6;
        }
        .modal-highlight strong {
            display: inline-block;
            min-width: 64px;
            margin-right: 6px;
            color: #1d4ed8;
        }

        .modal-card textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 14px;
            resize: vertical;
            color: #1f2937;
            background: #f8fafc;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;
        }

        .modal-card textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: #ffffff;
        }

        .modal-actions {
            margin-top: 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-actions button {
            padding: 10px 18px;
            border-radius: 999px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-actions .btn-secondary {
            background: #e2e8f0;
            color: #1f2937;
        }

        .modal-actions .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
        }
        
        .form-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .form-header > div:first-child {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .menu-item {
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            margin: 2px 0;
        }

        .menu-sub-item {
            padding: 10px 18px 10px 34px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            margin: 2px 12px;
            font-size: 14px;
            color: #ffffff;
            background-color: transparent;
            position: relative;
            font-weight: 600;
        }

        .menu-sub-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transform: translateX(4px);
        }

        .menu-sub-item::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background-color: #3b82f6;
            border-radius: 50%;
        }

        .menu-sub-item:hover::before {
            background-color: #1d4ed8;
            transform: translateY(-50%) scale(1.2);
        }
        
        .menu-item svg {
            flex-shrink: 0;
            opacity: 0.9;
        }

        .menu-item:hover {
            background: rgba(52, 73, 94, 0.6);
        }
        
        .menu-item:hover svg {
            opacity: 1;
            transform: translateX(2px);
        }

        .menu-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .menu-item.active svg {
            opacity: 1;
        }

        .selected-store-card {
            background: #34495e;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 16px;
            border: 1px solid #4a5f7a;
        }

        .selected-store-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .selected-store-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .store-logo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .catchphrase-container {
            margin-bottom: 18px;
            text-align: center;
        }

        .catchphrase {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 700;
            color: #ecf0f1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            justify-content: center;
        }

        .catchphrase-title {
            margin-bottom: 10px;
            color: #ecf0f1;
            font-weight: 700;
        }

        .catchphrase-text {
            color: #ecf0f1;
        }

        .catchphrase-highlight {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 18px;
            font-weight: 800;
            text-shadow: none;
        }

        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .dashboard-scope-toggle {
            display: flex;
            gap: 8px;
        }

        .dashboard-scope-btn {
            border: 1px solid #cbd5f5;
            background: #fff;
            color: #1e40af;
            padding: 10px 18px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(30, 64, 175, 0.08);
        }

        .dashboard-scope-btn.active {
            background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.25);
        }

        .dashboard-search-wrapper {
            display: none;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 260px;
        }

        .dashboard-search-wrapper input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #d0d7e2;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .dashboard-search-wrapper input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .dashboard-search-count {
            font-size: 13px;
            color: #64748b;
            white-space: nowrap;
        }

        .dashboard-store-table {
            display: none;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: #fff;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
            max-width: 100%;
            box-sizing: border-box;
        }

        .dashboard-store-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .dashboard-store-table th,
        .dashboard-store-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .dashboard-store-table th {
            background: #f8fafc;
            font-weight: 700;
            color: #1e293b;
        }

        .dashboard-store-table tbody tr:hover {
            background: #f1f5f9;
        }

        .dashboard-store-table .store-name-cell {
            font-weight: 600;
            color: #1f2937;
        }

        .dashboard-store-table .store-sub-info {
            display: block;
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .dashboard-store-table .store-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .dashboard-store-table .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .dashboard-store-table .status-paused {
            background: #fee2e2;
            color: #991b1b;
        }

        .dashboard-store-table .status-pending {
            background: #fef9c3;
            color: #92400e;
        }

        .dashboard-store-table .status-rejected {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .dashboard-store-table .store-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #dbeafe;
            background: #eff6ff;
            color: #1d4ed8;
            font-weight: 600;
            cursor: pointer;
        }

        .dashboard-store-table .store-action-btn:hover {
            background: #dbeafe;
        }

        .dashboard-scope-hint {
            margin-bottom: 18px;
            color: #64748b;
            font-size: 13px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .dashboard-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 35px -15px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        .dashboard-card h3 {
            margin: 0;
            font-size: 15px;
            color: #475569;
            font-weight: 600;
        }

        .dashboard-card .metric-value {
            font-size: 28px;
            font-weight: 800;
            color: #1e293b;
        }

        .dashboard-card .metric-sub {
            font-size: 13px;
            color: #94a3b8;
        }

        .dashboard-daily {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .dashboard-daily table {
            width: 100%;
            border-collapse: collapse;
        }

        .dashboard-daily th,
        .dashboard-daily td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
            font-size: 14px;
        }

        .dashboard-daily th {
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
        }

        /* AI 프롬프트 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-body p {
            margin: 0 0 16px;
            color: #6b7280;
            line-height: 1.5;
        }

        .modal-footer {
            padding: 16px 24px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .selected-store-icon {
            width: 24px;
            height: 24px;
            background: #27ae60;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
            color: white;
        }

        .selected-store-label {
            font-size: 12px;
            color: #bdc3c7;
            font-weight: 500;
        }

        .selected-store-name {
            font-size: 16px;
            font-weight: 600;
            color: #ecf0f1;
            margin-bottom: 5px;
        }

        .selected-store-subtitle {
            font-size: 12px;
            color: #95a5a6;
        }

        /* 토스트 알림 시스템 */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3498db;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
            pointer-events: auto;
            position: relative;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success {
            border-left-color: #27ae60;
        }

        .toast.error {
            border-left-color: #e74c3c;
        }

        .toast.warning {
            border-left-color: #f39c12;
        }

        .toast.info {
            border-left-color: #3498db;
        }

        .toast-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: white;
        }

        .toast.success .toast-icon {
            background: #27ae60;
        }

        .toast.error .toast-icon {
            background: #e74c3c;
        }

        .toast.warning .toast-icon {
            background: #f39c12;
        }

        .toast.info .toast-icon {
            background: #3498db;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #95a5a6;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            color: #7f8c8d;
        }

        /* 입력 모달 스타일 */
        .toast.input-modal {
            min-width: 350px;
            max-width: 450px;
        }

        .modal-input-group {
            margin: 16px 0;
        }
        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        .modal-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .modal-input::placeholder {
            color: #999;
        }
        /* 삭제 확인 모달 스타일 */
        .toast.delete-modal {
            min-width: 350px;
            max-width: 400px;
        }
        .toast-btn-danger {
            background: #f44336;
            color: white;
        }
        .toast-btn-danger:hover {
            background: #d32f2f;
        }
        .toast-message {
            font-size: 13px;
            color: #7f8c8d;
            line-height: 1.4;
        }
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0 0 8px 8px;
            transition: width linear;
        }

        .toast.success .toast-progress {
            background: #27ae60;
        }

        .toast.error .toast-progress {
            background: #e74c3c;
        }

        .toast.warning .toast-progress {
            background: #f39c12;
        }

        .toast.info .toast-progress {
            background: #3498db;
        }

        /* 테이블 스타일 */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .store-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }

        .store-table th {
            background: #f8f9fa;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        
        .store-table th:nth-child(1) { width: 15%; } /* 가게명 */
        .store-table th:nth-child(2) { width: 25%; } /* 부제목 */
        .store-table th:nth-child(3) { width: 13%; } /* 전화번호 */
        .store-table th:nth-child(4) { width: 20%; } /* 주소 */
        .store-table th:nth-child(5) { width: 10%; } /* 상태 */
        .store-table th:nth-child(6) { width: 17%; } /* 작업 */

        .store-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .store-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .store-row:hover {
            background-color: #f8f9fa;
        }

        .store-row.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .store-row.selected:hover {
            background-color: #e3f2fd;
        }

        .store-name {
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            min-width: 60px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-paused {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .table-actions {
            white-space: nowrap;
        }

        .table-actions .btn {
            margin-right: 8px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* 반응형 테이블 */
        @media (max-width: 768px) {
            .store-table {
                font-size: 14px;
            }
            
            .store-table th,
            .store-table td {
                padding: 8px 12px;
            }
            
            .table-actions .btn {
                margin-right: 4px;
                padding: 2px 6px;
                font-size: 11px;
            }
        }

        .store-list {
            list-style: none;
        }

        .store-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .store-info h4 {
            margin-bottom: 5px;
        }

        .store-info p {
            color: #666;
            font-size: 12px;
        }

        .store-actions {
            display: flex;
            gap: 5px;
        }

        .delivery-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        /* QR 코드 섹션 스타일 */
        .qr-code-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            border: 2px dashed #dee2e6;
        }
        
        .qr-code-preview {
            display: flex;
            align-items: center;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .qr-code-preview img {
            width: 200px;
            height: 200px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
        }
        .qr-code-info {
            flex: 1;
        }
        
        .qr-code-info p {
            font-size: 16px;
            font-weight: 600;
            color: #155724;
            margin-bottom: 8px;
        }
        
        .qr-code-info small {
            color: #6c757d;
            font-size: 14px;
        }
        .qr-code-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        
        .qr-code-hint {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 12px 16px;
            border-radius: 4px;
            margin-top: 16px;
        }
        
        .qr-code-hint p {
            font-size: 14px;
            color: #004085;
            margin: 4px 0;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* 이미지 업로드 영역 스타일 */
        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .image-upload-area.drag-over {
            border-color: #007bff;
            background-color: #e3f2fd;
        }

        .drag-drop-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .drag-drop-text span {
            font-size: 2em;
            opacity: 0.6;
        }

        .drag-drop-text p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .current-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .current-video {
            width: 100%;
            max-width: 360px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            background: #000;
        }

        .image-upload-area.has-image .drag-drop-text {
            display: none;
        }

        /* 배달앱 그리드 설정 스타일 */
        .delivery-grid-section {
            background: white;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        /* 배달앱 헤더는 form-header와 동일한 스타일 사용 */
        .delivery-grid-section-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f8fafc;
        }

        .delivery-grid-section-header h3,
        .delivery-grid-section h3 {
            margin: 0;
            color: #1a202c;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .delivery-grid-section-header h3::before {
            content: "";
            font-size: 20px;
        }

        .delivery-grid-section-header p,
        .order-description {
            margin: 0;
            color: #64748b;
            font-size: 15px;
            line-height: 1.6;
        }

        .delivery-grid-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .delivery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .delivery-grid-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px 16px;
            cursor: move;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .delivery-grid-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .delivery-grid-item.dragging {
            opacity: 0.6;
            transform: rotate(3deg) scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .delivery-grid-item .app-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .delivery-grid-item .app-icon.ttaeng {
            background-image: url('../../assets/images/icons/dgy.svg');
        }

        .delivery-grid-item .app-icon.baemin {
            background-image: url('../../assets/images/icons/bm.svg');
        }

        .delivery-grid-item .app-icon.coupang {
            background-image: url('../../assets/images/icons/cpeat.png');
        }

        .delivery-grid-item .app-icon.yogiyo {
            background-image: url('../../assets/images/icons/yogiyo.png');
        }

        /* 전역 로딩 바 (상단 고정) */
        .global-loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            z-index: 10000;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s ease-in-out infinite;
            transform: translateY(-100%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .global-loading-bar.active {
            transform: translateY(0);
        }

        .global-loading-bar.error {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 50%, #ef4444 100%);
            background-size: 200% 100%;
        }

        .global-loading-bar.success {
            background: linear-gradient(90deg, #10b981 0%, #059669 50%, #10b981 100%);
            background-size: 200% 100%;
        }

        @keyframes loading-shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* 섹션 로딩 모달 (큰 로딩 인디케이터) */
        .section-loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .section-loading-modal.active {
            display: flex;
            opacity: 1;
        }

        .section-loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .section-loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            text-align: center;
        }

        .section-loading-progress {
            width: 300px;
            max-width: 90%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .section-loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .section-loading-percent {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-top: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 홈 페이지 스타일 */
        .home-welcome {
            text-align: center;
            padding: 60px 20px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            margin-bottom: 32px;
            color: white;
        }

        .home-title {
            font-size: 36px;
            font-weight: 700;
            margin: 0 0 12px;
            color: white;
        }

        .home-subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin: 0;
        }

        .home-section-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 20px;
            color: #1f2937;
        }

        .home-quick-actions {
            margin-bottom: 40px;
        }

        .home-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .home-action-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .home-action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .home-action-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .home-action-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 8px;
            color: #1f2937;
        }

        .home-action-card p {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }

        .home-recent-stores {
            margin-top: 40px;
        }

        .home-stores-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .home-store-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .home-store-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .home-store-name {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px;
            color: #1f2937;
        }

        .home-store-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 12px;
        }

        .home-store-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #9ca3af;
        }

        .home-loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .catchphrase-container:hover {
            opacity: 0.9;
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        /* 로딩 및 에러 상태 스타일 */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .error-message {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #e74c3c;
            font-size: 14px;
            background-color: #fdf2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
        }

        /* 선택된 가게 행 스타일 */
        .selected-store {
            background-color: #eff6ff !important;
            border-left: 4px solid #3b82f6 !important;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        .selected-store:hover {
            background-color: #dbeafe !important;
        }

        .delivery-grid-item .app-name {
            font-size: 14px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 4px;
        }
        .delivery-grid-item .app-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #fef2f2;
            color: #dc2626;
            font-weight: 500;
            border: 1px solid #fecaca;
        }
        .delivery-grid-item .app-status.active {
            background: #f0fdf4;
            color: #16a34a;
            border-color: #bbf7d0;
        }
        /* SortableJS 드래그 중 스타일 */
        .sortable-ghost {
            opacity: 0.4;
        }
        .sortable-chosen {
            transform: scale(1.05);
        }
        /* 현대적인 토글 스위치 */
        .toggle-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-info h3 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .toggle-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin: 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 32px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 32px;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 2px;
            bottom: 2px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: rgba(255, 255, 255, 0.9);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(28px);
        }
        /* 현대적인 폼 카드 */
        .settings-form {
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .settings-form.active {
            opacity: 1;
        }
        
        /* UI 순서 변경은 항상 활성 상태 (활성/비활성 개념 없음) */
        #section-order .settings-form {
            opacity: 1;
        }

        /* DB 통계 스타일 */
        .db-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .db-stats-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .db-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        .db-stats-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }
        .db-stats-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }
        .db-stats-table {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .db-stats-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .db-stats-table th,
        .db-stats-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .db-stats-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        .db-stats-table tr:last-child td {
            border-bottom: none;
        }
        .db-stats-loading {
            padding: 20px;
            text-align: center;
            color: #6b7280;
        }
        .neon-plan-info {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }
        .plan-item {
            margin-bottom: 20px;
        }
        .plan-item:last-child {
            margin-bottom: 0;
        }
        .plan-item strong {
            display: block;
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .plan-item ul {
            margin: 8px 0 0 20px;
            color: #4b5563;
        }
        .plan-item li {
            margin-bottom: 4px;
        }
        .plan-warning {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
        }
        .plan-warning strong {
            color: #92400e;
        }
        .plan-warning p {
            margin: 8px 0 0 0;
            color: #78350f;
            font-size: 14px;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .form-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow-x: hidden;
            max-width: 100%;
            box-sizing: border-box;
        }

        .form-card:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .form-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f8fafc;
        }
        
        .form-header-title {
            display: flex;
            align-items: center;
        }

        .form-icon {
            font-size: 32px;
            margin-right: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-header h3 {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
            margin: 0;
        }
        
        .form-header p {
            font-size: 15px;
            color: #64748b;
            margin: 0;
            padding-left: 48px; /* icon + margin */
        }

        /* 현대적인 폼 라벨 */
        .form-label {
            display: block;
            margin-bottom: 16px;
        }

        .label-text {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .label-hint {
            display: block;
            font-size: 14px;
            color: #718096;
            font-style: italic;
        }

        /* 현대적인 입력 필드 */
        .input-wrapper, .textarea-wrapper {
            position: relative;
        }

        .modern-input, .modern-textarea {
            width: 100%;
            padding: 16px 20px 16px 56px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
            box-sizing: border-box;
        }

        .modern-textarea {
            padding: 16px 20px 16px 56px;
            resize: vertical;
            min-height: 120px;
        }

        .modern-input:focus, .modern-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .input-icon, .textarea-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #a0aec0;
            pointer-events: none;
        }

        .textarea-icon {
            top: 20px;
            transform: none;
        }

        /* 친절한 가이드 메시지 */
        .guide-message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #0ea5e9;
            margin-top: 16px;
        }

        .guide-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .guide-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.6;
            color: #0c4a6e;
        }

        .guide-text strong {
            color: #0369a1;
            font-weight: 600;
        }

        /* 섹션 순서 설정 스타일 (delivery-grid-section과 동일한 컨테이너 스타일) */
        .section-order-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            margin-bottom: 20px;
        }
        
        .order-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .order-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
            user-select: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .order-item:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .order-content {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 12px;
        }
        
        .order-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: #3b82f6;
            color: white;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .order-info {
            flex: 1;
        }
        
        .order-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
            font-size: 16px;
        }
        
        .order-subtitle {
            font-size: 14px;
            color: #64748b;
        }
        
        .order-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .drag-handle {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            color: #95a5a6;
            font-size: 16px;
            font-weight: bold;
            user-select: none;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .drag-handle:hover {
            color: #7f8c8d;
            background-color: #ecf0f1;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .btn-move-up,
        .btn-move-down {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            width: 32px;
            height: 32px;
        }
        
        .btn-move-up:hover:not(:disabled),
        .btn-move-down:hover:not(:disabled) {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .btn-move-up:disabled,
        .btn-move-down:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* 공통 컨테이너 스타일 */
        .settings-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e1e5e9;
        }

        .order-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px 20px 16px 50px;
            cursor: move;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .order-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .order-item.dragging {
            opacity: 0.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .order-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .order-content {
            flex: 1;
            min-width: 0;
        }
        .order-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .order-description {
            font-size: 13px;
            color: #64748b;
        }

        .order-handle {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            flex-shrink: 0;
            color: #94a3b8;
            transition: color 0.2s;
        }

        .order-handle:hover {
            color: #667eea;
        }

        .order-handle:active {
            cursor: grabbing;
        }
        
        .order-handle svg {
            opacity: 0.6;
        }
        
        .order-handle:hover svg {
            opacity: 1;
        }
        .save-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }
        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        .save-icon {
            margin-right: 8px;
            font-size: 16px;
        }
        /* 반응형 디자인 */
        @media (max-width: 768px), (max-height: 600px) {
            .admin-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transform: translateX(-100%);
            }
            
            .admin-sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .admin-content {
                flex: 1;
                width: 100%;
                margin-left: 0;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .toggle-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .form-card {
                padding: 24px;
            }

            .form-header {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }

            .form-icon {
                margin-right: 0;
                margin-bottom: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- 전역 로딩 바 -->
    <div id="globalLoadingBar" class="global-loading-bar"></div>
    <!-- 프로그레스 바 (최상단 고정) -->
    <div id="progressBar" style="position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); z-index: 99999; transition: width 0.3s ease, opacity 0.3s ease; opacity: 0;"></div>
    
    <!-- 섹션 로딩 모달 -->
    <div id="sectionLoadingModal" class="section-loading-modal">
        <div class="section-loading-spinner"></div>
        <div class="section-loading-text" id="sectionLoadingText">데이터를 불러오는 중...</div>
        <div class="section-loading-progress">
            <div class="section-loading-progress-bar" id="sectionLoadingProgressBar"></div>
        </div>
        <div class="section-loading-percent" id="sectionLoadingPercent">0%</div>
    </div>
    
    <div class="admin-container">
        <!-- 토스트 알림 컨테이너 -->
        <div id="toastContainer" class="toast-container"></div>
        
        <!-- 모바일 사이드바 토글 버튼 -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
        
        <!-- 사이드바 오버레이 (모바일) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- 사이드바 -->
        <div class="admin-sidebar">
            <!-- 메뉴 영역 (스크롤 가능) -->
            <div class="sidebar-content">
                <div class="catchphrase-container" style="cursor: pointer;" onclick="showSection('home')" title="홈으로 이동">
                    <h2 class="catchphrase-title">관리자 메뉴</h2>
                    <div class="catchphrase">
                        <span class="catchphrase-text">우리집 5분거리</span>
                        <span class="catchphrase-highlight">픽업</span>
                    </div>
                </div>

                <div class="menu-section-title">공통</div>
                <div class="menu-item" onclick="showSection('dashboard')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M9 3v18"/><path d="M15 9h6"/><path d="M15 15h6"/></svg>
                    대시보드
                </div>

                <div id="selectedStoreCard" class="selected-store-card">
                    <div class="selected-store-header">
                        <div class="selected-store-logo" id="selectedStoreLogo">
                            <img src="/assets/images/icons/default-store.png" alt="가게 로고" class="store-logo-img">
                        </div>
                        <div class="selected-store-label">선택된 가게</div>
                    </div>
                    <div class="selected-store-name" id="selectedStoreName">가게를 선택해주세요</div>
                    <div class="selected-store-subtitle" id="selectedStoreSubtitle">좌측 가게 목록에서 선택하세요</div>
                </div>

                <div class="menu-item" data-menu="store-management" onclick="showSection('stores')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    가게 관리
                </div>
                <div class="menu-item" onclick="showSection('basic')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    기본 정보
                </div>
                <div class="menu-item" onclick="showSection('domain-qr')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/></svg>
                    도메인/QR 관리
                </div>
                <div class="menu-item" onclick="showSection('delivery')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                    배달앱 설정
                </div>
                <div class="menu-item" onclick="showSection('images')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    이미지/동영상 관리
                </div>
                <div class="menu-item" onclick="showSection('discount')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                    할인 · 픽업 안내
                </div>
                <div class="menu-item" onclick="showSection('section-order')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    UI 순서 변경
                </div>
                <div class="menu-item" onclick="showSection('ambassadors')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    엠버서더 관리
                </div>

                <div class="menu-section-title owner-only">사장님 전용</div>
                <div class="menu-item owner-only" data-menu="owner-account" onclick="showSection('owner-account')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1l9 4v6c0 5-3.8 9.4-9 11-5.2-1.6-9-6-9-11V5l9-4z"/><circle cx="12" cy="11" r="3"/></svg>
                    내 계정
                </div>

                <div class="menu-section-title" data-role="superadmin-only">슈퍼어드민 전용</div>
                <div class="menu-item" data-role="superadmin-only" onclick="showSection('accounts')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 19.62V21"/><circle cx="12" cy="7" r="4"/><path d="M4 21a4 4 0 0 1 4-4h5"/></svg>
                    점주 계정 관리
                </div>
                <div class="menu-item" data-role="superadmin-only" onclick="showSection('activity-logs')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    활동 로그
                </div>
                <div class="menu-item" data-role="superadmin-only" onclick="showSection('superadmin')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    슈퍼어드민
                </div>
                <div class="menu-item" data-role="superadmin-only" onclick="showSection('db-stats')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 4-4"/></svg>
                    DB 통계 (NEON)
                </div>
            </div>
            
            <!-- 사이드바 하단 (버전 정보 & 릴리즈 노트) - 항상 하단 고정 -->
            <div class="sidebar-footer">
                <div class="version-info">
                    <div class="version-badge">v1.6.15-staging</div>
                </div>
                <a href="/admin/release-notes" class="release-notes-btn">
                    릴리즈 노트
                </a>
            </div>
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="admin-content">
            <!-- 헤더 -->
            <div class="admin-header">
                <div class="header-info">
                    <h1>픽업 - 관리자 페이지</h1>
                    <p>가게 정보와 설정을 관리하세요</p>
                </div>
                <div class="header-actions">
                    <a href="/admin/bulk-management" id="bulkManagementBtn" class="btn btn-primary" style="display: none; margin-right: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        대량 가게 관리
                    </a>
                    <button onclick="openSetupGuide()" class="btn btn-primary owner-only" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; margin-right: 10px;">
                        📋 설정 가이드
                    </button>
                    <a href="javascript:void(0)" onclick="openMainPage()" class="btn btn-primary">페이지 보기</a>
                    <button onclick="openLogoutModal()" class="btn btn-secondary">로그아웃</button>
                </div>
            </div>

            <!-- 홈 (메인 페이지) -->
            <div class="admin-section" id="home">
                <div class="home-welcome">
                    <h1 class="home-title">관리자 홈</h1>
                    <p class="home-subtitle">빠르게 시작하세요</p>
                </div>
                
                <div class="home-quick-actions">
                    <h2 class="home-section-title">빠른 액션</h2>
                    <div class="home-action-grid">
                        <div class="home-action-card" onclick="showSection('stores')">
                            <div class="home-action-icon">🏪</div>
                            <h3>가게 관리</h3>
                            <p>가게 목록 조회 및 관리</p>
                        </div>
                        <div class="home-action-card" onclick="showSection('dashboard')">
                            <div class="home-action-icon">📊</div>
                            <h3>대시보드</h3>
                            <p>통계 및 분석</p>
                        </div>
                        <div class="home-action-card" onclick="showSection('basic')">
                            <div class="home-action-icon">⚙️</div>
                            <h3>기본 정보</h3>
                            <p>가게 기본 정보 설정</p>
                        </div>
                        <div class="home-action-card" onclick="showSection('delivery')">
                            <div class="home-action-icon">🚚</div>
                            <h3>배달앱 설정</h3>
                            <p>배달앱 링크 관리</p>
                        </div>
                    </div>
                </div>
                
                <div class="home-recent-stores" id="homeRecentStores">
                    <h2 class="home-section-title">최근 가게</h2>
                    <div class="home-stores-list" id="homeStoresList">
                        <div class="home-loading">가게 목록을 불러오는 중...</div>
                    </div>
                </div>
            </div>

            <!-- 설정 가이드 섹션 -->
            <div class="admin-section" id="setup-guide" style="display:none;">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    설정 가이드
                </h2>
                <p class="section-description">필수 및 선택 설정을 단계별로 완료하여 가게 페이지를 쉽게 설정하세요.</p>
                
                <div class="setup-guide-container" id="setupGuideContainer">
                    <!-- 단계별 가이드가 동적으로 생성됩니다 -->
                </div>
            </div>

            <div class="admin-section" id="dashboard" style="display:none;">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M9 3v18"/><path d="M15 9h6"/><path d="M15 15h6"/></svg>
                    대시보드
                </h2>
                <p class="dashboard-scope-hint superadmin-only" id="dashboardScopeHint">선택된 가게 기준 주요 지표입니다.</p>
                <div class="dashboard-controls superadmin-only" id="dashboardControls">
                    <div class="dashboard-scope-toggle">
                        <button type="button" class="dashboard-scope-btn active" data-scope="store">선택된 가게</button>
                        <button type="button" class="dashboard-scope-btn" data-scope="all">전체 현황</button>
                    </div>
                    <div class="dashboard-search-wrapper" id="dashboardSearchWrapper">
                        <input type="text" id="dashboardStoreSearchInput" placeholder="가게 이름, 서브도메인 검색">
                        <span class="dashboard-search-count" id="dashboardStoreCount">총 0개 가게</span>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>페이지 방문</h3>
                        <div class="metric-value" id="metricPageViews">-</div>
                        <div class="metric-sub">최근 7일</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>전화 버튼 클릭</h3>
                        <div class="metric-value" id="metricCallClicks">-</div>
                        <div class="metric-sub">최근 7일</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>메뉴 열람</h3>
                        <div class="metric-value" id="metricMenuViews">-</div>
                        <div class="metric-sub">최근 7일</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>배달앱 클릭</h3>
                        <div class="metric-value" id="metricDeliveryClicks">-</div>
                        <div class="metric-sub">최근 7일</div>
                    </div>
                </div>
                <div class="dashboard-daily">
                    <h3 style="margin-bottom:12px; font-size:16px; color:#1f2937;">일일 이벤트 현황</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>방문</th>
                                <th>전화</th>
                                <th>메뉴</th>
                                <th>배달앱</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardDailyBody">
                            <tr>
                                <td colspan="5" style="text-align:center; color:#94a3b8;">데이터를 불러오는 중입니다.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="dashboard-store-table superadmin-only" id="dashboardStoreTable">
                    <table>
                        <thead>
                            <tr>
                                <th>가게명</th>
                                <th>서브도메인</th>
                                <th>상태</th>
                                <th>방문</th>
                                <th>전화</th>
                                <th>메뉴</th>
                                <th>배달</th>
                                <th>최근 활동</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardStoreTableBody">
                            <tr>
                                <td colspan="9" style="text-align:center; padding:18px; color:#94a3b8;">데이터를 불러오는 중입니다.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 상태 메시지 -->
            <div id="statusMessage" class="status-message" style="display: none;">
                <span id="statusText"></span>
            </div>

            <!-- 가게 관리 -->
            <div class="admin-section" id="stores">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    가게 관리
                </h2>
                
                <!-- 통계 대시보드 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div onclick="filterByStatCard('all')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">전체 가게</div>
                        <div style="font-size: 32px; font-weight: 700;" id="totalStoresCount">0</div>
                    </div>
                    <div onclick="filterByStatCard('active')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">활성 가게</div>
                        <div style="font-size: 32px; font-weight: 700;" id="activeStoresCount">0</div>
                    </div>
                    <div onclick="filterByStatCard('pending')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">승인 대기</div>
                        <div style="font-size: 32px; font-weight: 700;" id="pendingStoresCount">0</div>
                    </div>
                    <div onclick="filterByStatCard('paused')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">일시정지</div>
                        <div style="font-size: 32px; font-weight: 700;" id="pausedStoresCount">0</div>
                    </div>
                    <div onclick="filterByStatCard('today')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">오늘 추가</div>
                        <div style="font-size: 32px; font-weight: 700;" id="todayStoresCount">0</div>
                    </div>
                </div>
                
                <!-- 검색 및 필터 -->
                <div class="store-toolbar">
                    <div class="store-filters">
                        <input type="text" id="storeSearchInput" placeholder="가게명, 전화번호, 주소 검색..." 
                               onkeyup="handleStoreSearchInput()" />
                        <select id="storeStatusFilter" onchange="handleStoreStatusFilterChange()">
                            <option value="">전체 상태</option>
                            <option value="active">활성</option>
                            <option value="pending">승인 대기</option>
                            <option value="paused">일시정지</option>
                        </select>
                        <select id="storeOwnerFilter" class="superadmin-only" onchange="handleStoreOwnerFilterChange()">
                            <option value="">전체 점주</option>
                            <option value="__unassigned">미연결</option>
                        </select>
                        <select id="storeCreatedFilter" onchange="handleStoreCreatedFilterChange()">
                            <option value="">전체 기간</option>
                            <option value="today">오늘 등록</option>
                        </select>
                        <select id="storeSortBy" onchange="handleStoreSortChange()">
                            <option value="createdAt">생성일순</option>
                            <option value="name">이름순</option>
                            <option value="lastModified">최근 수정순</option>
                        </select>
                    </div>
                    <div class="store-view-toggle">
                        <button type="button" class="store-view-btn active" data-view="store" onclick="setStoreViewMode('store')">가게별</button>
                        <button type="button" class="store-view-btn superadmin-only" data-view="owner" onclick="setStoreViewMode('owner')">점주별</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>가게 목록 (<span id="filteredStoresCount">0</span>개)</label>
                    <div id="storeTableWrapper" style="overflow-x: auto; max-width: 100%; box-sizing: border-box;">
                        <table id="storeTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead style="background: #f8fafc;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ID</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">가게명</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">연결된 점주</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">전화번호</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">상태</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">작업</th>
                                </tr>
                            </thead>
                            <tbody id="storeTableBody">
                                <tr><td colspan="6" style="padding: 20px; text-align: center; color: #94a3b8;">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="owner-group-container" id="ownerGroupContainer"></div>
                </div>

                <div class="store-pagination" id="storePagination">
                    <button type="button" class="btn btn-secondary" id="storePrevPageBtn" onclick="changeStorePage(-1)">이전</button>
                    <span class="store-pagination-info" id="storePaginationInfo">1 / 1</span>
                    <button type="button" class="btn btn-secondary" id="storeNextPageBtn" onclick="changeStorePage(1)">다음</button>
                </div>

                <div class="button-group" style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button onclick="showStoreNameModal()" class="btn btn-primary">
                        새 가게 추가
                    </button>
                    <button onclick="window.location.href='/admin/bulk-management'" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        대량 관리
                    </button>
                    <button onclick="exportStoresJSON()" class="btn">
                        JSON 내보내기
                    </button>
                    <button onclick="exportStoresCSV()" class="btn">
                        CSV 내보내기
                    </button>
                </div>

                <div class="owner-store-actions owner-only" id="ownerStoreActions">
                    <button onclick="openOwnerStoreRequestModal()" class="btn btn-primary owner-action-btn">
                        추가 입점 신청
                    </button>
                    <p>추가 입점 신청이 승인되면 목록에 새로운 가게가 표시됩니다.</p>
                </div>
            </div>
            <!-- 기본 정보 -->
            <div class="admin-section" id="basic">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    기본 정보
                </h2>
                
                <div class="basic-summary-intro">
                    <div class="summary-highlight">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                        기본 정보는 아래 요약으로 확인할 수 있습니다. <strong>설정 변경</strong> 버튼을 눌러 단계별로 수정하세요.
                    </div>
                </div>

                <div class="basic-summary-card" id="basicSummaryCard">
                    <div class="basic-summary-header">
                        <h3>기본 정보 요약</h3>
                        <button type="button" class="btn btn-primary summary-action" onclick="openBasicInfoWizard()">설정 변경</button>
                    </div>
                    <div class="basic-summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">가게명</span>
                            <span class="summary-value" id="summaryStoreName">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">하단 텍스트</span>
                            <span class="summary-value" id="summaryStoreSubtitle">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">전화번호</span>
                            <span class="summary-value" id="summaryStorePhone">-</span>
                        </div>
                        <div class="summary-item summary-address">
                            <span class="summary-label">주소</span>
                            <span class="summary-value" id="summaryStoreAddress">-</span>
                        </div>
                        <div class="summary-item summary-domain">
                            <span class="summary-label">도메인</span>
                            <span class="summary-value" id="summaryStoreDomain">-</span>
                            <button type="button" class="btn btn-secondary summary-qr-btn" id="summaryQrDownloadBtn" style="display:none;" onclick="downloadDomainQR()">
                                QR 다운로드
                            </button>
                        </div>
                    </div>
                    <p class="summary-domain-notice" id="summaryDomainNotice"></p>
                </div>
                <input type="hidden" id="subdomain" value="">

                <div id="basicHiddenInputs" class="hidden-basic-inputs">
                    <div class="form-group">
                        <label for="storeName">가게명</label>
                        <input type="text" id="storeName" class="form-input" placeholder="가게명을 입력하세요" onblur="saveBasicInfo()">
                    </div>
                    
                    <div class="form-group">
                        <label for="storeSubtitle">하단 텍스트</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="storeSubtitle" class="form-input" placeholder="하단 텍스트를 입력하세요" onblur="saveBasicInfo()" style="flex: 1;">
                            <button type="button" onclick="generateSubtitleWithAI()" class="ai-generate-btn" title="AI로 하단 텍스트 자동 생성">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                AI 작성
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="storePhone">전화번호</label>
                        <input type="text" id="storePhone" class="form-input" placeholder="전화번호를 입력하세요" onblur="saveBasicInfo()">
                    </div>
                    
                    <div class="form-group">
                        <label for="storePostalCode">주소</label>
                        <div class="address-search-group">
                            <div class="address-row">
                                <input type="text" id="storePostalCode" class="form-input" placeholder="우편번호" readonly>
                                <button type="button" class="btn btn-secondary" style="padding: 10px 16px; font-size: 14px;" onclick="openAddressSearch()">주소 검색</button>
                            </div>
                            <input type="text" id="storeRoadAddress" class="form-input" placeholder="도로명 주소" readonly>
                            <input type="text" id="storeExtraAddress" class="form-input" placeholder="참고 항목" readonly>
                            <input type="text" id="storeAddressDetail" class="form-input" placeholder="상세 주소를 입력하세요" oninput="syncFullAddress()" onblur="handleAddressDetailBlur()">
                            <input type="hidden" id="storeAddress">
                        </div>
                        <small style="margin-top: 6px; display: block; color: #64748b;">주소 검색을 통해 도로명 주소를 선택하고, 상세 주소를 입력하면 자동 저장됩니다.</small>
                    </div>
                </div>
                
                <!-- 영업시간 조회 -->
                <div class="form-group">
                    <label>영업시간</label>
                    <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-top: 8px;">
                        <div id="businessHoursDisplay" style="max-height: 300px; overflow-y: auto;">
                            <!-- 영업시간이 여기에 표시됩니다 -->
                            </div>
                        <div style="margin-top: 12px; text-align: center;">
                            <button onclick="openBusinessHoursModal()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                                영업시간 설정
                            </button>
                            </div>
                    </div>
                </div>
                
            </div>

            <!-- 도메인/QR 관리 -->
            <div class="admin-section" id="domain-qr">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/></svg>
                    도메인/QR 관리
                </h2>
                
                <div class="form-card">
                    <div class="form-group">
                        <label for="domainSubdomain">서브도메인</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="domainSubdomain" class="form-input" placeholder="예: mystore" style="flex:1;">
                            <button type="button" class="btn btn-secondary" id="domainSaveBtn" onclick="saveDomainFromSection()" style="display:none;">
                                저장
                            </button>
                        </div>
                        <small class="form-helper" id="domainHelper">
                            도메인은 최초 1회만 설정할 수 있으며 QR 생성 후에는 수정할 수 없습니다.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>도메인 미리보기</label>
                        <div class="domain-preview" id="domainPreview" style="background: #f8fafc; border-radius: 8px; padding: 12px; font-family: monospace; color: #667eea; font-weight: 600;">
                            -
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>QR 코드</label>
                        <div id="qrSection" style="display:none;">
                            <div id="qrCodeDisplay" style="background: white; border-radius: 8px; padding: 20px; text-align: center; border: 1px solid #e2e8f0;">
                                <!-- QR 코드가 여기에 표시됩니다 -->
                            </div>
                            <div style="margin-top: 12px; text-align: center;">
                                <button type="button" class="btn btn-primary" id="domainQrDownloadBtn" onclick="downloadDomainQR()" style="display:none;">
                                    QR 다운로드
                                </button>
                            </div>
                        </div>
                        <div style="margin-top: 12px; text-align: center;">
                            <button type="button" class="btn btn-secondary" id="domainQrGenerateBtn" onclick="generateDomainQRFromSection()" style="display:none;">
                                QR 생성
                            </button>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="subdomain" value="">
            </div>

            <!-- 배달앱 설정 -->
            <div class="admin-section" id="delivery">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                    배달앱 설정
                </h2>
                
                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid #667eea; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #64748b; font-weight: 500; font-size: 14px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        변경사항을 저장하려면 하단의 저장 버튼을 클릭하세요
                    </div>
                </div>
                
                <div class="delivery-grid-section">
                    <div class="delivery-grid-section-header">
                        <h3>배달앱 표시 순서</h3>
                        <p class="order-description">드래그하여 순서를 변경할 수 있습니다. 가게 페이지와 동일한 형태로 표시됩니다.</p>
                    </div>
                    
                    <div class="delivery-grid-container">
                        <div class="delivery-grid" id="deliveryOrderGrid">
                            <!-- 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ttaengUrl">땡겨요 URL</label>
                    <input type="url" id="ttaengUrl" class="form-input" placeholder="땡겨요 URL을 입력하세요" oninput="updateDeliveryStatus('ttaeng'); markDeliverySettingsChanged();">
                    <div id="ttaengStatus" class="delivery-status status-inactive">준비중</div>
                </div>
                
                <div class="form-group">
                    <label for="baeminUrl">배달의민족 URL</label>
                    <input type="url" id="baeminUrl" class="form-input" placeholder="배달의민족 URL을 입력하세요" oninput="updateDeliveryStatus('baemin'); markDeliverySettingsChanged();">
                    <div id="baeminStatus" class="delivery-status status-inactive">준비중</div>
                </div>
                
                <div class="form-group">
                    <label for="coupangUrl">쿠팡이츠 URL</label>
                    <input type="url" id="coupangUrl" class="form-input" placeholder="쿠팡이츠 URL을 입력하세요" oninput="updateDeliveryStatus('coupang'); markDeliverySettingsChanged();">
                    <div id="coupangStatus" class="delivery-status status-inactive">준비중</div>
                </div>
                
                <div class="form-group">
                    <label for="yogiyoUrl">요기요 URL</label>
                    <input type="url" id="yogiyoUrl" class="form-input" placeholder="요기요 URL을 입력하세요" oninput="updateDeliveryStatus('yogiyo'); markDeliverySettingsChanged();">
                    <div id="yogiyoStatus" class="delivery-status status-inactive">준비중</div>
                </div>
                
                <div class="form-group" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #f1f5f9;">
                    <button type="button" id="saveDeliverySettingsBtn" class="btn btn-primary" onclick="saveAllDeliverySettings()" style="min-width: 200px; font-weight: 600;" disabled>
                        저장
                    </button>
                    <span id="deliverySettingsSaveStatus" style="margin-left: 12px; color: #64748b; font-size: 14px;"></span>
                </div>
            </div>

            <!-- 계정 관리 (슈퍼어드민 전용) -->
            <div class="admin-section superadmin-only" id="accounts">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 19.62V21"/><circle cx="12" cy="7" r="4"/><path d="M4 21a4 4 0 0 1 4-4h5"/></svg>
                    계정 관리
                </h2>
                <p style="margin-bottom: 20px; color: #64748b;">입점 요청을 확인하고 가게 사장님 계정을 승인/관리하세요.</p>

                <div class="owner-toolbar">
                    <div class="owner-tabs">
                        <button type="button" class="owner-tab active" data-status="pending">승인 대기</button>
                        <button type="button" class="owner-tab" data-status="active">운영 중</button>
                        <button type="button" class="owner-tab" data-status="suspended">일시 중지</button>
                        <button type="button" class="owner-tab" data-status="rejected">거절됨</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="ownerSearchInput" placeholder="가게명, 점주명, 전화번호, 주소 검색..." style="padding: 8px 12px; border: 1px solid #d0d7e2; border-radius: 8px; font-size: 14px; min-width: 300px;" oninput="debouncedOwnerSearch()">
                    <button type="button" class="btn" style="background: #e2e8f0; color: #1f2937; padding: 8px 16px; border-radius: 8px;" onclick="reloadOwnerAccounts()">새로고침</button>
                    </div>
                </div>

                <div id="ownerList"></div>
            </div>

            <div class="modal-backdrop" id="ownerApprovalModal">
                <div class="modal-card">
                    <h3>점주 계정 승인</h3>
                    <div class="modal-info" id="ownerModalInfo"></div>
                    <div id="ownerModalStoreInfo" class="modal-highlight"></div>
                     <div id="ownerModalResult" style="display:none; margin-top:16px; padding:12px; border-radius:12px; background:#ecfdf5; color:#047857; font-size:14px;"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeOwnerModal()">취소</button>
                        <button type="button" class="btn-primary" id="ownerModalSubmitBtn" data-mode="approve">승인하기</button>
                    </div>
                </div>
            </div>

            <div class="modal-backdrop" id="ownerRejectModal">
                <div class="modal-card">
                    <h3>점주 요청 거절</h3>
                    <div class="modal-info" id="ownerRejectInfo"></div>
                    <div class="form-group" style="margin-top:20px;">
                        <label for="ownerRejectReason">거절 사유</label>
                        <textarea id="ownerRejectReason" placeholder="거절 사유를 구체적으로 작성해주세요." required></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeOwnerRejectModal()">취소</button>
                        <button type="button" class="btn-primary" id="ownerRejectSubmitBtn" onclick="submitOwnerRejection()">거절하기</button>
                    </div>
                </div>
            </div>

            <div class="modal-backdrop" id="ownerManageModal">
                <div class="modal-card">
                    <h3 id="ownerManageModalTitle">계정 관리</h3>
                    <div class="modal-info" id="ownerManageModalMessage" style="margin-top:12px; color:#475569; line-height:1.6;"></div>
                    <div class="modal-actions" style="margin-top:24px;">
                        <button type="button" class="btn-secondary" onclick="closeOwnerManageModal()">취소</button>
                        <button type="button" class="btn btn-primary" id="ownerManageModalConfirmBtn" onclick="submitOwnerManageAction()">확인</button>
                    </div>
                </div>
            </div>

    <div class="modal-backdrop" id="logoutModal">
        <div class="modal-card">
            <h3>로그아웃</h3>
            <p style="margin-top:12px; color:#475569;">정말 로그아웃하시겠습니까?</p>
            <div class="modal-actions" style="margin-top:24px;">
                <button type="button" class="btn-secondary" onclick="closeLogoutModal()">취소</button>
                <button type="button" class="btn-primary" onclick="confirmLogout()">로그아웃</button>
            </div>
        </div>
    </div>

            <!-- 이미지/동영상 관리 -->
            <div class="admin-section" id="images">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    이미지/동영상 관리
                </h2>
                
                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid #667eea; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #667eea; font-weight: 600; font-size: 14px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                        이미지 업로드 시 자동 저장됩니다
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="mainLogo">메인 로고</label>
                    <div class="image-upload-area" id="mainLogoArea" ondrop="handleDrop(event, 'mainLogo')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="drag-drop-text">
                            <span></span>
                            <p>이미지를 드래그하여 놓거나 클릭하여 선택하세요</p>
                        </div>
                        <img id="mainLogoPreview" class="current-image" style="display: none;">
                        <input type="file" id="mainLogo" class="file-input" accept="image/*" onchange="handleImageUpload('mainLogo', 'mainLogo')">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="menuImage">메뉴 이미지</label>
                    <div class="image-upload-area" id="menuImageArea" ondrop="handleDrop(event, 'menuImage')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="drag-drop-text">
                            <span></span>
                            <p>이미지를 드래그하여 놓거나 클릭하여 선택하세요</p>
                        </div>
                        <img id="menuImagePreview" class="current-image" style="display: none;">
                        <input type="file" id="menuImage" class="file-input" accept="image/*" onchange="handleImageUpload('menuImage', 'menuImage')">
                    </div>
                    <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 6px;">
                        <button type="button" class="btn btn-secondary" style="align-self: flex-start; padding: 8px 16px; font-size: 13px;" onclick="triggerPromoVideoUpload()">
                            동영상 삽입 (10초 이내)
                        </button>
                        <span style="font-size: 12px; color: #6b7280;">소개 영상은 10초 이하, 20MB 이내의 mp4 · webm · ogg 파일만 지원됩니다.</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="promoVideo">동영상 삽입 (10초 이하)</label>
                    <div class="image-upload-area" id="promoVideoArea" ondrop="handleVideoDrop(event, 'promoVideo')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="drag-drop-text" id="promoVideoDragText" onclick="handlePromoVideoAreaClick(event)" style="cursor: pointer;">
                            <span>🎥</span>
                            <p>동영상을 드래그하여 놓거나 클릭하여 선택하세요</p>
                            <small style="color:#94a3b8;">mp4, webm, ogg 지원</small>
                            <small style="color:#dc2626; font-weight: 600;">10초 이하 영상만 업로드 가능합니다.</small>
                        </div>
                        <video id="promoVideoPreview" class="current-video" style="display: none;" muted playsinline loop controls onclick="event.stopPropagation();"></video>
                        <div id="promoVideoMeta" style="display:none; margin-top: 12px; font-size: 13px; color: #4b5563;"></div>
                        <input type="file" id="promoVideo" class="file-input" accept="video/mp4,video/webm,video/ogg" onchange="handleVideoUpload('promoVideo', 'promoVideo')" style="display: none;">
                    </div>
                </div>
            </div>
            <!-- 엠버서더 관리 -->
            <div class="admin-section" id="ambassadors">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    엠버서더 관리
                </h2>
                
                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid #667eea; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #667eea; font-weight: 600; font-size: 14px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        엠버서더 정보를 등록하고 고유 링크를 생성하여 고객에게 공유하세요
                    </div>
                </div>
                
                <!-- 엠버서더 추가 버튼 -->
                <div style="margin-bottom: 24px;">
                    <button onclick="openAmbassadorModal()" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        엠버서더 추가
                    </button>
                </div>
                
                <!-- 엠버서더 목록 -->
                <div id="ambassadorsList" class="ambassadors-list">
                    <div class="loading-state">엠버서더 목록을 불러오는 중...</div>
                </div>
            </div>
            <!-- 할인 · 픽업 안내 -->
            <div class="admin-section" id="discount">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                    할인 · 픽업 안내
                </h2>
                
                <!-- 할인 활성화 토글 -->
                <div class="toggle-card">
                    <div class="toggle-header">
                        <div class="toggle-info">
                            <h3>할인 이벤트 활성화</h3>
                            <p>고객들에게 할인 정보를 표시합니다</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="discountEnabled" onchange="saveDiscountSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 할인 설정 폼 -->
                <div class="settings-form" id="discountForm">
                    <div class="form-card">
                        <div class="form-header">
                            <h3>할인 정보 입력</h3>
                            <button onclick="generateAIContent('discount')" class="btn-ai" title="AI가 가게 이름을 분석하여 자동으로 작성합니다">
                                AI 작성
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="discountTitle" class="form-label">
                                <span class="label-text">할인 제목</span>
                                <span class="label-hint">고객이 눈에 띄는 제목을 입력하세요</span>
                            </label>
                            <div class="input-wrapper">
                                <input type="text" id="discountTitle" class="form-input modern-input" placeholder="예: 신메뉴 출시 기념 20% 할인!" onblur="saveDiscountSettings()">
                                <div class="input-icon">📝</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="discountDescription" class="form-label">
                                <span class="label-text">할인 설명</span>
                                <span class="label-hint">자세한 할인 내용을 입력하세요</span>
                            </label>
                            <div class="textarea-wrapper">
                                <textarea id="discountDescription" class="form-input modern-textarea" rows="4" placeholder="예: 신메뉴 출시를 기념하여 전체 메뉴 20% 할인! 기간: 12월 1일 ~ 12월 31일" onblur="saveDiscountSettings()"></textarea>
                                <div class="textarea-icon">📄</div>
                            </div>
                        </div>
                        
                        <div class="form-footer" id="discountGuideFooter">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <!-- 픽업 활성화 토글 -->
                <div class="toggle-card">
                    <div class="toggle-header">
                        <div class="toggle-info">
                            <h3>픽업 안내 활성화</h3>
                            <p>고객들에게 픽업 장소와 안내사항을 표시합니다</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pickupEnabled" onchange="savePickupSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 픽업 설정 폼 -->
                <div class="settings-form" id="pickupForm">
                    <div class="form-card">
                        <div class="form-header">
                            <h3>픽업 정보 입력</h3>
                            <button onclick="generateAIContent('pickup')" class="btn-ai" title="AI가 가게 이름을 분석하여 자동으로 작성합니다">
                                AI 작성
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="pickupTitle" class="form-label">
                                <span class="label-text">픽업 제목</span>
                                <span class="label-hint">고객이 이해하기 쉬운 제목을 입력하세요</span>
                            </label>
                            <div class="input-wrapper">
                                <input type="text" id="pickupTitle" class="form-input modern-input" placeholder="예: 픽업 장소 안내" onblur="savePickupSettings()">
                                <div class="input-icon">📝</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="pickupDescription" class="form-label">
                                <span class="label-text">픽업 설명</span>
                                <span class="label-hint">픽업 장소와 주의사항을 자세히 입력하세요</span>
                            </label>
                            <div class="textarea-wrapper">
                                <textarea id="pickupDescription" class="form-input modern-textarea" rows="4" placeholder="예: 매장 1층 카운터에서 픽업해주세요. 주문번호를 말씀해주시면 빠르게 받으실 수 있습니다." onblur="savePickupSettings()"></textarea>
                                <div class="textarea-icon">📄</div>
                            </div>
                        </div>
                        
                        <div class="form-footer" id="pickupGuideFooter">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- 섹션 순서 설정 -->
            <div class="admin-section" id="section-order">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    UI 순서 변경
                </h2>
                
                <div class="settings-form">
                    <div class="form-header">
                        <h3>가게 페이지 섹션 순서 관리</h3>
                        <p>드래그하거나 위/아래 버튼으로 순서를 변경하면 자동으로 저장됩니다</p>
                    </div>
                    
                    <div class="section-order-container">
                        <div class="order-list" id="sectionOrderList">
                            <!-- 동적으로 생성됩니다 -->
                        </div>
                    </div>
                    
                    <div class="form-footer" id="sectionOrderGuideFooter">
                        <strong>위/아래 버튼을 클릭하여 순서를 변경하세요</strong>
                        <p>변경사항은 자동 저장되며 즉시 반영됩니다</p>
                    </div>
                </div>
            </div>

            <!-- 대표 가게 설정 모달 -->
            <div class="modal-backdrop" id="primaryStoreSetupModal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>대표 가게 설정</h3>
                        <button type="button" class="modal-close" onclick="closePrimaryStoreSetupModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 20px; color: #64748b; line-height: 1.6;">
                            대표 가게를 설정해주세요. 로그인 시 자동으로 대표 가게가 선택됩니다.
                        </p>
                        <div class="form-group">
                            <label for="primaryStoreModalSelect">대표 가게 선택</label>
                            <select id="primaryStoreModalSelect" class="form-input">
                                <option value="">가게를 선택하세요</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closePrimaryStoreSetupModal()">나중에</button>
                        <button type="button" class="btn btn-primary" onclick="savePrimaryStoreFromModal()">설정</button>
                    </div>
                </div>
            </div>

            <div class="admin-section owner-only" id="owner-account">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7v7c0 5 3.5 9.4 10 11 6.5-1.6 10-6 10-11V7l-10-5z"/><circle cx="12" cy="11" r="3"/></svg>
                    내 계정
                </h2>

                <div class="owner-profile-card">
                    <div>
                        <div class="profile-label">로그인 이메일</div>
                        <div class="profile-value" id="ownerAccountEmail">-</div>
                    </div>
                    <div>
                        <div class="profile-label">대표 이름</div>
                        <div class="profile-value" id="ownerAccountName">-</div>
                    </div>
                    <div>
                        <div class="profile-label">대표 가게</div>
                        <div class="profile-value" id="ownerPrimaryStoreName">-</div>
                    </div>
                </div>

                <div class="settings-form">
                    <div class="form-card">
                        <div class="form-header">
                            <h3>대표 가게 설정</h3>
                            <p>대표 가게를 설정하면 로그인 시 자동으로 해당 가게가 선택됩니다.</p>
                        </div>

                        <div class="form-group">
                            <label for="ownerPrimaryStoreSelect">대표 가게 선택</label>
                            <select id="ownerPrimaryStoreSelect" class="form-input">
                                <option value="">가게를 선택하세요</option>
                            </select>
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-primary" onclick="saveOwnerPrimaryStore()">대표 가게 설정</button>
                        </div>
                    </div>

                    <div class="form-card">
                        <div class="form-header">
                            <h3>비밀번호 변경</h3>
                            <p>현재 비밀번호를 입력하고 새 비밀번호를 설정해주세요. 8자 이상을 권장합니다.</p>
                        </div>

                        <div class="form-group">
                            <label for="ownerCurrentPassword">현재 비밀번호</label>
                            <input type="password" id="ownerCurrentPassword" class="form-input" placeholder="현재 비밀번호를 입력하세요">
                        </div>

                        <div class="form-group">
                            <label for="ownerNewPassword">새 비밀번호</label>
                            <input type="password" id="ownerNewPassword" class="form-input" placeholder="새 비밀번호 (8자 이상)">
                        </div>

                        <div class="form-group">
                            <label for="ownerNewPasswordConfirm">새 비밀번호 확인</label>
                            <input type="password" id="ownerNewPasswordConfirm" class="form-input" placeholder="새 비밀번호를 다시 입력하세요">
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-primary" onclick="changeOwnerPassword()">비밀번호 변경</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 활동 로그 -->
            <div class="admin-section" id="activity-logs">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    활동 로그
                </h2>
                
                <div class="form-group">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <select id="logFilter" class="form-input" style="flex: 1;" onchange="loadActivityLogs()">
                            <option value="">전체 로그</option>
                            <option value="store">가게 관리</option>
                            <option value="settings">설정 변경</option>
                            <option value="image">이미지/동영상 관리</option>
                            <option value="qr">QR 코드</option>
                            <option value="ai">AI 생성</option>
                            <option value="admin">관리자</option>
                            <option value="system">시스템</option>
                        </select>
                        <button onclick="loadActivityLogs()" class="btn btn-primary">새로고침</button>
                    </div>
                </div>

                <div id="activityLogsList" class="activity-logs-list">
                    <div class="loading-message">활동 로그를 불러오는 중...</div>
                </div>
            </div>


            <!-- 슈퍼어드민 계정 관리 -->
            <div class="admin-section" id="superadmin">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/></svg>
                    슈퍼어드민 계정관리
                </h2>
                
                <div class="form-group">
                    <label for="adminUsername">계정명</label>
                    <input type="text" id="adminUsername" class="form-input" placeholder="계정명을 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">새 비밀번호</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="새 비밀번호를 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="adminPasswordConfirm">비밀번호 확인</label>
                    <input type="password" id="adminPasswordConfirm" class="form-input" placeholder="비밀번호를 다시 입력하세요">
                </div>
                
                <div class="button-group">
                    <button onclick="updateSuperAdminAccount()" class="btn btn-primary">계정 정보 수정</button>
                </div>
            </div>

            <!-- DB 통계 섹션 (슈퍼어드민 전용) -->
            <div class="admin-section superadmin-only" id="db-stats">
                <h2 class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 4-4"/></svg>
                    DB 통계 (NEON 비용 계산)
                </h2>
                
                <div class="form-card">
                    <div class="db-stats-header">
                        <h3>쿼리 통계</h3>
                        <button onclick="resetDbStats()" class="btn btn-secondary btn-sm">통계 리셋</button>
                    </div>
                    
                    <div class="db-stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">총 쿼리 수</div>
                            <div class="stat-value" id="dbStatsTotalQueries">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">시간당 쿼리</div>
                            <div class="stat-value" id="dbStatsQueriesPerHour">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">총 전송량</div>
                            <div class="stat-value" id="dbStatsTotalBytes">0 B</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">전송량 (GB)</div>
                            <div class="stat-value" id="dbStatsTotalGB">0.0000 GB</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">서버 가동 시간</div>
                            <div class="stat-value" id="dbStatsUptime">0시간</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">포함 전송량</div>
                            <div class="stat-value" id="dbStatsIncludedGB">100 GB</div>
                        </div>
                        <div class="stat-card" style="grid-column: span 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div class="stat-label" style="color: rgba(255,255,255,0.9);">예상 월간 비용 (전송량)</div>
                            <div class="stat-value" id="dbStatsEstimatedCost" style="font-size: 24px; font-weight: 700;">$0.00</div>
                            <div style="font-size: 12px; margin-top: 4px; opacity: 0.8;" id="dbStatsTransferOverGB">초과 전송량: 0 GB</div>
                        </div>
                    </div>

                    <div class="db-stats-section">
                        <h3>쿼리 타입별 통계</h3>
                        <div class="db-stats-table" id="dbStatsQueriesByType">
                            <div class="db-stats-loading">통계를 불러오는 중...</div>
                        </div>
                    </div>

                    <div class="db-stats-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0;">쿼리 실행 내역</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #64748b;">
                                    <input type="checkbox" id="dbStatsSlowQueryFilter" onchange="loadDbStats()" style="width: 16px; height: 16px;">
                                    느린 쿼리만 (1000ms 이상)
                                </label>
                                <select id="dbStatsQueryLimit" onchange="loadDbStats()" style="padding: 6px 12px; border: 1px solid #d0d7e2; border-radius: 6px; font-size: 13px;">
                                    <option value="50">최근 50개</option>
                                    <option value="100">최근 100개</option>
                                    <option value="200">최근 200개</option>
                                    <option value="500">최근 500개</option>
                                </select>
                            </div>
                        </div>
                        <div class="db-stats-table" id="dbStatsRecentQueries" style="max-height: 500px; overflow-y: auto;">
                            <div class="db-stats-loading">쿼리 데이터를 불러오는 중...</div>
                        </div>
                    </div>

                    <div class="db-stats-section">
                        <h3>NEON Launch 플랜 정보</h3>
                        <div class="neon-plan-info">
                            <div class="plan-item">
                                <strong>포함 사항:</strong>
                                <ul>
                                    <li>100 GB public network transfer (프로젝트당)</li>
                                    <li>Autoscale to 16 CU</li>
                                    <li>Scale to zero after 5 minutes</li>
                                    <li>Up to 100 projects</li>
                                </ul>
                            </div>
                            <div class="plan-item">
                                <strong>사용량 기반 요금:</strong>
                                <ul>
                                    <li>$0.106 / CU per hour</li>
                                    <li>$0.35 / GB-month of storage</li>
                                    <li>$0.20 / GB-month of instant restore</li>
                                </ul>
                            </div>
                            <div class="plan-item plan-warning">
                                <strong>⚠️ 참고:</strong>
                                <p>Compute 및 Storage 비용은 Neon 대시보드에서 확인하세요. 이 통계는 네트워크 전송량만 추정합니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 기본 정보 스텝 모달 -->
    <div class="basic-info-wizard-modal" id="basicInfoWizardModal">
        <div class="basic-wizard-card">
            <div class="basic-wizard-header">
                <h3>기본 정보 설정</h3>
                <button class="wizard-close-btn" onclick="closeBasicInfoWizard()">&times;</button>
            </div>
            <div class="wizard-stepper" id="basicWizardStepper">
                <div class="wizard-step-indicator" data-step-key="basic">
                    <span>1</span>
                    기본 정보
                </div>
                <div class="wizard-step-indicator" data-step-key="contact">
                    <span>2</span>
                    연락처 · 주소
                </div>
                <div class="wizard-step-indicator" data-step-key="review">
                    <span>3</span>
                    확인
                </div>
            </div>
            <div class="basic-wizard-body">
                <div class="wizard-step" data-step-key="basic">
                    <div class="form-group">
                        <label for="wizardStoreName">가게명</label>
                        <input type="text" id="wizardStoreName" class="form-input" placeholder="예: 픽업 맛집 강남점">
                    </div>
                    <div class="form-group">
                        <label for="wizardStoreSubtitle">하단 텍스트</label>
                        <input type="text" id="wizardStoreSubtitle" class="form-input" placeholder="예: 평일 11시~20시 / 주말 12시~18시">
                    </div>
                    <div class="wizard-secondary-info">
                        입력한 내용은 저장 후 즉시 가게 페이지에 반영됩니다.
                    </div>
                </div>
                <div class="wizard-step" data-step-key="contact">
                    <div class="form-group">
                        <label for="wizardStorePhone">전화번호</label>
                        <input type="text" id="wizardStorePhone" class="form-input" placeholder="예: 010-1234-5678">
                    </div>
                    <div class="form-group wizard-address-group">
                        <label>주소</label>
                        <div class="address-search-group">
                            <div class="address-row">
                                <input type="text" id="wizardPostalCode" class="form-input" placeholder="우편번호" readonly>
                                <button type="button" class="btn btn-secondary" style="padding: 10px 16px; font-size: 14px;" onclick="openWizardAddressSearch()">주소 검색</button>
                            </div>
                            <input type="text" id="wizardRoadAddress" class="form-input" placeholder="도로명 주소" readonly>
                            <input type="text" id="wizardExtraAddress" class="form-input" placeholder="참고 항목" readonly>
                            <input type="text" id="wizardAddressDetail" class="form-input" placeholder="상세 주소를 입력하세요">
                            <input type="hidden" id="wizardFullAddress">
                        </div>
                    </div>
                </div>
                <div class="wizard-step" data-step-key="review">
                    <div class="wizard-review-card">
                        <div class="wizard-review-item">
                            <span class="wizard-review-label">가게명</span>
                            <span class="wizard-review-value" id="wizardReviewStoreName">-</span>
                        </div>
                        <div class="wizard-review-item">
                            <span class="wizard-review-label">하단 텍스트</span>
                            <span class="wizard-review-value" id="wizardReviewStoreSubtitle">-</span>
                        </div>
                        <div class="wizard-review-item">
                            <span class="wizard-review-label">전화번호</span>
                            <span class="wizard-review-value" id="wizardReviewStorePhone">-</span>
                        </div>
                        <div class="wizard-review-item">
                            <span class="wizard-review-label">주소</span>
                            <span class="wizard-review-value" id="wizardReviewStoreAddress">-</span>
                        </div>
                    </div>
                    <div class="wizard-secondary-info">
                        입력 내용을 다시 확인한 뒤 저장을 누르면 즉시 적용됩니다.
                    </div>
                </div>
            </div>
            <div class="wizard-footer">
                <button type="button" class="btn btn-secondary" id="basicWizardPrevBtn" onclick="handleBasicWizardPrev()">이전</button>
                <button type="button" class="btn btn-primary" id="basicWizardNextBtn" onclick="handleBasicWizardNext()">다음</button>
                <button type="button" class="btn btn-primary" id="basicWizardSaveBtn" style="display: none;" onclick="submitBasicInfoWizard()">저장</button>
            </div>
        </div>
    </div>

    <!-- 추가 입점 신청 모달 -->
    <div class="basic-info-wizard-modal" id="ownerStoreRequestModal">
        <div class="basic-wizard-card">
            <div class="basic-wizard-header">
                <h3>추가 입점 신청</h3>
                <button class="wizard-close-btn" onclick="closeOwnerStoreRequestModal()">&times;</button>
            </div>
            <div class="basic-wizard-body" style="padding-bottom: 0;">
                <div class="form-group">
                    <label for="ownerRequestStoreName">가게명</label>
                    <input type="text" id="ownerRequestStoreName" class="form-input" placeholder="추가로 운영할 가게명을 입력하세요">
                </div>
                <div class="form-group">
                    <label for="ownerRequestSubtitle">한 줄 소개 (선택)</label>
                    <input type="text" id="ownerRequestSubtitle" class="form-input" placeholder="예: 직영 2호점, 주말 브런치 전문 등">
                </div>
                <div class="form-group">
                    <label for="ownerRequestPhone">연락처</label>
                    <input type="text" id="ownerRequestPhone" class="form-input" placeholder="예: 010-1234-5678">
                </div>
                <div class="form-group wizard-address-group">
                    <label>가게 주소</label>
                    <div class="address-search-group">
                        <div class="address-row">
                            <input type="text" id="ownerRequestPostalCode" class="form-input" placeholder="우편번호" readonly>
                            <button type="button" class="btn btn-secondary" style="padding: 10px 16px; font-size: 14px;" onclick="openOwnerRequestAddressSearch()">주소 검색</button>
                        </div>
                        <input type="text" id="ownerRequestRoadAddress" class="form-input" placeholder="도로명 주소" readonly>
                        <input type="text" id="ownerRequestExtraAddress" class="form-input" placeholder="참고 항목" readonly>
                        <input type="text" id="ownerRequestAddressDetail" class="form-input" placeholder="상세 주소를 입력하세요">
                        <input type="hidden" id="ownerRequestFullAddress">
                    </div>
                </div>
                <div class="form-group">
                    <label for="ownerRequestMemo">추가 메모 (선택)</label>
                    <textarea id="ownerRequestMemo" class="form-input" rows="3" placeholder="추가 안내 사항이나 운영 계획을 적어주세요."></textarea>
                </div>
            </div>
            <div class="wizard-footer" style="border-top: none;">
                <button type="button" class="btn btn-secondary" onclick="closeOwnerStoreRequestModal()">취소</button>
                <button type="button" class="btn btn-primary" onclick="submitOwnerStoreRequest()">입점 신청</button>
            </div>
        </div>
    </div>

<!-- 점주 연결 관리 모달 -->
<div class="modal" id="storeOwnerManageModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header owner-manage-header">
            <div>
                <h3 id="storeOwnerManageTitle">점주 연결 관리</h3>
                <p class="owner-manage-subtitle" id="storeOwnerManageSubtitle"></p>
            </div>
            <button class="modal-close" onclick="closeStoreOwnerManageModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="storeOwnerManageList" class="owner-manage-list"></div>
            <div class="form-group">
                <label for="storeOwnerAddSelect">점주 연결</label>
                <div class="owner-manage-add">
                    <select id="storeOwnerAddSelect">
                        <option value="">연결할 점주를 선택하세요</option>
                    </select>
                    <button type="button" class="btn btn-primary" id="storeOwnerAddBtn" onclick="handleStoreOwnerLink()">연결</button>
                    </div>
                <small style="color:#64748b;">점주는 한 가게에만 1차 연결됩니다. 연결 시 기존 점주가 교체될 수 있습니다.</small>
            </div>
        </div>
    </div>
</div>

    <!-- 영업시간 설정 모달 -->
    <div id="businessHoursModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>영업시간 설정</h3>
                <button onclick="closeBusinessHoursModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="business-hours-settings">
                    <!-- 24시간 영업 설정 -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151;">
                            <input type="checkbox" id="is24Hours" onchange="toggle24Hours()" style="width: 18px; height: 18px;">
                            24시간 영업
                        </label>
                    </div>
                    
                    <!-- 일괄 설정 -->
                    <div class="form-group">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 8px;">일괄 설정</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button onclick="applyToAllDays()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">모든 요일에 적용</button>
                            <button onclick="clearAllDays()" class="btn btn-outline" style="padding: 6px 12px; font-size: 13px;">모든 요일 초기화</button>
                        </div>
                    </div>
                    
                    <!-- 요일별 설정 -->
                    <div id="businessHoursContainer" style="max-height: 400px; overflow-y: auto;">
                        <!-- 월요일 -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="min-width: 60px; font-weight: 600; color: #475569;">월요일</label>
                            <input type="checkbox" id="modal_mon_enabled" onchange="updateBusinessHours()" style="width: 20px; height: 20px; cursor: pointer;">
                            <input type="time" id="modal_mon_open" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                            <span style="color: #94a3b8;">~</span>
                            <input type="time" id="modal_mon_close" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                        </div>
                        <!-- 화요일 -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="min-width: 60px; font-weight: 600; color: #475569;">화요일</label>
                            <input type="checkbox" id="modal_tue_enabled" onchange="updateBusinessHours()" style="width: 20px; height: 20px; cursor: pointer;">
                            <input type="time" id="modal_tue_open" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                            <span style="color: #94a3b8;">~</span>
                            <input type="time" id="modal_tue_close" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                        </div>
                        <!-- 수요일 -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="min-width: 60px; font-weight: 600; color: #475569;">수요일</label>
                            <input type="checkbox" id="modal_wed_enabled" onchange="updateBusinessHours()" style="width: 20px; height: 20px; cursor: pointer;">
                            <input type="time" id="modal_wed_open" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                            <span style="color: #94a3b8;">~</span>
                            <input type="time" id="modal_wed_close" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                        </div>
                        <!-- 목요일 -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="min-width: 60px; font-weight: 600; color: #475569;">목요일</label>
                            <input type="checkbox" id="modal_thu_enabled" onchange="updateBusinessHours()" style="width: 20px; height: 20px; cursor: pointer;">
                            <input type="time" id="modal_thu_open" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                            <span style="color: #94a3b8;">~</span>
                            <input type="time" id="modal_thu_close" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                        </div>
                        <!-- 금요일 -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="min-width: 60px; font-weight: 600; color: #475569;">금요일</label>
                            <input type="checkbox" id="modal_fri_enabled" onchange="updateBusinessHours()" style="width: 20px; height: 20px; cursor: pointer;">
                            <input type="time" id="modal_fri_open" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                            <span style="color: #94a3b8;">~</span>
                            <input type="time" id="modal_fri_close" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                        </div>
                        <!-- 토요일 -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="min-width: 60px; font-weight: 600; color: #475569;">토요일</label>
                            <input type="checkbox" id="modal_sat_enabled" onchange="updateBusinessHours()" style="width: 20px; height: 20px; cursor: pointer;">
                            <input type="time" id="modal_sat_open" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                            <span style="color: #94a3b8;">~</span>
                            <input type="time" id="modal_sat_close" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                        </div>
                        <!-- 일요일 -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <label style="min-width: 60px; font-weight: 600; color: #475569;">일요일</label>
                            <input type="checkbox" id="modal_sun_enabled" onchange="updateBusinessHours()" style="width: 20px; height: 20px; cursor: pointer;">
                            <input type="time" id="modal_sun_open" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                            <span style="color: #94a3b8;">~</span>
                            <input type="time" id="modal_sun_close" class="form-input" style="flex: 1;" onchange="updateBusinessHours()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeBusinessHoursModal()" class="btn btn-outline">취소</button>
                <button onclick="saveBusinessHoursFromModal()" class="btn btn-primary">저장</button>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = '/api';
        
        // 전역 가게 목록 (필터링용)
        let allStores = [];
        let filteredStores = [];
        let hasShownNoStoreGuide = false;
        
        // 프로그레스 바 제어
        const progressBar = document.getElementById('progressBar');
        let progressValue = 0;
        let progressInterval = null;
        
        function startProgress() {
            progressValue = 0;
            progressBar.style.opacity = '1';
            progressBar.style.width = '0%';
            
            // 점진적으로 증가 (최대 90%까지)
            progressInterval = setInterval(() => {
                if (progressValue < 90) {
                    progressValue += Math.random() * 10;
                    if (progressValue > 90) progressValue = 90;
                    progressBar.style.width = progressValue + '%';
                }
            }, 200);
        }
        
        function completeProgress() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            progressValue = 100;
            progressBar.style.width = '100%';
            
            // 완료 후 페이드 아웃
            setTimeout(() => {
                progressBar.style.opacity = '0';
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 300);
            }, 500);
        }

        // 세션 타임아웃 설정 (기본 2시간, 설정 가능)
        // URL 파라미터에서 타임아웃 시간을 받을 수 있음 (예: ?sessionTimeout=60 -> 60분)
        const urlParams = new URLSearchParams(window.location.search);
        const urlSessionTimeout = urlParams.get('sessionTimeout');
        let SESSION_TIMEOUT_MS = parseInt(sessionStorage.getItem('session_timeout_ms')) || (2 * 60 * 60 * 1000); // 기본 2시간
        
        // URL 파라미터에서 타임아웃 시간이 제공되면 업데이트
        if (urlSessionTimeout) {
            const timeoutMinutes = parseInt(urlSessionTimeout);
            if (timeoutMinutes > 0 && timeoutMinutes <= 1440) { // 최대 24시간
                SESSION_TIMEOUT_MS = timeoutMinutes * 60 * 1000;
                sessionStorage.setItem('session_timeout_ms', SESSION_TIMEOUT_MS.toString());
            }
        }
        
        const SESSION_EXPIRES_AT_KEY = 'session_expires_at';
        
        // 세션 만료 시간 설정 및 체크 함수
        function setSessionExpiry(timeoutMs = SESSION_TIMEOUT_MS) {
            const expiresAt = Date.now() + timeoutMs;
            sessionStorage.setItem(SESSION_EXPIRES_AT_KEY, expiresAt.toString());
            sessionStorage.setItem('session_timeout_ms', timeoutMs.toString());
        }
        
        function checkSessionExpiry() {
            const expiresAt = sessionStorage.getItem(SESSION_EXPIRES_AT_KEY);
            if (!expiresAt) {
                // 세션 만료 시간이 없으면 로그인 페이지로 리다이렉트
                clearSessionAndRedirect('세션이 만료되었습니다.');
                return false;
            }
            
            const now = Date.now();
            const expiryTime = parseInt(expiresAt);
            
            if (now > expiryTime) {
                // 세션이 만료됨
                clearSessionAndRedirect('세션이 만료되었습니다. 다시 로그인해주세요.');
                return false;
            }
            
            // 세션이 유효하면 만료 시간 갱신 (활동 시 자동 연장)
            // 단, 만료 시간이 10분 이하로 남았을 때만 갱신 (너무 자주 갱신하지 않음)
            const timeRemaining = expiryTime - now;
            const tenMinutes = 10 * 60 * 1000;
            if (timeRemaining <= tenMinutes) {
                setSessionExpiry(SESSION_TIMEOUT_MS);
            }
            return true;
        }
        
        function clearSessionAndRedirect(message = '세션이 만료되었습니다.') {
            // 모든 세션 데이터 제거
            sessionStorage.clear();
            // 로그인 페이지로 리다이렉트 (메시지 포함)
            const redirectUrl = `/login?message=${encodeURIComponent(message)}`;
            window.location.href = redirectUrl;
        }
        
        // 로그인 및 역할 확인
        const USER_ROLE = sessionStorage.getItem('user_role');
        const IS_SUPERADMIN = USER_ROLE !== 'owner' && sessionStorage.getItem('superadmin_logged_in') === 'true';
        const IS_STORE_OWNER = USER_ROLE === 'owner' && sessionStorage.getItem('owner_logged_in') === 'true';

        if (!IS_SUPERADMIN && !IS_STORE_OWNER) {
            window.location.href = '/login';
        } else {
            // 로그인된 경우 세션 만료 시간 확인
            if (!checkSessionExpiry()) {
                // 세션이 만료되었으면 이미 리다이렉트됨 (window.location.href로 이동)
                // 여기서는 아무것도 하지 않음 (페이지가 리다이렉트됨)
            } else {
                // 세션 만료 시간 설정 (처음 로드 시)
                if (!sessionStorage.getItem(SESSION_EXPIRES_AT_KEY)) {
                    setSessionExpiry(SESSION_TIMEOUT_MS);
                }
            }
        }
        
        // 주기적으로 세션 만료 체크 (1분마다)
        setInterval(() => {
            if (!checkSessionExpiry()) {
                // 세션이 만료되었으면 리다이렉트됨
            }
        }, 60 * 1000); // 1분마다 체크
        
        // 네트워크 재연결 시 세션 확인
        let wasOffline = false;
        window.addEventListener('online', () => {
            if (wasOffline) {
                wasOffline = false;
                console.log('✅ 네트워크 연결 복구됨, 세션 확인 중...');
                // 네트워크 재연결 시 세션 확인
                checkSessionWithHealthCheck();
            }
        });
        
        window.addEventListener('offline', () => {
            wasOffline = true;
            console.warn('⚠️ 네트워크 연결 끊김');
        });
        
        // 세션 확인 헬스체크 (네트워크 재연결 시)
        async function checkSessionWithHealthCheck() {
            try {
                // 간단한 헬스체크 API 호출로 세션 확인
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000) // 5초 타임아웃
                });
                
                if (!response.ok) {
                    // 헬스체크 실패 시 세션 확인
                    if (response.status === 401 || response.status === 403) {
                        clearSessionAndRedirect('세션이 만료되었습니다. 다시 로그인해주세요.');
                        return false;
                    }
                }
                
                // 헬스체크 성공 시 세션 만료 시간 갱신
                checkSessionExpiry();
                return true;
            } catch (error) {
                // 네트워크 에러는 세션 만료가 아닐 수 있으므로 무시
                console.warn('헬스체크 실패 (세션 확인 불가):', error);
                // 하지만 세션 만료 시간은 체크
                if (!checkSessionExpiry()) {
                    return false;
                }
                return true;
            }
        }
        
        // 페이지 가시성 변경 시 세션 확인 (탭 전환 후 돌아올 때)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // 페이지가 다시 보일 때 세션 확인
                checkSessionExpiry();
            }
        });

        if (IS_STORE_OWNER) {
            document.body.classList.add('owner-mode');
        }
        let ownerAccounts = [];
        let ownerSearchKeyword = ''; // 점주 계정 검색 키워드
        
        // 점주 계정 검색 함수 (debounce)
        const debouncedOwnerSearch = debounce(() => {
            const searchInput = document.getElementById('ownerSearchInput');
            if (searchInput) {
                ownerSearchKeyword = searchInput.value.trim().toLowerCase();
                renderOwnerAccounts();
            }
        }, 300);
        
        // 점주 계정 상태 상수 정의 (Single Source of Truth)
        const OWNER_STATUS = {
            PENDING: 'pending',
            ACTIVE: 'active',
            SUSPENDED: 'suspended',
            REJECTED: 'rejected',
            DELETED: 'deleted'
        };
        let ownerStatusFilter = OWNER_STATUS.PENDING; // 상수 사용
        let currentOwnerApprovalId = null;
        let currentOwnerRejectId = null;
        let dashboardScope = 'store';
        let dashboardStoreMetrics = [];
        let dashboardStoreSearchTerm = '';
        let dashboardStoreSearchTimer = null;
        let ownerManageModalState = null;
        let storeOwnerManageState = { storeId: null };
        let domainPermissionState = {
            hasSubdomain: false,
            qrLocked: false
        };
        let storeQueryState = {
            page: 1,
            pageSize: 10,
            keyword: '',
            status: '',
            createdDate: '',
            sortBy: 'createdAt',
            sortOrder: 'desc',
            ownerId: ''
        };
        let storePagination = {
            page: 1,
            pageSize: 10,
            total: 0,
            totalPages: 0
        };
        let storeViewMode = 'store';
        // 검색 함수를 debounce로 래핑
        const debouncedStoreSearch = debounce(() => {
            const value = document.getElementById('storeSearchInput')?.value.trim() || '';
            storeQueryState.keyword = value;
            storeQueryState.page = 1;
            loadStoreList();
        }, 300);
        let ownerGroupedStores = [];

        function serializeStoreForSession(store) {
            if (!store || typeof store !== 'object') {
                return null;
            }
            return {
                id: store.id || '',
                name: (store.basic?.storeName) || store.name || '',
                status: store.status || '',
                role: store.role || '',
                subdomain: store.subdomain || '',
                createdAt: store.createdAt || null,
                linkedAt: store.linkedAt || null,
                storePhone: store.basic?.storePhone || store.phone || ''
            };
        }

        function restoreOwnerStoresFromSession() {
            try {
                const raw = sessionStorage.getItem('owner_store_list');
                if (!raw) {
                    return [];
                }
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) {
                    return [];
                }
                return parsed
                    .map(entry => {
                        if (!entry || typeof entry !== 'object') {
                            return null;
                        }
                        return {
                            id: entry.id || '',
                            role: entry.role || '',
                            status: entry.status || '',
                            subdomain: entry.subdomain || '',
                            linkedAt: entry.linkedAt || null,
                            createdAt: entry.createdAt || null,
                            basic: {
                                storeName: entry.name || '',
                                storePhone: entry.storePhone || ''
                            }
                        };
                    })
                    .filter(store => store && store.id);
            } catch (error) {
                console.warn('owner_store_list 파싱 실패:', error);
                return [];
            }
        }

        function getStoreById(storeId) {
            if (!storeId) {
                return null;
            }
            return allStores.find(store => store.id === storeId)
                || filteredStores.find(store => store.id === storeId)
                || null;
        }

        function findOwnerAccount(ownerId) {
            const owner = ownerAccounts.find(item => item.id === ownerId);
            if (!owner) {
                return null;
            }
            if (owner.requestData && typeof owner.requestData === 'string') {
                try {
                    owner.requestData = JSON.parse(owner.requestData);
                } catch (error) {
                    owner.requestData = {};
                }
            }
            owner.requestData = owner.requestData || {};
            return owner;
        }
        // 가게 페이지 새로고침 알림
        function notifyStorePageRefresh() {
            // 현재 선택된 가게의 페이지 URL 생성
            const currentStoreId = getCurrentStoreId();
            if (currentStoreId) {
                showToast('설정이 저장되었습니다! 고객들이 가게 페이지에서 바로 확인할 수 있어요.', 'success', '설정 저장 완료');
            }
        }

        // 공통 가이드 메시지 생성 함수
        function createGuideMessage(icon, title, description) {
            return `
                <div class="guide-message">
                    <div class="guide-icon">${icon}</div>
                    <div class="guide-text">
                        <strong>${title}</strong><br>
                        ${description}
                    </div>
                </div>
            `;
        }

        // 토스트 알림 시스템
        function showToast(message, type = 'info', title = '', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };

            const titles = {
                success: title || '성공',
                error: title || '오류',
                warning: title || '경고',
                info: title || '알림'
            };

            toast.innerHTML = `
                <div class="toast-header">
                    <div class="toast-icon">${icons[type]}</div>
                    <div class="toast-title">${titles[type]}</div>
                    <button class="toast-close" onclick="removeToast(this.parentElement.parentElement)">&times;</button>
                </div>
                <div class="toast-message">${message}</div>
                <div class="toast-progress"></div>
            `;

            container.appendChild(toast);

            // 애니메이션을 위해 약간의 지연 후 show 클래스 추가
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // 진행 바 애니메이션
            const progressBar = toast.querySelector('.toast-progress');
            progressBar.style.width = '100%';
            progressBar.style.transitionDuration = `${duration}ms`;

            // 자동 제거
            setTimeout(() => {
                removeToast(toast);
            }, duration);
        }

        function removeToast(toast) {
            if (!toast) return;
            
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // 기존 showStatus 함수를 토스트 알림으로 대체
        function showStatus(message, type = 'info') {
            const toastType = type === 'success' ? 'success' : 
                             type === 'error' ? 'error' : 
                             type === 'warning' ? 'warning' : 'info';
            
            showToast(message, toastType);
        }

        // 세션 스토리지 캐싱 유틸리티
        (function() {
            const CACHE_PREFIX = 'pickup_cache_';
            const CACHE_TTL = 5 * 60 * 1000; // 5분

            window.sessionCache = {
                set: function(key, data) {
                    try {
                        const cacheData = {
                            data: data,
                            timestamp: Date.now()
                        };
                        sessionStorage.setItem(CACHE_PREFIX + key, JSON.stringify(cacheData));
                    } catch (error) {
                        console.warn('세션 캐시 저장 실패:', error);
                    }
                },
                get: function(key) {
                    try {
                        const cached = sessionStorage.getItem(CACHE_PREFIX + key);
                        if (!cached) return null;
                        
                        const cacheData = JSON.parse(cached);
                        const age = Date.now() - cacheData.timestamp;
                        
                        if (age > CACHE_TTL) {
                            sessionStorage.removeItem(CACHE_PREFIX + key);
                            return null;
                        }
                        
                        return cacheData.data;
                    } catch (error) {
                        console.warn('세션 캐시 읽기 실패:', error);
                        return null;
                    }
                },
                clear: function(key) {
                    try {
                        if (key) {
                            sessionStorage.removeItem(CACHE_PREFIX + key);
                        } else {
                            // 모든 캐시 삭제
                            Object.keys(sessionStorage).forEach(k => {
                                if (k.startsWith(CACHE_PREFIX)) {
                                    sessionStorage.removeItem(k);
                                }
                            });
                        }
                    } catch (error) {
                        console.warn('세션 캐시 삭제 실패:', error);
                    }
                }
            };
        })();

        // 전역 로딩 바 관리자 (로딩 모달 포함, 진행률 표시)
        (function() {
            let loadingCount = 0;
            let loadingBar = null;
            let sectionLoadingModal = null;
            let sectionLoadingText = null;
            let sectionLoadingProgressBar = null;
            let sectionLoadingPercent = null;
            let minDisplayTime = 300; // 최소 표시 시간 (ms)
            let hideTimer = null;
            let progressTimer = null;
            let currentProgress = 0;
            let isLoadingActive = false; // 로딩바가 활성화되어 있는지 여부
            let loadingTasks = []; // 현재 진행 중인 작업 목록
            let completedTasks = 0; // 완료된 작업 수
            let totalTasks = 0; // 전체 작업 수

            function initLoadingBar() {
                loadingBar = document.getElementById('globalLoadingBar');
                sectionLoadingModal = document.getElementById('sectionLoadingModal');
                sectionLoadingText = document.getElementById('sectionLoadingText');
                sectionLoadingProgressBar = document.getElementById('sectionLoadingProgressBar');
                sectionLoadingPercent = document.getElementById('sectionLoadingPercent');
                if (!loadingBar) {
                    console.warn('전역 로딩 바 요소를 찾을 수 없습니다.');
                }
            }

            function updateProgress(percent) {
                currentProgress = Math.min(100, Math.max(0, percent));
                if (sectionLoadingProgressBar) {
                    sectionLoadingProgressBar.style.width = currentProgress + '%';
                }
                if (sectionLoadingPercent) {
                    sectionLoadingPercent.textContent = Math.round(currentProgress) + '%';
                }
            }

            function updateLoadingText(text) {
                if (sectionLoadingText) {
                    sectionLoadingText.textContent = text;
                }
            }

            function calculateProgress() {
                // 완료된 작업 수에 따라 진행률 계산
                if (totalTasks > 0) {
                    const baseProgress = (completedTasks / totalTasks) * 90; // 최대 90%까지
                    // 각 작업 내에서도 진행률 시뮬레이션
                    const taskProgress = 10 / totalTasks; // 나머지 10%는 시뮬레이션
                    updateProgress(baseProgress + taskProgress);
                } else {
                    // 작업 수가 없으면 시뮬레이션으로 진행
                    if (currentProgress < 90) {
                        const increment = Math.random() * 3 + 1; // 1-4%씩 증가
                        updateProgress(Math.min(90, currentProgress + increment));
                    }
                }
            }

            function animateProgress() {
                if (isLoadingActive) {
                    calculateProgress();
                    progressTimer = setTimeout(animateProgress, 150);
                }
            }

            function showLoadingBar(type = 'default', showModal = false, modalText = '데이터를 불러오는 중...') {
                if (!loadingBar) initLoadingBar();
                if (!loadingBar) return;

                loadingCount++;
                
                // 최소 표시 시간 타이머 초기화
                if (hideTimer) {
                    clearTimeout(hideTimer);
                    hideTimer = null;
                }

                // 타입에 따라 클래스 설정
                loadingBar.className = 'global-loading-bar active';
                if (type === 'error') {
                    loadingBar.classList.add('error');
                } else if (type === 'success') {
                    loadingBar.classList.add('success');
                }

                // 섹션 로딩 모달 표시 (큰 로딩 인디케이터)
                if (showModal && sectionLoadingModal) {
                    // 첫 번째 요청일 때만 모달 표시 및 진행률 초기화
                    if (!isLoadingActive) {
                        isLoadingActive = true;
                        currentProgress = 0;
                        completedTasks = 0;
                        totalTasks = 0;
                        loadingTasks = [];
                        updateProgress(0);
                        updateLoadingText(modalText);
                        sectionLoadingModal.classList.add('active');
                        // 진행률 애니메이션 시작
                        if (progressTimer) {
                            clearTimeout(progressTimer);
                        }
                        animateProgress();
                    } else {
                        // 이미 로딩 중이면 텍스트만 업데이트
                        updateLoadingText(modalText);
                    }
                }
            }

            function hideLoadingBar(force = false) {
                if (!loadingBar) initLoadingBar();
                if (!loadingBar) return;

                loadingCount = Math.max(0, loadingCount - 1);

                if (loadingCount === 0) {
                    // 진행률 애니메이션 중지
                    if (progressTimer) {
                        clearTimeout(progressTimer);
                        progressTimer = null;
                    }
                    // 진행률을 100%로 설정
                    updateProgress(100);
                    isLoadingActive = false;
                    completedTasks = 0;
                    totalTasks = 0;
                    loadingTasks = [];
                    
                    const hide = () => {
                        loadingBar.classList.remove('active', 'error', 'success');
                        // 섹션 로딩 모달도 숨김
                        if (sectionLoadingModal) {
                            sectionLoadingModal.classList.remove('active');
                        }
                        // 진행률 초기화
                        currentProgress = 0;
                        updateProgress(0);
                    };

                    if (force || minDisplayTime === 0) {
                        hide();
                    } else {
                        // 최소 표시 시간 보장
                        hideTimer = setTimeout(hide, minDisplayTime);
                    }
                }
            }

            // 전역 함수로 노출 (모달 표시 옵션 추가)
            window.showGlobalLoading = function(type = 'default', showModal = true, modalText = '데이터를 불러오는 중...') {
                showLoadingBar(type, showModal, modalText);
            };
            window.hideGlobalLoading = hideLoadingBar;
            window.setLoadingBarType = function(type) {
                if (!loadingBar) initLoadingBar();
                if (!loadingBar) return;
                
                loadingBar.classList.remove('error', 'success');
                if (type === 'error' || type === 'success') {
                    loadingBar.classList.add(type);
                }
            };
            window.setLoadingProgress = function(percent) {
                updateProgress(percent);
            };
            window.setLoadingText = function(text) {
                updateLoadingText(text);
            };
            window.setLoadingTasks = function(total, completed = 0) {
                totalTasks = total;
                completedTasks = completed;
            };
            window.completeLoadingTask = function() {
                completedTasks = Math.min(totalTasks, completedTasks + 1);
            };

            // 초기화
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLoadingBar);
            } else {
                initLoadingBar();
            }
        })();

        // API 요청 함수 (타임아웃 및 재시도 포함, 로딩 바 통합)
        async function apiRequest(url, method = 'GET', data = null, retries = 3, showLoading = true, customHeaders = {}, timeoutMs = 10000) {
            // 로딩 바는 섹션 레벨에서 관리하므로 여기서는 표시하지 않음
            // showLoading 파라미터는 유지하되 실제로는 사용하지 않음
            // timeoutMs: 타임아웃 시간 (밀리초), 기본값 10초

            try {
            for (let attempt = 1; attempt <= retries; attempt++) {
                    let controller = null;
                    let timeoutId = null;
                    
                try {
                        controller = new AbortController();
                        timeoutId = setTimeout(() => controller.abort(), timeoutMs); // 동적 타임아웃
                    
                    const options = {
                        method: method,
                        headers: {
                                'Content-Type': 'application/json',
                                ...customHeaders
                        },
                        signal: controller.signal
                    };
                    
                    if (data) {
                        options.body = JSON.stringify(data);
                    }
                    
                    const response = await fetch(url, options);
                        
                        // 타임아웃 정리
                        if (timeoutId) {
                    clearTimeout(timeoutId);
                            timeoutId = null;
                        }
                    
                    const rawText = await response.text();
                    let payload = null;
                    
                    if (rawText) {
                        try {
                            payload = JSON.parse(rawText);
                        } catch (error) {
                            payload = rawText;
                        }
                    }
                    
                    if (!response.ok) {
                        // 401, 403 에러는 세션 만료로 간주
                        if (response.status === 401 || response.status === 403) {
                            clearSessionAndRedirect('세션이 만료되었습니다. 다시 로그인해주세요.');
                            throw new Error('세션이 만료되었습니다.');
                        }
                        
                        const serverMessage = typeof payload === 'object'
                            ? payload?.error?.message || payload?.message || payload?.error
                            : null;
                        const fallbackMessage = `요청 처리 중 오류가 발생했습니다. (HTTP ${response.status})`;
                        throw new Error(serverMessage || fallbackMessage);
                    }
                    
                    // API 요청 성공 시 세션 만료 시간 갱신 (활동 시 자동 연장)
                    checkSessionExpiry();
                        
                        // 로딩 바는 섹션 레벨에서 관리하므로 여기서는 숨기지 않음
                    
                    return payload ?? {};
                } catch (error) {
                        // 타임아웃 정리
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                            timeoutId = null;
                        }
                        
                        // AbortError는 요청 취소로 인한 에러이므로 재시도하지 않음
                        if (error.name === 'AbortError' || error.name === 'AbortedError') {
                            // 타임아웃으로 인한 취소인 경우
                            if (attempt === retries) {
                                console.warn('API 요청이 타임아웃되었습니다:', url);
                                // 타임아웃이 발생하면 세션 만료로 간주하고 로그인 페이지로 리다이렉트
                                clearSessionAndRedirect('요청 시간이 초과되었습니다. 다시 로그인해주세요.');
                                throw new Error('요청 시간이 초과되었습니다. 다시 로그인해주세요.');
                            }
                            // 중간 시도에서 취소된 경우 (의도적인 취소일 수 있음)
                            console.debug(`API 요청 취소됨 (시도 ${attempt}/${retries}):`, url);
                            continue;
                        }
                        
                        // 네트워크 에러 (TypeError: Failed to fetch 등)
                        if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            // 네트워크 연결 실패 - 세션 만료가 아닐 수 있으므로 재시도
                            if (attempt === retries) {
                                console.error('네트워크 연결 실패:', error);
                                // 마지막 시도에서도 실패하면 네트워크 문제로 간주
                                throw new Error('네트워크 연결에 실패했습니다. 연결 상태를 확인해주세요.');
                            }
                            continue;
                        }
                        
                        // 일반 에러는 로그 출력 및 재시도
                    console.error(`API 요청 실패 (시도 ${attempt}/${retries}):`, error);
                    
                    if (attempt === retries) {
                            // 최종 실패 시 로딩 바는 섹션 레벨에서 관리하므로 여기서는 숨기지 않음
                        throw error;
                    }
                    
                    // 재시도 전 잠시 대기
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
                }
            } catch (error) {
                // 예외 발생 시 로딩 바는 섹션 레벨에서 관리하므로 여기서는 숨기지 않음
                throw error;
            }
        }

        // Debounce 유틸리티 함수
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle 유틸리티 함수
        function throttle(func, limit) {
            let inThrottle;
            return function executedFunction(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // 이미지 Lazy Loading 구현
        (function() {
            const imageObserverOptions = {
                root: null,
                rootMargin: '50px',
                threshold: 0.01
            };

            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.getAttribute('data-src');
                        
                        if (src) {
                            img.src = src;
                            img.removeAttribute('data-src');
                            img.classList.remove('lazy');
                            img.classList.add('loaded');
                            observer.unobserve(img);
                        }
                    }
                });
            }, imageObserverOptions);

            // Lazy loading 초기화 함수
            window.initLazyLoading = function() {
                const lazyImages = document.querySelectorAll('img[data-src]');
                lazyImages.forEach(img => {
                    imageObserver.observe(img);
                });
            };

            // 페이지 로드 시 자동 초기화
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', window.initLazyLoading);
            } else {
                window.initLazyLoading();
            }

            // 동적으로 추가된 이미지도 관찰
            const originalAppendChild = Node.prototype.appendChild;
            Node.prototype.appendChild = function(child) {
                const result = originalAppendChild.call(this, child);
                if (child.tagName === 'IMG' && child.hasAttribute('data-src')) {
                    imageObserver.observe(child);
                }
                return result;
            };
        })();

        // 현재 가게 ID 가져오기 (세션/로컬스토리지만 확인, API 호출 없음)
        function getCurrentStoreId() {
            try {
                // 1순위: window.currentStoreId (현재 세션)
                if (window.currentStoreId) {
                    return window.currentStoreId;
                }

                // 2순위: sessionStorage (세션 저장)
                const sessionStoreId = sessionStorage.getItem('currentStoreId');
                if (sessionStoreId) {
                    return sessionStoreId;
                }

                // 3순위: localStorage에 저장된 선택 가게 (새로고침 후 복원용)
                const savedStoreId = localStorage.getItem('currentStoreId');
                if (savedStoreId) {
                    return savedStoreId;
                }

                // 4순위: 점주 모드의 경우 sessionStorage의 owner_store_id
                if (IS_STORE_OWNER) {
                    const ownerStoreId = sessionStorage.getItem('owner_store_id');
                    if (ownerStoreId) {
                        return ownerStoreId;
                    }
                }

                return null;
            } catch (error) {
                console.error('현재 가게 ID 조회 실패:', error);
                return null;
            }
        }

        // 가게 목록 로드
        // 통계 업데이트
        // 통계 카드 재계산 함수 (불변 조건: 항상 allStores만 사용)
        function recalculateStoreStatsFrom(storesArray) {
            if (!Array.isArray(storesArray)) {
                console.warn('⚠️ [통계] storesArray가 배열이 아닙니다:', storesArray);
                storesArray = [];
            }

            const total = storesArray.length;
            const active = storesArray.filter(s => (s.status || '').toLowerCase() === 'active').length;
            const paused = storesArray.filter(s => (s.status || '').toLowerCase() === 'paused').length;
            const pending = storesArray.filter(s => (s.status || '').toLowerCase() === 'pending').length;
            const today = new Date().toISOString().split('T')[0];
            const todayStores = storesArray.filter(s => {
                if (!s.createdAt) return false;
                const createdDate = new Date(s.createdAt).toISOString().split('T')[0];
                return createdDate === today;
            }).length;

            // DOM 업데이트
            const totalEl = document.getElementById('totalStoresCount');
            const activeEl = document.getElementById('activeStoresCount');
            const pausedEl = document.getElementById('pausedStoresCount');
            const pendingEl = document.getElementById('pendingStoresCount');
            const todayEl = document.getElementById('todayStoresCount');

            if (totalEl) totalEl.textContent = total;
            if (activeEl) activeEl.textContent = active;
            if (pausedEl) pausedEl.textContent = paused;
            if (pendingEl) pendingEl.textContent = pending;
            if (todayEl) todayEl.textContent = todayStores;

            // 개발용 체크 (불변 조건 검증)
            if (typeof console !== 'undefined' && console.assert) {
                const totalCard = totalEl ? parseInt(totalEl.textContent) || 0 : 0;
                console.assert(totalCard === storesArray.length, 
                    `❌ [통계 불변 조건 위반] 전체 가게 카드(${totalCard})와 storesArray 길이(${storesArray.length})가 다릅니다`);
                console.assert(active <= total, 
                    `❌ [통계 불변 조건 위반] 활성 가게 수(${active})가 전체 가게 수(${total})를 초과합니다`);
                console.assert(paused <= total, 
                    `❌ [통계 불변 조건 위반] 일시정지 가게 수(${paused})가 전체 가게 수(${total})를 초과합니다`);
                console.assert(pending <= total, 
                    `❌ [통계 불변 조건 위반] 승인 대기 가게 수(${pending})가 전체 가게 수(${total})를 초과합니다`);
            }

            console.log('✅ [통계 재계산]', {
                total,
                active,
                paused,
                pending,
                todayStores,
                allStoresLength: allStores.length
            });
        }

        // 하위 호환성을 위한 별칭 (기존 코드에서 사용 중인 경우)
        function updateStoreStats(summary = null) {
            // summary 파라미터는 더 이상 사용하지 않음 (불변 조건 위반)
            console.warn('⚠️ [통계] updateStoreStats는 deprecated입니다. recalculateStoreStatsFrom(allStores)를 사용하세요.');
            recalculateStoreStatsFrom(allStores);
        }

        // 가게 목록 API 응답을 배열 형태로 변환하는 헬퍼
        function normalizeStoreListResponse(response) {
            if (Array.isArray(response)) {
                return response;
            }
            if (response && typeof response === 'object') {
                if (Array.isArray(response.data)) {
                    return response.data;
                }
                if (Array.isArray(response.stores)) {
                    return response.stores;
                }
            }
            return [];
        }

        // 단일 가게 API 응답에서 가게 객체를 추출하는 헬퍼
        function normalizeStoreDetailResponse(response, storeId = null) {
            if (!response) {
                return null;
            }
            if (storeId) {
                const list = normalizeStoreListResponse(response);
                if (list.length > 0) {
                    return list.find(store => store.id === storeId) || null;
                }
            }
            if (typeof response === 'object' && response.id) {
                return response;
            }
            if (response && typeof response === 'object' && response.data && response.data.id) {
                return response.data;
            }
            return null;
        }

        async function reloadOwnerAccounts() {
            if (!IS_SUPERADMIN) return;
            // 현재 선택된 탭 상태로 다시 로드
            await loadOwnerAccounts(ownerStatusFilter);
        }

        async function loadOwnerAccounts(statusFilter = null) {
            try {
                // statusFilter가 없으면 현재 선택된 탭의 상태 사용
                const statusToLoad = statusFilter || ownerStatusFilter;
                
                // API 요청 URL 구성 (status 파라미터 명시적 전달)
                const url = statusToLoad && statusToLoad !== ''
                    ? `${API_BASE}/owners?status=${encodeURIComponent(statusToLoad)}`
                    : `${API_BASE}/owners`;
                
                console.log('🔍 [점주 계정 관리] API 요청:', url);
                
                const response = await apiRequest(url, 'GET');
                const receivedAccounts = response?.data || response || [];
                
                console.log(`✅ [점주 계정 관리] API 응답: ${receivedAccounts.length}개 계정 수신`, {
                    requestedStatus: statusToLoad,
                    receivedCount: receivedAccounts.length,
                    receivedStatuses: receivedAccounts.map(o => o.status),
                    // 재발 방지: 각 계정의 상세 정보 로그
                    accounts: receivedAccounts.map(o => ({
                        id: o.id,
                        email: o.email,
                        status: o.status,
                        statusType: typeof o.status,
                        statusLength: o.status ? o.status.length : 0
                    }))
                });
                
                // 재발 방지: status 값 불일치 상세 분석
                if (statusToLoad && statusToLoad !== '') {
                    const statusMismatch = receivedAccounts.filter(o => {
                        const ownerStatus = (o.status || '').toString().trim().toLowerCase();
                        const expectedStatus = statusToLoad.toString().trim().toLowerCase();
                        return ownerStatus !== expectedStatus;
                    });
                    
                    if (statusMismatch.length > 0) {
                        console.error('❌ [점주 계정 관리] 상태 불일치 상세:', {
                            requestedStatus: statusToLoad,
                            requestedStatusType: typeof statusToLoad,
                            requestedStatusLength: statusToLoad.length,
                            mismatchedAccounts: statusMismatch.map(o => ({
                                id: o.id,
                                email: o.email,
                                actualStatus: o.status,
                                actualStatusType: typeof o.status,
                                actualStatusLength: o.status ? o.status.length : 0,
                                comparison: {
                                    actual: (o.status || '').toString().trim().toLowerCase(),
                                    expected: statusToLoad.toString().trim().toLowerCase(),
                                    exactMatch: o.status === statusToLoad,
                                    caseInsensitiveMatch: (o.status || '').toString().trim().toLowerCase() === statusToLoad.toString().trim().toLowerCase()
                                }
                            }))
                        });
                    }
                }
                
                // 재발 방지: API 응답 데이터 검증
                if (statusToLoad && statusToLoad !== '') {
                    const mismatched = receivedAccounts.filter(o => o.status !== statusToLoad);
                    if (mismatched.length > 0) {
                        console.error('❌ [점주 계정 관리] 상태 불일치 발견:', {
                            requestedStatus: statusToLoad,
                            mismatchedCount: mismatched.length,
                            mismatched: mismatched.map(o => ({ id: o.id, email: o.email, status: o.status }))
                        });
                    }
                }
                
                ownerAccounts = receivedAccounts;
                renderOwnerAccounts();
                
                // 재발 방지: 렌더링 후 검증
                const container = document.getElementById('ownerList');
                if (container) {
                    const renderedCount = container.querySelectorAll('.owner-card').length;
                    if (receivedAccounts.length > 0 && renderedCount === 0) {
                        console.error('❌ [점주 계정 관리] 렌더링 불일치:', {
                            apiCount: receivedAccounts.length,
                            renderedCount: renderedCount,
                            statusFilter: statusToLoad
                        });
                    }
                }
            } catch (error) {
                console.error('점주 계정 목록 로드 실패:', error);
                const container = document.getElementById('ownerList');
                if (container) {
                    container.innerHTML = '<div class="owner-empty">계정 정보를 가져오는 데 실패했습니다. 잠시 후 다시 시도해주세요.</div>';
                }
            }
        }

        function setupOwnerTabs() {
            const tabs = document.querySelectorAll('.owner-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', async () => {
                    const status = tab.getAttribute('data-status');
                    // 상태 검증 (상수 사용)
                    const validStatuses = [OWNER_STATUS.PENDING, OWNER_STATUS.ACTIVE, OWNER_STATUS.SUSPENDED, OWNER_STATUS.REJECTED];
                    if (validStatuses.includes(status)) {
                    ownerStatusFilter = status;
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                        
                        // 탭 클릭 시 해당 상태로 API 재요청 (서버 사이드 필터링)
                        console.log(`🔄 [점주 계정 관리] 탭 변경: ${status}`);
                        await loadOwnerAccounts(status);
                    } else {
                        console.warn('⚠️ [점주 계정 관리] 유효하지 않은 상태 필터:', status);
                    }
                });
            });
        }

        function renderOwnerAccounts() {
            const container = document.getElementById('ownerList');
            if (!container) return;

            // 상태 필터링
            let filtered = ownerAccounts.filter(owner => {
                const matches = owner.status === ownerStatusFilter;
                if (!matches && ownerAccounts.length > 0) {
                    console.warn('⚠️ [점주 계정 관리] 상태 불일치 계정 발견:', {
                        ownerId: owner.id,
                        ownerEmail: owner.email,
                        ownerStatus: owner.status,
                        expectedStatus: ownerStatusFilter
                    });
                }
                return matches;
            });
            
            // 검색 필터링 (가게명, 점주명, 전화번호, 주소)
            if (ownerSearchKeyword) {
                filtered = filtered.filter(owner => {
                    const ownerName = (owner.ownerName || '').toLowerCase();
                    const email = (owner.email || '').toLowerCase();
                    const phone = (owner.phone || '').toLowerCase();
                    const storeName = (owner.requestData?.storeName || owner.storeName || '').toLowerCase();
                    const address = (owner.requestData?.storeAddress || owner.storeAddress || '').toLowerCase();
                    
                    return ownerName.includes(ownerSearchKeyword) ||
                           email.includes(ownerSearchKeyword) ||
                           phone.includes(ownerSearchKeyword) ||
                           storeName.includes(ownerSearchKeyword) ||
                           address.includes(ownerSearchKeyword);
                });
            }
            
            // 재발 방지: 디버그 로그
            console.log(`🎨 [점주 계정 관리] 렌더링:`, {
                totalAccounts: ownerAccounts.length,
                filterStatus: ownerStatusFilter,
                filterStatusType: typeof ownerStatusFilter,
                filteredCount: filtered.length,
                accountStatuses: ownerAccounts.map(o => o.status),
                // 재발 방지: 각 계정의 status와 필터 비교
                statusComparison: ownerAccounts.map(o => ({
                    id: o.id,
                    email: o.email,
                    ownerStatus: o.status,
                    filterStatus: ownerStatusFilter,
                    matches: o.status === ownerStatusFilter,
                    caseInsensitiveMatch: (o.status || '').toString().trim().toLowerCase() === (ownerStatusFilter || '').toString().trim().toLowerCase()
                }))
            });

            if (filtered.length === 0) {
                // 상태별 안내 메시지 (상수 사용)
                let guideText = '계정이 없습니다.';
                if (ownerSearchKeyword) {
                    guideText = `검색 결과가 없습니다. (검색어: "${ownerSearchKeyword}")`;
                } else if (ownerStatusFilter === OWNER_STATUS.PENDING) {
                    guideText = '새로운 입점 요청이 도착하면 이곳에서 확인할 수 있습니다.';
                } else if (ownerStatusFilter === OWNER_STATUS.ACTIVE) {
                    guideText = '운영 중인 가게 사장님 계정이 없습니다.';
                } else if (ownerStatusFilter === OWNER_STATUS.SUSPENDED) {
                    guideText = '일시 중지된 계정이 없습니다.';
                } else if (ownerStatusFilter === OWNER_STATUS.REJECTED) {
                    guideText = '거절된 요청이 없습니다.';
                }
                container.innerHTML = `<div class="owner-empty">${guideText}</div>`;
                return;
            }

            // 테이블 형태로 렌더링
            const tableHtml = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">점주명</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">이메일</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">연락처</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">가게명</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">주소</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">상태</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">요청일</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(owner => {
                if (owner.requestData && typeof owner.requestData === 'string') {
                    try {
                        owner.requestData = JSON.parse(owner.requestData);
                    } catch (error) {
                        owner.requestData = {};
                    }
                }
                owner.requestData = owner.requestData || {};

                const createdAt = owner.createdAt ? new Date(owner.createdAt).toLocaleString('ko-KR') : '-';
                const approvedAt = owner.approvedAt ? new Date(owner.approvedAt).toLocaleString('ko-KR') : null;
                const lastLogin = owner.lastLogin ? new Date(owner.lastLogin).toLocaleString('ko-KR') : null;
                const displayStoreName = owner.requestData?.storeName || owner.storeName || '';
                const storeLabelTitle = owner.status === OWNER_STATUS.ACTIVE ? '운영 가게' : '요청 가게';
                const storeLabel = displayStoreName
                    ? `${escapeHtml(displayStoreName)}`
                    : '<span style="color:#9ca3af;">가게 정보 없음</span>';
                
                // 상태 라벨 매핑 (상수 사용)
                let statusLabel = '알 수 없음';
                if (owner.status === OWNER_STATUS.PENDING) {
                    statusLabel = '승인 대기';
                } else if (owner.status === OWNER_STATUS.ACTIVE) {
                    statusLabel = '운영 중';
                } else if (owner.status === OWNER_STATUS.SUSPENDED) {
                    statusLabel = '일시 중지';
                } else if (owner.status === OWNER_STATUS.REJECTED) {
                    statusLabel = '거절됨';
                }
                
                const statusBadge = `<span class="owner-badge ${owner.status}">${statusLabel}</span>`;
                
                // 연결된 가게 수 표시
                const stores = Array.isArray(owner.stores) ? owner.stores : [];
                const activeStores = stores.filter(s => s.status === 'active').length;
                const pausedStores = stores.filter(s => s.status === 'paused').length;
                const pendingStores = stores.filter(s => s.status === 'pending').length;
                const storesInfo = stores.length > 0 
                    ? `<div style="margin-top:8px; font-size:12px; color:#64748b;">
                        연결된 가게: 총 ${stores.length}개
                        ${activeStores > 0 ? ` (운영 중 ${activeStores}개)` : ''}
                        ${pausedStores > 0 ? ` (일시정지 ${pausedStores}개)` : ''}
                        ${pendingStores > 0 ? ` (승인 대기 ${pendingStores}개)` : ''}
                       </div>`
                    : '';
                const safeEmail = escapeForAttribute(owner.email || '');
                const safeStoreName = escapeForAttribute(owner.requestData?.storeName || owner.storeName || '');
                const passwordSourceAttr = escapeForAttribute(owner.passwordSource || 'request');

                const requestSummary = owner.requestData ? Object.entries(owner.requestData)
                    .map(([key, value]) => {
                        const label = key === 'storeName' ? '가게명'
                            : key === 'storeAddress' ? '주소'
                            : key === 'rejectReason' ? '거절 사유'
                            : key;
                        return `${escapeHtml(label)}: ${escapeHtml(String(value || ''))}`;
                    })
                    .join('<br>') : '';
                const requestMessageHtml = owner.requestMessage
                    ? escapeHtml(owner.requestMessage).replace(/\n/g, '<br>')
                    : '';

                let actionButtons = '';
                // 상태별 버튼 표시 (상수 사용)
                if (owner.status === OWNER_STATUS.PENDING) {
                    actionButtons = `
                        <button class="btn-approve" onclick="openOwnerApprovalModal('${owner.id}')">승인</button>
                        <button class="btn-reject" onclick="openOwnerRejectModal('${owner.id}')">거절</button>
                        <button class="btn-danger" onclick="openOwnerDeleteModal('${owner.id}')">삭제</button>
                    `;
                } else if (owner.status === OWNER_STATUS.ACTIVE) {
                    actionButtons = `
                        <button class="btn-copy" onclick="copyOwnerGuide('${safeEmail}', '${safeStoreName}', '${passwordSourceAttr}')">안내 복사</button>
                        <button class="btn-secondary" onclick="openOwnerPauseModal('${owner.id}')">운영 중지</button>
                        <button class="btn-danger" onclick="openOwnerDeleteModal('${owner.id}')">삭제</button>
                    `;
                } else if (owner.status === OWNER_STATUS.SUSPENDED) {
                    actionButtons = `
                        <button class="btn-approve" onclick="openOwnerResumeModal('${owner.id}')">운영 재개</button>
                        <button class="btn-danger" onclick="openOwnerDeleteModal('${owner.id}')">삭제</button>
                    `;
                } else if (owner.status === OWNER_STATUS.REJECTED) {
                    actionButtons = `
                        <button class="btn-danger" onclick="openOwnerDeleteModal('${owner.id}')">삭제</button>
                    `;
                }

                const displayAddress = (owner.requestData?.storeAddress || owner.storeAddress || '-').substring(0, 50) + ((owner.requestData?.storeAddress || owner.storeAddress || '').length > 50 ? '...' : '');

                return `
                    <tr style="border-bottom: 1px solid #f1f5f9; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='white'">
                        <td style="padding: 12px; color: #1f2937; font-weight: 500;">${escapeHtml(owner.ownerName || owner.email || '-')}</td>
                        <td style="padding: 12px; color: #4b5563; font-size: 13px;">${escapeHtml(owner.email || '-')}</td>
                        <td style="padding: 12px; color: #4b5563; font-size: 13px;">${escapeHtml(owner.phone || '-')}</td>
                        <td style="padding: 12px; color: #4b5563; font-size: 13px;">${escapeHtml(displayStoreName || '-')}</td>
                        <td style="padding: 12px; color: #4b5563; font-size: 13px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(owner.requestData?.storeAddress || owner.storeAddress || '')}">${escapeHtml(displayAddress)}</td>
                        <td style="padding: 12px;">${statusBadge}</td>
                        <td style="padding: 12px; color: #64748b; font-size: 13px; white-space: nowrap;">${escapeHtml(createdAt)}</td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                ${actionButtons.replace(/class="btn-/g, 'style="padding: 6px 12px; border-radius: 6px; border: none; font-size: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s;" class="btn-').replace(/onclick="/g, 'onclick="event.stopPropagation(); ')}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('')}
                        </tbody>
                    </table>
                            </div>
                <div style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; color: #64748b; font-size: 13px;">
                    총 ${filtered.length}개 계정 (${ownerAccounts.length}개 중)
                            </div>
                `;

            container.innerHTML = tableHtml;
        }

        function openOwnerApprovalModal(ownerId) {
            const owner = ownerAccounts.find(item => item.id === ownerId);
            if (!owner) return;

            currentOwnerApprovalId = ownerId;
            const modal = document.getElementById('ownerApprovalModal');
            const infoEl = document.getElementById('ownerModalInfo');
            const storeInfoEl = document.getElementById('ownerModalStoreInfo');
            const resultEl = document.getElementById('ownerModalResult');
            const submitBtn = document.getElementById('ownerModalSubmitBtn');

            if (!modal || !infoEl || !storeInfoEl) return;

            infoEl.innerHTML = `
                <p><strong>${owner.ownerName || owner.email}</strong> (${owner.email})</p>
                <p style="margin-top:6px;">연락처: ${owner.phone || '-'}<br>요청일: ${owner.createdAt ? new Date(owner.createdAt).toLocaleString('ko-KR') : '-'}</p>
            `;

            const requestedStoreName = owner.requestData?.storeName || owner.storeName || '';
            const requestedStoreAddress = owner.requestData?.storeAddress || owner.storeAddress || '';
            const infoLines = [];

            if (requestedStoreName) {
                infoLines.push(`<p><strong>가게명</strong>${escapeHtml(requestedStoreName)}</p>`);
            }
            if (requestedStoreAddress) {
                infoLines.push(`<p><strong>주소</strong>${escapeHtml(requestedStoreAddress)}</p>`);
            }

            const guideMessage = owner.storeId
                ? '요청 시 생성된 가게가 연결되어 있습니다. 승인 시 활성화됩니다.'
                : '승인 시 위 정보로 가게가 자동 생성되어 연결됩니다.';

            storeInfoEl.innerHTML = `
                <div style="font-weight:600; margin-bottom:10px;">가게 연결 안내</div>
                ${infoLines.join('') || '<p>가게 정보가 없습니다. 승인 전 요청 내용을 다시 확인해주세요.</p>'}
                <p style="margin-top:8px; color:#2563eb; font-weight:500;">${guideMessage}</p>
            `;

            resultEl.style.display = 'none';
            resultEl.textContent = '';
            submitBtn.disabled = false;
            submitBtn.textContent = '승인하기';
            submitBtn.setAttribute('data-mode', 'approve');

            modal.classList.add('active');
        }

        function closeOwnerModal() {
            const modal = document.getElementById('ownerApprovalModal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentOwnerApprovalId = null;
        }
        function handleOwnerModalSubmit() {
            const submitBtn = document.getElementById('ownerModalSubmitBtn');
            if (!submitBtn) return;
            const mode = submitBtn.getAttribute('data-mode') || 'approve';
            if (mode === 'approve') {
                submitOwnerApproval();
            } else if (mode === 'close') {
                closeOwnerModal();
            }
        }
        async function submitOwnerApproval() {
            if (!currentOwnerApprovalId) return;

            const resultEl = document.getElementById('ownerModalResult');
            const submitBtn = document.getElementById('ownerModalSubmitBtn');

            // 중복 클릭 방지
            if (submitBtn.disabled) {
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '승인 중...';

            try {
                // 슈퍼어드민 권한 헤더 추가
                const headers = {};
                if (IS_SUPERADMIN) {
                    headers['X-Superadmin-Auth'] = 'true';
                }
                
                // 점주 승인은 DB 트랜잭션 작업이므로 충분한 타임아웃 필요 (30초)
                const response = await apiRequest(`${API_BASE}/owners/${currentOwnerApprovalId}/approve`, 'POST', {}, 3, false, headers, 30000);
                const owner = ownerAccounts.find(item => item.id === currentOwnerApprovalId);
                if (owner) {
                    owner.status = OWNER_STATUS.ACTIVE; // 상수 사용
                    owner.storeId = response.store?.id || owner.storeId;
                    owner.approvedAt = response.owner?.approved_at || new Date().toISOString();
                    owner.storeName = response.store?.name || owner.requestData?.storeName || owner.storeName || '';
                }
                // 즉시 UI 업데이트: 승인된 계정은 '운영 중' 탭으로 이동
                ownerStatusFilter = OWNER_STATUS.ACTIVE;
                const activeTab = document.querySelector(`.owner-tab[data-status="${OWNER_STATUS.ACTIVE}"]`);
                const tabs = document.querySelectorAll('.owner-tab');
                if (activeTab) {
                    tabs.forEach(t => t.classList.remove('active'));
                    activeTab.classList.add('active');
                }
                
                // 가게 목록 즉시 업데이트 (승인된 점주와 연결된 가게 상태 변경 반영)
                const storesSection = document.getElementById('stores');
                if (storesSection && storesSection.style.display !== 'none') {
                    // 모든 가게 관련 캐시 무효화
                    const cacheKeys = ['stores_list', 'dashboard_all_stores'];
                    if (window.sessionCache) {
                        cacheKeys.forEach(key => window.sessionCache.clear(key));
                    }
                    
                    // Incremental update: 승인된 점주와 연결된 가게만 업데이트
                    const approvedStoreId = response.store?.id || owner.storeId;
                    if (approvedStoreId) {
                        setTimeout(async () => {
                            try {
                                await incrementalUpdateStoreList([approvedStoreId]);
                            } catch (err) {
                                console.error('가게 목록 incremental update 실패:', err);
                                // 실패 시 전체 목록 다시 로드
                                await loadStoreList();
                            }
                        }, 300); // 약간의 지연을 두어 DB 트랜잭션이 완료된 후 로드
                    } else {
                        // 가게 ID가 없으면 전체 목록 다시 로드
                        setTimeout(() => {
                            loadStoreList().catch(err => console.error('가게 목록 새로고침 실패:', err));
                        }, 500);
                    }
                }
                
                // 점주 목록 즉시 업데이트
                await loadOwnerAccounts(OWNER_STATUS.ACTIVE);

                const passwordSource = response.passwordSource || 'generated';
                const tempPassword = response.tempPassword;
                resultEl.style.display = 'block';
                const safeEmail = escapeHtml(response.owner?.email || '-');
                const safeEmailAttr = escapeForAttribute(response.owner?.email || '');
                const safePasswordAttr = escapeForAttribute(tempPassword || '');
                const displayStoreName = escapeHtml(response.store?.name || owner?.requestData?.storeName || owner?.storeName || '연결된 가게');
                const displayStoreAddress = response.store?.address ? `<br>가게 주소: ${escapeHtml(response.store.address)}` : '';
                let passwordInfoHtml = '';

                if (passwordSource === 'request') {
                    passwordInfoHtml = `
                        비밀번호: <strong>입점 요청 시 설정한 비밀번호</strong><br>
                        <span style="font-size:13px; color:#64748b;">사장님께 이미 안내된 비밀번호가 그대로 적용되었습니다.</span>
                    `;
                } else {
                    passwordInfoHtml = `
                        임시 비밀번호: <strong style="font-size:16px;">${escapeHtml(tempPassword)}</strong><br>
                        <button class="btn-copy" style="margin-top:10px; padding:6px 12px; border-radius:999px; border:none; background:#e2e8f0; cursor:pointer;" onclick="copyOwnerTempPassword('${safeEmailAttr}', '${safePasswordAttr}')">안내 복사</button>
                    `;
                }

                resultEl.innerHTML = `
                    ✅ 계정이 승인되었습니다.<br>
                    계정: <strong>${safeEmail}</strong><br>
                    ${passwordInfoHtml}
                    연결 가게: <strong>${displayStoreName}</strong>${displayStoreAddress}
                `;

                if (owner) {
                    owner.passwordSource = passwordSource;
                }

                submitBtn.textContent = '닫기';
                submitBtn.disabled = false;
                submitBtn.setAttribute('data-mode', 'close');

                showToast('계정이 승인되었습니다.', 'success');
            } catch (error) {
                console.error('계정 승인 실패:', error);
                showToast(error.message || '계정 승인에 실패했습니다.', 'error');
                
                // 에러 시 로딩 숨김
                if (window.hideGlobalLoading) {
                    window.setLoadingBarType('error');
                    setTimeout(() => window.hideGlobalLoading(), 500);
                }
                
                submitBtn.disabled = false;
                submitBtn.textContent = '승인하기';
                submitBtn.setAttribute('data-mode', 'approve');
            }
        }

        function openOwnerRejectModal(ownerId) {
            const owner = ownerAccounts.find(item => item.id === ownerId);
            if (!owner) return;

            currentOwnerRejectId = ownerId;
            const modal = document.getElementById('ownerRejectModal');
            const infoEl = document.getElementById('ownerRejectInfo');
            const reasonEl = document.getElementById('ownerRejectReason');
            const submitBtn = document.getElementById('ownerRejectSubmitBtn');

            if (!modal || !infoEl || !reasonEl || !submitBtn) return;

            infoEl.innerHTML = `
                <p><strong>${owner.ownerName || owner.email}</strong> (${owner.email})</p>
                <p style="margin-top:6px;">연락처: ${owner.phone || '-'}<br>요청일: ${owner.createdAt ? new Date(owner.createdAt).toLocaleString('ko-KR') : '-'}</p>
            `;

            reasonEl.value = '';
            submitBtn.disabled = false;
            submitBtn.textContent = '거절하기';

            modal.classList.add('active');
        }
        function closeOwnerRejectModal() {
            const modal = document.getElementById('ownerRejectModal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentOwnerRejectId = null;
        }
        async function submitOwnerRejection() {
            const reasonEl = document.getElementById('ownerRejectReason');
            const submitBtn = document.getElementById('ownerRejectSubmitBtn');

            if (!reasonEl || !submitBtn) return;

            const reason = reasonEl.value.trim();
            if (!reason) {
                showToast('거절 사유를 입력해주세요.', 'warning');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '거절 중...';

            try {
                await apiRequest(`${API_BASE}/owners/${currentOwnerRejectId}/reject`, 'POST', { reason: reason });
                const owner = ownerAccounts.find(item => item.id === currentOwnerRejectId);
                if (owner) {
                    owner.status = OWNER_STATUS.REJECTED; // 상수 사용
                    if (owner.requestData && typeof owner.requestData === 'string') {
                        try {
                            owner.requestData = JSON.parse(owner.requestData);
                        } catch (parseError) {
                            owner.requestData = {};
                        }
                    }
                    owner.requestData = owner.requestData || {};
                    owner.requestData.rejectReason = reason;
                }
                closeOwnerRejectModal();
                // 거절된 계정은 '거절됨' 탭으로 이동하므로 탭 변경
                ownerStatusFilter = OWNER_STATUS.REJECTED;
                const rejectedTab = document.querySelector(`.owner-tab[data-status="${OWNER_STATUS.REJECTED}"]`);
                const tabs = document.querySelectorAll('.owner-tab');
                if (rejectedTab) {
                    tabs.forEach(t => t.classList.remove('active'));
                    rejectedTab.classList.add('active');
                    // 탭 변경 후 해당 상태로 API 재요청
                    await loadOwnerAccounts(OWNER_STATUS.REJECTED);
                } else {
                renderOwnerAccounts();
                }
                showToast('요청을 거절했습니다.', 'warning', '거절 완료');
            } catch (error) {
                console.error('계정 거절 실패:', error);
                showToast(error.message || '요청 거절에 실패했습니다.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '거절하기';
            }
        }

        function showOwnerManageModal({ title, message, confirmText, confirmClass = 'btn-primary', action, ownerId }) {
            const modal = document.getElementById('ownerManageModal');
            const titleEl = document.getElementById('ownerManageModalTitle');
            const messageEl = document.getElementById('ownerManageModalMessage');
            const confirmBtn = document.getElementById('ownerManageModalConfirmBtn');
            if (!modal || !titleEl || !messageEl || !confirmBtn) return;

            ownerManageModalState = {
                action,
                ownerId,
                confirmText
            };

            titleEl.textContent = title;
            messageEl.innerHTML = message;
            confirmBtn.textContent = confirmText;
            confirmBtn.className = `btn ${confirmClass}`;
            confirmBtn.disabled = false;

            modal.classList.add('active');
        }

        function closeOwnerManageModal() {
            const modal = document.getElementById('ownerManageModal');
            const confirmBtn = document.getElementById('ownerManageModalConfirmBtn');
            if (modal) {
                modal.classList.remove('active');
            }
            if (confirmBtn && ownerManageModalState?.confirmText) {
                confirmBtn.textContent = ownerManageModalState.confirmText;
                confirmBtn.disabled = false;
            }
            ownerManageModalState = null;
        }

        async function submitOwnerManageAction() {
            if (!ownerManageModalState || !ownerManageModalState.action || !ownerManageModalState.ownerId) {
                return;
            }

            const { action, ownerId, confirmText } = ownerManageModalState;
            const confirmBtn = document.getElementById('ownerManageModalConfirmBtn');
            if (!confirmBtn) return;

            confirmBtn.disabled = true;
            confirmBtn.textContent = '처리 중...';

            try {
                if (action === 'pause') {
                    await pauseOwnerAccount(ownerId);
                } else if (action === 'resume') {
                    await resumeOwnerAccount(ownerId);
                } else if (action === 'delete') {
                    await deleteOwnerAccount(ownerId);
                }
                closeOwnerManageModal();
            } catch (error) {
                console.error('계정 관리 액션 실패:', error);
                confirmBtn.disabled = false;
                confirmBtn.textContent = confirmText || '확인';
            }
        }

        function openOwnerPauseModal(ownerId) {
            const owner = findOwnerAccount(ownerId);
            if (!owner) return;
            const ownerName = escapeHtml(owner.ownerName || owner.email || '점주');
            const storeName = escapeHtml(owner.requestData?.storeName || owner.storeName || '');
            const storeLine = storeName ? `<br><span style="color:#1d4ed8;">연결 가게: <strong>${storeName}</strong></span>` : '';
            showOwnerManageModal({
                title: '계정 일시 중지',
                message: `<strong>${ownerName}</strong>님의 계정을 일시 중지할까요?${storeLine}<br>중지된 계정은 재승인 후 다시 활성화할 수 있습니다.`,
                confirmText: '중지',
                confirmClass: 'btn-danger',
                action: 'pause',
                ownerId
            });
        }

        function openOwnerResumeModal(ownerId) {
            const owner = findOwnerAccount(ownerId);
            if (!owner) return;
            const ownerName = escapeHtml(owner.ownerName || owner.email || '점주');
            const storeName = escapeHtml(owner.requestData?.storeName || owner.storeName || '');
            const storeLine = storeName ? `<br><span style="color:#1d4ed8;">연결 가게: <strong>${storeName}</strong></span>` : '';
            showOwnerManageModal({
                title: '계정 재개',
                message: `<strong>${ownerName}</strong>님의 계정을 다시 활성화할까요?${storeLine}`,
                confirmText: '재개',
                confirmClass: 'btn-primary',
                action: 'resume',
                ownerId
            });
        }

        function openOwnerDeleteModal(ownerId) {
            const owner = findOwnerAccount(ownerId);
            if (!owner) return;
            const ownerName = escapeHtml(owner.ownerName || owner.email || '점주');
            const storeName = escapeHtml(owner.requestData?.storeName || owner.storeName || '');
            const storeLine = storeName ? `<br><span style="color:#b91c1c;">연결 가게: <strong>${storeName}</strong></span>` : '';
            showOwnerManageModal({
                title: '계정 삭제',
                message: `<strong>${ownerName}</strong>님의 계정을 삭제할까요?${storeLine}<br>삭제 후에는 복구할 수 없습니다.`,
                confirmText: '삭제',
                confirmClass: 'btn-danger',
                action: 'delete',
                ownerId
            });
        }

        async function pauseOwnerAccount(ownerId) {
            try {
                const response = await apiRequest(`${API_BASE}/owners/${ownerId}/pause`, 'POST', {});
                // 상태 변경 후 즉시 로컬 데이터 업데이트
                const owner = ownerAccounts.find(item => item.id === ownerId);
                if (owner) {
                    owner.status = OWNER_STATUS.SUSPENDED; // 상수 사용
                }
                // 일시 중지된 계정은 '일시 중지' 탭으로 이동하므로 탭 변경
                ownerStatusFilter = OWNER_STATUS.SUSPENDED;
                const suspendedTab = document.querySelector(`.owner-tab[data-status="${OWNER_STATUS.SUSPENDED}"]`);
                const tabs = document.querySelectorAll('.owner-tab');
                if (suspendedTab) {
                    tabs.forEach(t => t.classList.remove('active'));
                    suspendedTab.classList.add('active');
                    // 탭 변경 후 해당 상태로 API 재요청
                    await loadOwnerAccounts(OWNER_STATUS.SUSPENDED);
                } else {
                    await loadOwnerAccounts(OWNER_STATUS.SUSPENDED);
                }
                await loadStoreList();
                showToast('계정을 일시 중지했습니다.', 'warning', '운영 중지 완료');
            } catch (error) {
                console.error('계정 중지 실패:', error);
                showToast(error.message || '계정을 중지하지 못했습니다.', 'error');
                throw error;
            }
        }

        async function resumeOwnerAccount(ownerId) {
            try {
                const response = await apiRequest(`${API_BASE}/owners/${ownerId}/resume`, 'POST', {});
                // 상태 변경 후 즉시 로컬 데이터 업데이트
                const owner = ownerAccounts.find(item => item.id === ownerId);
                if (owner) {
                    owner.status = OWNER_STATUS.ACTIVE; // 상수 사용
                }
                // 재개된 계정은 '운영 중' 탭으로 이동하므로 탭 변경
                ownerStatusFilter = OWNER_STATUS.ACTIVE;
                const activeTab = document.querySelector(`.owner-tab[data-status="${OWNER_STATUS.ACTIVE}"]`);
                const tabs = document.querySelectorAll('.owner-tab');
                if (activeTab) {
                    tabs.forEach(t => t.classList.remove('active'));
                    activeTab.classList.add('active');
                    // 탭 변경 후 해당 상태로 API 재요청
                    await loadOwnerAccounts(OWNER_STATUS.ACTIVE);
                } else {
                    await loadOwnerAccounts(OWNER_STATUS.ACTIVE);
                }
                await loadStoreList(); // 가게 관리 화면의 "연결된 점주" 표시도 업데이트됨
                showToast('계정 운영을 재개했습니다.', 'success', '운영 재개 완료');
            } catch (error) {
                console.error('계정 재개 실패:', error);
                showToast(error.message || '계정을 재개하지 못했습니다.', 'error');
                throw error;
            }
        }

        async function deleteOwnerAccount(ownerId) {
            try {
                await apiRequest(`${API_BASE}/owners/${ownerId}`, 'DELETE');
                // 삭제 후 현재 선택된 탭 상태로 다시 로드
                await loadOwnerAccounts(ownerStatusFilter);
                await loadStoreList();
                showToast('계정을 삭제했습니다.', 'warning');
            } catch (error) {
                console.error('계정 삭제 실패:', error);
                showToast(error.message || '계정을 삭제하지 못했습니다.', 'error');
                throw error;
            }
        }

        function copyOwnerTempPassword(email, password) {
            const guide = `픽업 관리자 로그인 안내\n\n로그인 주소: ${window.location.origin}/login\n이메일: ${email}\n임시 비밀번호: ${password}\n\n첫 로그인 후 비밀번호를 꼭 변경해주세요.`;
            navigator.clipboard.writeText(guide).then(() => {
                showToast('임시 비밀번호 안내가 복사되었습니다.', 'success');
            }).catch(() => {
                showToast('복사에 실패했습니다.', 'error');
            });
        }

        function copyOwnerGuide(email, storeName, passwordSource = 'request') {
            const normalizedSource = (passwordSource || 'request').toLowerCase();
            const passwordGuide = normalizedSource === 'request'
                ? '비밀번호: 입점 신청 시 설정하신 비밀번호를 그대로 사용해주세요.'
                : '비밀번호: 승인 시 전달드린 비밀번호를 사용해주세요.';
            const guide = `픽업 관리자 로그인 안내\n\n로그인 주소: ${window.location.origin}/login\n이메일: ${email}\n가게: ${storeName || '연결된 가게'}\n${passwordGuide}\n\n로그인 후 비밀번호를 변경하고 가게 정보를 확인해주세요.`;
            navigator.clipboard.writeText(guide).then(() => {
                showToast('안내 문구가 복사되었습니다.', 'success');
            }).catch(() => {
                showToast('복사에 실패했습니다.', 'error');
            });
        }

        const ownerModalSubmitBtn = document.getElementById('ownerModalSubmitBtn');
        if (ownerModalSubmitBtn) {
            ownerModalSubmitBtn.addEventListener('click', handleOwnerModalSubmit);
        }
        function handleStoreSearchInput() {
            debouncedStoreSearch();
        }

        function handleStoreStatusFilterChange() {
            storeQueryState.status = document.getElementById('storeStatusFilter').value;
            storeQueryState.page = 1;
            loadStoreList();
        }

        function handleStoreOwnerFilterChange() {
            storeQueryState.ownerId = document.getElementById('storeOwnerFilter').value;
            storeQueryState.page = 1;
            loadStoreList();
        }

        function handleStoreCreatedFilterChange() {
            storeQueryState.createdDate = document.getElementById('storeCreatedFilter').value;
            storeQueryState.page = 1;
            loadStoreList();
        }

        function handleStoreSortChange() {
            const sortValue = document.getElementById('storeSortBy').value;
            storeQueryState.sortBy = sortValue;
            storeQueryState.sortOrder = sortValue === 'name' ? 'asc' : 'desc';
            storeQueryState.page = 1;
            loadStoreList();
        }

        function setStoreViewMode(mode) {
            if (!mode || storeViewMode === mode) {
                return;
            }
            storeViewMode = mode;
            storeQueryState.page = 1;
            const buttons = document.querySelectorAll('.store-view-btn');
            buttons.forEach(btn => {
                const btnMode = btn.getAttribute('data-view');
                btn.classList.toggle('active', btnMode === mode);
            });
            renderStoreView();
            updateStorePaginationControls();
        }

        async function renderStoreView() {
            if (storeViewMode === 'owner') {
                // 점주별 보기: filteredStores를 점주별로 그룹화하여 표시
                if (IS_SUPERADMIN) {
                    renderOwnerGroupView();
                } else {
                    // 점주 계정은 점주별 보기 불가
                    await renderStoreTable();
                }
            } else {
                await renderStoreTable();
            }
        }

        function updateStorePaginationControls() {
            const infoEl = document.getElementById('storePaginationInfo');
            const prevBtn = document.getElementById('storePrevPageBtn');
            const nextBtn = document.getElementById('storeNextPageBtn');

            if (infoEl) {
                const totalPages = storePagination.totalPages || 1;
                if (storeViewMode === 'owner') {
                    const ownerCount = ownerGroupedStores.length;
                    infoEl.textContent = `${storePagination.page} / ${totalPages} (점주 그룹 ${ownerCount}개)`;
                } else {
                    infoEl.textContent = `${storePagination.page} / ${totalPages} (총 ${storePagination.total || 0}개)`;
                }
            }
            if (prevBtn) {
                prevBtn.disabled = storePagination.page <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = storePagination.page >= (storePagination.totalPages || 1);
            }
        }

        function changeStorePage(delta) {
            const nextPage = storePagination.page + delta;
            const maxPage = storePagination.totalPages || 1;
            if (nextPage < 1 || nextPage > maxPage) {
                return;
            }
            storeQueryState.page = nextPage;
            loadStoreList();
        }

        function buildOwnerGroups(stores) {
            const groupsMap = new Map();
            const unassignedKey = '__unassigned';

            stores.forEach(store => {
                const owners = Array.isArray(store.owners) && store.owners.length > 0 ? store.owners : [null];
                owners.forEach(owner => {
                    const ownerId = owner?.id || unassignedKey;
                    const existing = groupsMap.get(ownerId);
                    if (!existing) {
                        groupsMap.set(ownerId, {
                            ownerId,
                            ownerName: owner?.ownerName || owner?.email || (ownerId === unassignedKey ? '미연결' : '이름 미상'),
                            email: owner?.email || '',
                            phone: owner?.phone || '',
                            stores: []
                        });
                    }
                    groupsMap.get(ownerId).stores.push(store);
                });
            });

            return Array.from(groupsMap.values()).sort((a, b) => {
                if (a.ownerId === '__unassigned') return 1;
                if (b.ownerId === '__unassigned') return -1;
                return (a.ownerName || '').localeCompare(b.ownerName || '', 'ko', { sensitivity: 'base' });
            });
        }

        function populateOwnerFilterOptions(stores) {
            const ownerFilter = document.getElementById('storeOwnerFilter');
            if (!ownerFilter) return;

            const previousValue = ownerFilter.value || storeQueryState.ownerId || '';
            const ownerMap = new Map();

            stores.forEach(store => {
                const owners = Array.isArray(store.owners) ? store.owners : [];
                owners.forEach(owner => {
                    if (!owner?.id) {
                        return;
                    }
                    if (!ownerMap.has(owner.id)) {
                        ownerMap.set(owner.id, {
                            id: owner.id,
                            name: owner.ownerName || owner.email || '이름 미상',
                            email: owner.email || ''
                        });
                    }
                });
            });

            let optionsHtml = '<option value="">전체 점주</option><option value="__unassigned">미연결</option>';
            const sortedOwners = Array.from(ownerMap.values()).sort((a, b) => a.name.localeCompare(b.name, 'ko', { sensitivity: 'base' }));
            sortedOwners.forEach(owner => {
                const displayLabel = owner.email ? `${owner.name} (${owner.email})` : owner.name;
                optionsHtml += `<option value="${owner.id}">${displayLabel}</option>`;
            });

            ownerFilter.innerHTML = optionsHtml;
            if (previousValue && (previousValue === '__unassigned' || ownerMap.has(previousValue))) {
                ownerFilter.value = previousValue;
            } else {
                ownerFilter.value = '';
                storeQueryState.ownerId = '';
            }
        }

        // 가게 상태 결정 함수: 점주 상태를 고려하여 실제 상태 반환
        function determineStoreStatus(store) {
            // 일시정지 상태는 우선순위가 가장 높음
            if (store.status === 'paused') {
                return 'paused';
            }
            
            // 점주가 연결되어 있는 경우 점주 상태 확인
            const owners = Array.isArray(store?.owners) ? store.owners : [];
            if (owners.length > 0) {
                // 모든 점주가 승인(active) 상태인지 확인
                const allOwnersActive = owners.every(owner => owner?.status === OWNER_STATUS.ACTIVE);
                // 하나라도 승인 대기(pending) 상태인 점주가 있으면 가게도 pending
                const hasPendingOwner = owners.some(owner => owner?.status === OWNER_STATUS.PENDING);
                
                if (hasPendingOwner || !allOwnersActive) {
                    return 'pending';
                }
            } else {
                // 점주가 없으면 pending 상태
                return 'pending';
            }
            
            // 기본적으로 DB의 상태 반환 (active 또는 기타)
            return store.status || 'pending';
        }

        function buildStoreStatusBadge(status) {
            if (status === 'paused') {
                return '<span style="display:inline-block;padding:4px 12px;background:#fef3c7;color:#92400e;border-radius:12px;font-size:12px;font-weight:600;">일시정지</span>';
            }
            if (status === 'pending') {
                return '<span style="display:inline-block;padding:4px 12px;background:#e0e7ff;color:#4338ca;border-radius:12px;font-size:12px;font-weight:600;">입점대기</span>';
            }
            return '<span style="display:inline-block;padding:4px 12px;background:#d1fae5;color:#065f46;border-radius:12px;font-size:12px;font-weight:600;">활성</span>';
        }

        function renderStoreOwnersCell(store) {
            const owners = Array.isArray(store?.owners) ? store.owners : [];
            if (!owners.length) {
                return '<span class="owner-tag empty">연결된 점주 없음</span>';
            }
            return owners.map(owner => {
                const ownerName = owner?.ownerName || '이름 미상';
                const ownerEmail = owner?.email ? `<span style="display:block; font-weight:400; color:#1d4ed8; font-size:11px;">${owner.email}</span>` : '';
                
                // Owner 상태에 따른 표시
                let statusBadge = '';
                const ownerStatus = owner?.status || '';
                if (ownerStatus === OWNER_STATUS.ACTIVE) {
                    statusBadge = '<span style="display:block; font-size:10px; color:#10b981; margin-top:2px;">✓ 운영 중</span>';
                } else if (ownerStatus === OWNER_STATUS.SUSPENDED) {
                    statusBadge = '<span style="display:block; font-size:10px; color:#f59e0b; margin-top:2px;">⚠ 일시 중지</span>';
                } else if (ownerStatus === OWNER_STATUS.PENDING) {
                    statusBadge = '<span style="display:block; font-size:10px; color:#3b82f6; margin-top:2px;">⏳ 승인 대기</span>';
                } else if (ownerStatus === OWNER_STATUS.REJECTED) {
                    statusBadge = '<span style="display:block; font-size:10px; color:#ef4444; margin-top:2px;">✗ 거절됨</span>';
                }
                
                return `<span class="owner-tag">${ownerName}${ownerEmail}${statusBadge}</span>`;
            }).join('');
        }

        function renderOwnerGroupView() {
            const tableWrapper = document.getElementById('storeTableWrapper');
            const groupsContainer = document.getElementById('ownerGroupContainer');
            const pagination = document.getElementById('storePagination');
            if (tableWrapper) {
                tableWrapper.style.display = 'none';
            }
            if (groupsContainer) {
                groupsContainer.style.display = 'block';
            }
            ownerGroupedStores = buildOwnerGroups(filteredStores);

            if (!groupsContainer) return;

            if (ownerGroupedStores.length === 0) {
                groupsContainer.innerHTML = '<div class="owner-group-empty">현재 조건에 해당하는 점주가 없습니다.</div>';
                if (pagination) {
                    pagination.style.display = 'flex';
                }
                return;
            }

            const groupCardsHtml = ownerGroupedStores.map(group => {
                const storeItems = group.stores.map(store => {
                    const actualStatus = determineStoreStatus(store);
                    const statusBadge = buildStoreStatusBadge(actualStatus);
                    const storeName = store?.basic?.storeName || store?.name || '이름 없음';
                    const phone = store?.basic?.storePhone || store?.phone || '-';
                    const subdomain = store?.subdomain ? `${window.location.origin}/${store.subdomain}` : '';
                    const address = store?.basic?.storeAddress || store?.address || '';
                    return `
                        <div class="owner-group-store">
                            <div style="flex:1; min-width: 220px;">
                                <div style="font-weight:700; color:#1f2937;">${storeName}</div>
                                <div style="font-size:12px; color:#64748b; margin-top:4px;">
                                    ${phone !== '-' ? `<span>${phone}</span>` : ''}
                                    ${address ? `<span style="margin-left:8px;">${address}</span>` : ''}
                                    ${subdomain ? `<span style="margin-left:8px; color:#2563eb;">${subdomain}</span>` : ''}
                                </div>
                            </div>
                            <div>${statusBadge}</div>
                            <button type="button" onclick="event.stopPropagation(); selectStore('${store.id}')">가게 선택</button>
                        </div>
                    `;
                }).join('');

                const ownerMeta = [];
                if (group.email) {
                    ownerMeta.push(group.email);
                }
                if (group.phone) {
                    ownerMeta.push(group.phone);
                }
                const metaText = ownerMeta.length > 0 ? ownerMeta.join(' · ') : '연락처 없음';

                return `
                    <div class="owner-group-card">
                        <div class="owner-group-header">
                            <div>
                                <div class="owner-group-title">${group.ownerName}</div>
                                <div class="owner-group-meta">${metaText}</div>
                            </div>
                            <div class="owner-group-meta">연결된 가게 ${group.stores.length}곳</div>
                        </div>
                        ${storeItems}
                    </div>
                `;
            }).join('');

            groupsContainer.innerHTML = groupCardsHtml;
            if (pagination) {
                pagination.style.display = 'flex';
            }
        }

        async function openStoreOwnerManageModal(storeId) {
            if (!IS_SUPERADMIN) {
                showToast('점주 연결 관리는 슈퍼어드민만 가능합니다.', 'error');
                return;
            }
            storeOwnerManageState = { storeId };
            if (ownerAccounts.length === 0) {
                await loadOwnerAccounts(ownerStatusFilter);
            }
            const store = getStoreById(storeId);
            if (!store) {
                showToast('가게 정보를 찾을 수 없습니다.', 'error');
                return;
            }
            renderStoreOwnerManageModal(store);
            const modal = document.getElementById('storeOwnerManageModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeStoreOwnerManageModal() {
            const modal = document.getElementById('storeOwnerManageModal');
            if (modal) {
                modal.style.display = 'none';
            }
            storeOwnerManageState = { storeId: null };
        }

        function renderStoreOwnerManageModal(store) {
            const titleEl = document.getElementById('storeOwnerManageTitle');
            const subtitleEl = document.getElementById('storeOwnerManageSubtitle');
            const listEl = document.getElementById('storeOwnerManageList');
            const selectEl = document.getElementById('storeOwnerAddSelect');
            const addBtn = document.getElementById('storeOwnerAddBtn');

            if (!listEl || !selectEl || !addBtn) {
                return;
            }

            const storeName = escapeHtml(store.basic?.storeName || store.name || '이름 없음');
            const subdomainLabel = store.subdomain ? ` /${escapeHtml(store.subdomain)}` : '';
            if (titleEl) {
                titleEl.textContent = '점주 연결 관리';
            }
            if (subtitleEl) {
                subtitleEl.innerHTML = `<strong>${storeName}</strong>${subdomainLabel ? `<span style="color:#64748b;">${subdomainLabel}</span>` : ''}`;
            }

            const owners = Array.isArray(store.owners) ? store.owners.filter(owner => owner && owner.id) : [];
            if (owners.length === 0) {
                listEl.innerHTML = '<div class="owner-manage-empty">연결된 점주가 없습니다. 새로운 점주를 연결해주세요.</div>';
            } else {
                listEl.innerHTML = owners.map(owner => {
                    const ownerName = escapeHtml(owner.ownerName || owner.email || '점주');
                    const ownerEmail = owner.email ? `<span>${escapeHtml(owner.email)}</span>` : '';
                    const ownerPhone = owner.phone ? `<span>${escapeHtml(owner.phone)}</span>` : '';
                    const ownerRole = owner.role ? `<span>역할: ${escapeHtml(owner.role)}</span>` : '';
                    const ownerIdAttr = escapeForAttribute(owner.id || '');
                    return `
                        <div class="owner-manage-item">
                            <div class="owner-manage-info">
                                <strong>${ownerName}</strong>
                                ${ownerEmail}
                                ${ownerPhone}
                                ${ownerRole}
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button type="button" class="btn btn-secondary" onclick="handleStoreOwnerUnlink('${ownerIdAttr}')">연결 해제</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // active 또는 suspended 상태의 점주만 연결 가능 (Single Source of Truth)
            const availableOwners = ownerAccounts
                .filter(owner => owner.status === OWNER_STATUS.ACTIVE || owner.status === OWNER_STATUS.SUSPENDED)
                .filter(owner => !owners.some(linked => linked?.id === owner.id));

            const optionsHtml = ['<option value="">연결할 점주를 선택하세요</option>']
                .concat(availableOwners.map(owner => {
                    const name = escapeHtml(owner.ownerName || owner.email || '점주');
                    const email = owner.email ? ` (${escapeHtml(owner.email)})` : '';
                    return `<option value="${escapeForAttribute(owner.id)}">${name}${email}</option>`;
                }));

            selectEl.innerHTML = optionsHtml.join('');
            selectEl.value = '';
            addBtn.disabled = availableOwners.length === 0;
            if (availableOwners.length === 0) {
                selectEl.title = '연결 가능한 승인된 점주가 없습니다.';
            } else {
                selectEl.title = '';
            }
        }

        async function handleStoreOwnerLink() {
            if (!IS_SUPERADMIN) {
                showToast('점주 연결 권한이 없습니다.', 'error');
                return;
            }
            const storeId = storeOwnerManageState.storeId;
            if (!storeId) {
                showToast('가게 정보가 확인되지 않았습니다.', 'error');
                return;
            }
            const selectEl = document.getElementById('storeOwnerAddSelect');
            if (!selectEl) {
                return;
            }
            const ownerId = selectEl.value;
            if (!ownerId) {
                showToast('연결할 점주를 선택해주세요.', 'error');
                return;
            }
            try {
                await apiRequest(`${API_BASE}/stores/${storeId}/owners`, 'POST', { ownerId });
                showToast('점주를 연결했습니다.', 'success');
                await loadOwnerAccounts(ownerStatusFilter);
                await loadStoreList();
                const updatedStore = getStoreById(storeId);
                if (updatedStore) {
                    renderStoreOwnerManageModal(updatedStore);
                } else {
                    closeStoreOwnerManageModal();
                }
            } catch (error) {
                console.error('점주 연결 실패:', error);
                showToast(error.message || '점주 연결에 실패했습니다.', 'error');
            }
        }

        async function handleStoreOwnerUnlink(ownerId) {
            if (!IS_SUPERADMIN) {
                showToast('점주 연결 해제 권한이 없습니다.', 'error');
                return;
            }
            const storeId = storeOwnerManageState.storeId;
            if (!storeId || !ownerId) {
                showToast('점주 연결 정보를 찾을 수 없습니다.', 'error');
                return;
            }
            const confirmUnlink = confirm('선택한 점주와의 연결을 해제할까요?');
            if (!confirmUnlink) {
                return;
            }
            try {
                await apiRequest(`${API_BASE}/stores/${storeId}/owners/${ownerId}`, 'DELETE');
                showToast('점주 연결이 해제되었습니다.', 'warning');
                await loadOwnerAccounts(ownerStatusFilter);
                await loadStoreList();
                const updatedStore = getStoreById(storeId);
                if (updatedStore) {
                    renderStoreOwnerManageModal(updatedStore);
                } else {
                    closeStoreOwnerManageModal();
                }
            } catch (error) {
                console.error('점주 연결 해제 실패:', error);
                showToast(error.message || '점주 연결 해제에 실패했습니다.', 'error');
            }
        }
        
        // 가게 테이블 렌더링
        async function renderStoreTable() {
            const tbody = document.getElementById('storeTableBody');
            const persistedStoreId = await getCurrentStoreId();
            const activeStoreId = window.currentStoreId || persistedStoreId || null;
            const tableWrapper = document.getElementById('storeTableWrapper');
            const ownerContainer = document.getElementById('ownerGroupContainer');
            
            if (tableWrapper) {
                tableWrapper.style.display = 'block';
            }
            if (ownerContainer) {
                ownerContainer.style.display = 'none';
                ownerContainer.innerHTML = '';
            }
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredStores.length === 0) {
                if (allStores.length === 0) {
                    if (IS_STORE_OWNER) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="padding: 48px 32px;">
                                    <div style="background: #f8fafc; border: 1px dashed #cbd5f5; border-radius: 16px; padding: 32px; text-align: center; color:#475569;">
                                        <div style="font-size: 42px;">📬</div>
                                        <h3 style="margin-top: 12px; margin-bottom: 8px; font-size: 20px; color: #1e293b;">관리자 승인 대기 중입니다</h3>
                                        <p style="margin: 0; color: #64748b; font-size: 14px;">아직 연결된 가게가 없습니다. 관리자에게 문의해주세요.</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="padding: 48px 32px;">
                                    <div style="background: #f8fafc; border: 1px dashed #cbd5f5; border-radius: 16px; padding: 32px; text-align: center;">
                                        <div style="font-size: 42px;">🌱</div>
                                        <h3 style="margin-top: 12px; margin-bottom: 8px; font-size: 20px; color: #1e293b;">아직 등록된 가게가 없습니다</h3>
                                        <p style="margin: 0; color: #64748b; font-size: 14px;">첫 번째 가게를 등록하고 픽업 서비스를 시작해보세요.</p>
                                        <button onclick="showStoreNameModal()" style="margin-top: 20px; padding: 10px 20px; border: none; border-radius: 999px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; cursor: pointer;">새 가게 만들기</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #94a3b8;">검색 조건에 맞는 가게가 없습니다.</td></tr>';
                }
                return;
            }
            
            // Virtual Scrolling: 한 번에 최대 50개만 렌더링 (성능 최적화)
            const ITEMS_PER_PAGE = 50;
            const visibleStores = filteredStores.slice(0, ITEMS_PER_PAGE);

            visibleStores.forEach(store => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-store-id', store.id);
                tr.style.borderBottom = '1px solid #e2e8f0';
                tr.style.transition = 'background 0.2s';
                tr.style.cursor = 'pointer';
                tr.onclick = () => selectStore(store.id); // 행 클릭으로 선택

                tr.addEventListener('mouseover', () => {
                    tr.style.background = '#f8fafc';
                });

                tr.addEventListener('mouseout', () => {
                    const latestActive = window.currentStoreId || persistedStoreId || null;
                    if (latestActive === store.id) {
                        tr.style.background = '#eff6ff';
                        tr.style.borderLeft = '4px solid #3b82f6';
                    } else {
                        tr.style.background = 'white';
                        tr.style.borderLeft = '';
                    }
                });

                if (activeStoreId === store.id) {
                    tr.style.background = '#eff6ff';
                    tr.style.borderLeft = '4px solid #3b82f6';
                }
                
                // 서브도메인이 있는 경우 서브도메인 URL 사용, 없으면 기존 URL 사용
                const storeUrl = store.subdomain 
                    ? `${window.location.origin}/${store.subdomain}` 
                    : `${window.location.origin}/store.html?id=${store.id}`;
                const shortId = store.id.split('_').pop().substring(0, 8);
                
                const statusBadge = buildStoreStatusBadge(store.status);
                const ownersCell = renderStoreOwnersCell(store);
                
                console.log('🔍 [DEBUG] 가게 상태:', { storeId: store.id, status: store.status });
                
                // 일시정지/재개 버튼
                const pauseResumeBtn = store.status === 'paused'
                    ? `<button onclick="event.stopPropagation(); resumeStore('${store.id}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">재개</button>`
                    : `<button onclick="event.stopPropagation(); pauseStore('${store.id}')" style="padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">일시정지</button>`;

                const actionButtons = IS_STORE_OWNER
                    ? `
                            <button onclick="event.stopPropagation(); viewStorePage('${store.id}')" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">페이지보기</button>
                            <button onclick="event.stopPropagation(); copyStoreUrl('${storeUrl}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">URL 복사</button>
                    `
                    : `
                            ${pauseResumeBtn}
                            <button onclick="event.stopPropagation(); openStoreOwnerManageModal('${store.id}')" style="padding: 6px 12px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">점주 관리</button>
                            <button onclick="event.stopPropagation(); viewStorePage('${store.id}')" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">페이지보기</button>
                            <button onclick="event.stopPropagation(); copyStoreUrl('${storeUrl}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">URL 복사</button>
                            <button onclick="event.stopPropagation(); deleteStore('${store.id}')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">삭제</button>
                        `;
                
                tr.innerHTML = `
                    <td style="padding: 16px 12px;">
                        <code style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #475569;">${shortId}</code>
                    </td>
                    <td style="padding: 16px 12px; font-weight: 600; color: #1e293b;">${store.basic?.storeName || '이름 없음'}</td>
                    <td style="padding: 16px 12px;">${ownersCell}</td>
                    <td style="padding: 16px 12px; color: #64748b;">${store.basic?.storePhone || '-'}</td>
                    <td style="padding: 16px 12px;">${statusBadge}</td>
                    <td style="padding: 16px 12px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                // 행 클릭 이벤트 추가
                tr.addEventListener('click', function(e) {
                    // 버튼 클릭이 아닌 경우에만 가게 선택
                    if (!e.target.closest('button')) {
                        selectStore(store.id);
                    }
                });
                
                tbody.appendChild(tr);
            });
            
            // Virtual Scrolling: 나머지 항목이 있으면 표시
            if (filteredStores.length > ITEMS_PER_PAGE) {
                const moreCount = filteredStores.length - ITEMS_PER_PAGE;
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = `
                    <td colspan="6" style="padding: 16px; text-align: center; color: #64748b; background: #f8fafc;">
                        <strong>${moreCount}개</strong>의 추가 가게가 있습니다. 검색을 사용하여 찾아보세요.
                    </td>
                `;
                tbody.appendChild(moreRow);
            }
        }
        
        // JSON 내보내기
        async function exportStoresJSON() {
            try {
                const response = await fetch(`${API_BASE}/stores/bulk-export?format=json`);
                if (!response.ok) throw new Error('Failed to export');
                
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stores_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('JSON 파일이 다운로드되었습니다.', 'success');
            } catch (error) {
                console.error('Error exporting JSON:', error);
                showToast('내보내기 실패', 'error');
            }
        }
        
        // CSV 내보내기
        // 통계 카드 클릭 필터 (단일 진실: storeQueryState.status)
        window.filterByStatCard = function filterByStatCard(type) {
            const statusFilter = document.getElementById('storeStatusFilter');
            const searchInput = document.getElementById('storeSearchInput');
            
            // 검색 초기화
                searchInput.value = '';
                storeQueryState.keyword = '';
            
            // storeQueryState.status 업데이트 (단일 진실)
            if (type === 'all') {
                storeQueryState.status = '';
                storeQueryState.createdDate = '';
            } else if (type === 'active') {
                storeQueryState.status = 'active';
                storeQueryState.createdDate = '';
            } else if (type === 'pending') {
                storeQueryState.status = 'pending';
                storeQueryState.createdDate = '';
            } else if (type === 'paused') {
                storeQueryState.status = 'paused';
                storeQueryState.createdDate = '';
            } else if (type === 'today') {
                storeQueryState.status = '';
                const today = new Date().toISOString().split('T')[0];
                storeQueryState.createdDate = today;
            }
            
            // 페이지 초기화
            storeQueryState.page = 1;
            
            // 드롭다운 UI 동기화
            if (statusFilter) {
                if (type === 'all') {
                    statusFilter.value = '';
                } else if (type === 'today') {
                    statusFilter.value = '';
                    // 오늘 추가는 createdDate 필터로 처리되므로 status는 빈 값
                } else {
                    statusFilter.value = storeQueryState.status;
                }
            }
            
            // createdDate 필터 UI도 동기화
            const createdFilter = document.getElementById('storeCreatedFilter');
            if (createdFilter) {
                if (type === 'today') {
                    createdFilter.value = 'today';
                } else {
                    createdFilter.value = '';
                }
            }
            
            // 목록 재조회 (storeQueryState.status 기준으로 필터링)
            loadStoreList();
        };
        
        // URL 복사
        async function copyStoreUrl(url) {
            try {
                await navigator.clipboard.writeText(url);
                showToast('URL이 클립보드에 복사되었습니다', 'success');
            } catch (err) {
                showToast('URL 복사 실패', 'error');
            }
        }
        
        async function exportStoresCSV() {
            try {
                const response = await fetch(`${API_BASE}/stores/bulk-export?format=csv`);
                if (!response.ok) throw new Error('Failed to export');
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stores_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('CSV 파일이 다운로드되었습니다.', 'success');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showToast('내보내기 실패', 'error');
            }
        }
        async function loadStoreList() {
            try {
                // 점주 계정일 때는 무조건 본인 가게만 조회 (슈퍼어드민이 아닐 때)
                if (IS_STORE_OWNER && !IS_SUPERADMIN) {
                    const ownerId = sessionStorage.getItem('owner_id');
                    if (!ownerId) {
                        console.warn('점주 ID가 없습니다. 로그인 상태를 확인해주세요.');
                        allStores = [];
                        filteredStores = [];
                        document.getElementById('filteredStoresCount').textContent = '0';
                        await renderStoreView();
                        initializeSidebarStoreInfo();
                        updateOwnerStoreActions(0);
                        recalculateStoreStatsFrom(allStores);
                        return;
                    }

                    // 점주 계정은 무조건 ownerId로 필터링하여 본인 가게만 조회
                        try {
                            const storesResponse = await apiRequest(`${API_BASE}/stores?ownerId=${ownerId}`);
                        const normalizedStores = normalizeStoreListResponse(storesResponse);
                        
                        // 연결된 점주가 있는 가게만 필터링 (연결된 점주 없음 가게 제외)
                        const filteredByOwner = normalizedStores.filter(store => {
                            const owners = store.owners || [];
                            // 본인 ownerId와 연결된 가게만 표시
                            return owners.some(owner => owner.id === ownerId);
                        });

                        if (filteredByOwner.length === 0) {
                        allStores = [];
                        filteredStores = [];
                        document.getElementById('filteredStoresCount').textContent = '0';
                        await renderStoreView();
                        initializeSidebarStoreInfo();
                        updateOwnerStoreActions(0);
                            recalculateStoreStatsFrom(allStores);
                        return;
                    }

                        allStores = filteredByOwner;
                        
                        // 점주 모드에서도 storeQueryState.status 필터 적용
                        filteredStores = filteredByOwner.filter(store => {
                            if (!storeQueryState.status || storeQueryState.status === '') {
                                return true;
                            }
                            const storeStatus = (store.status || '').toLowerCase();
                            return storeStatus === storeQueryState.status.toLowerCase();
                        });
                        
                        // createdDate 필터도 적용
                        if (storeQueryState.createdDate) {
                            const filterDate = storeQueryState.createdDate === 'today' 
                                ? new Date().toISOString().split('T')[0]
                                : storeQueryState.createdDate;
                            filteredStores = filteredStores.filter(store => {
                                if (!store.createdAt) return false;
                                const createdDate = new Date(store.createdAt).toISOString().split('T')[0];
                                return createdDate === filterDate;
                            });
                        }
                        
                        updateOwnerStoreActions(filteredByOwner.length);
                        recalculateStoreStatsFrom(allStores);

                        try {
                            const serializedStores = filteredByOwner
                            .map(store => serializeStoreForSession(store))
                            .filter(Boolean);
                        sessionStorage.setItem('owner_store_list', JSON.stringify(serializedStores));
                    } catch (error) {
                        console.warn('owner_store_list 저장 실패:', error);
                    }

                        // 선택 가게 복원 로직
                        const ownerStoreId = sessionStorage.getItem('owner_store_id');
                    let activeStoreId = null;

                        const savedStoreId = localStorage.getItem('currentStoreId');
                        if (savedStoreId && filteredByOwner.some(store => store.id === savedStoreId)) {
                            activeStoreId = savedStoreId;
                        } else if (ownerStoreId && filteredByOwner.some(store => store.id === ownerStoreId)) {
                            activeStoreId = ownerStoreId;
                        } else if (window.currentStoreId && filteredByOwner.some(store => store.id === window.currentStoreId)) {
                            activeStoreId = window.currentStoreId;
                            console.log('✅ [선택 가게 복원] window.currentStoreId에서 복원:', activeStoreId);
                        }
                        // 4순위: 최초 진입 시에만 첫 번째 가게 자동 선택
                        else if (filteredByOwner.length > 0 && !savedStoreId && !ownerStoreId && !window.currentStoreId) {
                            activeStoreId = filteredByOwner[0]?.id;
                            console.log('✅ [선택 가게 복원] 최초 진입 - 첫 번째 가게 자동 선택:', activeStoreId);
                            // 최초 진입 시 localStorage에도 저장
                            if (activeStoreId) {
                                localStorage.setItem('currentStoreId', activeStoreId);
                        }
                    }

                    if (activeStoreId) {
                            // sessionStorage 동기화 (점주 모드)
                        sessionStorage.setItem('owner_store_id', activeStoreId);
                            // window.currentStoreId 동기화
                            window.currentStoreId = activeStoreId;
                            // API 동기화
                        try {
                            await apiRequest(`${API_BASE}/current-store`, 'POST', { storeId: activeStoreId });
                        } catch (error) {
                            console.warn('현재 가게 설정 동기화 실패:', error);
                        }
                        }

                        document.getElementById('filteredStoresCount').textContent = filteredStores.length;
                        populateOwnerFilterOptions(filteredByOwner);
                    await renderStoreView();

                    if (activeStoreId) {
                        await updateSelectedStoreCard(activeStoreId);
                        updateSelectedStoreVisual(activeStoreId);
                    } else {
                        initializeSidebarStoreInfo();
                    }

                    return;
                    } catch (error) {
                        console.error('점주 가게 목록 조회 실패:', error);
                        allStores = [];
                        filteredStores = [];
                        document.getElementById('filteredStoresCount').textContent = '0';
                        await renderStoreView();
                        initializeSidebarStoreInfo();
                        updateOwnerStoreActions(0);
                        recalculateStoreStatsFrom(allStores);
                    return;
                    }
                }

                if (IS_SUPERADMIN && ownerAccounts.length === 0) {
                    await loadOwnerAccounts(ownerStatusFilter);
                }

                // 점주 계정일 때는 본인 가게만 보이도록 필터링
                if (IS_STORE_OWNER && !IS_SUPERADMIN) {
                    const ownerId = sessionStorage.getItem('owner_id');
                    if (ownerId) {
                        storeQueryState.ownerId = ownerId; // 점주 ID로 필터링 강제
                    }
                }
                
                // 초기 로드 시에는 최소한의 데이터만 가져오기 (페이지네이션 기본값 사용)
                const initialLoad = !allStores || allStores.length === 0;
                const pageSize = initialLoad ? '20' : storeQueryState.pageSize.toString(); // 초기 로드 시 20개만

                const query = new URLSearchParams({
                    page: storeQueryState.page.toString(),
                    pageSize: pageSize,
                    sortBy: storeQueryState.sortBy,
                    sortOrder: storeQueryState.sortOrder
                });
                if (storeQueryState.keyword) {
                    query.set('keyword', storeQueryState.keyword);
                }
                if (storeQueryState.status) {
                    query.set('status', storeQueryState.status);
                }
                // 점주 계정일 때는 본인 가게만 보이도록 필터링 (슈퍼어드민이 아닐 때)
                if (IS_STORE_OWNER && !IS_SUPERADMIN) {
                    const ownerId = sessionStorage.getItem('owner_id');
                    if (ownerId) {
                        query.set('ownerId', ownerId);
                    }
                } else if (storeQueryState.ownerId && storeQueryState.ownerId !== '__unassigned') {
                    query.set('ownerId', storeQueryState.ownerId);
                }
                if (storeQueryState.createdDate) {
                    query.set('createdDate', storeQueryState.createdDate);
                }

                // 필터가 적용된 목록 가져오기 (테이블 표시용)
                const storesResponse = await apiRequest(`${API_BASE}/stores?${query.toString()}`);
                const stores = normalizeStoreListResponse(storesResponse);
                filteredStores = [...stores];
                populateOwnerFilterOptions(stores);

                // allStores는 통계 계산용 (대시보드에서만 필요)
                // 초기 로드 시에는 전체 목록을 가져오지 않음 (대시보드 섹션 열 때만 로드)
                if (IS_SUPERADMIN) {
                    // 통계가 필요한 경우에만 전체 목록 가져오기 (지연 로딩)
                    // 여기서는 필터된 목록만 사용
                    if (!allStores || allStores.length === 0) {
                        allStores = [...stores]; // 초기에는 필터된 목록만 사용
                    }
                } else {
                    // 점주 모드에서는 본인 가게만 전체 목록으로 간주
                    allStores = stores;
                }

                if (storeQueryState.ownerId === '__unassigned') {
                    filteredStores = filteredStores.filter(store => {
                        const owners = Array.isArray(store.owners) ? store.owners : [];
                        return owners.length === 0;
                    });
                    storePagination = {
                        page: 1,
                        pageSize: storeQueryState.pageSize,
                        total: filteredStores.length,
                        totalPages: 1
                    };
                    storeQueryState.page = 1;
                }

                if (storeQueryState.ownerId !== '__unassigned') {
                    const pagination = storesResponse?.meta?.pagination || {};
                    storePagination = {
                        page: pagination.page || storeQueryState.page || 1,
                        pageSize: pagination.pageSize || storeQueryState.pageSize,
                        total: pagination.total || stores.length,
                        totalPages: pagination.totalPages || 1
                    };
                    storeQueryState.page = storePagination.page;
                }

                updateOwnerStoreActions(stores.length);

                if (IS_SUPERADMIN) {
                    if (storePagination.total === 0) {
                        showNoStoreGuide();
                        initializeSidebarStoreInfo();
                    } else {
                        resetNoStoreGuideFlag();
                    }
                }

                // 통계 재계산 (항상 allStores 기준)
                recalculateStoreStatsFrom(allStores);
                
                // 통계 숫자와 목록 숫자 동기화
                const filteredCount = filteredStores.length;
                const totalCount = allStores.length;
                document.getElementById('filteredStoresCount').textContent = filteredCount;
                document.getElementById('totalStoresCount').textContent = totalCount;
                await renderStoreView();
                updateStorePaginationControls();
                
                // 슈퍼어드민 모드: 선택 가게 복원 (localStorage 우선)
                if (IS_SUPERADMIN && filteredStores.length > 0) {
                    let activeStoreId = null;
                    
                    // 1순위: localStorage에 저장된 선택 가게 확인
                    const savedStoreId = localStorage.getItem('currentStoreId');
                    if (savedStoreId && filteredStores.some(store => store.id === savedStoreId)) {
                        activeStoreId = savedStoreId;
                        console.log('✅ [선택 가게 복원] localStorage에서 복원:', activeStoreId);
                    }
                    // 2순위: window.currentStoreId 확인
                    else if (window.currentStoreId && filteredStores.some(store => store.id === window.currentStoreId)) {
                        activeStoreId = window.currentStoreId;
                        console.log('✅ [선택 가게 복원] window.currentStoreId에서 복원:', activeStoreId);
                    }
                    // 3순위: getCurrentStoreId()로 복원 시도
                    else {
                        const persistedStoreId = await getCurrentStoreId();
                        if (persistedStoreId && filteredStores.some(store => store.id === persistedStoreId)) {
                            activeStoreId = persistedStoreId;
                            console.log('✅ [선택 가게 복원] getCurrentStoreId()에서 복원:', activeStoreId);
                        }
                    }
                    // 4순위: 최초 진입 시에만 첫 번째 가게 자동 선택
                    if (!activeStoreId && !savedStoreId && !window.currentStoreId) {
                        activeStoreId = filteredStores[0]?.id;
                        console.log('✅ [선택 가게 복원] 최초 진입 - 첫 번째 가게 자동 선택:', activeStoreId);
                        // 최초 진입 시 localStorage에도 저장
                        if (activeStoreId) {
                            localStorage.setItem('currentStoreId', activeStoreId);
                        }
                    }
                    
                    // 선택 가게가 있으면 UI 업데이트
                    if (activeStoreId) {
                        window.currentStoreId = activeStoreId;
                        await updateSelectedStoreCard(activeStoreId);
                        updateSelectedStoreVisual(activeStoreId);
                    } else {
                        // 선택 가게가 없으면 사이드바 초기화
                        initializeSidebarStoreInfo();
                        updateSelectedStoreVisual(null);
                    }
                }
                
            } catch (error) {
                console.error('가게 목록 로드 실패:', error);
                const tbody = document.getElementById('storeTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;">가게 목록을 불러오는데 실패했습니다.</td></tr>';
                }
                showToast('가게 목록을 불러오는데 실패했습니다.', 'error');
            }
        }

        function updateOwnerStoreActions(storeCount) {
            const container = document.getElementById('ownerStoreActions');
            if (!container) return;

            if (!IS_STORE_OWNER) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            const hint = container.querySelector('p');
            if (hint) {
                hint.textContent = storeCount > 0
                    ? '승인된 가게를 선택하면 상세 설정을 관리할 수 있습니다.'
                    : '승인 완료된 가게는 목록에 표시됩니다.';
            }
        }

        // 가게 선택 (영역 클릭)
        async function selectStore(storeId) {
            if (isLoading) return;
            isLoading = true;
            startProgress();
            
            try {
                console.log('🔄 [DEBUG] 가게 선택 시작:', storeId);
                
                // window.currentStoreId 설정 (현재 세션)
                window.currentStoreId = storeId;
                console.log('✅ [DEBUG] window.currentStoreId 설정:', storeId);
                
                // sessionStorage에 저장 (세션 유지)
                sessionStorage.setItem('currentStoreId', storeId);
                console.log('✅ [DEBUG] sessionStorage에 선택 가게 저장:', storeId);
                
                // localStorage에 저장 (새로고침 후 복원용)
                localStorage.setItem('currentStoreId', storeId);
                console.log('✅ [DEBUG] localStorage에 선택 가게 저장:', storeId);
                
                // 점주 모드의 경우 owner_store_id도 저장
                if (IS_STORE_OWNER) {
                    sessionStorage.setItem('owner_store_id', storeId);
                }
                
                // 현재 가게 설정 (백엔드 동기화, 로딩바 없이)
                try {
                    await apiRequest(`${API_BASE}/current-store`, 'POST', { storeId }, 3, false);
                console.log('✅ [DEBUG] 현재 가게 설정 완료');
                } catch (error) {
                    console.warn('⚠️ [DEBUG] 현재 가게 설정 실패 (계속 진행):', error);
                }
                
                // 현재 가게 정보 업데이트 (사이드바)
                await updateCurrentStoreInfo(storeId);
                console.log('✅ [DEBUG] 사이드바 정보 업데이트 완료');
                
                // 선택된 가게 시각적 표시 업데이트 (테이블)
                updateSelectedStoreVisual(storeId);
                console.log('✅ [DEBUG] 테이블 시각적 표시 업데이트 완료');
                
                // 가게 선택 시에는 현재 보이는 섹션의 데이터만 로드
                // 모든 섹션의 로드 플래그 초기화 (새 가게 선택 시)
                const sectionKeys = ['basicSectionLoaded', 'deliverySectionLoaded', 'imagesSectionLoaded', 
                                     'discountSectionLoaded', 'sectionOrderLoaded'];
                sectionKeys.forEach(key => {
                    const fullKey = `${key}_${storeId}`;
                    if (window[fullKey]) {
                        delete window[fullKey];
                    }
                });
                
                // 현재 보이는 섹션이 있으면 해당 섹션의 데이터만 로드
                const visibleSection = document.querySelector('.admin-section[style*="block"]');
                if (visibleSection && visibleSection.id) {
                    const sectionId = visibleSection.id;
                    // showSection을 다시 호출하여 해당 섹션의 데이터만 로드
                    // 중요: loadSectionData 내부에서 최신 storeId를 가져오므로 즉시 호출 가능
                    // setTimeout 제거: 타이밍 이슈 방지를 위해 loadSectionData 내부에서 최신 storeId 사용
                    showSection(sectionId).catch(err => {
                        console.error('섹션 데이터 로드 실패:', err);
                    });
                }
                
                // 사용자 정보 로드 (DB 데이터 → 폼 매핑)
                console.log('🔄 [DEBUG] 가게 선택 후 사용자 정보 로딩 시작');
                await loadUserInfo(storeId);
                console.log('✅ [DEBUG] 가게 선택 후 사용자 정보 로딩 완료');
                
                // 토스트 알림
                const stores = allStores.length > 0
                    ? allStores
                    : normalizeStoreListResponse(await apiRequest(`${API_BASE}/stores`));
                const selectedStore = stores.find(s => s.id === storeId);
                if (selectedStore) {
                    const storeName = selectedStore.basic?.storeName || selectedStore.name || '알 수 없는 가게';
                    showToast(`${storeName} 가게가 선택되었습니다.`, 'success', '가게 선택');
                }
                
            } catch (error) {
                console.error('가게 선택 실패:', error);
                showToast('가게 선택에 실패했습니다.', 'error', '오류');
            } finally {
                isLoading = false;
                completeProgress();
            }
        }

        // 선택된 가게 시각적 표시 업데이트
        function updateSelectedStoreVisual(selectedStoreId) {
            console.log('🎨 [DEBUG] 테이블 시각적 표시 업데이트 시작:', selectedStoreId);
            
            // 전역 선택 상태 동기화
            window.currentStoreId = selectedStoreId || null;

            // 테이블의 모든 행 배경 초기화
            const tbody = document.getElementById('storeTableBody');
            if (!tbody) {
                console.warn('⚠️ [DEBUG] storeTableBody를 찾을 수 없습니다');
                return;
            }
            
            const allRows = tbody.querySelectorAll('tr[data-store-id]');
            console.log(`🎨 [DEBUG] 총 ${allRows.length}개의 행을 처리합니다`);
            
            // 먼저 모든 행을 완전히 초기화
            allRows.forEach((row, index) => {
                const storeId = row.getAttribute('data-store-id');
                
                // 모든 스타일과 클래스 제거
                row.style.background = '';
                row.style.borderLeft = '';
                row.classList.remove('selected-store');
                
                console.log(`🔄 [DEBUG] 행 ${index + 1} (${storeId}) 초기화 완료`);
            });
            
            // 선택된 가게가 있는 경우에만 강조
            if (selectedStoreId) {
                const selectedRow = tbody.querySelector(`tr[data-store-id="${selectedStoreId}"]`);
                if (selectedRow) {
                    selectedRow.style.background = '#eff6ff';
                    selectedRow.style.borderLeft = '4px solid #3b82f6';
                    selectedRow.classList.add('selected-store');
                    console.log(`✅ [DEBUG] 선택된 행 강조 완료: ${selectedStoreId}`);
                } else {
                    console.warn(`⚠️ [DEBUG] 선택된 가게 행을 찾을 수 없습니다: ${selectedStoreId}`);
                }
            } else {
                console.log('ℹ️ [DEBUG] 선택된 가게가 없으므로 모든 행만 초기화');
            }
            
            console.log('✅ [DEBUG] 테이블 시각적 표시 업데이트 완료');
        }

        // 현재 선택된 가게 정보 업데이트
        async function updateCurrentStoreInfo(storeId) {
            try {
                const response = await apiRequest(`${API_BASE}/stores?storeId=${storeId}`);
                const currentStore = normalizeStoreDetailResponse(response, storeId);
                if (currentStore) {
                    // 사이드바의 선택된 가게 정보 업데이트
                    await updateSelectedStoreCard(storeId);
                }
            } catch (error) {
                console.error('현재 가게 정보 업데이트 실패:', error);
            }
        }
        // 사이드바 가게 정보 초기화 (가게 선택되지 않은 경우)
        function initializeSidebarStoreInfo() {
            const nameElement = document.getElementById('selectedStoreName');
            const subtitleElement = document.getElementById('selectedStoreSubtitle');
            const logoElement = document.getElementById('selectedStoreLogo');
            
            if (nameElement) nameElement.textContent = '가게를 선택해주세요';
            if (subtitleElement) subtitleElement.textContent = '좌측 가게 목록에서 선택하세요';
            
            // 기본 로고로 설정
            if (logoElement) {
                const logoImg = logoElement.querySelector('.store-logo-img');
                if (logoImg) {
                    logoImg.src = '/assets/images/icons/default-store.png';
                    logoImg.alt = '기본 가게 로고';
                }
            }
        }
        // 사이드바 가게 정보 업데이트 (가게 선택 시)
        async function updateSidebarStoreInfo(storeId) {
            try {
                const response = await apiRequest(`${API_BASE}/stores?storeId=${storeId}`);
                const selectedStore = normalizeStoreDetailResponse(response, storeId);
                
                if (selectedStore) {
                    const nameElement = document.getElementById('selectedStoreName');
                    const subtitleElement = document.getElementById('selectedStoreSubtitle');
                    const logoElement = document.getElementById('selectedStoreLogo');
                    
                    if (nameElement) nameElement.textContent = selectedStore.name || '이름 없음';
                    if (subtitleElement) subtitleElement.textContent = selectedStore.subtitle || '부제목 없음';
                    
                    // 가게 로고 업데이트
                    if (logoElement) {
                        const logoImg = logoElement.querySelector('.store-logo-img');
                        if (logoImg) {
                            // 가게 설정에서 로고 URL 가져오기
                            const settings = await apiRequest(`${API_BASE}/settings?storeId=${storeId}`);
                            if (settings && settings.basic && settings.basic.storeLogo) {
                                logoImg.src = settings.basic.storeLogo;
                                logoImg.alt = `${selectedStore.name} 로고`;
                            } else {
                                logoImg.src = '/assets/images/icons/default-store.png';
                                logoImg.alt = '기본 가게 로고';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('사이드바 가게 정보 업데이트 실패:', error);
            }
        }
        // 선택된 가게 카드 업데이트
        async function updateSelectedStoreCard(storeId) {
            try {
                if (!storeId) {
                    // 가게가 선택되지 않은 경우 초기화
                    initializeSidebarStoreInfo();
                    return;
                }
                
                const storesResponse = await apiRequest(`${API_BASE}/stores`);
                const storeList = normalizeStoreListResponse(storesResponse);
                const selectedStore = storeList.find(store => store.id === storeId);
                
                if (selectedStore) {
                    const nameElement = document.getElementById('selectedStoreName');
                    const subtitleElement = document.getElementById('selectedStoreSubtitle');
                    const logoElement = document.getElementById('selectedStoreLogo');
                    let storeSubtitle = selectedStore.subtitle || '';
                    let logoUrl = '/assets/images/icons/default-store.png';

                    // 1단계: 가게명과 부제목을 즉시 업데이트 (이미 가져온 데이터 사용)
                    if (nameElement) nameElement.textContent = selectedStore.name || '이름 없음';
                    if (subtitleElement) subtitleElement.textContent = storeSubtitle || '';

                    // 2단계: 로고는 캐시에서 먼저 확인
                    const cacheKey = `settings_${storeId}_images`;
                    const cachedSettings = window.sessionCache?.get(cacheKey);
                    
                    if (logoElement) {
                        const logoImg = logoElement.querySelector('.store-logo-img');
                        if (logoImg) {
                            // 캐시에서 로고 확인
                            if (cachedSettings) {
                                const cachedLogo = cachedSettings.images?.mainLogo || cachedSettings.basic?.storeLogo;
                                if (cachedLogo) {
                                    logoUrl = cachedLogo;
                                    logoImg.src = logoUrl;
                                    logoImg.alt = selectedStore.name ? `${selectedStore.name} 로고` : '기본 가게 로고';
                                } else {
                                    // 캐시에 로고가 없으면 기본 이미지 즉시 표시
                                    logoImg.src = logoUrl;
                                    logoImg.alt = '기본 가게 로고';
                                }
                            } else {
                                // 캐시가 없으면 기본 이미지 먼저 표시 (로딩 중 표시)
                                logoImg.src = logoUrl;
                                logoImg.alt = '로딩 중...';
                            }
                        }
                    }

                    // 3단계: 설정 정보를 백그라운드에서 가져와서 업데이트 (캐시가 없거나 로고가 없는 경우)
                    if (!cachedSettings || (!cachedSettings.images?.mainLogo && !cachedSettings.basic?.storeLogo)) {
                        try {
                            // 선택된 가게의 상세 설정을 불러와 보조 정보 확보
                            const settingsResponse = await apiRequest(`${API_BASE}/settings?storeId=${storeId}&fields=images,basic`);
                            const storeSettings = settingsResponse?.data || settingsResponse || {};

                            if (storeSettings?.basic?.storeSubtitle) {
                                storeSubtitle = storeSettings.basic.storeSubtitle;
                                if (subtitleElement) subtitleElement.textContent = storeSubtitle;
                            }
                            
                            // 로고 업데이트 (API에서 가져온 최신 데이터)
                            if (logoElement) {
                                const logoImg = logoElement.querySelector('.store-logo-img');
                                if (logoImg) {
                                    const newLogoUrl = storeSettings?.images?.mainLogo || storeSettings?.basic?.storeLogo;
                                    if (newLogoUrl) {
                                        logoImg.src = newLogoUrl;
                                        logoImg.alt = selectedStore.name ? `${selectedStore.name} 로고` : '기본 가게 로고';
                                    } else {
                                        logoImg.src = '/assets/images/icons/default-store.png';
                                        logoImg.alt = '기본 가게 로고';
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('선택된 가게 설정 로드 중 오류:', error);
                            // 에러 시에도 기본 로고는 유지
                        }
                    } else if (cachedSettings?.basic?.storeSubtitle) {
                        // 캐시에 부제목이 있으면 업데이트
                        storeSubtitle = cachedSettings.basic.storeSubtitle;
                        if (subtitleElement) subtitleElement.textContent = storeSubtitle;
                    }
                } else {
                    // 가게를 찾을 수 없는 경우 초기화
                    initializeSidebarStoreInfo();
                }
            } catch (error) {
                console.error('선택된 가게 카드 업데이트 실패:', error);
                // 오류 발생 시 초기화
                initializeSidebarStoreInfo();
            }
        }

        // 범용 모달 함수
        function showModal(title, message, buttons = []) {
            const container = document.getElementById('toastContainer') || createToastContainer();
            
            const modal = document.createElement('div');
            modal.className = 'toast input-modal';
            
            // 버튼 HTML 생성
            const buttonsHtml = buttons.map(button => 
                `<button onclick="${button.onclick}" class="btn ${button.class || 'btn-primary'}">${button.text}</button>`
            ).join('');
            
            modal.innerHTML = `
                <div class="toast-header">
                    <span class="toast-icon">⚠️</span>
                    <span class="toast-title">${title}</span>
                    <button class="toast-close" onclick="closeModal()">×</button>
                </div>
                <div class="toast-message">
                    ${message}
                </div>
                <div class="toast-actions">
                    ${buttonsHtml}
                </div>
            `;
            
            container.appendChild(modal);
            
            // 애니메이션을 위해 약간의 지연 후 show 클래스 추가
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        // 모달 닫기 함수
        function closeModal() {
            const modals = document.querySelectorAll('.toast.input-modal, .toast.delete-modal');
            modals.forEach(modal => {
                modal.classList.remove('show');
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }, 300);
            });
        }
        // 가게명 입력 모달 표시
        function showStoreNameModal() {
            const container = document.getElementById('toastContainer') || createToastContainer();
            
            const modal = document.createElement('div');
            modal.className = 'toast input-modal';
            
            modal.innerHTML = `
                <div class="toast-header">
                    <span class="toast-icon">🏬</span>
                    <span class="toast-title">새 가게 추가</span>
                    <button class="toast-close" onclick="closeStoreNameModal(this)">×</button>
                </div>
                <div class="toast-message">
                    새 가게명을 입력하세요
                </div>
                <div class="modal-input-group">
                    <input type="text" id="storeNameInput" placeholder="가게명을 입력하세요" class="modal-input" maxlength="50">
                </div>
                <div class="toast-actions">
                    <button class="toast-btn toast-btn-cancel" onclick="closeStoreNameModal(this)">취소</button>
                    <button class="toast-btn toast-btn-confirm" onclick="confirmStoreName()">추가</button>
                </div>
            `;
            
            container.appendChild(modal);
            
            setTimeout(() => {
                modal.classList.add('show');
                document.getElementById('storeNameInput').focus();
            }, 10);
            
            // Enter 키로 확인
            document.getElementById('storeNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    confirmStoreName();
                }
            });
        }

        // 가게명 입력 모달 닫기
        function closeStoreNameModal(closeButton) {
            const modal = closeButton.closest('.toast');
            modal.classList.remove('show');
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }

        // 가게명 확인 및 추가
        function confirmStoreName() {
            const input = document.getElementById('storeNameInput');
            const storeName = input.value.trim();
            
            if (!storeName) {
                showToast('가게명을 입력해주세요.', 'error', '오류');
                input.focus();
                return;
            }
            
            closeStoreNameModal(document.querySelector('.input-modal .toast-close'));
            addNewStore(storeName);
        }

        // Incremental update: 변경된 가게만 가져와서 목록에 추가/업데이트
        async function incrementalUpdateStoreList(storeIds) {
            try {
                if (!storeIds || storeIds.length === 0) return;
                
                log('INFO', 'Incremental update 시작', { storeIds });
                
                // 변경된 가게만 조회 (배치 API 또는 개별 조회)
                const updatedStores = [];
                for (const storeId of storeIds) {
                    try {
                        const response = await apiRequest(`${API_BASE}/stores/${storeId}`);
                        // normalizeStoreDetailResponse 사용하여 단일 가게 객체 추출
                        const store = normalizeStoreDetailResponse(response, storeId);
                        if (store && store.id) {
                            updatedStores.push(store);
                        }
                    } catch (error) {
                        console.warn(`가게 ${storeId} 조회 실패:`, error);
                    }
                }
                
                if (updatedStores.length === 0) return;
                
                // 목록에 추가/업데이트 (로컬에서만)
                updatedStores.forEach(store => {
                    // 이미 정규화된 가게 객체 (normalizeStoreDetailResponse 사용)
                    if (!store || !store.id) return;
                    
                    const existingIndex = allStores.findIndex(s => s.id === store.id);
                    
                    if (existingIndex >= 0) {
                        // 기존 가게 업데이트
                        allStores[existingIndex] = store;
                        log('INFO', '가게 업데이트 (로컬)', { storeId: store.id, name: store.name || store.basic?.storeName });
                    } else {
                        // 새 가게 추가
                        allStores.push(store);
                        log('INFO', '가게 추가 (로컬)', { storeId: store.id, name: store.name || store.basic?.storeName });
                    }
                });
                
                // 필터링된 목록 재계산 (현재 필터 조건 적용)
                filteredStores = allStores.filter(store => {
                    // 상태 필터
                    if (storeQueryState.status && storeQueryState.status !== '') {
                        const storeStatus = (store.status || '').toLowerCase();
                        if (storeStatus !== storeQueryState.status.toLowerCase()) {
                            return false;
                        }
                    }
                    
                    // 검색 키워드 필터
                    if (storeQueryState.keyword) {
                        const keyword = storeQueryState.keyword.toLowerCase();
                        const name = (store.basic?.storeName || store.name || '').toLowerCase();
                        const phone = (store.basic?.storePhone || store.phone || '').toLowerCase();
                        const address = (store.basic?.storeAddress || store.address || '').toLowerCase();
                        if (!name.includes(keyword) && !phone.includes(keyword) && !address.includes(keyword)) {
                            return false;
                        }
                    }
                    
                    // 점주 필터
                    if (storeQueryState.ownerId === '__unassigned') {
                        const owners = Array.isArray(store.owners) ? store.owners : [];
                        if (owners.length > 0) {
                            return false;
                        }
                    } else if (storeQueryState.ownerId && storeQueryState.ownerId !== '__unassigned') {
                        const owners = Array.isArray(store.owners) ? store.owners : [];
                        if (!owners.some(owner => owner.id === storeQueryState.ownerId)) {
                            return false;
                        }
                    }
                    
                    // 생성일 필터
                    if (storeQueryState.createdDate) {
                        const filterDate = storeQueryState.createdDate === 'today' 
                            ? new Date().toISOString().split('T')[0]
                            : storeQueryState.createdDate;
                        if (!store.createdAt) {
                            return false;
                        }
                        const createdDate = new Date(store.createdAt).toISOString().split('T')[0];
                        if (createdDate !== filterDate) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                // 통계 재계산
                recalculateStoreStatsFrom(allStores);
                
                // 통계 숫자와 목록 숫자 동기화
                const filteredCount = filteredStores.length;
                const totalCount = allStores.length;
                document.getElementById('filteredStoresCount').textContent = filteredCount;
                document.getElementById('totalStoresCount').textContent = totalCount;
                
                // 화면 재렌더링 (전체 목록 다시 로드 없이)
                await renderStoreView();
                updateStorePaginationControls();
                
                log('INFO', 'Incremental update 완료', { updatedCount: updatedStores.length });
            } catch (error) {
                console.error('Incremental update 실패:', error);
                // 실패 시 전체 목록 다시 로드
                await loadStoreList();
            }
        }
        
        // 새 가게 추가 (Incremental update 적용)
        async function addNewStore(storeName) {
            try {
                const newStore = {
                    name: storeName,
                    subtitle: '',
                    phone: '',
                    address: ''
                };
                
                // 개별 가게 객체를 POST로 전송
                const result = await apiRequest(`${API_BASE}/stores`, 'POST', newStore);
                console.log('가게 추가 결과:', result);
                
                // 새로 추가된 가게를 현재 선택된 가게로 설정
                if (result && result.store && result.store.id) {
                    console.log('새 가게 자동 선택 시작:', result.store.id);
                    await selectStore(result.store.id);
                    console.log('새 가게 자동 선택 완료');
                    
                    // Incremental update: 새 가게만 가져와서 목록에 추가
                    await incrementalUpdateStoreList([result.store.id]);
                    
                    showToast(`"${storeName}" 가게가 추가되고 선택되었습니다!`, 'success', '성공');
                } else {
                    console.log('새 가게 자동 선택 실패 - 응답 구조:', result);
                    showToast(`"${storeName}" 가게가 추가되었습니다!`, 'success', '성공');
                    // 전체 목록 다시 로드
                await loadStoreList();
                }
            } catch (error) {
                console.error('가게 추가 실패:', error);
                showToast('가게 추가에 실패했습니다.', 'error', '오류');
            }
        }

        // 가게 삭제 확인 모달 표시
        function showDeleteConfirmModal(storeId, storeName) {
            const container = document.getElementById('toastContainer') || createToastContainer();
            
            const modal = document.createElement('div');
            modal.className = 'toast delete-modal';
            
            modal.innerHTML = `
                <div class="toast-header">
                    <span class="toast-icon">⚠️</span>
                    <span class="toast-title">가게 삭제 확인</span>
                    <button class="toast-close" onclick="closeDeleteConfirmModal(this)">×</button>
                </div>
                <div class="toast-message">
                    <strong>"${storeName}"</strong> 가게를 삭제하시겠습니까?<br>
                    <small style="color: #666; margin-top: 8px; display: block;">이 작업은 되돌릴 수 없습니다.</small>
                </div>
                <div class="toast-actions">
                    <button class="toast-btn toast-btn-cancel" onclick="closeDeleteConfirmModal(this)">취소</button>
                    <button class="toast-btn toast-btn-danger" onclick="confirmDeleteStore('${storeId}')">삭제</button>
                </div>
            `;
            
            container.appendChild(modal);
            
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // 자동 닫기 (15초 후)
            setTimeout(() => {
                closeDeleteConfirmModal(modal.querySelector('.toast-close'));
            }, 15000);
        }

        // 삭제 확인 모달 닫기
        function closeDeleteConfirmModal(closeButton) {
            const modal = closeButton.closest('.toast');
            modal.classList.remove('show');
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }

        // 가게 삭제 확인 및 실행
        async function confirmDeleteStore(storeId) {
            closeDeleteConfirmModal(document.querySelector('.delete-modal .toast-close'));
            await performDeleteStore(storeId);
        }

        // 실제 가게 삭제 수행
        async function performDeleteStore(storeId) {
            try {
                // 현재 선택된 가게가 삭제되는 가게인지 확인
                const currentStoreId = await getCurrentStoreId();
                const isCurrentStore = currentStoreId === storeId;
                
                await apiRequest(`${API_BASE}/stores/${storeId}`, 'DELETE');
                showToast('가게가 삭제되었습니다!', 'success', '성공');
                
                // 삭제된 가게가 현재 선택된 가게인 경우, localStorage에서 제거
                if (isCurrentStore) {
                    localStorage.removeItem('currentStoreId');
                    window.currentStoreId = null;
                    console.log('✅ [가게 삭제] 선택된 가게가 삭제되어 선택 해제:', storeId);
                    try {
                    await apiRequest(`${API_BASE}/current-store`, 'POST', { storeId: null });
                    } catch (apiError) {
                        console.warn('현재 가게 설정 초기화 실패:', apiError);
                    }
                }
                
                // 전체 목록을 다시 가져와서 통계 재계산
                window.shouldReloadAllStores = true;
                await loadStoreList();
                
                // 삭제된 가게가 현재 선택된 가게였다면 사이드바 초기화
                if (isCurrentStore) {
                    initializeSidebarStoreInfo();
                    updateSelectedStoreVisual(null);
                }
            } catch (error) {
                console.error('가게 삭제 실패:', error);
                showToast('가게 삭제에 실패했습니다.', 'error', '오류');
            }
        }

        function openOwnerStoreRequestModal() {
            const modal = document.getElementById('ownerStoreRequestModal');
            if (!modal) return;

            document.getElementById('ownerRequestStoreName').value = '';
            document.getElementById('ownerRequestSubtitle').value = '';
            document.getElementById('ownerRequestPhone').value = '';
            document.getElementById('ownerRequestPostalCode').value = '';
            document.getElementById('ownerRequestRoadAddress').value = '';
            document.getElementById('ownerRequestExtraAddress').value = '';
            document.getElementById('ownerRequestAddressDetail').value = '';
            document.getElementById('ownerRequestFullAddress').value = '';
            document.getElementById('ownerRequestMemo').value = '';

            modal.style.display = 'flex';
        }

        function closeOwnerStoreRequestModal() {
            const modal = document.getElementById('ownerStoreRequestModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function collectOwnerStoreRequestData() {
            return {
                storeName: document.getElementById('ownerRequestStoreName')?.value.trim() || '',
                storeSubtitle: document.getElementById('ownerRequestSubtitle')?.value.trim() || '',
                storePhone: document.getElementById('ownerRequestPhone')?.value.trim() || '',
                postalCode: document.getElementById('ownerRequestPostalCode')?.value.trim() || '',
                roadAddress: document.getElementById('ownerRequestRoadAddress')?.value.trim() || '',
                extraAddress: document.getElementById('ownerRequestExtraAddress')?.value.trim() || '',
                addressDetail: document.getElementById('ownerRequestAddressDetail')?.value.trim() || '',
                memo: document.getElementById('ownerRequestMemo')?.value.trim() || ''
            };
        }

        function openOwnerRequestAddressSearch() {
            if (typeof daum === 'undefined' || !daum?.Postcode) {
                alert('주소 검색 서비스를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            new daum.Postcode({
                oncomplete: function(data) {
                    const postalCodeEl = document.getElementById('ownerRequestPostalCode');
                    const roadAddressEl = document.getElementById('ownerRequestRoadAddress');
                    const extraAddressEl = document.getElementById('ownerRequestExtraAddress');
                    const detailAddressEl = document.getElementById('ownerRequestAddressDetail');

                    if (postalCodeEl) {
                        postalCodeEl.value = data.zonecode || '';
                    }

                    const roadAddress = data.roadAddress || data.jibunAddress || '';
                    if (roadAddressEl) {
                        roadAddressEl.value = roadAddress;
                    }

                    let extraAddress = '';
                    if (data.bname && /[동|로|가]$/g.test(data.bname)) {
                        extraAddress += data.bname;
                    }
                    if (data.buildingName && data.apartment === 'Y') {
                        extraAddress += extraAddress ? `, ${data.buildingName}` : data.buildingName;
                    }
                    if (extraAddressEl) {
                        extraAddressEl.value = extraAddress ? `(${extraAddress})` : '';
                    }

                    if (detailAddressEl) {
                        detailAddressEl.focus();
                    }

                    const state = collectOwnerStoreRequestData();
                    document.getElementById('ownerRequestFullAddress').value = buildWizardFullAddress({
                        postalCode: state.postalCode,
                        roadAddress: state.roadAddress,
                        extraAddress: state.extraAddress,
                        addressDetail: state.addressDetail
                    });
                }
            }).open();
        }

        async function submitOwnerStoreRequest() {
            try {
                if (!IS_STORE_OWNER) {
                    showToast('사장님 전용 기능입니다.', 'error', '권한 부족');
                    return;
                }

                const ownerId = sessionStorage.getItem('owner_id');
                if (!ownerId) {
                    showToast('점주 정보가 확인되지 않습니다. 다시 로그인해주세요.', 'error', '권한 부족');
                    return;
                }

                const data = collectOwnerStoreRequestData();
                if (!data.storeName) {
                    showToast('가게명을 입력해주세요.', 'error', '입력 필요');
                    document.getElementById('ownerRequestStoreName')?.focus();
                    return;
                }

                if (!data.storePhone || !/^0\d{1,2}-\d{3,4}-\d{4}$/.test(data.storePhone)) {
                    showToast('연락처를 정확히 입력해주세요. 예: 010-1234-5678', 'error', '입력 필요');
                    document.getElementById('ownerRequestPhone')?.focus();
                    return;
                }

                if (!data.roadAddress) {
                    showToast('가게 주소를 검색해 입력해주세요.', 'error', '입력 필요');
                    return;
                }

                const payload = {
                    name: data.storeName,
                    subtitle: data.storeSubtitle,
                    phone: data.storePhone,
                    postalCode: data.postalCode,
                    roadAddress: data.roadAddress,
                    extraAddress: data.extraAddress,
                    addressDetail: data.addressDetail,
                    memo: data.memo
                };

                const response = await apiRequest(`${API_BASE}/owners/${ownerId}/stores`, 'POST', payload);
                const message = response?.message || '입점 신청이 접수되었습니다.';
                showToast(message, 'success', '신청 완료');
                closeOwnerStoreRequestModal();
                
                // 전체 목록을 다시 가져와서 통계 재계산
                window.shouldReloadAllStores = true;
                await loadStoreList();
            } catch (error) {
                console.error('추가 입점 신청 실패:', error);
                showToast(error.message || '입점 신청에 실패했습니다.', 'error', '신청 실패');
            }
        }

        // 가게 일시정지
        async function pauseStore(storeId) {
            try {
                await apiRequest(`${API_BASE}/stores/${storeId}/pause`, 'POST');
                showToast('가게가 일시정지되었습니다.', 'success', '성공');
                
                // 전체 목록을 다시 가져와서 통계 재계산
                window.shouldReloadAllStores = true;
                await loadStoreList();
            } catch (error) {
                console.error('가게 일시정지 실패:', error);
                showToast('가게 일시정지에 실패했습니다.', 'error', '오류');
            }
        }

        // 가게 재개
        async function resumeStore(storeId) {
            try {
                await apiRequest(`${API_BASE}/stores/${storeId}/resume`, 'POST');
                showToast('가게가 재개되었습니다.', 'success', '성공');
                
                // 전체 목록을 다시 가져와서 통계 재계산
                window.shouldReloadAllStores = true;
                await loadStoreList();
            } catch (error) {
                console.error('가게 재개 실패:', error);
                showToast('가게 재개에 실패했습니다.', 'error', '오류');
            }
        }


        // 가게 삭제
        async function deleteStore(storeId) {
            const storeName = await getStoreNameById(storeId);
            showDeleteConfirmModal(storeId, storeName);
        }

        // 가게 페이지 보기
        async function viewStorePage(storeId) {
            try {
                console.log('페이지보기 버튼 클릭:', storeId);
                
                // 가게 정보 조회하여 서브도메인 확인
                const response = await apiRequest(`${API_BASE}/stores/${storeId}`);
                console.log('가게 정보 조회 응답:', response);
                
                const store = normalizeStoreDetailResponse(response, storeId);
                console.log('가게 데이터:', store);
                
                let storeUrl;
                
                if (store && store.subdomain) {
                    // 서브도메인이 있는 경우 서브도메인 URL 사용
                    storeUrl = `/${store.subdomain}`;
                    console.log('서브도메인 URL 사용:', storeUrl);
                } else {
                    // 서브도메인이 없는 경우 기존 URL 사용
                    storeUrl = `/store.html?id=${storeId}`;
                    console.log('기존 URL 사용:', storeUrl);
                }
                
                console.log('최종 URL:', storeUrl);
                window.open(storeUrl, '_blank');
            } catch (error) {
                console.error('가게 정보 조회 실패:', error);
                // 에러 시 기존 방식으로 fallback
                const storeUrl = `/store.html?id=${storeId}`;
                console.log('에러 시 fallback URL:', storeUrl);
                window.open(storeUrl, '_blank');
            }
        }

        // 가게명으로 ID 찾기
        async function getStoreNameById(storeId) {
            try {
                console.log('가게명 조회 요청:', storeId);
                const storesResponse = await apiRequest(`${API_BASE}/stores`);
                console.log('가게 목록:', storesResponse);
                const stores = normalizeStoreListResponse(storesResponse);
                const store = stores.find(s => s.id === storeId);
                console.log('찾은 가게:', store);
                return store ? (store.basic?.storeName || '이름 없음') : '알 수 없는 가게';
            } catch (error) {
                console.error('가게명 조회 실패:', error);
                return '알 수 없는 가게';
            }
        }
        // 설정 로드 (필드 선택적 로딩 지원, 세션 캐싱)
        async function loadSettings(fields = null) {
            try {
                const currentStoreId = getCurrentStoreId();
                console.log('🔍 [DEBUG] loadSettings - currentStoreId:', currentStoreId);
                
                if (!currentStoreId) {
                    showStatus('가게를 먼저 선택해주세요.', 'error');
                    return;
                }
                
                // 캐시 키 생성
                const cacheKey = `settings_${currentStoreId}_${fields ? fields.join(',') : 'all'}`;
                
                // 세션 캐시에서 확인
                const cached = window.sessionCache?.get(cacheKey);
                if (cached) {
                    console.log('✅ [캐시] 세션 캐시에서 설정 로드 (즉시 표시):', cacheKey);
                    window.currentSettings = cached;
                    // 캐시에서 가져온 경우 즉시 UI 업데이트만 하고 빠르게 반환
                    // fields 파라미터에 따라 필요한 필드만 빠르게 업데이트
                    const fieldsSet = fields && fields.length > 0 ? new Set(fields.map(f => f.trim())) : null;
                    const shouldUpdateField = (fieldName) => !fieldsSet || fieldsSet.has(fieldName) || fieldsSet.has('*');
                    
                    // 기본 정보만 빠르게 업데이트 (요약 표시용)
                    if (shouldUpdateField('basic')) {
                const storeNameEl = document.getElementById('storeName');
                const storeSubtitleEl = document.getElementById('storeSubtitle');
                const storePhoneEl = document.getElementById('storePhone');
                const storeAddressEl = document.getElementById('storeAddress');
                
                        if (storeNameEl) storeNameEl.value = cached.basic?.storeName || cached.name || '';
                        if (storeSubtitleEl) storeSubtitleEl.value = cached.basic?.storeSubtitle || cached.subtitle || '';
                        if (storePhoneEl) storePhoneEl.value = cached.basic?.storePhone || cached.phone || '';
                        if (storeAddressEl) {
                            const basicSettings = cached.basic || {};
                            storeAddressEl.value = basicSettings.storeAddress || cached.address || '';
                            const storeRoadAddressEl = document.getElementById('storeRoadAddress');
                            if (storeRoadAddressEl) storeRoadAddressEl.value = basicSettings.storeRoadAddress || storeAddressEl.value;
                        }
                    }
                    
                    // 영업시간만 빠르게 업데이트
                    if (shouldUpdateField('businessHours') && typeof loadBusinessHours === 'function') {
                        loadBusinessHours(cached);
                    }
                    
                    // 할인/픽업 설정도 캐시에서 즉시 업데이트
                    if (shouldUpdateField('discount')) {
                        const discountEnabledEl = document.getElementById('discountEnabled');
                        const discountTitleEl = document.getElementById('discountTitle');
                        const discountDescriptionEl = document.getElementById('discountDescription');
                        
                        if (discountEnabledEl) discountEnabledEl.checked = cached.discount?.enabled || false;
                        if (discountTitleEl) discountTitleEl.value = cached.discount?.title || '';
                        if (discountDescriptionEl) discountDescriptionEl.value = cached.discount?.description || '';
                        
                        const discountForm = document.getElementById('discountForm');
                        if (discountForm) {
                            if (cached.discount?.enabled) {
                                discountForm.classList.add('active');
                            } else {
                                discountForm.classList.remove('active');
                            }
                        }
                    }
                    
                    if (shouldUpdateField('pickup')) {
                        const pickupEnabledEl = document.getElementById('pickupEnabled');
                        const pickupTitleEl = document.getElementById('pickupTitle');
                        const pickupDescriptionEl = document.getElementById('pickupDescription');
                        
                        if (pickupEnabledEl) pickupEnabledEl.checked = cached.pickup?.enabled || false;
                        if (pickupTitleEl) pickupTitleEl.value = cached.pickup?.title || '';
                        if (pickupDescriptionEl) pickupDescriptionEl.value = cached.pickup?.description || '';
                        
                        const pickupForm = document.getElementById('pickupForm');
                        if (pickupForm) {
                            if (cached.pickup?.enabled) {
                                pickupForm.classList.add('active');
                            } else {
                                pickupForm.classList.remove('active');
                            }
                        }
                    }
                    
                    // 이미지 설정도 캐시에서 즉시 업데이트
                    if (shouldUpdateField('images') && cached.images) {
                        if (typeof updateImagePreview === 'function') {
                            updateImagePreview('mainLogo', cached.images.mainLogo);
                            updateImagePreview('menuImage', cached.images.menuImage);
                        }
                        if (typeof updateVideoPreview === 'function') {
                            updateVideoPreview('promoVideo', cached.images.promoVideo);
                        }
                    }
                    
                    // 캐시에서 가져왔지만 백그라운드에서 최신 데이터 확인 (비동기)
                    // 캐시 데이터로 빠르게 표시하고 최신 데이터로 갱신
                    setTimeout(async () => {
                        try {
                            const url = fields && fields.length > 0
                                ? `${API_BASE}/settings?storeId=${currentStoreId}&fields=${fields.join(',')}`
                                : `${API_BASE}/settings?storeId=${currentStoreId}`;
                            
                            const latestSettings = await apiRequest(url);
                            
                            // 전역 설정을 최신 데이터로 업데이트
                            window.currentSettings = latestSettings;
                            
                            // 세션 캐시도 최신 데이터로 업데이트
                            if (window.sessionCache) {
                                window.sessionCache.set(cacheKey, latestSettings);
                            }
                            
                            // UI 업데이트 (필요한 필드만)
                            if (shouldUpdateField('discount')) {
                                const discountEnabledEl = document.getElementById('discountEnabled');
                                const discountTitleEl = document.getElementById('discountTitle');
                                const discountDescriptionEl = document.getElementById('discountDescription');
                                
                                if (discountEnabledEl) discountEnabledEl.checked = latestSettings.discount?.enabled || false;
                                if (discountTitleEl) discountTitleEl.value = latestSettings.discount?.title || '';
                                if (discountDescriptionEl) discountDescriptionEl.value = latestSettings.discount?.description || '';
                                
                                const discountForm = document.getElementById('discountForm');
                                if (discountForm) {
                                    if (latestSettings.discount?.enabled) {
                                        discountForm.classList.add('active');
                                    } else {
                                        discountForm.classList.remove('active');
                                    }
                                }
                            }
                            
                            if (shouldUpdateField('pickup')) {
                                const pickupEnabledEl = document.getElementById('pickupEnabled');
                                const pickupTitleEl = document.getElementById('pickupTitle');
                                const pickupDescriptionEl = document.getElementById('pickupDescription');
                                
                                if (pickupEnabledEl) pickupEnabledEl.checked = latestSettings.pickup?.enabled || false;
                                if (pickupTitleEl) pickupTitleEl.value = latestSettings.pickup?.title || '';
                                if (pickupDescriptionEl) pickupDescriptionEl.value = latestSettings.pickup?.description || '';
                                
                                const pickupForm = document.getElementById('pickupForm');
                                if (pickupForm) {
                                    if (latestSettings.pickup?.enabled) {
                                        pickupForm.classList.add('active');
                                    } else {
                                        pickupForm.classList.remove('active');
                                    }
                                }
                            }
                            
                            // 이미지 설정도 최신 데이터로 업데이트
                            if (shouldUpdateField('images') && latestSettings.images) {
                                if (typeof updateImagePreview === 'function') {
                                    updateImagePreview('mainLogo', latestSettings.images.mainLogo);
                                    updateImagePreview('menuImage', latestSettings.images.menuImage);
                                }
                                if (typeof updateVideoPreview === 'function') {
                                    updateVideoPreview('promoVideo', latestSettings.images.promoVideo);
                                }
                            }
                        } catch (error) {
                            console.warn('⚠️ [캐시] 최신 데이터 확인 실패:', error);
                        }
                    }, 100);
                    
                    return cached; // 캐시에서 가져온 경우 즉시 반환
                }
                
                // 캐시에 없으면 API 호출
                // fields 파라미터가 있으면 해당 필드만 요청
                const url = fields && fields.length > 0
                    ? `${API_BASE}/settings?storeId=${currentStoreId}&fields=${fields.join(',')}`
                    : `${API_BASE}/settings?storeId=${currentStoreId}`;
                
                const settings = await apiRequest(url);
                console.log('🔍 [DEBUG] loadSettings - settings:', settings);
                console.log('🔍 [DEBUG] loadSettings - discount:', { enabled: settings.discount?.enabled, title: settings.discount?.title });
                console.log('🔍 [DEBUG] loadSettings - pickup:', { enabled: settings.pickup?.enabled, title: settings.pickup?.title });
                
                // 전역 설정 저장
                window.currentSettings = settings;
                
                // 세션 캐시에 저장 (최신 데이터로 업데이트)
                if (window.sessionCache) {
                    window.sessionCache.set(cacheKey, settings);
                    console.log('✅ [캐시] 세션 캐시에 설정 저장:', cacheKey);
                }
                
                // 캐시에서 가져왔든 API에서 가져왔든 UI 업데이트는 동일하게 수행
                // settings는 이미 위에서 선언되었으므로 재사용
                
                // fields 파라미터에 따라 필요한 필드만 업데이트
                const fieldsSet = fields && fields.length > 0 ? new Set(fields.map(f => f.trim())) : null;
                const shouldUpdateField = (fieldName) => !fieldsSet || fieldsSet.has(fieldName) || fieldsSet.has('*');
                
                // 기본 정보 (basic 필드가 요청되었거나 전체 요청인 경우만)
                if (shouldUpdateField('basic')) {
                    const storeNameEl = document.getElementById('storeName');
                    const storeSubtitleEl = document.getElementById('storeSubtitle');
                    const storePhoneEl = document.getElementById('storePhone');
                    const storeAddressEl = document.getElementById('storeAddress');
                
                if (storeNameEl) {
                    const storeName = settings.basic?.storeName || settings.name || '';
                    storeNameEl.value = storeName;
                }
                if (storeSubtitleEl) {
                    const storeSubtitle = settings.basic?.storeSubtitle || settings.subtitle || '';
                    storeSubtitleEl.value = storeSubtitle;
                }
                if (storePhoneEl) {
                    const storePhone = settings.basic?.storePhone || settings.phone || '';
                    storePhoneEl.value = storePhone;
                }
                if (storeAddressEl) {
                    const basicSettings = settings.basic || {};
                    const storeAddress = basicSettings.storeAddress || settings.address || '';
                    const storePostalCodeEl = document.getElementById('storePostalCode');
                    const storeRoadAddressEl = document.getElementById('storeRoadAddress');
                    const storeExtraAddressEl = document.getElementById('storeExtraAddress');
                    const storeAddressDetailEl = document.getElementById('storeAddressDetail');

                    if (storePostalCodeEl) {
                        storePostalCodeEl.value = basicSettings.storePostalCode || '';
                    }
                    if (storeRoadAddressEl) {
                        storeRoadAddressEl.value = basicSettings.storeRoadAddress || storeAddress;
                    }
                    if (storeExtraAddressEl) {
                        storeExtraAddressEl.value = basicSettings.storeExtraAddress || '';
                    }
                    if (storeAddressDetailEl) {
                        storeAddressDetailEl.value = basicSettings.storeAddressDetail || '';
                    }

                    storeAddressEl.value = storeAddress;
                        if (typeof syncFullAddress === 'function') {
                    syncFullAddress();
                        }
                    }
                }
                
                // 배달앱 설정 (delivery 필드가 요청되었거나 전체 요청인 경우만)
                if (shouldUpdateField('delivery')) {
                const ttaengUrlEl = document.getElementById('ttaengUrl');
                const baeminUrlEl = document.getElementById('baeminUrl');
                const coupangUrlEl = document.getElementById('coupangUrl');
                const yogiyoUrlEl = document.getElementById('yogiyoUrl');
                
                if (ttaengUrlEl) {
                    ttaengUrlEl.value = settings.delivery?.ttaengUrl || '';
                }
                if (baeminUrlEl) {
                    baeminUrlEl.value = settings.delivery?.baeminUrl || '';
                }
                if (coupangUrlEl) {
                    coupangUrlEl.value = settings.delivery?.coupangUrl || '';
                }
                if (yogiyoUrlEl) {
                    yogiyoUrlEl.value = settings.delivery?.yogiyoUrl || '';
                }
                
                // 배달앱 상태 업데이트 (설정 로드 후)
                setTimeout(() => {
                        if (typeof updateAllDeliveryStatuses === 'function') {
                    updateAllDeliveryStatuses();
                        }
                }, 100);
                
                    // 배달앱 순서 렌더링
                    if (typeof renderDeliveryOrder === 'function') {
                        await renderDeliveryOrder();
                    }
                }
                
                // 할인 설정 (discount 필드가 요청되었거나 전체 요청인 경우만)
                if (shouldUpdateField('discount')) {
                    const discountEnabledEl = document.getElementById('discountEnabled');
                    const discountTitleEl = document.getElementById('discountTitle');
                    const discountDescriptionEl = document.getElementById('discountDescription');
                    
                    if (discountEnabledEl) {
                        discountEnabledEl.checked = settings.discount?.enabled || false;
                    }
                    if (discountTitleEl) {
                        discountTitleEl.value = settings.discount?.title || '';
                    }
                    if (discountDescriptionEl) {
                        discountDescriptionEl.value = settings.discount?.description || '';
                    }
                
                // 할인 폼 표시/숨김
                const discountForm = document.getElementById('discountForm');
                    if (discountForm) {
                if (settings.discount?.enabled) {
                    discountForm.classList.add('active');
                } else {
                    discountForm.classList.remove('active');
                        }
                    }
                }
                
                // 픽업 설정 (pickup 필드가 요청되었거나 전체 요청인 경우만)
                if (shouldUpdateField('pickup')) {
                    const pickupEnabledEl = document.getElementById('pickupEnabled');
                    const pickupTitleEl = document.getElementById('pickupTitle');
                    const pickupDescriptionEl = document.getElementById('pickupDescription');
                    
                    if (pickupEnabledEl) {
                        pickupEnabledEl.checked = settings.pickup?.enabled || false;
                    }
                    if (pickupTitleEl) {
                        pickupTitleEl.value = settings.pickup?.title || '';
                    }
                    if (pickupDescriptionEl) {
                        pickupDescriptionEl.value = settings.pickup?.description || '';
                    }
                
                // 픽업 폼 표시/숨김
                const pickupForm = document.getElementById('pickupForm');
                    if (pickupForm) {
                if (settings.pickup?.enabled) {
                    pickupForm.classList.add('active');
                } else {
                    pickupForm.classList.remove('active');
                        }
                    }
                }
                
                // 영업시간 로드 (businessHours 필드가 요청되었거나 전체 요청인 경우만)
                if (shouldUpdateField('businessHours')) {
                    if (typeof loadBusinessHours === 'function') {
                loadBusinessHours(settings);
                    }
                }
                
                // 이미지 설정 (images 필드가 요청되었거나 전체 요청인 경우만)
                if (shouldUpdateField('images') && settings.images) {
                    if (typeof updateImagePreview === 'function') {
                    updateImagePreview('mainLogo', settings.images.mainLogo);
                    updateImagePreview('menuImage', settings.images.menuImage);
                    }
                    if (typeof updateVideoPreview === 'function') {
                    updateVideoPreview('promoVideo', settings.images.promoVideo);
                    }
                }
                
                // 섹션 순서 렌더링 (sectionOrder 필드가 요청되었거나 전체 요청인 경우만)
                if (shouldUpdateField('sectionOrder')) {
                    if (typeof renderSectionOrder === 'function') {
                await renderSectionOrder();
                    }
                }
                
            } catch (error) {
                console.error('설정 로드 실패:', error);
                showStatus('설정을 불러오는데 실패했습니다.', 'error');
            }
        }

        // 기본 정보 저장
        // 영업시간 저장
        async function saveBusinessHours() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) return;
                
                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                const businessHours = {};
                
                days.forEach(day => {
                    const enabled = document.getElementById(`${day}_enabled`).checked;
                    const open = document.getElementById(`${day}_open`).value;
                    const close = document.getElementById(`${day}_close`).value;
                    
                    businessHours[day] = {
                        enabled: enabled,
                        open: open || '09:00',
                        close: close || '22:00'
                    };
                });
                
                // 영업시간만 업데이트
                const updateData = {
                    businessHours: businessHours
                };
                
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', updateData);
                
                showToast('영업시간이 저장되었습니다', 'success');
            } catch (error) {
                console.error('영업시간 저장 실패:', error);
                showToast('영업시간 저장 실패', 'error');
            }
        }
        
        // 영업시간 로드
        function loadBusinessHours(settings) {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const businessHours = settings.businessHours || {};
            
            days.forEach(day => {
                const dayData = businessHours[day] || { enabled: true, open: '09:00', close: '22:00' };
                
                const enabledCheckbox = document.getElementById(`${day}_enabled`);
                const openInput = document.getElementById(`${day}_open`);
                const closeInput = document.getElementById(`${day}_close`);
                
                if (enabledCheckbox) enabledCheckbox.checked = dayData.enabled !== false;
                if (openInput) openInput.value = dayData.open || '09:00';
                if (closeInput) closeInput.value = dayData.close || '22:00';
            });
        }
        
        /**
         * 주소 필드들을 합쳐 숨겨진 전체 주소 값을 최신 상태로 유지합니다.
         */
        function syncFullAddress() {
            const roadAddress = document.getElementById('storeRoadAddress')?.value || '';
            const extraAddress = document.getElementById('storeExtraAddress')?.value || '';
            const detailAddress = document.getElementById('storeAddressDetail')?.value || '';
            const storeAddressEl = document.getElementById('storeAddress');

            if (!storeAddressEl) {
                return;
            }

            const segments = [roadAddress];
            if (extraAddress) {
                segments.push(extraAddress);
            }
            if (detailAddress) {
                segments.push(detailAddress);
            }

            const fullAddress = segments
                .map(segment => segment.trim())
                .filter(Boolean)
                .join(' ')
                .trim();

            storeAddressEl.value = fullAddress;
        }

        /**
         * 카카오 주소 검색 API를 호출하여 우편번호와 도로명 주소를 자동으로 입력합니다.
         */
        function openAddressSearch() {
            if (typeof daum === 'undefined' || !daum?.Postcode) {
                alert('주소 검색 서비스를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            new daum.Postcode({
                oncomplete: function(data) {
                    const postalCodeEl = document.getElementById('storePostalCode');
                    const roadAddressEl = document.getElementById('storeRoadAddress');
                    const extraAddressEl = document.getElementById('storeExtraAddress');
                    const detailAddressEl = document.getElementById('storeAddressDetail');

                    if (postalCodeEl) {
                        postalCodeEl.value = data.zonecode || '';
                    }

                    const roadAddress = data.roadAddress || data.jibunAddress || '';
                    if (roadAddressEl) {
                        roadAddressEl.value = roadAddress;
                    }

                    let extraAddress = '';
                    if (data.bname && /[동|로|가]$/g.test(data.bname)) {
                        extraAddress += data.bname;
                    }
                    if (data.buildingName && data.apartment === 'Y') {
                        extraAddress += extraAddress ? `, ${data.buildingName}` : data.buildingName;
                    }
                    if (extraAddressEl) {
                        extraAddressEl.value = extraAddress ? `(${extraAddress})` : '';
                    }

                    if (detailAddressEl) {
                        detailAddressEl.focus();
                    }

                    syncFullAddress();
                    saveBasicInfo().catch(error => {
                        console.error('주소 자동 저장 실패:', error);
                    });
                }
            }).open();
        }

        /**
         * 상세 주소 입력이 끝났을 때 전체 주소를 다시 저장합니다.
         */
        function handleAddressDetailBlur() {
            syncFullAddress();
            saveBasicInfo().catch(error => {
                console.error('상세 주소 저장 실패:', error);
            });
        }

        function renderBasicSummary() {
            const summaryName = document.getElementById('summaryStoreName');
            const summarySubtitle = document.getElementById('summaryStoreSubtitle');
            const summaryPhone = document.getElementById('summaryStorePhone');
            const summaryAddress = document.getElementById('summaryStoreAddress');
            const summaryDomain = document.getElementById('summaryStoreDomain');
            const summaryQrDownloadBtn = document.getElementById('summaryQrDownloadBtn');
            const summaryDomainNotice = document.getElementById('summaryDomainNotice');

            if (!summaryName || !summarySubtitle || !summaryPhone || !summaryAddress) {
                return;
            }

            const storeNameInput = document.getElementById('storeName');
            const storeSubtitleInput = document.getElementById('storeSubtitle');
            const storePhoneInput = document.getElementById('storePhone');
            const postalInput = document.getElementById('storePostalCode');
            const roadInput = document.getElementById('storeRoadAddress');
            const extraInput = document.getElementById('storeExtraAddress');
            const detailInput = document.getElementById('storeAddressDetail');
            const subdomainInput = document.getElementById('subdomain');

            const nameValue = (storeNameInput?.value || '').trim();
            const subtitleValue = (storeSubtitleInput?.value || '').trim();
            const phoneValue = (storePhoneInput?.value || '').trim();
            const postalCode = (postalInput?.value || '').trim();
            const roadAddress = (roadInput?.value || '').trim();
            const extraAddress = (extraInput?.value || '').trim();
            const detailAddress = (detailInput?.value || '').trim();
            
            // 서브도메인 정보 확인 (input 필드 또는 캐시에서)
            let subdomainValue = '';
            if (subdomainInput && subdomainInput.value) {
                subdomainValue = subdomainInput.value.trim();
            } else {
                // 캐시에서 도메인 설정 확인
                const currentStoreId = getCurrentStoreId();
                if (currentStoreId) {
                    const cacheKey = `domain_settings_${currentStoreId}`;
                    const cached = window.sessionCache?.get(cacheKey);
                    if (cached && cached.subdomain) {
                        subdomainValue = cached.subdomain.trim();
                        // subdomain input에도 업데이트
                        if (subdomainInput) {
                            subdomainInput.value = subdomainValue;
                        }
                    }
                }
                
                // 캐시에 없으면 API 호출 (비동기, 백그라운드)
                if (!subdomainValue && currentStoreId) {
                    loadDomainSettings().then(() => {
                        // 도메인 설정 로드 완료 후 요약 다시 렌더링
                        renderBasicSummary();
                    }).catch(err => {
                        console.warn('도메인 설정 로드 실패 (백그라운드):', err);
                    });
                }
            }

            const addressParts = [];
            if (roadAddress) addressParts.push(roadAddress);
            if (detailAddress) addressParts.push(detailAddress);
            if (extraAddress) addressParts.push(extraAddress);

            let formattedAddress = addressParts.join('\n');
            if (postalCode) {
                formattedAddress = formattedAddress ? `[${postalCode}] ${formattedAddress}` : `[${postalCode}]`;
            }

            summaryName.textContent = nameValue || '-';
            summarySubtitle.textContent = subtitleValue || '-';
            summaryPhone.textContent = phoneValue || '-';
            summaryAddress.textContent = formattedAddress || '-';
            
            // 서브도메인 정보 표시
            if (summaryDomain) {
                if (subdomainValue) {
                    const origin = window.location.origin;
                    const domainUrl = `${origin}/${subdomainValue}`;
                    summaryDomain.textContent = domainUrl;
                    
                    // QR 다운로드 버튼 표시 (QR 코드가 있으면)
                    if (summaryQrDownloadBtn) {
                        const cacheKey = `domain_settings_${getCurrentStoreId()}`;
                        const cached = window.sessionCache?.get(cacheKey);
                        const hasQr = Boolean(cached?.qrCode?.url);
                        if (hasQr) {
                            summaryQrDownloadBtn.style.display = 'inline-flex';
                        } else {
                            summaryQrDownloadBtn.style.display = 'none';
                        }
                    }
                    
                    // 도메인 안내 텍스트
                    if (summaryDomainNotice) {
                        summaryDomainNotice.textContent = `이 주소로 접속하면 ${nameValue || '가게'} 페이지가 표시됩니다.`;
                        summaryDomainNotice.style.display = 'block';
                    }
                } else {
                    summaryDomain.textContent = '설정되지 않음';
                    if (summaryQrDownloadBtn) {
                        summaryQrDownloadBtn.style.display = 'none';
                    }
                    if (summaryDomainNotice) {
                        summaryDomainNotice.textContent = '서브도메인을 설정하면 고유한 주소로 가게 페이지를 제공할 수 있습니다.';
                        summaryDomainNotice.style.display = 'block';
                    }
                }
            }
        }

        async function saveBasicInfo() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    console.log('⚠️ [DEBUG] 가게가 선택되지 않아 저장을 건너뜁니다.');
                    return;
                }
                
                // 주소 필드 동기화
                syncFullAddress();

                // 폼 값 확인
                const storeName = document.getElementById('storeName').value;
                const storeSubtitle = document.getElementById('storeSubtitle').value;
                const storePhone = document.getElementById('storePhone').value;
                const storeAddress = document.getElementById('storeAddress').value;
                const storePostalCode = document.getElementById('storePostalCode').value;
                const storeRoadAddress = document.getElementById('storeRoadAddress').value;
                const storeExtraAddress = document.getElementById('storeExtraAddress').value;
                const storeAddressDetail = document.getElementById('storeAddressDetail').value;
                
                console.log('🔍 [DEBUG] 저장할 기본 정보:', {
                    storeName, storeSubtitle, storePhone, storeAddress,
                    storePostalCode, storeRoadAddress, storeExtraAddress, storeAddressDetail
                });
                
                // 빈 값이면 저장하지 않음
                if (!storeName && !storeSubtitle && !storePhone && !storeAddress) {
                    console.log('⚠️ [DEBUG] 모든 필드가 비어있어 저장을 건너뜁니다.');
                    return;
                }
                
                const settings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                
                settings.basic = {
                    storeName: storeName,
                    storeSubtitle: storeSubtitle,
                    storePhone: storePhone,
                    storeAddress: storeAddress,
                    storePostalCode: storePostalCode,
                    storeRoadAddress: storeRoadAddress,
                    storeExtraAddress: storeExtraAddress,
                    storeAddressDetail: storeAddressDetail
                };
                
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', settings);
                
                // 가게 목록의 subtitle도 동기화 (로컬에서만 업데이트)
                const storesResponse = await apiRequest(`${API_BASE}/stores`);
                const stores = normalizeStoreListResponse(storesResponse);
                const currentStore = stores.find(store => store.id === currentStoreId);
                if (currentStore) {
                    currentStore.subtitle = settings.basic.storeSubtitle;
                    currentStore.name = settings.basic.storeName;
                    currentStore.phone = settings.basic.storePhone;
                    currentStore.address = settings.basic.storeAddress;
                    
                    // 로컬에서만 업데이트 (API 호출 제거)
                    console.log('🔍 [DEBUG] 가게 정보 로컬 업데이트:', currentStore);
                }
                
                // window.currentSettings 업데이트 (설정 가이드 즉시 반영)
                if (!window.currentSettings) {
                    window.currentSettings = settings;
                } else {
                    window.currentSettings.basic = settings.basic;
                }
                
                // 활동 로그 기록
                await logActivity('basic', '기본 정보 변경', 
                    `기본 정보가 변경되었습니다.\n가게명: ${storeName}\n하단 텍스트: ${storeSubtitle}\n전화번호: ${storePhone}\n주소: ${storeAddress}`, 
                    {
                        storeName: storeName,
                        storeSubtitle: storeSubtitle,
                        storePhone: storePhone,
                        storeAddress: storeAddress,
                        storePostalCode,
                        storeRoadAddress,
                        storeExtraAddress,
                        storeAddressDetail
                    }
                );
                
                showStatus('가게명, 하단 텍스트, 전화번호, 주소가 저장되었습니다!', 'success');
                renderBasicSummary();
                
                // 설정 가이드 자동 갱신 (설정 저장 후 즉시 반영)
                await refreshSetupGuideIfVisible();
                
                // 가게 목록 다시 로드하여 변경사항 반영
                await loadStoreList();
            } catch (error) {
                console.error('기본 정보 저장 실패:', error);
                showStatus('기본 정보 저장에 실패했습니다.', 'error');
            }
        }

        // 전체 주소를 개별 필드로 파싱하는 함수
        function parseFullAddressToFields(fullAddress) {
            if (!fullAddress || !fullAddress.trim()) {
                return { postalCode: '', roadAddress: '', extraAddress: '', addressDetail: '' };
            }
            
            let roadAddress = fullAddress.trim();
            let extraAddress = '';
            let addressDetail = '';
            
            // 괄호 안의 내용을 참고항목으로 추출 (예: "(서초동, 서초그랑자이)")
            const extraMatch = roadAddress.match(/\(([^)]+)\)/);
            if (extraMatch) {
                extraAddress = `(${extraMatch[1]})`;
                roadAddress = roadAddress.replace(/\([^)]+\)/, '').trim();
            }
            
            // 마지막 숫자나 단어를 상세주소로 추출 (예: "1", "101호" 등)
            // 도로명 주소와 상세주소를 구분하기 위해 마지막 부분을 확인
            const parts = roadAddress.split(/\s+/);
            if (parts.length > 0) {
                const lastPart = parts[parts.length - 1];
                // 마지막 부분이 숫자로 시작하거나 호수 형식이면 상세주소로 분리
                if (/^\d/.test(lastPart) || /호$/.test(lastPart)) {
                    addressDetail = lastPart;
                    roadAddress = parts.slice(0, -1).join(' ').trim();
                }
            }
            
            return {
                postalCode: '', // 우편번호는 주소 검색 API를 통해서만 얻을 수 있음
                roadAddress: roadAddress,
                extraAddress: extraAddress,
                addressDetail: addressDetail
            };
        }

        function openBasicInfoWizard() {
            const modal = document.getElementById('basicInfoWizardModal');
            if (!modal) return;

            const storeName = document.getElementById('storeName')?.value || '';
            const storeSubtitle = document.getElementById('storeSubtitle')?.value || '';
            const storePhone = document.getElementById('storePhone')?.value || '';
            let postalCode = document.getElementById('storePostalCode')?.value || '';
            let roadAddress = document.getElementById('storeRoadAddress')?.value || '';
            let extraAddress = document.getElementById('storeExtraAddress')?.value || '';
            let addressDetail = document.getElementById('storeAddressDetail')?.value || '';
            const storeAddress = document.getElementById('storeAddress')?.value || '';
            const existingSubdomain = document.getElementById('subdomain')?.value || '';

            // 개별 필드가 비어있고 전체 주소만 있는 경우, 파싱해서 각 필드에 분리
            if ((!roadAddress && !extraAddress && !addressDetail) && storeAddress) {
                const parsed = parseFullAddressToFields(storeAddress);
                if (!roadAddress) roadAddress = parsed.roadAddress;
                if (!extraAddress) extraAddress = parsed.extraAddress;
                if (!addressDetail) addressDetail = parsed.addressDetail;
            }

            basicWizardState.storeName = storeName;
            basicWizardState.storeSubtitle = storeSubtitle;
            basicWizardState.storePhone = storePhone;
            basicWizardState.postalCode = postalCode;
            basicWizardState.roadAddress = roadAddress;
            basicWizardState.extraAddress = extraAddress;
            basicWizardState.addressDetail = addressDetail;
            basicWizardState.subdomain = existingSubdomain;

            const subdomainInputEl = document.getElementById('subdomain');
            const hasSubdomain = Boolean((existingSubdomain || '').trim());
            const qrLockedFromInput = subdomainInputEl?.dataset?.qrLocked === 'true';
            const qrLockedEffective = qrLockedFromInput || domainPermissionState.qrLocked;

            domainPermissionState.hasSubdomain = hasSubdomain;
            domainPermissionState.qrLocked = qrLockedEffective;

            // 도메인 단계는 별도 섹션으로 분리되어 제거됨
            basicWizardSteps = ['basic', 'contact', 'review'];

            document.getElementById('wizardStoreName').value = storeName;
            document.getElementById('wizardStoreSubtitle').value = storeSubtitle;
            document.getElementById('wizardStorePhone').value = storePhone;
            document.getElementById('wizardPostalCode').value = postalCode;
            document.getElementById('wizardRoadAddress').value = roadAddress;
            document.getElementById('wizardExtraAddress').value = extraAddress;
            document.getElementById('wizardAddressDetail').value = addressDetail;
            document.getElementById('wizardFullAddress').value = buildWizardFullAddress({
                postalCode,
                roadAddress,
                extraAddress,
                addressDetail
            });
            // 도메인 단계는 별도 섹션으로 분리되어 제거됨

            basicWizardStepIndex = 0;
            setBasicWizardStep(0);
            updateBasicWizardReview(basicWizardState);

            modal.style.display = 'flex';
        }

        function closeBasicInfoWizard() {
            const modal = document.getElementById('basicInfoWizardModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function setBasicWizardStep(stepIndex) {
            const modal = document.getElementById('basicInfoWizardModal');
            if (!modal) return;

            basicWizardStepIndex = Math.max(0, Math.min(stepIndex, basicWizardSteps.length - 1));
            const currentStepKey = basicWizardSteps[basicWizardStepIndex];

            const steps = modal.querySelectorAll('.wizard-step');
            steps.forEach(stepEl => {
                const key = stepEl.getAttribute('data-step-key');
                const isConfigured = basicWizardSteps.includes(key);
                const isActive = isConfigured && key === currentStepKey;
                if (isConfigured) {
                    stepEl.classList.toggle('active', isActive);
                    stepEl.style.display = isActive ? '' : 'none';
                } else {
                    stepEl.classList.remove('active');
                    stepEl.style.display = 'none';
                }
            });

            const indicators = modal.querySelectorAll('.wizard-step-indicator');
            indicators.forEach(indicator => {
                const key = indicator.getAttribute('data-step-key');
                const isVisible = basicWizardSteps.includes(key);
                indicator.style.display = isVisible ? 'flex' : 'none';
                indicator.classList.toggle('active', key === currentStepKey);
                const numberSpan = indicator.querySelector('span');
                if (numberSpan && isVisible) {
                    numberSpan.textContent = (basicWizardSteps.indexOf(key) + 1).toString();
                }
            });

            const prevBtn = document.getElementById('basicWizardPrevBtn');
            const nextBtn = document.getElementById('basicWizardNextBtn');
            const saveBtn = document.getElementById('basicWizardSaveBtn');

            if (prevBtn) prevBtn.style.display = basicWizardStepIndex === 0 ? 'none' : 'inline-flex';
            if (nextBtn) nextBtn.style.display = basicWizardStepIndex === basicWizardSteps.length - 1 ? 'none' : 'inline-flex';
            if (saveBtn) saveBtn.style.display = basicWizardStepIndex === basicWizardSteps.length - 1 ? 'inline-flex' : 'none';

            // 도메인은 별도 섹션으로 분리되어 제거됨
            updateBasicWizardReview(basicWizardState);
        }

        function collectBasicWizardData() {
            return {
                storeName: document.getElementById('wizardStoreName')?.value.trim() || '',
                storeSubtitle: document.getElementById('wizardStoreSubtitle')?.value.trim() || '',
                storePhone: document.getElementById('wizardStorePhone')?.value.trim() || '',
                postalCode: document.getElementById('wizardPostalCode')?.value.trim() || '',
                roadAddress: document.getElementById('wizardRoadAddress')?.value.trim() || '',
                extraAddress: document.getElementById('wizardExtraAddress')?.value.trim() || '',
                addressDetail: document.getElementById('wizardAddressDetail')?.value.trim() || ''
                // 도메인은 별도 섹션으로 분리되어 제거됨
            };
        }

        function handleBasicWizardNext() {
            const currentStepKey = basicWizardSteps[basicWizardStepIndex];
            if (!validateBasicWizardStep(currentStepKey)) {
                return;
            }
            Object.assign(basicWizardState, collectBasicWizardData());
            updateBasicWizardReview(basicWizardState);
            setBasicWizardStep(basicWizardStepIndex + 1);
        }

        function handleBasicWizardPrev() {
            setBasicWizardStep(basicWizardStepIndex - 1);
        }

        function buildWizardFullAddress(state) {
            const { postalCode, roadAddress, extraAddress, addressDetail } = state;
            const parts = [];
            if (roadAddress) parts.push(roadAddress);
            if (addressDetail) parts.push(addressDetail);
            if (extraAddress) parts.push(extraAddress);
            let full = parts.join(' ');
            if (postalCode) {
                full = full ? `[${postalCode}] ${full}` : `[${postalCode}]`;
            }
            return full;
        }

        function updateWizardDomainPreview(subdomain) {
            const previewEl = document.getElementById('wizardDomainPreview');
            if (!previewEl) return;
            const origin = window.location.origin || window.location.host || '';
            if (subdomain && subdomain.length > 0) {
                previewEl.textContent = `${origin.replace(/\/+$/, '')}/${subdomain}`;
            } else if (domainPermissionState.hasSubdomain && !shouldShowDomainStep) {
                previewEl.textContent = `${origin.replace(/\/+$/, '')}/${(document.getElementById('subdomain')?.value || '').replace(/^\/+/, '')}`;
            } else {
                previewEl.textContent = `${origin.replace(/\/+$/, '')}/(미설정)`;
            }
        }

        function updateBasicWizardReview(state) {
            document.getElementById('wizardReviewStoreName').textContent = state.storeName || '-';
            document.getElementById('wizardReviewStoreSubtitle').textContent = state.storeSubtitle || '-';
            document.getElementById('wizardReviewStorePhone').textContent = state.storePhone || '-';
            document.getElementById('wizardReviewStoreAddress').textContent = buildWizardFullAddress(state) || '-';
            // 도메인은 별도 섹션으로 분리되어 제거됨
        }

        function validateBasicWizardStep(stepKey) {
            if (stepKey === 'basic') {
                const name = document.getElementById('wizardStoreName')?.value.trim();
                if (!name) {
                    showToast('가게명을 입력해주세요.', 'error', '입력 필요');
                    document.getElementById('wizardStoreName')?.focus();
                    return false;
                }
            }
            if (stepKey === 'contact') {
                const phone = document.getElementById('wizardStorePhone')?.value.trim();
                if (phone && !/^0\d{1,2}-\d{3,4}-\d{4}$/.test(phone)) {
                    showToast('전화번호 형식이 올바르지 않습니다. 예: 010-1234-5678', 'error', '입력 필요');
                    document.getElementById('wizardStorePhone')?.focus();
                    return false;
                }
            }
            // 도메인 단계는 별도 섹션으로 분리되어 제거됨
            return true;
        }

        async function submitBasicInfoWizard() {
            Object.assign(basicWizardState, collectBasicWizardData());
            const modal = document.getElementById('basicInfoWizardModal');
            try {
                document.getElementById('storeName').value = basicWizardState.storeName;
                document.getElementById('storeSubtitle').value = basicWizardState.storeSubtitle;
                document.getElementById('storePhone').value = basicWizardState.storePhone;
                document.getElementById('storePostalCode').value = basicWizardState.postalCode;
                document.getElementById('storeRoadAddress').value = basicWizardState.roadAddress;
                document.getElementById('storeExtraAddress').value = basicWizardState.extraAddress;
                document.getElementById('storeAddressDetail').value = basicWizardState.addressDetail;
                document.getElementById('storeAddress').value = buildWizardFullAddress(basicWizardState);

                await saveBasicInfo();

                if (basicWizardSteps.includes('domain') && shouldShowDomainStep) {
                    const newSubdomain = (basicWizardState.subdomain || '').trim();
                    if (newSubdomain) {
                        document.getElementById('subdomain').value = newSubdomain;
                        await saveDomainSettings({
                            subdomain: newSubdomain,
                            suppressToast: true,
                            skipReload: true
                        });
                        showToast('도메인 설정이 저장되었습니다.', 'success', '도메인 저장');
                    }
                }

                await loadDomainSettings();
                closeBasicInfoWizard();
            } catch (error) {
                console.error('기본 정보 저장 실패:', error);
                showToast('기본 정보를 저장하지 못했습니다.', 'error', '저장 실패');
            } finally {
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        }

        async function handleWizardGenerateDomainQR() {
            if (!IS_SUPERADMIN) {
                showToast('QR 생성은 슈퍼어드민만 가능합니다.', 'error', '권한 부족');
                return;
            }
            if (!shouldShowDomainStep) {
                showToast('이미 서브도메인이 설정되어 있습니다.', 'info', '도메인 설정 완료');
                return;
            }
            const subdomainInput = document.getElementById('wizardSubdomain');
            const subdomainValue = subdomainInput?.value.trim() || '';
            if (!subdomainValue) {
                showToast('서브도메인을 입력해주세요.', 'error', '입력 필요');
                subdomainInput?.focus();
                return;
            }
            try {
                document.getElementById('subdomain').value = subdomainValue;
                basicWizardState.subdomain = subdomainValue;
                await saveDomainSettings({
                    subdomain: subdomainValue,
                    suppressToast: true,
                    skipReload: true
                });
                updateWizardDomainPreview(subdomainValue);
                updateBasicWizardReview(basicWizardState);
                generateDomainQR();
            } catch (error) {
                console.error('Wizard QR 생성 실패:', error);
                showToast('QR 코드를 생성하지 못했습니다.', 'error', 'QR 생성 실패');
            }
        }

        function openWizardAddressSearch() {
            if (typeof daum === 'undefined' || !daum?.Postcode) {
                alert('주소 검색 서비스를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            new daum.Postcode({
                oncomplete: function(data) {
                    const postalCodeEl = document.getElementById('wizardPostalCode');
                    const roadAddressEl = document.getElementById('wizardRoadAddress');
                    const extraAddressEl = document.getElementById('wizardExtraAddress');
                    const detailAddressEl = document.getElementById('wizardAddressDetail');

                    if (postalCodeEl) {
                        postalCodeEl.value = data.zonecode || '';
                    }

                    const roadAddress = data.roadAddress || data.jibunAddress || '';
                    if (roadAddressEl) {
                        roadAddressEl.value = roadAddress;
                    }

                    let extraAddress = '';
                    if (data.bname && /[동|로|가]$/g.test(data.bname)) {
                        extraAddress += data.bname;
                    }
                    if (data.buildingName && data.apartment === 'Y') {
                        extraAddress += extraAddress ? `, ${data.buildingName}` : data.buildingName;
                    }
                    if (extraAddressEl) {
                        extraAddressEl.value = extraAddress ? `(${extraAddress})` : '';
                    }

                    if (detailAddressEl) {
                        detailAddressEl.focus();
                    }

                    Object.assign(basicWizardState, collectBasicWizardData());
                    document.getElementById('wizardFullAddress').value = buildWizardFullAddress(basicWizardState);
                    updateBasicWizardReview(basicWizardState);
                }
            }).open();
        }
        // 배달앱 표시 순서 그리드 로드
        async function loadDeliveryOrderGrid() {
            try {
                const currentStoreId = getCurrentStoreId(); // 동기 함수로 변경
                if (!currentStoreId) return;
                
                // 캐시에서 설정 가져오기 (이미 loadSettings에서 가져왔으므로)
                const settings = window.currentSettings || {};
                const deliveryOrder = settings.delivery?.deliveryOrder || ['ttaeng', 'baemin', 'coupang', 'yogiyo'];
                
                const appConfigs = {
                    'ttaeng': { name: '땡겨요', iconClass: 'ttaeng' },
                    'baemin': { name: '배달의민족', iconClass: 'baemin' },
                    'coupang': { name: '쿠팡이츠', iconClass: 'coupang' },
                    'yogiyo': { name: '요기요', iconClass: 'yogiyo' }
                };
                
                const gridContainer = document.getElementById('deliveryOrderGrid');
                if (!gridContainer) return;
                
                // 그리드 내용 즉시 생성 (이미지 로딩 대기하지 않음)
                gridContainer.innerHTML = '';
                
                deliveryOrder.forEach((appId, index) => {
                    const config = appConfigs[appId];
                    const url = settings.delivery?.[`${appId}Url`] || '';
                    const hasUrl = url && url.trim() !== '';
                    
                    // 강력한 디버깅을 위한 로그 추가
                    console.log(`[배달앱 그리드] ${appId}: URL="${url}", hasUrl=${hasUrl}, 상태=${hasUrl ? '활성' : '준비중'}`);
                    
                    const gridItem = document.createElement('div');
                    gridItem.className = `delivery-grid-item ${hasUrl ? 'has-url' : 'no-url'}`;
                    gridItem.setAttribute('data-app-id', appId);
                    gridItem.setAttribute('draggable', 'true');
                    
                    const statusText = hasUrl ? '활성' : '준비중';
                    const statusClass = hasUrl ? 'active' : 'inactive';
                    
                    gridItem.innerHTML = `
                        <div class="app-icon ${config.iconClass}"></div>
                        <div class="app-name">${config.name}</div>
                        <div class="app-status ${statusClass}">${statusText}</div>
                    `;
                    
                    gridContainer.appendChild(gridItem);
                    
                    // 각 아이템이 추가된 후 즉시 상태 확인
                    console.log(`[배달앱 그리드] ${appId} 아이템 추가 완료 - 상태: ${statusText}`);
                });
                
                // SortableJS 초기화
                initializeSortable();
            } catch (error) {
                console.error('배달앱 표시 순서 그리드 로드 실패:', error);
                const gridContainer = document.getElementById('deliveryOrderGrid');
                if (gridContainer) {
                    gridContainer.innerHTML = '<div class="error-message">로드 실패</div>';
                }
            }
        }
        // 배달앱 URL 편집
        function editDeliveryUrl(appId) {
            const inputId = `${appId}Url`;
            const inputElement = document.getElementById(inputId);
            if (inputElement) {
                inputElement.focus();
                inputElement.select();
            }
        }

        // 배달앱 URL 저장 (CRUD 완전 구현)
        // 모든 배달앱 설정 저장 (URL + 순서)
        async function saveAllDeliverySettings() {
            const saveBtn = document.getElementById('saveDeliverySettingsBtn');
            const statusSpan = document.getElementById('deliverySettingsSaveStatus');
            
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '저장 중...';
            }
            if (statusSpan) {
                statusSpan.textContent = '저장 중...';
                statusSpan.style.color = '#64748b';
            }
            
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    throw new Error('가게를 선택해주세요.');
                }
                
                // 현재 서버 설정 가져오기
                const settings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                
                // 로컬 상태에서 URL과 순서 가져오기
                const ttaengUrl = document.getElementById('ttaengUrl')?.value || '';
                const baeminUrl = document.getElementById('baeminUrl')?.value || '';
                const coupangUrl = document.getElementById('coupangUrl')?.value || '';
                const yogiyoUrl = document.getElementById('yogiyoUrl')?.value || '';
                
                // 현재 그리드 순서 가져오기
                const gridItems = document.querySelectorAll('#deliveryOrderGrid .delivery-grid-item');
                const currentOrder = Array.from(gridItems).map(item => item.getAttribute('data-app-id'));
                
                // 배달앱 설정 업데이트
                settings.delivery = {
                    ...(settings.delivery || {}),
                    ttaengUrl: ttaengUrl.trim(),
                    baeminUrl: baeminUrl.trim(),
                    coupangUrl: coupangUrl.trim(),
                    yogiyoUrl: yogiyoUrl.trim(),
                    deliveryOrder: currentOrder.length > 0 ? currentOrder : localDeliveryOrder
                };
                
                console.log('저장할 배달앱 설정:', settings.delivery);
                
                // 서버에 저장
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', settings);
                
                // 로컬 순서 업데이트
                localDeliveryOrder = settings.delivery.deliveryOrder;
                
                // 변경 추적 리셋
                deliverySettingsChanged = false;
                
                if (saveBtn) {
                    saveBtn.textContent = '저장';
                }
                if (statusSpan) {
                    statusSpan.textContent = '저장 완료';
                    statusSpan.style.color = '#10b981';
                    setTimeout(() => {
                        statusSpan.textContent = '';
                    }, 2000);
                }
                
                showToast('배달앱 설정이 저장되었습니다!', 'success', '저장 완료');
                
                // 활동 로그 기록
                try {
                    const appNames = {
                        'ttaeng': '땡겨요',
                        'baemin': '배달의민족',
                        'coupang': '쿠팡이츠',
                        'yogiyo': '요기요'
                    };
                    const orderNames = settings.delivery.deliveryOrder.map(id => appNames[id] || id).join(' → ');
                    await logActivity('settings', '배달앱 설정 변경', 
                        `배달앱 URL 및 순서 변경\n순서: ${orderNames}`, {
                        delivery: settings.delivery
                    });
                } catch (logError) {
                    console.warn('활동 로그 기록 실패:', logError);
                }
                
            } catch (error) {
                console.error('배달앱 설정 저장 실패:', error);
                showToast('배달앱 설정 저장에 실패했습니다.', 'error', '저장 실패');
                
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '저장';
                }
                if (statusSpan) {
                    statusSpan.textContent = '저장 실패';
                    statusSpan.style.color = '#ef4444';
                }
            }
        }

        // 배달앱 순서 목록 렌더링 (2x2 그리드 + 드래그앤드롭)
        async function renderDeliveryOrder() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) return;
                
                const settings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                const deliveryOrder = settings.delivery?.deliveryOrder || ['ttaeng', 'baemin', 'coupang', 'yogiyo'];
                
                // 로컬 순서 초기화
                localDeliveryOrder = [...deliveryOrder];
                
                // 변경 추적 리셋 (초기 로드 시)
                deliverySettingsChanged = false;
                const saveBtn = document.getElementById('saveDeliverySettingsBtn');
                const statusSpan = document.getElementById('deliverySettingsSaveStatus');
                if (saveBtn) {
                    saveBtn.disabled = true;
                }
                if (statusSpan) {
                    statusSpan.textContent = '';
                }
                
                const appConfigs = {
                    'ttaeng': { name: '땡겨요', iconClass: 'ttaeng' },
                    'baemin': { name: '배달의민족', iconClass: 'baemin' },
                    'coupang': { name: '쿠팡이츠', iconClass: 'coupang' },
                    'yogiyo': { name: '요기요', iconClass: 'yogiyo' }
                };
                
                const gridContainer = document.getElementById('deliveryOrderGrid');
                if (!gridContainer) return;
                
                gridContainer.innerHTML = '';
                
                deliveryOrder.forEach((appId, index) => {
                    const config = appConfigs[appId];
                    if (!config) return;
                    
                    // 현재 입력 필드에서 URL 가져오기 (로컬 상태 반영)
                    const urlInput = document.getElementById(`${appId}Url`);
                    const url = urlInput ? urlInput.value.trim() : (settings.delivery?.[`${appId}Url`] || '');
                    const isActive = url && url.trim() !== '';
                    
                    const item = document.createElement('div');
                    item.className = 'delivery-grid-item';
                    item.setAttribute('data-app-id', appId);
                    item.innerHTML = `
                        <div class="drag-handle">⋮⋮</div>
                        <div class="app-icon ${config.iconClass}"></div>
                        <div class="app-name">${config.name}</div>
                        <div class="app-status ${isActive ? 'active' : ''}">
                            ${isActive ? '활성' : '준비중'}
                        </div>
                    `;
                    gridContainer.appendChild(item);
                });
                
                // SortableJS 초기화
                initializeSortable();
                
            } catch (error) {
                console.error('배달앱 순서 렌더링 실패:', error);
            }
        }

        // 배달앱 설정 변경 추적 변수
        let deliverySettingsChanged = false;
        let localDeliveryOrder = ['ttaeng', 'baemin', 'coupang', 'yogiyo'];
        
        // 배달앱 설정 변경 표시
        function markDeliverySettingsChanged() {
            deliverySettingsChanged = true;
            const saveBtn = document.getElementById('saveDeliverySettingsBtn');
            const statusSpan = document.getElementById('deliverySettingsSaveStatus');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            }
            if (statusSpan) {
                statusSpan.textContent = '저장되지 않은 변경사항이 있습니다.';
                statusSpan.style.color = '#f59e0b';
            }
        }
        
        // SortableJS 드래그앤드롭 초기화
        function initializeSortable() {
            const gridContainer = document.getElementById('deliveryOrderGrid');
            if (!gridContainer || !window.Sortable) return;
            
            // 기존 Sortable 인스턴스가 있다면 제거
            if (window.deliverySortable) {
                window.deliverySortable.destroy();
            }
            
            window.deliverySortable = new Sortable(gridContainer, {
                animation: 200,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'dragging',
                onStart: function(evt) {
                    console.log('🔄 [DEBUG] 배달앱 드래그 시작:', evt.item.getAttribute('data-app-id'));
                },
                onEnd: function(evt) {
                    console.log('✅ [DEBUG] 배달앱 드래그 완료');
                    // 로컬 상태만 업데이트 (즉시 저장하지 않음)
                    const gridItems = document.querySelectorAll('#deliveryOrderGrid .delivery-grid-item');
                    localDeliveryOrder = Array.from(gridItems).map(item => item.getAttribute('data-app-id'));
                    markDeliverySettingsChanged();
                }
            });
        }


        // 활동 로그 기록 (개선된 버전)
        async function logActivity(logType, action, description, details = null, beforeData = null, afterData = null) {
            // 현재 선택된 가게 ID 가져오기
            const currentStoreId = window.currentStoreId;
            if (!currentStoreId) {
                console.warn('⚠️ [DEBUG] 현재 선택된 가게가 없어 활동 로그를 기록할 수 없습니다.');
                return;
            }
            
            // 타임스탬프 생성
            const timestamp = new Date().toISOString();
            
            // 상세한 로그 데이터 구성
            const logData = {
                storeId: currentStoreId,
                logType: logType,
                action: action,
                description: description,
                details: details || {},
                before: beforeData || null,
                after: afterData || null,
                timestamp: timestamp,
                user: 'admin',
                ip: '127.0.0.1', // 로컬 개발 환경
                userAgent: navigator.userAgent
            };
            
            // 변경사항이 있는 경우 상세 정보 추가
            if (beforeData && afterData) {
                const changes = [];
                
                // 객체 비교하여 변경사항 추출
                for (const key in afterData) {
                    if (beforeData[key] !== afterData[key]) {
                        changes.push({
                            field: key,
                            before: beforeData[key],
                            after: afterData[key]
                        });
                    }
                }
                
                if (changes.length > 0) {
                    logData.changes = changes;
                    logData.changeCount = changes.length;
                }
            }
            
            try {
                console.log('📝 [DEBUG] 활동 로그 기록 시도:', logData);
                const response = await apiRequest('/api/activity-logs', 'POST', logData);
                console.log('✅ [DEBUG] 활동 로그 기록 성공:', response);
                
                // 활동 로그 목록 새로고침
                if (typeof displayActivityLogs === 'function') {
                    await displayActivityLogs();
                }
            } catch (error) {
                console.error('❌ [DEBUG] 활동 로그 기록 실패:', error);
                // 로컬 폴백 처리
                console.log('🔄 [DEBUG] 서버 저장 실패 - 로컬 폴백 처리 시도');
                try {
                    const localLogs = JSON.parse(localStorage.getItem('localActivityLogs') || '[]');
                    localLogs.push({
                        ...logData,
                        id: 'local_' + Date.now(),
                        source: 'local_fallback',
                        error: error.message
                    });
                    localStorage.setItem('localActivityLogs', JSON.stringify(localLogs));
                    console.log('✅ [DEBUG] 로컬 스토리지에 활동 로그 저장 완료');
                } catch (localError) {
                    console.error('❌ [DEBUG] 로컬 스토리지 저장 실패:', localError);
                }
            }
        }

        // 배달앱 URL 입력 필드 이벤트 리스너 설정
        function setupDeliveryUrlEventListeners() {
            const deliveryApps = ['ttaeng', 'baemin', 'coupang', 'yogiyo'];
            
            deliveryApps.forEach(app => {
                const urlInput = document.getElementById(`${app}Url`);
                if (urlInput) {
                    // 입력 시 즉시 상태 업데이트
                    urlInput.addEventListener('input', () => {
                        updateDeliveryStatus(app);
                    });
                    
                    // 포커스 아웃 시에도 상태 업데이트
                    urlInput.addEventListener('blur', () => {
                        updateDeliveryStatus(app);
                    });
                }
            });
        }
        // 배달앱 상태 업데이트 (구조화된 버전)
        function updateDeliveryStatus(app) {
            const urlInput = document.getElementById(`${app}Url`);
            const statusDiv = document.getElementById(`${app}Status`);
            
            if (!urlInput || !statusDiv) {
                console.warn(`${app} URL 입력 필드 또는 상태 표시 요소를 찾을 수 없습니다.`);
                return;
            }
            
            const url = urlInput.value.trim();
            
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                statusDiv.textContent = '활성';
                statusDiv.className = 'delivery-status status-active';
            } else {
                statusDiv.textContent = '준비중';
                statusDiv.className = 'delivery-status status-inactive';
            }
            
            // 그리드 내부의 상태도 로컬에서만 업데이트 (서버 요청 없음)
            updateGridItemStatus(app, url && url.trim() !== '');
        }
        
        // 그리드 아이템 상태만 업데이트 (로컬)
        function updateGridItemStatus(appId, isActive) {
            const gridItems = document.querySelectorAll('#deliveryOrderGrid .delivery-grid-item');
            gridItems.forEach(item => {
                if (item.getAttribute('data-app-id') === appId) {
                    const statusDiv = item.querySelector('.app-status');
                    if (statusDiv) {
                        statusDiv.textContent = isActive ? '활성' : '준비중';
                        statusDiv.className = `app-status ${isActive ? 'active' : ''}`;
                    }
                }
            });
        }

        // 모든 배달앱 상태 업데이트
        function updateAllDeliveryStatuses() {
            console.log('[상태 업데이트] 모든 배달앱 상태 업데이트 시작');
            const deliveryApps = ['ttaeng', 'baemin', 'coupang', 'yogiyo'];
            deliveryApps.forEach(app => {
                updateDeliveryStatus(app);
            });
            
            // 그리드의 상태도 강제로 업데이트
            setTimeout(() => {
                const gridItems = document.querySelectorAll('.delivery-grid-item');
                gridItems.forEach(item => {
                    const appId = item.getAttribute('data-app-id');
                    const urlInput = document.getElementById(`${appId}Url`);
                    if (urlInput) {
                        const hasUrl = urlInput.value && urlInput.value.trim() !== '';
                        const statusDiv = item.querySelector('.delivery-app-status');
                        if (statusDiv) {
                            const statusText = hasUrl ? '활성' : '준비중';
                            const statusClass = hasUrl ? 'active' : 'inactive';
                            statusDiv.textContent = statusText;
                            statusDiv.className = `delivery-app-status ${statusClass}`;
                            statusDiv.setAttribute('data-status', statusText);
                            console.log(`[상태 업데이트] ${appId} 그리드 상태 업데이트: ${statusText}`);
                        }
                    }
                });
            }, 50);
        }

        // 할인 설정 저장
        async function saveDiscountSettings() {
            try {
                const currentStoreId = await getCurrentStoreId();
                const oldSettings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                
                // 변경 전 값 저장
                const oldDiscount = oldSettings.discount || {};
                
                // 새 값 설정
                oldSettings.discount = {
                    enabled: document.getElementById('discountEnabled').checked,
                    title: document.getElementById('discountTitle').value,
                    description: document.getElementById('discountDescription').value
                };
                
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', oldSettings);
                
                // 캐시 무효화 (최신 데이터 반영)
                const cacheKey = `settings_${currentStoreId}`;
                if (window.sessionCache) {
                    window.sessionCache.clear(cacheKey);
                }
                // 백엔드 캐시는 API 호출 시 자동으로 무효화됨 (프론트엔드에서 직접 접근 불가)
                
                // 현재 설정 업데이트 (즉시 반영) - 설정 가이드에서 바로 확인 가능하도록
                if (!window.currentSettings) {
                    window.currentSettings = oldSettings;
                } else {
                    window.currentSettings.discount = oldSettings.discount;
                }
                
                // 설정 가이드 자동 갱신 (설정 저장 후 즉시 반영)
                await refreshSetupGuideIfVisible();
                
                // 토글 상태에 따라 폼 표시/숨김
                const discountForm = document.getElementById('discountForm');
                if (oldSettings.discount.enabled) {
                    discountForm.classList.add('active');
                } else {
                    discountForm.classList.remove('active');
                }
                
                // 활동 로그 기록 (변경 전/후)
                const changes = [];
                if (oldDiscount.enabled !== oldSettings.discount.enabled) {
                    changes.push(`활성화: ${oldDiscount.enabled ? '활성' : '비활성'} → ${oldSettings.discount.enabled ? '활성' : '비활성'}`);
                }
                if (oldDiscount.title !== oldSettings.discount.title) {
                    changes.push(`제목: "${oldDiscount.title || '없음'}" → "${oldSettings.discount.title || '없음'}"`);
                }
                if (oldDiscount.description !== oldSettings.discount.description) {
                    changes.push(`설명: "${oldDiscount.description || '없음'}" → "${oldSettings.discount.description || '없음'}"`);
                }
                
                if (changes.length > 0) {
                    await logActivity('settings', '할인 설정 변경', 
                        `할인 설정이 변경되었습니다.\n\n${changes.join('\n')}`, {
                        before: oldDiscount,
                        after: oldSettings.discount,
                        changes: changes
                    });
                }
                
                showToast('할인 설정이 저장되었습니다!', 'success', '저장 완료');
            } catch (error) {
                console.error('할인 설정 저장 실패:', error);
                showToast('할인 설정 저장에 실패했습니다.', 'error', '저장 실패');
            }
        }

        // 픽업 설정 저장
        async function savePickupSettings() {
            try {
                const currentStoreId = await getCurrentStoreId();
                const oldSettings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                
                // 변경 전 값 저장
                const oldPickup = oldSettings.pickup || {};
                
                // 새 값 설정 (빈 값 처리)
                const pickupTitleEl = document.getElementById('pickupTitle');
                const pickupDescriptionEl = document.getElementById('pickupDescription');
                const pickupEnabledEl = document.getElementById('pickupEnabled');
                
                oldSettings.pickup = {
                    enabled: pickupEnabledEl ? pickupEnabledEl.checked : false,
                    title: pickupTitleEl ? pickupTitleEl.value.trim() : '',
                    description: pickupDescriptionEl ? pickupDescriptionEl.value.trim() : ''
                };
                
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', oldSettings);
                
                // 캐시 무효화 (최신 데이터 반영)
                const cacheKey = `settings_${currentStoreId}`;
                if (window.sessionCache) {
                    window.sessionCache.clear(cacheKey);
                }
                // 백엔드 캐시는 API 호출 시 자동으로 무효화됨 (프론트엔드에서 직접 접근 불가)
                
                // 현재 설정 업데이트 (즉시 반영) - 설정 가이드에서 바로 확인 가능하도록
                if (!window.currentSettings) {
                    window.currentSettings = oldSettings;
                } else {
                    window.currentSettings.pickup = oldSettings.pickup;
                }
                
                // 설정 가이드 자동 갱신 (설정 저장 후 즉시 반영)
                await refreshSetupGuideIfVisible();
                
                // 토글 상태에 따라 폼 표시/숨김
                const pickupForm = document.getElementById('pickupForm');
                if (oldSettings.pickup.enabled) {
                    pickupForm.classList.add('active');
                } else {
                    pickupForm.classList.remove('active');
                }
                
                // 활동 로그 기록 (변경 전/후)
                const changes = [];
                if (oldPickup.enabled !== oldSettings.pickup.enabled) {
                    changes.push(`활성화: ${oldPickup.enabled ? '활성' : '비활성'} → ${oldSettings.pickup.enabled ? '활성' : '비활성'}`);
                }
                if (oldPickup.title !== oldSettings.pickup.title) {
                    changes.push(`제목: "${oldPickup.title || '없음'}" → "${oldSettings.pickup.title || '없음'}"`);
                }
                if (oldPickup.description !== oldSettings.pickup.description) {
                    changes.push(`설명: "${oldPickup.description || '없음'}" → "${oldSettings.pickup.description || '없음'}"`);
                }
                
                if (changes.length > 0) {
                    await logActivity('settings', '픽업 설정 변경', 
                        `픽업 설정이 변경되었습니다.\n\n${changes.join('\n')}`, {
                        before: oldPickup,
                        after: oldSettings.pickup,
                        changes: changes
                    });
                }
                
                showToast('픽업 설정이 저장되었습니다!', 'success', '저장 완료');
            } catch (error) {
                console.error('픽업 설정 저장 실패:', error);
                showToast('픽업 설정 저장에 실패했습니다.', 'error', '저장 실패');
            }
        }
        
        // AI 콘텐츠 자동 생성 (사용자 프롬프트 포함)
        async function generateAIContent(type) {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    showToast('가게를 먼저 선택해주세요.', 'error', 'AI 생성');
                    return;
                }
                
                // 사용자 프롬프트 입력 모달 표시
                const userPrompt = await showAIPromptModal(type);
                if (userPrompt === null) {
                    return; // 사용자가 취소한 경우
                }
                
                // 가게 정보 가져오기 (캐시된 정보 우선 사용)
                const storeInfo = await getStoreInfoForAI(currentStoreId);
                
                // 로딩 표시
                showToast('AI가 콘텐츠를 생성하고 있습니다...', 'info', 'AI 생성 중');
                
                // AI API 호출
                const result = await apiRequest('/api/ai/generate-content', 'POST', {
                    type: type,
                    storeName: storeInfo.name,
                    storeSubtitle: storeInfo.subtitle || '',
                    storePhone: storeInfo.phone || '',
                    storeAddress: storeInfo.address || '',
                    storeId: currentStoreId,
                    userPrompt: userPrompt
                });
                
                if (result.success) {
                    const data = result.content;
                    
                    // 생성된 콘텐츠를 폼에 적용
                    applyAIContent(type, data);
                    
                    // 자동 저장
                    await autoSaveAfterAI(type);
                    
                    // 성공 메시지
                    const analysis = data.analysis || {};
                    showToast(
                        `AI가 콘텐츠를 생성했습니다!\n업종: ${analysis.category || '분석 중'}\n${analysis.reasoning || ''}`,
                        'success',
                        'AI 생성 완료'
                    );
                } else {
                    showToast(`AI 생성 실패: ${result.error}`, 'error', 'AI 생성 실패');
                }
                
            } catch (error) {
                console.error('AI 콘텐츠 생성 실패:', error);
                showToast('AI 콘텐츠 생성에 실패했습니다.', 'error', 'AI 생성 실패');
            }
        }
        // AI 프롬프트 입력 모달 표시
        function showAIPromptModal(type) {
            return new Promise((resolve) => {
                // 기존 모달이 있으면 제거
                const existingModal = document.querySelector('.modal-overlay');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>AI 콘텐츠 생성 요청</h3>
                            <button class="modal-close" onclick="closeAIPromptModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>${getAIPromptDescription(type)}</p>
                            <div class="form-group">
                                <label for="aiPromptInput">요청사항을 입력하세요:</label>
                                <textarea id="aiPromptInput" class="form-input" rows="4" 
                                    placeholder="${getAIPromptPlaceholder(type)}"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAIPromptModal()">취소</button>
                            <button class="btn btn-primary" onclick="submitAIPrompt()">AI 생성</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 전역 함수로 등록
                window.closeAIPromptModal = () => {
                    if (modal && modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                    resolve(null);
                };
                
                window.submitAIPrompt = () => {
                    const prompt = document.getElementById('aiPromptInput').value.trim();
                    if (modal && modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                    resolve(prompt || '');
                };
                
                // Enter 키로 제출
                setTimeout(() => {
                    const input = document.getElementById('aiPromptInput');
                    if (input) {
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && e.ctrlKey) {
                                window.submitAIPrompt();
                            }
                        });
                        input.focus();
                    }
                }, 100);
            });
        }

        // AI 프롬프트 설명 텍스트
        function getAIPromptDescription(type) {
            const descriptions = {
                'discount': '할인 정보를 AI가 자동으로 생성합니다. 특별한 요청사항이 있으면 아래에 입력해주세요.',
                'pickup': '픽업 안내를 AI가 자동으로 생성합니다. 특별한 요청사항이 있으면 아래에 입력해주세요.',
                'both': '할인 정보와 픽업 안내를 모두 AI가 자동으로 생성합니다. 특별한 요청사항이 있으면 아래에 입력해주세요.'
            };
            return descriptions[type] || 'AI 콘텐츠를 생성합니다.';
        }

        // AI 프롬프트 플레이스홀더 텍스트
        function getAIPromptPlaceholder(type) {
            const placeholders = {
                'discount': '예: "학생 할인을 강조해주세요", "포장 주문 할인 위주로 작성해주세요"',
                'pickup': '예: "주차 공간이 넓다고 강조해주세요", "매장 1층에서 픽업한다고 명시해주세요"',
                'both': '예: "친근하고 따뜻한 톤으로 작성해주세요", "고객이 쉽게 이해할 수 있게 작성해주세요"'
            };
            return placeholders[type] || '요청사항을 입력하세요...';
        }
        // AI로 하단 텍스트 생성 (사용자 프롬프트 포함)
        async function generateSubtitleWithAI() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    notifyStoreSelectionRequired();
                    return;
                }

                // 사용자 프롬프트 입력 모달 표시
                const userPrompt = await showAIPromptModal('subtitle');
                if (userPrompt === null) {
                    return; // 사용자가 취소한 경우
                }

                // 현재 폼에서 가게 정보 가져오기
                const storeInfo = getCurrentFormStoreInfo();
                
                // 로딩 표시
                showToast('AI가 하단 텍스트를 생성하고 있습니다...', 'info', 'AI 생성 중');
                
                // AI API 호출
                const result = await apiRequest(`${API_BASE}/ai/generate-content`, 'POST', {
                    type: 'subtitle',
                    storeName: storeInfo.name,
                    storeSubtitle: storeInfo.subtitle,
                    storePhone: storeInfo.phone,
                    storeAddress: storeInfo.address,
                    storeId: currentStoreId,
                    userPrompt: userPrompt
                });

                if (result && result.content) {
                    const subtitle = result.content.subtitle || result.content;
                    document.getElementById('storeSubtitle').value = subtitle;
                    showToast('AI가 하단 텍스트를 생성했습니다!', 'success', 'AI 생성');
                    
                    // 자동 저장
                    await saveBasicInfo();
                } else {
                    showToast('AI 하단 텍스트 생성에 실패했습니다.', 'error', '오류');
                }
            } catch (error) {
                console.error('AI 하단 텍스트 생성 실패:', error);
                showToast('AI 하단 텍스트 생성 중 오류가 발생했습니다.', 'error', '오류');
            }
        }
        // 가게 정보 가져오기 (캐시 우선)
        async function getStoreInfoForAI(storeId) {
            // 캐시된 정보가 있으면 사용
            if (window.currentSettings && window.currentSettings.store) {
                return window.currentSettings.store;
            }
            
            // 캐시된 정보가 없으면 API 호출
            const storesResponse = await apiRequest(`${API_BASE}/stores`);
            const stores = normalizeStoreListResponse(storesResponse);
            const store = stores.find(s => s.id === storeId);
            
            if (!store) {
                throw new Error('가게 정보를 찾을 수 없습니다.');
            }
            
            return store;
        }

        // 현재 폼에서 가게 정보 가져오기
        function getCurrentFormStoreInfo() {
            return {
                name: document.getElementById('storeName').value || '이름 없음',
                subtitle: document.getElementById('storeSubtitle').value || '',
                phone: document.getElementById('storePhone').value || '',
                address: document.getElementById('storeAddress').value || ''
            };
        }

        // AI 콘텐츠를 폼에 적용
        function applyAIContent(type, content) {
            if (type === 'discount') {
                document.getElementById('discountTitle').value = content.title || '';
                document.getElementById('discountDescription').value = content.description || '';
            } else if (type === 'pickup') {
                document.getElementById('pickupTitle').value = content.title || '';
                document.getElementById('pickupDescription').value = content.description || '';
            } else if (type === 'both') {
                if (content.discount) {
                    document.getElementById('discountTitle').value = content.discount.title || '';
                    document.getElementById('discountDescription').value = content.discount.description || '';
                }
                if (content.pickup) {
                    document.getElementById('pickupTitle').value = content.pickup.title || '';
                    document.getElementById('pickupDescription').value = content.pickup.description || '';
                }
            }
        }

        // AI 생성 후 자동 저장
        async function autoSaveAfterAI(type) {
            if (type === 'discount' || type === 'both') {
                await saveDiscountSettings();
            }
            if (type === 'pickup' || type === 'both') {
                await savePickupSettings();
            }
        }

        // 섹션 순서 렌더링
        async function renderSectionOrder() {
            try {
                const currentStoreId = await getCurrentStoreId();
                const settings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                
                // 기본 섹션 순서 (설정이 없으면 기본값 사용)
                const defaultOrder = [
                    { id: 'discount', title: '할인 · 픽업 안내', description: '할인 및 픽업 정보' },
                    { id: 'delivery', title: '배달 주문', description: '배달앱 주문 링크' },
                    { id: 'address', title: '주소 정보', description: '가게 주소 및 지도' }
                ];
                
                const sectionOrder = settings.sectionOrder || defaultOrder;
                const orderList = document.getElementById('sectionOrderList');
                
                orderList.innerHTML = '';
                
                sectionOrder.forEach((section, index) => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.dataset.sectionId = section.id;
                    
                    // 아이콘 기본값 설정
                    const iconMap = {
                        'discount': '🎉',
                        'delivery': '🚚',
                        'address': '📍'
                    };
                    const icon = section.icon || iconMap[section.id] || '📌';
                    
                    orderItem.innerHTML = `
                        <div class="order-number">${index + 1}</div>
                        <div class="order-content">
                            <div class="order-icon" style="display: none;">${icon}</div>
                            <div class="order-title">${section.title}</div>
                            <div class="order-description">${section.description}</div>
                        </div>
                        <div class="order-handle">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="3" y1="12" x2="21" y2="12"/>
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <line x1="3" y1="18" x2="21" y2="18"/>
                            </svg>
                        </div>
                    `;
                    
                    orderList.appendChild(orderItem);
                });
                
                // SortableJS 초기화는 loadSectionOrder에서 처리됨
                
            } catch (error) {
                console.error('섹션 순서 렌더링 실패:', error);
                showStatus('섹션 순서를 불러오는데 실패했습니다.', 'error');
            }
        }

        // 순서 번호 업데이트
        function updateOrderNumbers() {
            const orderItems = document.querySelectorAll('.order-item');
            orderItems.forEach((item, index) => {
                const numberElement = item.querySelector('.order-number');
                if (numberElement) {
                    numberElement.textContent = index + 1;
                }
            });
        }

        // 섹션 순서 저장
        async function saveSectionOrder() {
            try {
                const currentStoreId = await getCurrentStoreId();
                const settingsResponse = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                // API 응답이 {success: true, data: {...}} 형태일 수도 있고, 직접 설정 객체일 수도 있음
                const settings = settingsResponse?.data || settingsResponse || {};
                
                const orderItems = document.querySelectorAll('.order-item');
                const sectionOrder = Array.from(orderItems).map(item => {
                    const sectionId = item.dataset.sectionId;
                    const title = item.querySelector('.order-title').textContent;
                    const icon = item.querySelector('.order-icon').textContent;
                    const description = item.querySelector('.order-description').textContent;
                    
                    return { id: sectionId, title, icon, description };
                });
                
                // 변경 전 순서 저장
                const oldSectionOrder = settings.sectionOrder || [];
                const oldOrderTitles = oldSectionOrder.map(s => s.title).join(' → ');
                const newOrderTitles = sectionOrder.map(s => s.title).join(' → ');
                
                // sectionOrder만 업데이트 (기존 설정 유지)
                const updatedSettings = {
                    ...settings,
                    sectionOrder: sectionOrder
                };
                
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', updatedSettings);
                
                // 캐시 무효화 (최신 데이터 반영)
                const cacheKey = `settings_${currentStoreId}`;
                if (window.sessionCache) {
                    window.sessionCache.clear(cacheKey);
                }
                // 백엔드 캐시는 API 호출 시 자동으로 무효화됨 (프론트엔드에서 직접 접근 불가)
                
                // 현재 설정 업데이트 (즉시 반영)
                if (window.currentSettings) {
                    window.currentSettings.sectionOrder = sectionOrder;
                } else {
                    window.currentSettings = updatedSettings;
                }
                
                showToast('UI 순서가 자동으로 저장되었습니다!', 'success', '저장 완료');
                
                // 활동 로그 기록 (변경 전/후 명확히)
                await logActivity('settings', 'UI 순서 변경', 
                    `가게 페이지 섹션 순서 변경\n이전: ${oldOrderTitles}\n이후: ${newOrderTitles}`, {
                    oldOrder: oldSectionOrder.map(s => s.id),
                    newOrder: sectionOrder.map(s => s.id),
                    oldOrderTitles: oldOrderTitles,
                    newOrderTitles: newOrderTitles
                });
                
            } catch (error) {
                console.error('섹션 순서 저장 실패:', error);
                showStatus('섹션 순서 저장에 실패했습니다.', 'error');
            }
        }

        // 이미지 업로드 처리
        async function handleImageUpload(inputId, imageType) {
            const fileInput = document.getElementById(inputId);
            if (fileInput && fileInput.files && fileInput.files[0]) {
                await processImageFile(fileInput.files[0], imageType);
            }
        }

        // 이미지 파일 처리
        async function processImageFile(file, imageType) {
            console.log('🔍 [DEBUG] processImageFile 시작:', { file, imageType });
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const imageData = e.target.result;
                    console.log('🔍 [DEBUG] 이미지 데이터 로드됨:', { imageDataLength: imageData.length });
                    
                    const currentStoreId = await getCurrentStoreId();
                    console.log('🔍 [DEBUG] 현재 가게 ID:', currentStoreId);
                    
                    if (!currentStoreId) {
                        showStatus('가게를 먼저 선택해주세요.', 'error');
                        return;
                    }
                    
                    // 기존 설정 가져오기 (GET /api/settings 사용)
                    const settingsResponse = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                    const settings = settingsResponse?.data || settingsResponse || {};
                    console.log('🔍 [DEBUG] 기존 설정 로드됨:', settings);
                    
                    // images 객체 병합 (기존 이미지 유지)
                    const updatedSettings = {
                        ...settings,
                        images: {
                            ...(settings.images || {}),
                            [imageType]: imageData
                        }
                    };
                    
                    console.log('🔍 [DEBUG] 저장할 설정:', { images: updatedSettings.images });
                    
                    await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', updatedSettings);
                    
                    // 캐시 무효화 (최신 데이터 반영)
                    const cacheKey = `settings_${currentStoreId}`;
                    if (window.sessionCache) {
                        window.sessionCache.clear(cacheKey);
                    }
                    // 백엔드 캐시도 무효화
                    if (window.dbServices && window.dbServices.clearCache) {
                        window.dbServices.clearCache('storeSettings', currentStoreId);
                    }
                    
                    // 현재 설정 업데이트 (즉시 반영)
                    if (window.currentSettings) {
                        window.currentSettings.images = window.currentSettings.images || {};
                        window.currentSettings.images[imageType] = imageData;
                    } else {
                        window.currentSettings = updatedSettings;
                    }
                    
                    // 이미지 미리보기 업데이트
                    updateImagePreview(imageType, imageData);
                    
                    // 설정 가이드 자동 갱신
                    await refreshSetupGuideIfVisible();
                    
                    // 사이드바 즉시 업데이트 (로고 변경 시 바로 반영)
                    if (imageType === 'mainLogo') {
                        // 즉시 사이드바 로고 업데이트 (API 호출 없이 현재 이미지 데이터 사용)
                        const logoElement = document.getElementById('selectedStoreLogo');
                        if (logoElement) {
                            const logoImg = logoElement.querySelector('.store-logo-img');
                            if (logoImg) {
                                logoImg.src = imageData;
                                logoImg.alt = `${document.getElementById('selectedStoreName')?.textContent || '가게'} 로고`;
                            }
                        }
                        
                        // 백그라운드에서 최신 데이터로 사이드바 업데이트 (최신 상태 유지)
                        updateSelectedStoreCard(currentStoreId).catch(err => 
                            console.warn('사이드바 업데이트 실패 (백그라운드):', err)
                        );
                    }
                    
                    showToast(`${imageType === 'mainLogo' ? '로고' : '메뉴판'} 이미지가 업로드되어 저장되었습니다!`, 'success', '저장 완료');
                } catch (error) {
                    console.error('이미지 저장 오류:', error);
                    showStatus('이미지 저장에 실패했습니다.', 'error');
                }
            };
            
            reader.readAsDataURL(file);
        }

        async function handleVideoUpload(inputId, videoType) {
            const fileInput = document.getElementById(inputId);
            if (fileInput && fileInput.files && fileInput.files[0]) {
                await processVideoFile(fileInput.files[0], videoType);
            }
        }

        /**
         * 이미지/동영상 관리 섹션에서 동영상 업로드 입력을 열어주는 헬퍼 함수입니다.
         * 메뉴 이미지 아래의 "동영상 삽입" 버튼을 클릭했을 때 즉시 파일 선택창이 열리도록 처리합니다.
         */
        function triggerPromoVideoUpload() {
            const promoVideoInput = document.getElementById('promoVideo');
            if (promoVideoInput) {
                promoVideoInput.click();
            }
        }

        // 동영상 영역 클릭 처리: 비디오가 있으면 재생, 없으면 파일 선택
        function handlePromoVideoAreaClick(event) {
            const videoPreview = document.getElementById('promoVideoPreview');
            if (videoPreview && videoPreview.style.display !== 'none' && videoPreview.src) {
                // 비디오가 있으면 재생/일시정지 토글
                if (videoPreview.paused) {
                    videoPreview.play();
                } else {
                    videoPreview.pause();
                }
            } else {
                // 비디오가 없으면 파일 선택 다이얼로그 열기
                triggerPromoVideoUpload();
            }
        }

        // 동영상 미리보기 업데이트 함수 (기존 함수와 통합)
        function updateVideoPreview(videoType, videoInfo) {
            const videoPreview = document.getElementById('promoVideoPreview');
            const dragText = document.getElementById('promoVideoDragText');
            const videoMeta = document.getElementById('promoVideoMeta');
            const uploadArea = document.getElementById('promoVideoArea');

            if (!videoInfo || !videoInfo.src) {
                // 비디오 정보가 없으면 초기 상태로 복원
                if (videoPreview) {
                    videoPreview.style.display = 'none';
                    videoPreview.src = '';
                    videoPreview.pause();
                }
                if (dragText) {
                    dragText.style.display = 'flex';
                }
                if (videoMeta) {
                    videoMeta.style.display = 'none';
                }
                return;
            }

            // 비디오 정보가 있으면 미리보기 표시
            if (videoPreview) {
                // videoInfo가 객체인 경우 src 속성 사용, 문자열인 경우 직접 사용
                const videoSrc = typeof videoInfo === 'string' ? videoInfo : (videoInfo.src || videoInfo);
                videoPreview.src = videoSrc;
                videoPreview.style.display = 'block';
                videoPreview.load(); // 비디오 로드
            }
            if (dragText) {
                dragText.style.display = 'none';
            }
            if (videoMeta) {
                const sizeMB = videoInfo.size ? (videoInfo.size / (1024 * 1024)).toFixed(1) : '0';
                const filename = videoInfo.filename || '동영상';
                const duration = videoInfo.duration || 0;
                videoMeta.innerHTML = `파일명: ${filename} ㆍ 길이: ${duration}초 ㆍ 크기: ${sizeMB} MB`;
                videoMeta.style.display = 'block';
            }
        }

        async function processVideoFile(file, videoType) {
            try {
                const MAX_VIDEO_SIZE_MB = 20;
                const MAX_VIDEO_DURATION = 10;

                if (file.size > MAX_VIDEO_SIZE_MB * 1024 * 1024) {
                    showStatus(`동영상 용량은 최대 ${MAX_VIDEO_SIZE_MB}MB까지 업로드할 수 있습니다.`, 'error');
                    return;
                }

                const objectUrl = URL.createObjectURL(file);
                const videoElement = document.createElement('video');
                videoElement.preload = 'metadata';

                const metadataLoaded = new Promise((resolve, reject) => {
                    videoElement.onloadedmetadata = () => resolve(videoElement.duration);
                    videoElement.onerror = () => reject(new Error('동영상 메타데이터를 불러올 수 없습니다.'));
                });

                videoElement.src = objectUrl;

                const duration = await metadataLoaded;
                URL.revokeObjectURL(objectUrl);

                if (duration > MAX_VIDEO_DURATION) {
                    showStatus(`10초 이하의 동영상만 등록할 수 있습니다. (현재 길이: ${duration.toFixed(1)}초)`, 'error');
                    return;
                }
                await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const videoData = e.target.result;
                            const currentStoreId = await getCurrentStoreId();
                            if (!currentStoreId) {
                                showStatus('가게를 먼저 선택해주세요.', 'error');
                                resolve();
                                return;
                            }

                            const settingsResponse = await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`);
                            const settings = settingsResponse?.data || settingsResponse || {};
                            settings.images = settings.images || {};

                            const videoInfo = {
                                src: videoData,
                                type: file.type,
                                filename: file.name,
                                size: file.size,
                                duration: Math.round(duration * 10) / 10,
                                uploadedAt: new Date().toISOString()
                            };

                            settings.images[videoType] = videoInfo;

                            await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', settings);

                            updateVideoPreview(videoType, videoInfo);

                            showStatus('동영상이 업로드되어 저장되었습니다!', 'success');
                            
                            // 설정 가이드 자동 갱신
                            await refreshSetupGuideIfVisible();
                            
                            resolve();
                        } catch (error) {
                            console.error('동영상 저장 오류:', error);
                            showStatus('동영상 저장에 실패했습니다.', 'error');
                            reject(error);
                        }
                    };
                    reader.onerror = () => {
                        showStatus('동영상 파일을 읽는 중 오류가 발생했습니다.', 'error');
                        reject(new Error('파일 읽기 실패'));
                    };
                    reader.readAsDataURL(file);
                });

            } catch (error) {
                console.error('동영상 처리 실패:', error);
            }
        }

        // 드래그앤드롭 처리
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, imageType) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processImageFile(files[0], imageType);
            }
        }

        function handleVideoDrop(event, videoType) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processVideoFile(files[0], videoType);
            }
        }
        // 이미지 미리보기 업데이트
        function updateImagePreview(imageType, imageData) {
            const preview = document.getElementById(`${imageType}Preview`);
            const uploadArea = document.getElementById(`${imageType}Area`);
            
            if (imageData) {
                preview.src = imageData;
                preview.style.display = 'block';
                uploadArea.classList.add('has-image');
            } else {
                preview.style.display = 'none';
                uploadArea.classList.remove('has-image');
            }
        }
        // updateVideoPreview 함수는 위에서 이미 정의됨 (중복 제거)

        function formatBytes(bytes) {
            if (!bytes || bytes <= 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
            const value = bytes / Math.pow(1024, exponent);
            return `${value.toFixed(value >= 10 ? 0 : 1)} ${units[exponent]}`;
        }

        // 홈 페이지 최근 가게 로드
        async function loadHomeRecentStores() {
            try {
                const storesListEl = document.getElementById('homeStoresList');
                if (!storesListEl) return;

                // 최근 6개 가게만 가져오기 (빠른 로딩)
                // 홈 페이지에서는 owner 정보 불필요 (성능 최적화)
                const query = new URLSearchParams({
                    page: '1',
                    pageSize: '6',
                    sortBy: 'createdAt',
                    sortOrder: 'desc',
                    includeOwners: 'false' // owner 정보 제외 (성능 최적화)
                });

                // 점주 계정일 때는 본인 가게만 보이도록 필터링 (슈퍼어드민이 아닐 때)
                if (IS_STORE_OWNER && !IS_SUPERADMIN) {
                    const ownerId = sessionStorage.getItem('owner_id');
                    if (ownerId) {
                        query.set('ownerId', ownerId);
                    } else {
                        // 점주 ID가 없으면 빈 목록 표시
                        storesListEl.innerHTML = '<div class="home-loading">점주 정보를 찾을 수 없습니다.</div>';
                        return;
                    }
                }

                const response = await apiRequest(`${API_BASE}/stores?${query.toString()}`, 'GET', null, 3, false);
                const stores = normalizeStoreListResponse(response);
                
                // 점주 계정일 때는 본인과 연결된 가게만 추가 필터링
                let filteredStores = stores;
                if (IS_STORE_OWNER && !IS_SUPERADMIN) {
                    const ownerId = sessionStorage.getItem('owner_id');
                    if (ownerId) {
                        filteredStores = stores.filter(store => {
                            const owners = store.owners || [];
                            return owners.some(owner => owner.id === ownerId);
                        });
                    } else {
                        filteredStores = [];
                    }
                }
                
                const storesToDisplay = filteredStores;

                if (storesToDisplay.length === 0) {
                    storesListEl.innerHTML = '<div class="home-loading">등록된 가게가 없습니다.</div>';
                    return;
                }

                storesListEl.innerHTML = storesToDisplay.map(store => `
                    <div class="home-store-card" onclick="selectStore('${store.id}')">
                        <div class="home-store-name">${escapeHtml(store.basic?.storeName || store.name || '알 수 없는 가게')}</div>
                        <div class="home-store-subtitle">${escapeHtml(store.basic?.storeSubtitle || store.subtitle || '')}</div>
                        <div class="home-store-meta">
                            <span>${store.status === 'active' ? '✅ 운영중' : store.status === 'paused' ? '⏸️ 일시정지' : '⏳ 대기중'}</span>
                            ${store.subdomain ? `<span>🌐 ${store.subdomain}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('홈 최근 가게 로드 실패:', error);
                const storesListEl = document.getElementById('homeStoresList');
                if (storesListEl) {
                    storesListEl.innerHTML = '<div class="home-loading">가게 목록을 불러올 수 없습니다.</div>';
                }
            }
        }

        // 슈퍼어드민 계정 정보 로드
        async function loadSuperAdminInfo() {
            try {
                const response = await apiRequest(`${API_BASE}/superadmin/info`);
                if (response) {
                    document.getElementById('adminUsername').value = response.username || '';
                }
            } catch (error) {
                console.error('슈퍼어드민 정보 로드 오류:', error);
            }
        }

        // 슈퍼어드민 계정 정보 수정
        async function updateSuperAdminAccount() {
            try {
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;
                const passwordConfirm = document.getElementById('adminPasswordConfirm').value;
                
                if (!username.trim()) {
                    showStatus('계정명을 입력해주세요.', 'error');
                    return;
                }
                
                if (password && password !== passwordConfirm) {
                    showStatus('비밀번호가 일치하지 않습니다.', 'error');
                    return;
                }
                
                const updateData = { username: username.trim() };
                if (password.trim()) {
                    updateData.password = password.trim();
                }
                
                const response = await apiRequest(`${API_BASE}/superadmin/update`, 'POST', updateData);
                if (response?.data?.username) {
                    sessionStorage.setItem('superadmin_username', response.data.username);
                }
                showStatus(response?.message || '슈퍼어드민 계정 정보가 수정되었습니다!', 'success');
                
                // 비밀번호 필드 초기화
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPasswordConfirm').value = '';
                
            } catch (error) {
                console.error('슈퍼어드민 계정 수정 오류:', error);
                showStatus(error.message || '계정 정보 수정에 실패했습니다.', 'error');
            }
        }

        // 로그아웃
        function openLogoutModal() {
            const modal = document.getElementById('logoutModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeLogoutModal() {
            const modal = document.getElementById('logoutModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function confirmLogout() {
            sessionStorage.removeItem('superadmin_logged_in');
            sessionStorage.removeItem('superadmin_username');
            sessionStorage.removeItem('owner_logged_in');
            sessionStorage.removeItem('owner_store_id');
            sessionStorage.removeItem('owner_name');
            sessionStorage.removeItem('owner_email');
            sessionStorage.removeItem('owner_id');
            sessionStorage.removeItem('owner_store_list');
            sessionStorage.removeItem('user_role');
            window.location.href = '/login';
        }

        // 메인 페이지 열기
        async function openMainPage() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (currentStoreId) {
                    // 가게 정보 조회하여 서브도메인 확인
                    try {
                        const response = await apiRequest(`${API_BASE}/stores/${currentStoreId}`);
                        const store = normalizeStoreDetailResponse(response, currentStoreId);
                        let storePageUrl;
                        
                        if (store && store.subdomain) {
                            // 서브도메인이 있는 경우 서브도메인 URL 사용
                            storePageUrl = `/${store.subdomain}`;
                        } else {
                            // 서브도메인이 없는 경우 기존 URL 사용
                            storePageUrl = `/store.html?id=${currentStoreId}`;
                        }
                        
                        console.log('가게 페이지 URL:', storePageUrl);
                        window.open(storePageUrl, '_blank');
                    } catch (error) {
                        console.error('가게 정보 조회 실패:', error);
                        // 에러 시 기존 방식으로 fallback
                        const storePageUrl = `/store.html?id=${currentStoreId}`;
                        console.log('가게 페이지 URL (fallback):', storePageUrl);
                        window.open(storePageUrl, '_blank');
                    }
                } else {
                    // 가게가 선택되지 않은 경우 기본 페이지로 이동
                    console.log('가게가 선택되지 않음, 기본 페이지로 이동');
                    window.open('/', '_blank');
                }
            } catch (error) {
                console.error('메인 페이지 열기 실패:', error);
                // 오류 발생 시 기본 페이지로 이동
                window.open('/', '_blank');
            }
        }

        // 가게 선택 상태 확인 (동기 함수로 변경)
        function checkStoreSelected() {
            try {
                const currentStoreId = getCurrentStoreId();
                return currentStoreId && currentStoreId !== null;
            } catch (error) {
                console.error('가게 선택 상태 확인 실패:', error);
                return false;
            }
        }

        // 가게 선택되지 않은 경우 알림 표시
        function showNoStoreGuide() {
            if (hasShownNoStoreGuide) return;
            hasShownNoStoreGuide = true;
            showToast('등록된 가게가 없습니다. 가게 관리에서 새 가게를 만들어주세요.', 'info', '가게 등록 필요', 6000);
        }

        function resetNoStoreGuideFlag() {
            hasShownNoStoreGuide = false;
        }

        function notifyStoreSelectionRequired() {
            if (IS_SUPERADMIN && allStores.length === 0) {
                showNoStoreGuide();
            } else {
                notifyStoreSelectionRequired();
            }
        }

        function showStoreSelectionRequired() {
            notifyStoreSelectionRequired();
        }

        // 사이드바 토글 (모바일)
        function toggleSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // 모든 섹션 숨기기 헬퍼 함수 (슈퍼어드민 전용 섹션 포함, 재사용)
        function hideAllSections(exceptSectionId = null) {
            // 1단계: 모든 admin-section 섹션 숨기기
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => {
                if (!exceptSectionId || section.id !== exceptSectionId) {
                    section.style.display = 'none';
                    section.setAttribute('style', 'display: none !important;');
                }
            });
            
            // 2단계: 슈퍼어드민 전용 섹션들도 명시적으로 숨김 (ID 목록으로 안전장치)
            const superadminOnlySectionIds = ['accounts', 'db-stats', 'activity-logs', 'superadmin'];
            superadminOnlySectionIds.forEach(id => {
                if (id !== exceptSectionId) {
                    const section = document.getElementById(id);
                    if (section) {
                        section.style.display = 'none';
                        section.setAttribute('style', 'display: none !important;');
                    }
                }
            });
            
            // 3단계: .superadmin-only 클래스를 가진 모든 요소도 숨김
            const superadminSections = document.querySelectorAll('.superadmin-only');
            superadminSections.forEach(section => {
                if (!exceptSectionId || !section.id || section.id !== exceptSectionId) {
                    section.style.display = 'none';
                    section.setAttribute('style', 'display: none !important;');
                }
            });
        }
        
        // 특정 섹션 표시 헬퍼 함수
        function showSectionOnly(sectionId) {
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.setAttribute('style', 'display: block !important;');
            }
        }

        // 섹션 표시 (전역 함수로 정의)
        window.showSection = async function(sectionId) {
            // URL 해시 업데이트 (새로고침 시 현재 섹션 유지)
            window.location.hash = sectionId;

            // 모바일에서 섹션 전환 시 사이드바 자동 닫기
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.admin-sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }

            // 대량 가게 관리 버튼 표시/숨김
            const bulkBtn = document.getElementById('bulkManagementBtn');
            if (bulkBtn) {
                bulkBtn.style.display = (sectionId === 'stores' && IS_SUPERADMIN) ? 'inline-block' : 'none';
            }

            // 가게 관리 섹션과 도메인 설정 섹션은 항상 접근 가능
            if (sectionId === 'accounts' && !IS_SUPERADMIN) {
                showToast('접근 권한이 없습니다.', 'error');
                return;
            }

            // 홈 섹션인 경우 최근 가게만 로드
            if (sectionId === 'home') {
                // 모든 섹션 숨기기 (슈퍼어드민 전용 섹션 포함)
                hideAllSections('home');
                // 홈 섹션 표시
                showSectionOnly('home');
                
                // 최근 가게 로드 (비동기, 로딩 바 없이)
                loadHomeRecentStores().catch(err => {
                    console.error('홈 최근 가게 로드 실패:', err);
                });
                
                // 메뉴 활성화 제거 (홈은 메뉴가 아님)
            const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                
                return;
            }

            // 설정 가이드 섹션
            if (sectionId === 'setup-guide') {
                if (!checkStoreSelected()) {
                    showToast('가게를 먼저 선택해주세요.', 'error', '가게 선택 필요');
                    return;
                }
                
                // 모든 섹션 숨기기 (슈퍼어드민 전용 섹션 포함)
                hideAllSections('setup-guide');
                // 설정 가이드 섹션 표시
                showSectionOnly('setup-guide');
                
                // 메뉴 활성화 제거 (설정 가이드는 메뉴가 아님)
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                
                // 설정 가이드 렌더링
                await renderSetupGuide();
                
                return;
            }
            
            // 슈퍼어드민 전용 섹션들 (가게 선택 불필요)
            if (sectionId === 'stores' || sectionId === 'domain-settings' || sectionId === 'domain-qr' || sectionId === 'accounts' || sectionId === 'db-stats' || sectionId === 'activity-logs' || sectionId === 'superadmin') {
                // 권한 확인
                if ((sectionId === 'accounts' || sectionId === 'db-stats' || sectionId === 'activity-logs' || sectionId === 'superadmin') && !IS_SUPERADMIN) {
                    showToast('접근 권한이 없습니다.', 'error');
                    return;
                }
                
                // 모든 섹션 숨기기 (owner-account 포함, 슈퍼어드민 전용 섹션 포함)
                hideAllSections(sectionId);
                // 선택된 섹션 표시
                showSectionOnly(sectionId);
                
                // 메뉴 활성화
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                
                // 클릭된 메뉴 아이템 찾기
                const clickedItem = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }
                
                // 가게 관리 섹션인 경우 가게 목록 로드 (필요할 때만)
                if (sectionId === 'stores') {
                    // 세션 캐시 확인
                    const cacheKey = 'stores_list';
                    // 권한 체크 후 해당 데이터만 로드 (초기 로드 시점부터 필터링)
                    // 점주 계정일 때는 캐시 확인 전에 권한 체크하여 본인 가게만 로드
                    if (IS_STORE_OWNER && !IS_SUPERADMIN) {
                        // 점주 계정: 본인 가게만 로드 (캐시 무시하고 권한 체크 우선)
                        try {
                            await loadStoreList();
                        } catch (error) {
                            console.error('가게 목록 로드 실패:', error);
                            allStores = [];
                            filteredStores = [];
                            await renderStoreView();
                        }
                    } else {
                        // 슈퍼어드민: 캐시 확인 후 로드
                        const cached = window.sessionCache?.get(cacheKey);
                        
                        if (cached && cached.length > 0) {
                            console.log('✅ [캐시] 가게 목록 캐시에서 로드:', cached.length);
                            allStores = cached;
                            filteredStores = cached;
                            await renderStoreView();
                        } else {
                            // 캐시에 없으면 즉시 로드 (로딩바 없이 빠르게)
                            try {
                                await loadStoreList();
                                // 캐시에 저장
                                if (window.sessionCache && allStores.length > 0) {
                                    window.sessionCache.set(cacheKey, allStores);
                                }
                            } catch (error) {
                                console.error('가게 목록 로드 실패:', error);
                            }
                        }
                    }
                }
                
                // 도메인 설정 섹션인 경우 도메인 정보 로드
                if (sectionId === 'domain-settings' || sectionId === 'domain-qr') {
                    // 로딩 모달 표시
                    if (window.showGlobalLoading) {
                        window.showGlobalLoading('default', true, '도메인 설정을 불러오는 중...');
                    }
                    loadDomainSettings().then(() => {
                        // 로딩바 숨김
                        if (window.hideGlobalLoading) {
                            window.setLoadingBarType('success');
                            setTimeout(() => window.hideGlobalLoading(), 200);
                        }
                    }).catch(error => {
                        console.error('도메인 설정 로드 실패:', error);
                        // 에러 시 로딩바 숨김
                        if (window.hideGlobalLoading) {
                            window.setLoadingBarType('error');
                            setTimeout(() => window.hideGlobalLoading(), 500);
                        }
                    });
                }

                if (sectionId === 'accounts') {
                    await reloadOwnerAccounts();
                }

                // DB 통계 섹션인 경우 통계 로드
                if (sectionId === 'db-stats') {
                    loadDbStats();
                }
                
                // 활동 로그 섹션인 경우 로그 로드
                if (sectionId === 'activity-logs') {
                    loadActivityLogs();
                }
                
                // 슈퍼어드민 섹션인 경우 정보 로드
                if (sectionId === 'superadmin') {
                    loadSuperAdminInfo();
                }

                return;
            }

            const skipStoreCheck = sectionId === 'dashboard' && IS_SUPERADMIN;

            // 도메인/QR 관리 섹션은 가게 선택 후에만 접근 가능
            if (sectionId === 'domain-qr') {
                if (!checkStoreSelected()) {
                showStoreSelectionRequired();
                    return;
                }
                // 모든 섹션 숨기기 (슈퍼어드민 전용 섹션 포함)
                hideAllSections('domain-qr');
                // 도메인/QR 관리 섹션 표시
                showSectionOnly('domain-qr');
                
                // 캐시 확인 후 필요할 때만 로딩바 표시
                const currentStoreId = getCurrentStoreId();
                const domainCacheKey = `domain_settings_${currentStoreId}`;
                const domainCached = window.sessionCache?.get(domainCacheKey);
                
                if (!domainCached) {
                    // 캐시에 없을 때만 로딩 모달 표시
                    if (window.showGlobalLoading) {
                        window.showGlobalLoading('default', true, '도메인 설정을 불러오는 중...');
                    }
                }
                
                try {
                    await loadDomainSettings();
                    // 로딩바는 loadDomainSettings 내부에서 캐시 확인하므로 여기서는 필요시에만 숨김
                    if (!domainCached && window.hideGlobalLoading) {
                        window.setLoadingBarType('success');
                        setTimeout(() => window.hideGlobalLoading(), 200);
                    }
                } catch (error) {
                    console.error('도메인 설정 로드 실패:', error);
                    // 에러 시 로딩바 숨김
                    if (window.hideGlobalLoading) {
                        window.setLoadingBarType('error');
                        setTimeout(() => window.hideGlobalLoading(), 500);
                    }
                }
                // 메뉴 활성화
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => item.classList.remove('active'));
                const clickedItem = document.querySelector(`[onclick="showSection('domain-qr')"]`);
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }
                return;
            }

            // 다른 섹션들은 가게 선택 후에만 접근 가능
            if (!skipStoreCheck && !checkStoreSelected()) {
                showStoreSelectionRequired();
                return;
            }
            
            // ===== UI 즉시 전환 (메뉴 클릭 시 즉시 반응) =====
            // 모든 섹션 숨기기 (슈퍼어드민 전용 섹션 포함, 헬퍼 함수 사용)
            hideAllSections(sectionId);
            
            // 선택된 섹션만 표시 (헬퍼 함수 사용)
            showSectionOnly(sectionId);
            
            // 메뉴 활성화 (즉시)
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            const clickedItem = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            // ===== 데이터 로드 (UI 전환 후 비동기로 실행) =====
            // 중요: loadSectionData 내부에서 최신 storeId를 가져와야 함 (가게 선택 후 타이밍 이슈 방지)
            
            // 섹션별 데이터 로드 (비동기, 로딩 모달 표시)
            const loadSectionData = async () => {
                // 내부에서 최신 storeId 가져오기 (가게 선택 후 갱신 보장)
                const currentStoreId = getCurrentStoreId();
                
                // 내 계정 섹션인 경우 계정 정보 로드
                if (sectionId === 'owner-account') {
                    populateOwnerAccountSection();
                    return;
            }

            if (sectionId === 'dashboard') {
                    // 슈퍼어드민 모드 확인 및 요소 표시
                    if (IS_SUPERADMIN) {
                        // body에 superadmin-mode 클래스 추가
                        document.body.classList.add('superadmin-mode');
                        
                        // 대시보드 컨트롤 강제 표시
                        const dashboardControls = document.getElementById('dashboardControls');
                        if (dashboardControls) {
                            dashboardControls.style.display = 'flex';
                        }
                        
                        // 대시보드 컨트롤 초기화 (슈퍼어드민만)
                        initializeDashboardControls();
                        updateDashboardScopeUI();
                    }
                    
                    // 대시보드 캐시 확인 (로딩바 표시 전에 확인)
                    const scope = IS_SUPERADMIN ? dashboardScope : 'store';
                    const cacheKey = `dashboard_summary_${scope}`;
                    const cachedSummary = window.sessionCache?.get(cacheKey);
                    
                    // 캐시가 있으면 즉시 렌더링 (로딩바 없이)
                    if (cachedSummary && scope === 'store') {
                        // 최신 storeId 확인 (getCurrentStoreId는 동기 함수)
                        const latestStoreId = getCurrentStoreId();
                        if (latestStoreId && cachedSummary.storeId === latestStoreId) {
                            console.log('✅ [캐시] 대시보드 데이터 즉시 표시');
                            renderDashboardSummary(cachedSummary);
                            
                            // 백그라운드에서 최신 데이터 확인 (5분 이상 지난 경우만)
                            const cacheAge = Date.now() - (cachedSummary._cacheTime || 0);
                            if (cacheAge > 5 * 60 * 1000) { // 5분
                                loadDashboardSummary().catch(err => {
                                    console.warn('대시보드 백그라운드 업데이트 실패:', err);
                                });
                            }
                            return; // 즉시 반환
                        }
                    }
                    
                    // 캐시가 없거나 전체 현황인 경우 로딩바 표시
                    if (window.showGlobalLoading) {
                        window.showGlobalLoading('default', true, '대시보드 데이터를 불러오는 중...');
                    }
                    try {
                            
                            // 전체 현황일 때만 가게 목록 로드 (캐싱 활용)
                            if (dashboardScope === 'all') {
                                if (!allStores || allStores.length === 0) {
                                    // 세션 캐시 확인
                                    const storesCacheKey = 'dashboard_all_stores';
                                    const cached = window.sessionCache?.get(storesCacheKey);
                                    
                                    if (cached) {
                                        console.log('✅ [캐시] 대시보드용 가게 목록 캐시에서 로드:', cached.length);
                                        allStores = cached;
                                    } else {
                                        // 캐시에 없으면 백그라운드에서 로드 (대시보드 로드 병렬)
                                        Promise.all([
                                            loadDashboardSummary(),
                                            (async () => {
                                                const allStoresQuery = new URLSearchParams({
                                                    page: '1',
                                                    pageSize: '50',
                                                    sortBy: 'createdAt',
                                                    sortOrder: 'desc'
                                                });
                                                const allStoresResponse = await apiRequest(`${API_BASE}/stores?${allStoresQuery.toString()}`, 'GET', null, 3, false);
                                                allStores = normalizeStoreListResponse(allStoresResponse);
                                                if (window.sessionCache) {
                                                    window.sessionCache.set(storesCacheKey, allStores);
                                                }
                                                console.log('✅ [통계] 대시보드용 가게 목록 로드 완료:', allStores.length);
                                            })()
                                        ]).then(() => {
                                            if (dashboardScope === 'all') {
                                                loadDashboardStoreMetrics(dashboardStoreSearchTerm).catch(err => {
                                                    console.warn('가게별 메트릭 로드 실패:', err);
                                                });
                                            }
                                            if (window.hideGlobalLoading) {
                                                window.setLoadingBarType('success');
                                                setTimeout(() => window.hideGlobalLoading(), 200);
                                            }
                                        }).catch(error => {
                                            console.error('대시보드 로드 실패:', error);
                                            if (window.hideGlobalLoading) {
                                                window.setLoadingBarType('error');
                                                setTimeout(() => window.hideGlobalLoading(), 500);
                                            }
                                        });
                                        return; // 병렬 처리 중
                                    }
                                }
                            }
                            
                            await loadDashboardSummary();
                            // 로딩바는 모든 작업이 완료된 후 한 번만 숨김
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('success');
                                setTimeout(() => window.hideGlobalLoading(), 200);
                            }
                    } catch (error) {
                        console.error('대시보드 로드 실패:', error);
                        if (window.hideGlobalLoading) {
                            window.setLoadingBarType('error');
                            setTimeout(() => window.hideGlobalLoading(), 500);
                        }
                    }
                    return;
                }
                
                // 기본 정보 섹션인 경우 기본 정보와 영업시간만 로드
                if (sectionId === 'basic' || sectionId === 'basic-info') {
                    const loadedKey = `basicSectionLoaded_${currentStoreId}`;
                    const cacheKey = `settings_${currentStoreId}_basic,businessHours`;
                    const cached = window.sessionCache?.get(cacheKey);
                    
                    // 캐시에 있으면 즉시 표시 (로딩바 없이)
                    if (cached) {
                        console.log('✅ [캐시] 기본 정보 즉시 표시');
                        window.currentSettings = cached;
                displayBusinessHours();
                        
                        // 도메인 설정도 확인 (캐시에서 또는 백그라운드 로드)
                        const domainCacheKey = `domain_settings_${currentStoreId}`;
                        const domainCached = window.sessionCache?.get(domainCacheKey);
                        if (domainCached && domainCached.subdomain) {
                            // 캐시에 도메인 설정이 있으면 input 필드에 업데이트
                            const subdomainInput = document.getElementById('subdomain');
                            if (subdomainInput) {
                                subdomainInput.value = domainCached.subdomain || '';
                            }
                        } else {
                            // 캐시에 없으면 백그라운드에서 로드
                            loadDomainSettings().catch(err => {
                                console.warn('도메인 설정 로드 실패 (백그라운드):', err);
                            });
                        }
                        
                        renderBasicSummary();
                        window[loadedKey] = true;
                        return; // 즉시 반환
                    }
                    
                    // 캐시에 없을 때만 API 호출
                    if (!window[loadedKey]) {
                        try {
                            // 로딩 모달 표시
                            if (window.showGlobalLoading) {
                                window.showGlobalLoading('default', true, '기본 정보를 불러오는 중...');
                            }
                            
                            // 기본 정보와 도메인 설정을 동시에 로드
                            await Promise.all([
                                loadSettings(['basic', 'businessHours']),
                                loadDomainSettings().catch(err => {
                                    console.warn('도메인 설정 로드 실패 (무시):', err);
                                    return null;
                                })
                            ]);
                            
                            // loadSettings가 완료된 후 UI 업데이트
                            displayBusinessHours();
                            renderBasicSummary(); // 기본 정보 요약 표시 (서브도메인 포함)
                            window[loadedKey] = true;
                            // 로딩바는 모든 작업이 완료된 후 한 번만 숨김
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('success');
                                setTimeout(() => window.hideGlobalLoading(), 200);
                            }
                        } catch (error) {
                            console.error('기본 정보 로드 실패:', error);
                            showToast('기본 정보를 불러오는데 실패했습니다.', 'error');
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('error');
                                setTimeout(() => window.hideGlobalLoading(), 500);
                            }
                        }
                    } else {
                        // 이미 로드된 경우에도 도메인 설정 확인 및 요약 업데이트
                        const domainCacheKey = `domain_settings_${currentStoreId}`;
                        const domainCached = window.sessionCache?.get(domainCacheKey);
                        if (!domainCached) {
                            // 캐시에 없으면 백그라운드에서 로드
                            loadDomainSettings().then(() => {
                                renderBasicSummary(); // 도메인 설정 로드 후 요약 업데이트
                            }).catch(err => {
                                console.warn('도메인 설정 로드 실패 (백그라운드):', err);
                            });
                        }
                        displayBusinessHours();
                        renderBasicSummary();
                    }
                    return;
                }
            
                // UI 순서 변경 섹션인 경우 섹션 순서만 로드
            if (sectionId === 'section-order') {
                    const loadedKey = `sectionOrderLoaded_${currentStoreId}`;
                    if (!window[loadedKey]) {
                        try {
                            // 로딩 모달 표시
                            if (window.showGlobalLoading) {
                                window.showGlobalLoading('default', true, '섹션 순서를 불러오는 중...');
                            }
                            await loadSettings(['sectionOrder']);
                loadSectionOrder();
                            window[loadedKey] = true;
                            // 로딩바는 모든 작업이 완료된 후 한 번만 숨김
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('success');
                                setTimeout(() => window.hideGlobalLoading(), 200);
                            }
                        } catch (error) {
                            console.error('섹션 순서 로드 실패:', error);
                            showToast('섹션 순서를 불러오는데 실패했습니다.', 'error');
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('error');
                                setTimeout(() => window.hideGlobalLoading(), 500);
                            }
                        }
                    } else {
                        loadSectionOrder();
                    }
                    return;
                }
                
                // 배달앱 설정 섹션인 경우 배달앱 설정만 로드
            if (sectionId === 'delivery') {
                    const loadedKey = `deliverySectionLoaded_${currentStoreId}`;
                    const cacheKey = `settings_${currentStoreId}_delivery`;
                    const cached = window.sessionCache?.get(cacheKey);
                    
                    // 캐시에 있으면 즉시 표시 (로딩바 없이)
                    if (cached && window[loadedKey]) {
                        console.log('✅ [캐시] 배달앱 설정 즉시 표시');
                        window.currentSettings = { ...window.currentSettings, delivery: cached.delivery || {} };
                        await loadDeliveryOrderGrid(); // 그리드만 업데이트
                        return; // 즉시 반환
                    }
                    
                    // 캐시에 없을 때만 API 호출
                    if (!window[loadedKey]) {
                        try {
                            // 로딩 모달 표시
                            if (window.showGlobalLoading) {
                                window.showGlobalLoading('default', true, '배달앱 설정을 불러오는 중...');
                            }
                            await loadSettings(['delivery']);
                        await loadDeliveryOrderGrid();
                            window[loadedKey] = true;
                            // 로딩바는 모든 작업이 완료된 후 한 번만 숨김
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('success');
                                setTimeout(() => window.hideGlobalLoading(), 200);
                            }
                    } catch (error) {
                        console.error('배달앱 설정 로드 실패:', error);
                        showToast('배달앱 설정을 불러오는데 실패했습니다.', 'error');
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('error');
                                setTimeout(() => window.hideGlobalLoading(), 500);
                    }
                        }
            } else {
                        // 이미 로드된 경우 그리드만 업데이트
                        await loadDeliveryOrderGrid();
                    }
                    return;
                }
                
                // 이미지/동영상 관리 섹션인 경우 이미지 정보만 로드
                if (sectionId === 'images') {
                    const loadedKey = `imagesSectionLoaded_${currentStoreId}`;
                    const cacheKey = `settings_${currentStoreId}_images`;
                    const cached = window.sessionCache?.get(cacheKey);
                    
                    // 캐시에 있으면 즉시 표시 (로딩바 없이)
                    if (cached && cached.images && window[loadedKey]) {
                        console.log('✅ [캐시] 이미지 설정 즉시 표시');
                        window.currentSettings = { ...window.currentSettings, images: cached.images || {} };
                        // 이미지 미리보기 업데이트
                        if (typeof updateImagePreview === 'function') {
                            updateImagePreview('mainLogo', cached.images.mainLogo);
                            updateImagePreview('menuImage', cached.images.menuImage);
                        }
                        if (typeof updateVideoPreview === 'function') {
                            updateVideoPreview('promoVideo', cached.images.promoVideo);
                        }
                        return; // 즉시 반환
                    }
                    
                    // 캐시에 없을 때만 API 호출
                    if (!window[loadedKey]) {
                        try {
                            // 로딩 모달 표시
                            if (window.showGlobalLoading) {
                                window.showGlobalLoading('default', true, '이미지 정보를 불러오는 중...');
                            }
                            await loadSettings(['images']);
                            window[loadedKey] = true;
                            // 로딩바는 모든 작업이 완료된 후 한 번만 숨김
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('success');
                                setTimeout(() => window.hideGlobalLoading(), 200);
                            }
                        } catch (error) {
                            console.error('이미지 정보 로드 실패:', error);
                            showToast('이미지 정보를 불러오는데 실패했습니다.', 'error');
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('error');
                                setTimeout(() => window.hideGlobalLoading(), 500);
                            }
                        }
                    } else {
                        // 이미 로드된 경우에도 캐시 확인하여 UI 업데이트
                        if (cached && cached.images) {
                            if (typeof updateImagePreview === 'function') {
                                updateImagePreview('mainLogo', cached.images.mainLogo);
                                updateImagePreview('menuImage', cached.images.menuImage);
                            }
                            if (typeof updateVideoPreview === 'function') {
                                updateVideoPreview('promoVideo', cached.images.promoVideo);
                            }
                        }
                    }
                    return;
                }
                
                // 할인·픽업 안내 섹션인 경우 할인/픽업 정보만 로드
                if (sectionId === 'discount') {
                    const loadedKey = `discountSectionLoaded_${currentStoreId}`;
                    if (!window[loadedKey]) {
                        try {
                            // 로딩 모달 표시
                            if (window.showGlobalLoading) {
                                window.showGlobalLoading('default', true, '할인/픽업 정보를 불러오는 중...');
                            }
                            await loadSettings(['discount', 'pickup']);
                            window[loadedKey] = true;
                            // 로딩바는 모든 작업이 완료된 후 한 번만 숨김
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('success');
                                setTimeout(() => window.hideGlobalLoading(), 200);
                            }
                        } catch (error) {
                            console.error('할인/픽업 정보 로드 실패:', error);
                            showToast('할인/픽업 정보를 불러오는데 실패했습니다.', 'error');
                            if (window.hideGlobalLoading) {
                                window.setLoadingBarType('error');
                                setTimeout(() => window.hideGlobalLoading(), 500);
                            }
                        }
                    }
                    return;
                }
                
                // 엠버서더 관리 섹션
                if (sectionId === 'ambassadors') {
                    // 가게 선택 확인
                    const currentStoreId = getCurrentStoreId();
                    if (!currentStoreId) {
                        showStoreSelectionRequired();
                        return;
                    }
                    
                    // 엠버서더 목록 로드
                    loadAmbassadors().catch(err => {
                        console.error('엠버서더 목록 로드 실패:', err);
                        showToast('엠버서더 목록을 불러오지 못했습니다.', 'error');
                    });
                    return;
                }
            };
            
            // 데이터 로드 시작 (비동기, UI 전환 후)
            loadSectionData().catch(err => {
                console.error('섹션 데이터 로드 실패:', err);
                if (window.hideGlobalLoading) {
                    window.setLoadingBarType('error');
                    setTimeout(() => window.hideGlobalLoading(), 500);
                }
            });
        }

        // 상태 메시지 표시 (토스트 알림으로 대체됨)
        // function showStatus(message, type) {
        //     const statusDiv = document.getElementById('statusMessage');
        //     const statusText = document.getElementById('statusText');
        //     
        //     const now = new Date();
        //     const timeString = now.toLocaleTimeString('ko-KR', { 
        //         hour: '2-digit', 
        //         minute: '2-digit', 
        //         second: '2-digit' 
        //     });
        //     
        //     statusText.innerHTML = `${message} <span style="opacity: 0.7; font-size: 12px;">(${timeString})</span>`;
        //     statusDiv.className = `status-message status-${type}`;
        //     statusDiv.style.display = 'block';
        // }

        async function loadDashboardSummary(overrideScope = null) {
            try {
                const dashboardSection = document.getElementById('dashboard');
                if (!dashboardSection) return;

                // 점주 계정은 항상 'store' 스코프만 사용 (본인 가게만)
                // 슈퍼어드민만 'all' 스코프 사용 가능
                const scope = overrideScope || (IS_SUPERADMIN ? dashboardScope : 'store');
                
                // 점주 계정이 'all' 스코프로 접근하려 하면 'store'로 강제 변경
                const finalScope = (IS_STORE_OWNER && !IS_SUPERADMIN) ? 'store' : scope;
                const scopeHint = document.getElementById('dashboardScopeHint');
                if (scopeHint) {
                    scopeHint.textContent = finalScope === 'all'
                        ? '전체 가게 기준 주요 지표입니다.'
                        : '선택된 가게 기준 주요 지표입니다.';
                }

                if (finalScope === 'store') {
                    const targetStoreId = await getCurrentStoreId();
                    if (!targetStoreId) {
                        showStoreSelectionRequired();
                        return;
                    }

                    window.currentStoreId = targetStoreId;
                    
                    // 선택된 가게 카드 업데이트 최적화 (캐시 확인)
                    const storeCardCacheKey = `store_card_${targetStoreId}`;
                    const cachedStoreCard = window.sessionCache?.get(storeCardCacheKey);
                    if (!cachedStoreCard) {
                        // 캐시가 없을 때만 API 호출
                    await updateSelectedStoreCard(targetStoreId);
                    } else {
                        // 캐시가 있으면 즉시 시각적 업데이트만 수행
                    updateSelectedStoreVisual(targetStoreId);
                    }

                    const query = new URLSearchParams({
                        storeId: targetStoreId
                    });

                    const summary = await apiRequest(`${API_BASE}/dashboard/summary?${query.toString()}`, 'GET');
                    
                    // 캐시에 저장 (5분 TTL)
                    const cacheKey = `dashboard_summary_${finalScope}`;
                    if (summary && window.sessionCache) {
                        summary._cacheTime = Date.now();
                        summary.storeId = targetStoreId;
                        window.sessionCache.set(cacheKey, summary, 5 * 60 * 1000); // 5분
                    }
                    
                    renderDashboardSummary(summary);
                } else {
                    // 'all' 스코프는 슈퍼어드민만 사용 가능
                    if (!IS_SUPERADMIN) {
                        console.warn('점주 계정은 전체 현황을 볼 수 없습니다. 가게별 현황으로 전환합니다.');
                        // 점주 계정이 'all'로 접근하면 가게별 현황으로 리다이렉트
                        await loadDashboardSummary('store');
                        return;
                    }
                    
                    const query = new URLSearchParams({
                        scope: 'all'
                    });

                    const summary = await apiRequest(`${API_BASE}/dashboard/summary?${query.toString()}`, 'GET');
                    
                    // 캐시에 저장 (5분 TTL)
                    const cacheKey = `dashboard_summary_${finalScope}`;
                    if (summary && window.sessionCache) {
                        summary._cacheTime = Date.now();
                        window.sessionCache.set(cacheKey, summary, 5 * 60 * 1000); // 5분
                    }
                    
                    renderDashboardSummary(summary);
                    
                    // 가게별 메트릭은 백그라운드에서 로드 (대시보드 로드와 병렬)
                    // 슈퍼어드민만 전체 가게 메트릭 조회 가능
                    if (IS_SUPERADMIN && typeof loadDashboardStoreMetrics === 'function') {
                        loadDashboardStoreMetrics(dashboardStoreSearchTerm).catch(err => {
                            console.warn('가게별 메트릭 로드 실패:', err);
                        });
                    }
                }
            } catch (error) {
                console.error('대시보드 데이터 로드 실패:', error);
                showToast('대시보드 데이터를 불러오지 못했습니다.', 'error');
            }
        }

        function renderDashboardSummary(summary) {
            const totals = summary?.totals || {};
            const daily = summary?.daily || {};

            const pageViews = totals.page_view || 0;
            const callClicks = totals.call_click || 0;
            const menuViews = totals.menu_view || 0;
            const deliveryClicks = totals.delivery_click || 0;

            const pageViewsEl = document.getElementById('metricPageViews');
            const callClicksEl = document.getElementById('metricCallClicks');
            const menuViewsEl = document.getElementById('metricMenuViews');
            const deliveryClicksEl = document.getElementById('metricDeliveryClicks');

            if (pageViewsEl) pageViewsEl.textContent = pageViews.toLocaleString('ko-KR');
            if (callClicksEl) callClicksEl.textContent = callClicks.toLocaleString('ko-KR');
            if (menuViewsEl) menuViewsEl.textContent = menuViews.toLocaleString('ko-KR');
            if (deliveryClicksEl) deliveryClicksEl.textContent = deliveryClicks.toLocaleString('ko-KR');

            const dailyBody = document.getElementById('dashboardDailyBody');
            if (!dailyBody) return;

            const days = Object.keys(daily).sort();
            if (days.length === 0) {
                dailyBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align:center; color:#94a3b8;">데이터가 없습니다.</td>
                    </tr>
                `;
                return;
            }

            dailyBody.innerHTML = days.map(day => {
                const row = daily[day] || {};
                return `
                    <tr>
                        <td>${day}</td>
                        <td>${(row.page_view || 0).toLocaleString('ko-KR')}</td>
                        <td>${(row.call_click || 0).toLocaleString('ko-KR')}</td>
                        <td>${(row.menu_view || 0).toLocaleString('ko-KR')}</td>
                        <td>${(row.delivery_click || 0).toLocaleString('ko-KR')}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateDashboardScopeUI() {
            if (!IS_SUPERADMIN) return;
            const buttons = document.querySelectorAll('.dashboard-scope-btn');
            buttons.forEach(btn => {
                const scope = btn.getAttribute('data-scope');
                btn.classList.toggle('active', scope === dashboardScope);
            });

            const searchWrapper = document.getElementById('dashboardSearchWrapper');
            const storeTable = document.getElementById('dashboardStoreTable');
            if (searchWrapper) {
                searchWrapper.style.display = dashboardScope === 'all' ? 'flex' : 'none';
            }
            if (storeTable) {
                storeTable.style.display = dashboardScope === 'all' ? 'block' : 'none';
            }
        }

        async function setDashboardScope(scope) {
            if (!IS_SUPERADMIN) return;
            if (scope !== 'all' && scope !== 'store') return;

            // 즉시 UI 업데이트 (사용자에게 즉각적인 피드백)
            const previousScope = dashboardScope;
                dashboardScope = scope;
                updateDashboardScopeUI();
            
            // 스코프 힌트 텍스트 즉시 업데이트
            const scopeHint = document.getElementById('dashboardScopeHint');
            if (scopeHint) {
                scopeHint.textContent = scope === 'all'
                    ? '전체 가게 기준 주요 지표입니다.'
                    : '선택된 가게 기준 주요 지표입니다.';
            }

            // 캐시된 데이터가 있으면 즉시 표시
            const cacheKey = `dashboard_summary_${scope}`;
            const cachedSummary = window.sessionCache?.get(cacheKey);
            
            if (cachedSummary) {
                // 캐시된 데이터가 있고, 선택된 가게 모드인 경우 가게 ID 확인
                if (scope === 'store') {
                    const currentStoreId = await getCurrentStoreId();
                    if (currentStoreId && cachedSummary.storeId === currentStoreId) {
                        console.log('✅ [대시보드] 캐시된 데이터 즉시 표시');
                        renderDashboardSummary(cachedSummary);
                        // 백그라운드에서 최신 데이터 확인 (5분 이상 지난 경우만)
                        const cacheAge = Date.now() - (cachedSummary._cacheTime || 0);
                        if (cacheAge > 5 * 60 * 1000) {
                            loadDashboardSummary(scope).catch(err => {
                                console.warn('대시보드 백그라운드 업데이트 실패:', err);
                            });
                        }
                        return; // 즉시 반환
                    }
                } else {
                    // 전체 현황 모드: 캐시된 데이터 즉시 표시
                    console.log('✅ [대시보드] 캐시된 전체 현황 데이터 즉시 표시');
                    renderDashboardSummary(cachedSummary);
                    // 백그라운드에서 최신 데이터 확인
                    const cacheAge = Date.now() - (cachedSummary._cacheTime || 0);
                    if (cacheAge > 5 * 60 * 1000) {
                        loadDashboardSummary(scope).catch(err => {
                            console.warn('대시보드 백그라운드 업데이트 실패:', err);
                        });
                    }
                    // 가게별 메트릭도 백그라운드에서 로드
            if (scope === 'all') {
                        loadDashboardStoreMetrics(dashboardStoreSearchTerm).catch(err => {
                            console.warn('가게별 메트릭 로드 실패:', err);
                        });
                    }
                    return; // 즉시 반환
                }
            }

            // 캐시가 없으면 로딩바 표시 후 데이터 로드
            if (window.showGlobalLoading) {
                window.showGlobalLoading('default', true, scope === 'all' ? '전체 현황을 불러오는 중...' : '가게 현황을 불러오는 중...');
            }

            try {
            await loadDashboardSummary(scope);
                
                if (scope === 'all') {
                    await loadDashboardStoreMetrics(dashboardStoreSearchTerm);
                }
                
                if (window.hideGlobalLoading) {
                    window.setLoadingBarType('success');
                    setTimeout(() => window.hideGlobalLoading(), 200);
                }
            } catch (error) {
                console.error('대시보드 스코프 전환 실패:', error);
                if (window.hideGlobalLoading) {
                    window.setLoadingBarType('error');
                    setTimeout(() => window.hideGlobalLoading(), 500);
                }
                showToast('대시보드 데이터를 불러오지 못했습니다.', 'error');
            }
        }

        // 대시보드 검색 함수를 debounce로 래핑
        const debouncedDashboardSearch = debounce((searchTerm) => {
            dashboardStoreSearchTerm = searchTerm;
            loadDashboardStoreMetrics(searchTerm);
            }, 250);

        function handleDashboardStoreSearchInput(event) {
            const value = event.target.value.trim();
            debouncedDashboardSearch(value);
        }

        function formatMetricNumber(value) {
            if (typeof value !== 'number') {
                value = Number(value || 0);
            }
            return Number.isFinite(value) ? value.toLocaleString('ko-KR') : '0';
        }

        function renderStoreStatusBadge(status) {
            const normalized = (status || '').toLowerCase();
            let label = '대기';
            let className = 'status-pending';

            switch (normalized) {
                case 'active':
                    label = '운영 중';
                    className = 'status-active';
                    break;
                case 'paused':
                    label = '중지됨';
                    className = 'status-paused';
                    break;
                case 'rejected':
                    label = '거절됨';
                    className = 'status-rejected';
                    break;
                case 'pending':
                    label = '대기';
                    className = 'status-pending';
                    break;
                default:
                    label = status || '미정';
                    className = 'status-pending';
            }

            return `<span class="store-status-badge ${className}">${label}</span>`;
        }

        async function loadDashboardStoreMetrics(searchTerm = '') {
            if (!IS_SUPERADMIN) return;
            try {
                const query = new URLSearchParams({
                    scope: 'all',
                    limit: '200'
                });
                if (searchTerm) {
                    query.set('search', searchTerm);
                }
                const response = await apiRequest(`${API_BASE}/dashboard/stores?${query.toString()}`, 'GET');
                const data = response?.data || response || [];
                dashboardStoreMetrics = data;
                renderDashboardStoreMetrics();
            } catch (error) {
                console.error('가게별 대시보드 데이터 로드 실패:', error);
                showToast('가게별 대시보드를 불러오지 못했습니다.', 'error');
            }
        }

        function renderDashboardStoreMetrics() {
            if (!IS_SUPERADMIN) return;
            const tableBody = document.getElementById('dashboardStoreTableBody');
            const countEl = document.getElementById('dashboardStoreCount');

            if (countEl) {
                countEl.textContent = `총 ${dashboardStoreMetrics.length}개 가게`;
            }

            if (!tableBody) return;

            if (!dashboardStoreMetrics.length) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align:center; padding:18px; color:#94a3b8;">조건에 맞는 가게가 없습니다.</td>
                    </tr>
                `;
                return;
            }

            const sortedMetrics = [...dashboardStoreMetrics].sort((a, b) => {
                const aTime = a.lastEventAt ? new Date(a.lastEventAt).getTime() : 0;
                const bTime = b.lastEventAt ? new Date(b.lastEventAt).getTime() : 0;
                if (bTime !== aTime) {
                    return bTime - aTime;
                }
                const aCreated = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                const bCreated = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                return bCreated - aCreated;
            });

            tableBody.innerHTML = sortedMetrics.map(metric => {
                const safeStoreId = escapeForAttribute(metric.storeId || '');
                const storeName = escapeHtml(metric.storeName || '이름 없음');
                const subdomain = escapeHtml(metric.subdomain || '');
                const lastEvent = metric.lastEventAt ? new Date(metric.lastEventAt).toLocaleString('ko-KR') : '-';

                return `
                    <tr onclick="selectStoreFromDashboard(event, '${safeStoreId}')">
                        <td class="store-name-cell">
                            ${storeName}
                            <span class="store-sub-info">${subdomain ? `/${subdomain}` : '서브도메인 없음'}</span>
                        </td>
                        <td>${subdomain || '-'}</td>
                        <td>${renderStoreStatusBadge(metric.status)}</td>
                        <td>${formatMetricNumber(metric.pageViews)}</td>
                        <td>${formatMetricNumber(metric.callClicks)}</td>
                        <td>${formatMetricNumber(metric.menuViews)}</td>
                        <td>${formatMetricNumber(metric.deliveryClicks)}</td>
                        <td>${lastEvent}</td>
                        <td>
                            <button type="button" class="store-action-btn" onclick="selectStoreFromDashboard(event, '${safeStoreId}')">
                                가게 보기
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function selectStoreFromDashboard(event, storeId) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            if (!storeId) return;
            await selectStore(storeId);
            if (IS_SUPERADMIN) {
                await setDashboardScope('store');
            }
        }

        function initializeDashboardControls() {
            if (!IS_SUPERADMIN) return;
            updateDashboardScopeUI();
            const scopeButtons = document.querySelectorAll('.dashboard-scope-btn');
            scopeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const scope = btn.getAttribute('data-scope');
                    setDashboardScope(scope);
                });
            });

            const searchInput = document.getElementById('dashboardStoreSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', handleDashboardStoreSearchInput);
            }
        }
        // 활동 로그 로드
        // DB 통계 로드
        async function loadDbStats() {
            try {
                // 슈퍼어드민 권한 헤더 추가
                const headers = {};
                if (IS_SUPERADMIN) {
                    headers['X-Superadmin-Auth'] = 'true';
                }
                
                const response = await apiRequest(`${API_BASE}/db-stats`, 'GET', null, 3, false, headers);
                if (response && response.success && response.data) {
                    const stats = response.data;
                    
                    // 통계 업데이트
                    document.getElementById('dbStatsTotalQueries').textContent = stats.totalQueries.toLocaleString();
                    document.getElementById('dbStatsQueriesPerHour').textContent = `${stats.queriesPerHour} /시간`;
                    document.getElementById('dbStatsTotalBytes').textContent = formatBytes(stats.totalBytes);
                    document.getElementById('dbStatsTotalGB').textContent = `${stats.totalTransferGB} GB`;
                    document.getElementById('dbStatsUptime').textContent = `${stats.uptimeHours}시간`;
                    document.getElementById('dbStatsIncludedGB').textContent = `${stats.includedTransferGB} GB`;
                    
                    // 비용 정보 업데이트
                    const estimatedCost = stats.estimatedCost || {};
                    const costPerMonth = parseFloat(estimatedCost.transferCostPerMonth || 0);
                    const transferOverGB = parseFloat(estimatedCost.transferOverGB || 0);
                    document.getElementById('dbStatsEstimatedCost').textContent = `$${costPerMonth.toFixed(2)}`;
                    document.getElementById('dbStatsTransferOverGB').textContent = `초과 전송량: ${transferOverGB.toFixed(4)} GB`;
                    
                    // 최근 실행된 쿼리 표시 (필터링 및 제한 적용)
                    const recentQueriesEl = document.getElementById('dbStatsRecentQueries');
                    if (recentQueriesEl) {
                        let recentQueries = stats.recentQueries || [];
                        
                        // 느린 쿼리 필터 적용
                        const slowQueryFilter = document.getElementById('dbStatsSlowQueryFilter');
                        if (slowQueryFilter && slowQueryFilter.checked) {
                            recentQueries = recentQueries.filter(q => q.duration >= 1000);
                        }
                        
                        // 제한 적용
                        const queryLimitSelect = document.getElementById('dbStatsQueryLimit');
                        const limit = queryLimitSelect ? parseInt(queryLimitSelect.value) || 50 : 50;
                        recentQueries = recentQueries.slice(-limit).reverse(); // 최신순으로 정렬
                        
                        if (recentQueries.length === 0) {
                            const filterMsg = slowQueryFilter && slowQueryFilter.checked ? '느린 쿼리(1000ms 이상)가 없습니다.' : '쿼리 데이터가 없습니다.';
                            recentQueriesEl.innerHTML = `<div class="db-stats-loading">${filterMsg}</div>`;
                        } else {
                            recentQueriesEl.innerHTML = `
                                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc;">
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">시간</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">타입</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">쿼리</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">소요시간</th>
                                            <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e2e8f0;">크기</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${recentQueries.map(q => {
                                            const time = new Date(q.timestamp).toLocaleTimeString('ko-KR');
                                            const duration = q.duration >= 1000 ? `<span style="color: #ef4444; font-weight: 600;">${q.duration}ms ⚠️</span>` : (q.duration >= 500 ? `<span style="color: #f59e0b; font-weight: 500;">${q.duration}ms</span>` : `${q.duration}ms`);
                                            const size = formatBytes(q.size);
                                            const queryText = escapeHtml(q.query);
                                            return `
                                                <tr style="border-bottom: 1px solid #f1f5f9; ${q.duration >= 1000 ? 'background: #fef2f2;' : ''}">
                                                    <td style="padding: 8px; color: #64748b; white-space: nowrap;">${time}</td>
                                                    <td style="padding: 8px;"><strong style="color: #3b82f6;">${q.type}</strong></td>
                                                    <td style="padding: 8px; font-family: 'Courier New', monospace; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${queryText}">${queryText}</td>
                                                    <td style="padding: 8px; text-align: right; white-space: nowrap;">${duration}</td>
                                                    <td style="padding: 8px; text-align: right; color: #64748b; white-space: nowrap;">${size}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                <div style="margin-top: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 12px; color: #64748b; text-align: center;">
                                    ${recentQueries.length}개 쿼리 표시 중${slowQueryFilter && slowQueryFilter.checked ? ' (느린 쿼리만)' : ''}
                                </div>
                            `;
                        }
                    }
                    
                    // 쿼리 타입별 통계 테이블
                    const queriesByTypeEl = document.getElementById('dbStatsQueriesByType');
                    if (queriesByTypeEl) {
                        const queriesByType = stats.queriesByType || {};
                        const entries = Object.entries(queriesByType).sort((a, b) => b[1] - a[1]);
                        
                        if (entries.length === 0) {
                            queriesByTypeEl.innerHTML = '<div class="db-stats-loading">쿼리 데이터가 없습니다.</div>';
                        } else {
                            queriesByTypeEl.innerHTML = `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>쿼리 타입</th>
                                            <th>실행 횟수</th>
                                            <th>비율</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${entries.map(([type, count]) => {
                                            const percentage = ((count / stats.totalQueries) * 100).toFixed(1);
                                            return `
                                                <tr>
                                                    <td><strong>${type}</strong></td>
                                                    <td>${count.toLocaleString()}</td>
                                                    <td>${percentage}%</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('DB 통계 로드 실패:', error);
                showToast('DB 통계를 불러오는데 실패했습니다.', 'error');
            }
        }

        // DB 통계 리셋
        async function resetDbStats() {
            if (!confirm('DB 통계를 리셋하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            try {
                const response = await apiRequest(`${API_BASE}/db-stats/reset`, 'POST', null, 3, false);
                if (response && response.success) {
                    showToast('DB 통계가 리셋되었습니다.', 'success');
                    loadDbStats(); // 통계 다시 로드
                }
            } catch (error) {
                console.error('DB 통계 리셋 실패:', error);
                showToast('DB 통계 리셋에 실패했습니다.', 'error');
            }
        }

        async function loadActivityLogs() {
            try {
                const response = await fetch(`${API_BASE}/activity-logs`);
                const data = await response.json();
                
                // API가 배열을 직접 반환하므로 data.logs가 아닌 data 자체를 사용
                const logs = Array.isArray(data) ? data : (data.logs || []);
                
                if (logs && logs.length > 0) {
                    const filter = document.getElementById('logFilter').value;
                    let filteredLogs = logs;
                    
                    // 프론트엔드에서 필터링
                    if (filter) {
                        filteredLogs = logs.filter(log => {
                            console.log('🔍 [DEBUG] 로그 필터링:', { 
                                filter, 
                                logType: log.type, 
                                logAction: log.action,
                                matches: checkLogFilter(log, filter)
                            });
                            
                            return checkLogFilter(log, filter);
                        });
                    }
                    
                    displayActivityLogs(filteredLogs);
                } else {
                    showStatus('활동 로그를 불러오는데 실패했습니다.', 'error');
                }
            } catch (error) {
                console.error('활동 로그 로드 실패:', error);
                showStatus('활동 로그를 불러오는데 실패했습니다.', 'error');
            }
        }

        // HTML 이스케이프 함수
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 로그 필터링 체크 함수
        function checkLogFilter(log, filter) {
            const logType = log.type || log.logType || 'unknown';
            const logAction = log.action || '';
            
            switch(filter) {
                case 'store':
                    return logType === 'store' || logAction.includes('가게') || logAction.includes('store');
                case 'settings':
                    return logType === 'settings' || logAction.includes('설정') || logAction.includes('저장');
                case 'image':
                    return logType === 'image' || logAction.includes('이미지') || logAction.includes('로고');
                case 'qr':
                    return logType === 'qr' || logAction.includes('QR') || logAction.includes('도메인');
                case 'ai':
                    return logType === 'ai' || logAction.includes('AI') || logAction.includes('생성');
                case 'admin':
                    return logType === 'admin' || logAction.includes('관리자') || logAction.includes('로그인');
                case 'system':
                    return logType === 'system' || logAction.includes('시스템');
                default:
                    return true;
            }
        }

        // 도메인 설정 저장
        async function saveDomainSettings(options = {}) {
            const {
                subdomain: overrideSubdomain,
                customDomain = '',
                suppressToast = false,
                skipReload = false
            } = options || {};

            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    notifyStoreSelectionRequired();
                    return { success: false };
                }

                const subdomainInput = document.getElementById('subdomain');
                let subdomainValue = typeof overrideSubdomain === 'string'
                    ? overrideSubdomain.trim()
                    : (subdomainInput?.value.trim() || '');

                if (!subdomainValue) {
                    showToast('서브도메인을 입력해주세요.', 'error', '입력 필요');
                    return { success: false };
                }

                if (!/^[a-zA-Z0-9_-]+$/.test(subdomainValue)) {
                    showToast('서브도메인은 영문, 숫자, 하이픈(-), 언더스코어(_)만 사용할 수 있습니다.', 'error', '입력 필요');
                    return { success: false };
                }

                const role = IS_SUPERADMIN ? 'superadmin' : (IS_STORE_OWNER ? 'owner' : 'admin');

                const response = await apiRequest(`${API_BASE}/store/${currentStoreId}/domain-settings`, 'POST', {
                    subdomain: subdomainValue,
                    customDomain,
                    role,
                    updatedAt: new Date().toISOString()
                });

                // 저장 성공 후 캐시 무효화 (즉시 최신 데이터 반영)
                const cacheKey = `domain_settings_${currentStoreId}`;
                if (window.sessionCache) {
                    window.sessionCache.clear(cacheKey);
                }

                // 백엔드 캐시는 API 호출 시 자동으로 무효화됨 (프론트엔드에서 직접 접근 불가)

                // API 응답에서 최신 데이터 가져오기
                const savedData = response?.data || response || {};
                const savedSubdomain = savedData.subdomain || subdomainValue;

                // 모든 input 필드 업데이트
                if (subdomainInput) {
                    subdomainInput.value = savedSubdomain;
                }
                const domainSubdomainInput = document.getElementById('domainSubdomain');
                if (domainSubdomainInput) {
                    domainSubdomainInput.value = savedSubdomain;
                }

                // QR 정보 업데이트
                currentDomainQrInfo = {
                    url: savedData.qrCode?.url || '',
                    domainUrl: savedData.qrCode?.domainUrl || ''
                };
                
                // 도메인 설정 UI 전체 업데이트 (updateDomainQrSection이 모든 UI 요소를 업데이트함)
                updateDomainSummaryView(savedSubdomain, currentDomainQrInfo);
                applyDomainSettingsPermissions(savedData);
                updateDomainQrSection(savedSubdomain, currentDomainQrInfo);
                
                updateCurrentDomainInfo(savedSubdomain);

                await logActivity('도메인 설정 저장', {
                    subdomain: savedSubdomain
                });

                if (!suppressToast) {
                    showToast('도메인 설정이 저장되었습니다!', 'success', '저장 완료');
                }

                // skipReload가 false일 때만 다시 로드 (이미 위에서 UI 업데이트 완료)
                if (!skipReload) {
                    // 캐시 무효화 후 최신 데이터 로드
                    await loadDomainSettings();
                }

                // 설정 가이드 자동 갱신
                await refreshSetupGuideIfVisible();

                return { success: true, subdomain: savedSubdomain, data: savedData };
            } catch (error) {
                console.error('도메인 설정 저장 실패:', error);
                if (!suppressToast) {
                    showToast('도메인 설정 저장에 실패했습니다.', 'error', '저장 실패');
                }
                throw error;
            }
        }

        // 현재 도메인 정보 업데이트
        function updateCurrentDomainInfo(subdomain) {
            const currentSubdomainElement = document.getElementById('currentSubdomain');
            if (currentSubdomainElement) {
                currentSubdomainElement.textContent = subdomain ? `/${subdomain}` : '설정되지 않음';
            }
        }
        function resolveQrUrl(qrUrl) {
            if (!qrUrl) return '';
            // Base64 데이터인 경우 (data:image/png;base64,로 시작)
            if (qrUrl.startsWith('data:image/')) {
                return qrUrl;
            }
            // HTTP/HTTPS URL인 경우
            if (/^https?:\/\//i.test(qrUrl)) {
                return qrUrl;
            }
            // 상대 경로인 경우
            const normalized = qrUrl.startsWith('/') ? qrUrl : `/${qrUrl}`;
            return `${window.location.origin}${normalized}`;
        }

        let currentDomainQrInfo = { url: '', domainUrl: '' };

        function updateDomainSummaryView(subdomain, qrInfo) {
            const summaryDomainEl = document.getElementById('summaryStoreDomain');
            const noticeEl = document.getElementById('summaryDomainNotice');
            const downloadBtn = document.getElementById('summaryQrDownloadBtn');
            const resolvedSubdomain = (subdomain || '').trim();

            if (summaryDomainEl) {
                summaryDomainEl.textContent = resolvedSubdomain ? `/${resolvedSubdomain}` : '미설정';
            }

            const hasQr = qrInfo && qrInfo.url;
            if (downloadBtn) {
                downloadBtn.style.display = hasQr ? 'inline-flex' : 'none';
                downloadBtn.disabled = !hasQr;
            }

            if (noticeEl) {
                noticeEl.textContent = resolvedSubdomain
                    ? '서브도메인은 최초 설정 이후에는 슈퍼어드민만 변경할 수 있으며, QR 생성이 완료된 후에는 변경할 수 없습니다.'
                    : '서브도메인은 기본 정보 설정 변경 단계에서 최초 1회만 등록할 수 있습니다.';
            }
        }

        async function loadDomainSettings() {
            try {
                updateCurrentDomain();
                const currentStoreId = getCurrentStoreId(); // 동기 함수로 변경
                if (!currentStoreId) {
                    document.getElementById('subdomain').value = '';
                    currentDomainQrInfo = { url: '', domainUrl: '' };
                    updateDomainSummaryView('', null);
                    applyDomainSettingsPermissions({});
                    updateDomainQrSection('', null);
                    return;
                }

                // 캐시 확인
                const cacheKey = `domain_settings_${currentStoreId}`;
                const cached = window.sessionCache?.get(cacheKey);
                
                if (cached) {
                    console.log('✅ [캐시] 도메인 설정 즉시 표시');
                    const domainSettings = cached;
                    const subdomain = domainSettings.subdomain || '';
                    document.getElementById('subdomain').value = subdomain;
                    currentDomainQrInfo = {
                        url: domainSettings.qrCode?.url || '',
                        domainUrl: domainSettings.qrCode?.domainUrl || ''
                    };
                    updateDomainSummaryView(subdomain, currentDomainQrInfo);
                    applyDomainSettingsPermissions(domainSettings);
                    updateDomainQrSection(subdomain, currentDomainQrInfo);
                    
                    // 기본 정보 섹션이 활성화되어 있으면 요약도 업데이트
                    const basicSection = document.getElementById('basic');
                    if (basicSection && basicSection.style.display !== 'none') {
                        renderBasicSummary();
                    }
                    
                    return; // 캐시에서 가져온 경우 즉시 반환
                }

                // 캐시에 없을 때만 API 호출
                const response = await apiRequest(`${API_BASE}/store/${currentStoreId}/domain-settings`);
                console.log('🔍 [DEBUG] 도메인 설정 응답:', { response, success: response?.success, data: response?.data });
                
                if (response && response.success && response.data) {
                    const domainSettings = response.data;
                    const subdomain = domainSettings.subdomain || '';
                    document.getElementById('subdomain').value = subdomain;
                    
                    // QR 코드 정보 추출 (여러 경로 확인)
                    const qrCodeData = domainSettings.qrCode || {};
                    console.log('🔍 [DEBUG] QR 코드 데이터:', { qrCodeData, url: qrCodeData.url });
                    
                    currentDomainQrInfo = {
                        url: qrCodeData.url || '',
                        domainUrl: qrCodeData.domainUrl || qrCodeData.url || ''
                    };
                    
                    console.log('🔍 [DEBUG] currentDomainQrInfo 설정:', currentDomainQrInfo);
                    
                    updateDomainSummaryView(subdomain, currentDomainQrInfo);
                    applyDomainSettingsPermissions(domainSettings);
                    updateDomainQrSection(subdomain, currentDomainQrInfo);
                    
                    // 캐시에 저장
                    if (window.sessionCache) {
                        window.sessionCache.set(cacheKey, domainSettings);
                    }
                    
                    // 기본 정보 섹션이 활성화되어 있으면 요약도 업데이트
                    const basicSection = document.getElementById('basic');
                    if (basicSection && basicSection.style.display !== 'none') {
                        renderBasicSummary();
                    }
                } else {
                    // 응답이 없거나 실패한 경우에도 QR 정보 확인 (qrCode 필드 직접 확인)
                    const qrInfo = response?.data?.qrCode || response?.qrCode || {};
                    console.log('🔍 [DEBUG] 응답 실패 또는 QR 정보 확인:', { qrInfo, response });
                    
                    if (qrInfo && qrInfo.url) {
                        // QR 코드가 있으면 표시
                        const subdomain = (response?.data?.subdomain || document.getElementById('subdomain')?.value || '').trim();
                        currentDomainQrInfo = {
                            url: qrInfo.url || '',
                            domainUrl: qrInfo.domainUrl || qrInfo.url || ''
                        };
                        updateDomainSummaryView(subdomain, currentDomainQrInfo);
                        applyDomainSettingsPermissions(response?.data || {});
                        updateDomainQrSection(subdomain, currentDomainQrInfo);
                } else {
                    document.getElementById('subdomain').value = '';
                    currentDomainQrInfo = { url: '', domainUrl: '' };
                    updateDomainSummaryView('', null);
                    applyDomainSettingsPermissions({});
                        updateDomainQrSection('', null);
                    }
                }
            } catch (error) {
                console.error('도메인 설정 로드 실패:', error);
                document.getElementById('subdomain').value = '';
                currentDomainQrInfo = { url: '', domainUrl: '' };
                updateDomainSummaryView('', null);
                applyDomainSettingsPermissions({});
                updateDomainQrSection('', null);
            }
        }
        
        // 도메인/QR 섹션 UI 업데이트
        function updateDomainQrSection(subdomain, qrInfo) {
            const domainSubdomainInput = document.getElementById('domainSubdomain');
            const domainPreview = document.getElementById('domainPreview');
            const domainSaveBtn = document.getElementById('domainSaveBtn');
            const domainHelper = document.getElementById('domainHelper');
            const qrSection = document.getElementById('qrSection');
            const qrCodeDisplay = document.getElementById('qrCodeDisplay');
            const domainQrDownloadBtn = document.getElementById('domainQrDownloadBtn');
            const domainQrGenerateBtn = document.getElementById('domainQrGenerateBtn');
            
            const resolvedSubdomain = (subdomain || '').trim();
            const hasSubdomain = Boolean(resolvedSubdomain);
            const hasQr = qrInfo && qrInfo.url;
            const qrLocked = domainPermissionState.qrLocked;
            
            // 서브도메인 입력 필드 업데이트
            if (domainSubdomainInput) {
                domainSubdomainInput.value = resolvedSubdomain;
                domainSubdomainInput.readOnly = qrLocked || (hasSubdomain && !IS_SUPERADMIN);
            }
            
            // 도메인 미리보기 업데이트
            if (domainPreview) {
                const currentDomain = window.location.host;
                const protocol = window.location.protocol;
                domainPreview.textContent = resolvedSubdomain 
                    ? `${protocol}//${currentDomain}/${resolvedSubdomain}` 
                    : '-';
            }
            
            // 저장 버튼 표시/숨김
            if (domainSaveBtn) {
                const canEdit = !qrLocked && (!hasSubdomain || IS_SUPERADMIN);
                domainSaveBtn.style.display = canEdit ? 'inline-flex' : 'none';
            }
            
            // 도메인 안내 문구 업데이트
            if (domainHelper) {
                if (qrLocked) {
                    domainHelper.textContent = 'QR 생성 후에는 서브도메인을 변경할 수 없습니다.';
                    domainHelper.style.color = '#ef4444';
                } else if (hasSubdomain && !IS_SUPERADMIN) {
                    domainHelper.textContent = '서브도메인은 슈퍼어드민만 변경할 수 있습니다.';
                    domainHelper.style.color = '#64748b';
                } else {
                    domainHelper.textContent = '도메인은 최초 1회만 설정할 수 있으며 QR 생성 후에는 수정할 수 없습니다.';
                    domainHelper.style.color = '#64748b';
                }
            }
            
            // QR 섹션 표시/숨김 (QR 코드 이미지가 있을 때만 표시)
            if (qrSection) {
                qrSection.style.display = hasQr ? 'block' : 'none';
            }
            
            // QR 코드 이미지 업데이트
            if (qrCodeDisplay && hasQr && qrInfo.url) {
                const qrUrl = resolveQrUrl(qrInfo.url);
                console.log('🔍 [DEBUG] QR 코드 표시:', { qrUrl, hasQr, qrInfo, qrCodeDisplayTag: qrCodeDisplay.tagName });
                // qrCodeDisplay가 img 태그인지 div인지 확인
                if (qrCodeDisplay.tagName === 'IMG') {
                    qrCodeDisplay.src = qrUrl;
                    qrCodeDisplay.alt = 'QR 코드';
                    qrCodeDisplay.style.display = 'block';
                } else {
                    // div인 경우 innerHTML로 img 태그 삽입
                    qrCodeDisplay.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 300px; width: 100%; height: auto; display: block; margin: 0 auto;">`;
                    qrCodeDisplay.style.display = 'block';
                }
            } else if (qrCodeDisplay) {
                if (qrCodeDisplay.tagName === 'IMG') {
                    qrCodeDisplay.style.display = 'none';
                } else {
                    qrCodeDisplay.innerHTML = '';
                    qrCodeDisplay.style.display = 'none';
                }
            }
            
            // QR 다운로드 버튼 표시/숨김
            if (domainQrDownloadBtn) {
                domainQrDownloadBtn.style.display = hasQr ? 'inline-flex' : 'none';
                domainQrDownloadBtn.disabled = !hasQr;
            }
            
            // QR 생성 버튼 표시/숨김 (슈퍼어드민 또는 점주, QR이 없고 서브도메인이 있을 때)
            if (domainQrGenerateBtn) {
                // 슈퍼어드민 또는 점주 계정이 QR을 생성할 수 있음 (QR이 없고 서브도메인이 있으며 잠금 상태가 아닐 때)
                const canGenerate = (IS_SUPERADMIN || IS_STORE_OWNER) && !hasQr && hasSubdomain && !qrLocked;
                console.log('QR 생성 버튼 표시 조건:', { 
                    IS_SUPERADMIN, 
                    IS_STORE_OWNER,
                    hasQr, 
                    hasSubdomain, 
                    qrLocked, 
                    canGenerate 
                });
                domainQrGenerateBtn.style.display = canGenerate ? 'inline-flex' : 'none';
            }
        }
        
        // 도메인/QR 섹션에서 저장
        window.saveDomainFromSection = async function saveDomainFromSection() {
            const domainSubdomainInput = document.getElementById('domainSubdomain');
            const subdomainValue = domainSubdomainInput?.value.trim() || '';
            
            if (!subdomainValue) {
                showToast('서브도메인을 입력해주세요.', 'error', '입력 필요');
                return;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(subdomainValue)) {
                showToast('서브도메인은 영문, 숫자, 하이픈(-), 언더스코어(_)만 사용할 수 있습니다.', 'error', '입력 오류');
                return;
            }
            
            try {
                // 저장 전에 캐시 무효화 (저장 후 즉시 반영되도록)
                const currentStoreId = getCurrentStoreId();
                if (currentStoreId) {
                    const cacheKey = `domain_settings_${currentStoreId}`;
                    if (window.sessionCache) {
                        window.sessionCache.clear(cacheKey);
                    }
                }
                
                const result = await saveDomainSettings({ 
                    subdomain: subdomainValue,
                    suppressToast: true,  // 중복 토스트 방지
                    skipReload: true      // saveDomainSettings에서 이미 UI 업데이트 완료
                });
                
                if (result && result.success) {
                    // 저장 성공 - saveDomainSettings에서 이미 UI 업데이트 완료
                    showToast('서브도메인이 저장되었습니다!', 'success', '저장 완료');
                } else {
                    showToast('도메인 저장에 실패했습니다.', 'error', '저장 실패');
                }
            } catch (error) {
                console.error('도메인 저장 실패:', error);
                const errorMessage = error?.message || '도메인 저장에 실패했습니다.';
                showToast(errorMessage, 'error', '저장 실패');
            }
        };
        
        // 도메인/QR 섹션에서 QR 생성
        window.generateDomainQRFromSection = function generateDomainQRFromSection() {
            generateDomainQR();
        };

        // 설정 가이드 열기
        async function openSetupGuide() {
            const currentStoreId = await getCurrentStoreId();
            if (!currentStoreId) {
                showToast('가게를 먼저 선택해주세요.', 'error', '가게 선택 필요');
                    return;
                }

            showSection('setup-guide');
            await renderSetupGuide();
        }
        
        // 설정 가이드 렌더링
        async function renderSetupGuide() {
            const container = document.getElementById('setupGuideContainer');
            if (!container) return;
            
            const currentStoreId = await getCurrentStoreId();
            if (!currentStoreId) {
                container.innerHTML = '<div style="padding: 24px; text-align: center; color: #ef4444;">가게를 먼저 선택해주세요.</div>';
                return;
            }
            
            try {
                // 가게 정보 및 설정 로드 (에러 핸들링 강화)
                // 설정 저장 후 즉시 반영을 위해 window.currentSettings 우선 사용
                let store = null;
                let settings = window.currentSettings || {}; // 저장된 설정 우선 사용
                let domainSettings = {};
                
                try {
                    const storeResponse = await apiRequest(`${API_BASE}/stores/${currentStoreId}`);
                    store = normalizeStoreDetailResponse(storeResponse, currentStoreId);
                    if (!store) {
                        throw new Error('가게 정보를 찾을 수 없습니다.');
                    }
                } catch (error) {
                    console.error('가게 정보 로드 실패:', error);
                    throw new Error('가게 정보를 불러올 수 없습니다.');
                }
                
                // window.currentSettings가 없거나 불완전한 경우만 API 호출
                // 설정 저장 후 즉시 반영을 위해 window.currentSettings 우선 사용
                if (!settings || Object.keys(settings).length === 0) {
                    try {
                        const settingsResponse = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                        const fetchedSettings = settingsResponse?.data || settingsResponse || {};
                        settings = fetchedSettings;
                        // window.currentSettings 초기화 (항상 최신 데이터로 업데이트)
                        window.currentSettings = settings;
                        console.log('✅ [설정 가이드] API에서 설정 로드 및 저장:', { 
                            hasDiscount: Boolean(settings.discount),
                            hasPickup: Boolean(settings.pickup),
                            discountEnabled: settings.discount?.enabled,
                            pickupEnabled: settings.pickup?.enabled,
                            hasImages: Boolean(settings.images)
                        });
                    } catch (error) {
                        console.warn('설정 로드 실패 (기본값 사용):', error);
                        settings = settings || {};
                        if (!window.currentSettings) {
                            window.currentSettings = settings;
                        }
                    }
                } else {
                    // window.currentSettings가 있으면 사용 (저장된 최신 설정)
                    settings = window.currentSettings;
                    console.log('✅ [설정 가이드] 저장된 설정 사용:', { 
                        hasDiscount: Boolean(settings.discount),
                        hasPickup: Boolean(settings.pickup),
                        discountEnabled: settings.discount?.enabled,
                        pickupEnabled: settings.pickup?.enabled,
                        hasImages: Boolean(settings.images)
                    });
                }
                
                // 도메인 설정 로드 (캐시 확인 후 필요시 API 호출)
                try {
                    const domainCacheKey = `domain_settings_${currentStoreId}`;
                    const cachedDomainSettings = window.sessionCache?.get(domainCacheKey);
                    
                    if (cachedDomainSettings) {
                        // 캐시에서 가져온 도메인 설정 사용
                        domainSettings = cachedDomainSettings;
                        console.log('✅ [설정 가이드] 캐시된 도메인 설정 사용');
                    } else {
                        // 캐시가 없으면 API 호출
                        const domainResponse = await apiRequest(`${API_BASE}/store/${currentStoreId}/domain-settings`);
                        domainSettings = domainResponse?.data || domainResponse || {};
                        
                        // 캐시에 저장 (5분 TTL)
                        if (window.sessionCache && domainSettings) {
                            window.sessionCache.set(domainCacheKey, domainSettings);
                        }
                        console.log('✅ [설정 가이드] API에서 도메인 설정 로드');
                    }
                } catch (error) {
                    console.warn('도메인 설정 로드 실패 (기본값 사용):', error);
                    domainSettings = {};
                }
                
                // 각 항목 완료 상태 체크 (에러 핸들링 포함)
                let checkStatus;
                try {
                    checkStatus = checkSetupStatus(store, settings, domainSettings);
                } catch (error) {
                    console.error('설정 상태 체크 실패:', error);
                    throw new Error('설정 상태를 확인할 수 없습니다.');
                }
                
                // 진행률 계산
                const progress = calculateSetupProgress(checkStatus);
                
                // 가이드 렌더링
                container.innerHTML = `
                    <div class="setup-guide-progress">
                        <div class="setup-guide-progress-text">
                            <span class="setup-guide-progress-label">설정 완료도</span>
                            <span class="setup-guide-progress-percent">${progress}%</span>
                        </div>
                        <div class="setup-guide-progress-bar">
                            <div class="setup-guide-progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    ${renderSetupStep(1, '기본 정보', [
                        { label: '하단 텍스트', key: 'subtitle', required: false },
                        { label: '전화번호', key: 'phone', required: true },
                        { label: '주소', key: 'address', required: true },
                        { label: '도메인', key: 'subdomain', required: true, hasExample: true },
                        { label: 'QR 생성', key: 'qrCode', required: true }
                    ], checkStatus, store, settings, domainSettings, 'basic')}
                    
                    ${renderSetupStep(2, '이미지/동영상', [
                        { label: '로고', key: 'logo', required: true },
                        { label: '메뉴 이미지', key: 'menuImage', required: true },
                        { label: '동영상', key: 'video', required: false }
                    ], checkStatus, store, settings, domainSettings, 'images')}
                    
                    ${renderSetupStep(3, '추가 설정', [
                        { label: '할인 이벤트', key: 'discount', required: false },
                        { label: '픽업 안내', key: 'pickup', required: false }
                    ], checkStatus, store, settings, domainSettings, 'discount')}
                    
                    ${renderSetupStep(4, '가게 페이지 미리보기', [], checkStatus, store, settings, domainSettings, 'preview')}
                    
                    ${renderSetupStep(5, 'UI 순서 변경', [], checkStatus, store, settings, domainSettings, 'ui-order')}
                `;
                
                // 미리보기 iframe 설정
                const previewIframe = container.querySelector('#setupGuidePreview');
                if (previewIframe && store?.subdomain) {
                    const origin = window.location.origin;
                    previewIframe.src = `${origin}/${store.subdomain}`;
                }
            } catch (error) {
                console.error('설정 가이드 렌더링 실패:', error);
                const errorMessage = error?.message || '알 수 없는 오류가 발생했습니다.';
                container.innerHTML = `
                    <div style="padding: 24px; text-align: center; color: #ef4444;">
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">설정 가이드를 불러오는데 실패했습니다.</p>
                        <p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">${errorMessage}</p>
                        <button onclick="renderSetupGuide()" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">다시 시도</button>
                    </div>
                `;
            }
        }
        
        // 설정 상태 체크 (안전한 타입 체크)
        function checkSetupStatus(store, settings, domainSettings) {
            try {
                // 문자열 안전 체크 헬퍼
                const hasString = (value) => {
                    if (!value) return false;
                    if (typeof value === 'string') return value.trim().length > 0;
                    return false;
                };
                
                // 이미지 안전 체크 헬퍼 (문자열 또는 객체)
                const hasImage = (value) => {
                    if (!value) return false;
                    if (typeof value === 'string') return value.trim().length > 0;
                    if (typeof value === 'object' && value.src) return hasString(value.src);
                    return false;
                };
                
                // 동영상 안전 체크 헬퍼 (객체 형태)
                const hasVideo = (value) => {
                    if (!value) return false;
                    if (typeof value === 'object' && value.src) {
                        return hasString(value.src);
                    }
                    if (typeof value === 'string') {
                        return value.trim().length > 0;
                    }
                    return false;
                };
                
                return {
                    subtitle: hasString(store?.subtitle),
                    phone: hasString(store?.phone),
                    address: hasString(store?.address),
                    subdomain: hasString(domainSettings?.subdomain),
                    qrCode: Boolean(
                        (domainSettings?.qrCode?.url && hasString(domainSettings.qrCode.url)) ||
                        (domainSettings?.qrCode?.base64 && hasString(domainSettings.qrCode.base64))
                    ),
                    logo: hasImage(settings?.images?.mainLogo),
                    menuImage: hasImage(settings?.images?.menuImage),
                    video: hasVideo(settings?.images?.promoVideo),
                    discount: Boolean(
                        settings?.discount?.enabled && 
                        hasString(settings.discount.description)
                    ),
                    pickup: Boolean(
                        settings?.pickup?.enabled && 
                        hasString(settings.pickup.description)
                    )
                };
            } catch (error) {
                console.error('설정 상태 체크 실패:', error);
                // 에러 발생 시 모든 항목을 false로 반환 (안전한 기본값)
                return {
                    subtitle: false,
                    phone: false,
                    address: false,
                    subdomain: false,
                    qrCode: false,
                    logo: false,
                    menuImage: false,
                    video: false,
                    discount: false,
                    pickup: false
                };
            }
        }
        
        // 진행률 계산
        function calculateSetupProgress(checkStatus) {
            const required = ['phone', 'address', 'subdomain', 'qrCode', 'logo', 'menuImage'];
            const optional = ['subtitle', 'video', 'discount', 'pickup'];
            
            const requiredCompleted = required.filter(key => checkStatus[key]).length;
            const optionalCompleted = optional.filter(key => checkStatus[key]).length;
            
            // 필수 항목 70%, 선택 항목 30%
            const requiredProgress = (requiredCompleted / required.length) * 70;
            const optionalProgress = (optionalCompleted / optional.length) * 30;
            
            return Math.round(requiredProgress + optionalProgress);
        }
        
        // 설정 단계 렌더링
        function renderSetupStep(stepNumber, title, items, checkStatus, store, settings, domainSettings, sectionId) {
            const isCompleted = items.length === 0 || items.every(item => {
                if (item.required) {
                    return checkStatus[item.key];
                }
                return true; // 선택 항목은 완료 체크에 포함하지 않음
            });
            
            const isActive = stepNumber === 1 || (stepNumber > 1 && renderSetupStep.previousCompleted !== false);
            renderSetupStep.previousCompleted = isCompleted;
            
            let contentHtml = '';
            
            // 4단계: 가게 페이지 미리보기
            if (stepNumber === 4) {
                contentHtml = `
                    <div class="setup-guide-preview">
                        <p style="margin-bottom: 12px; color: #6b7280; font-size: 14px;">
                            가게 페이지를 미리보고, 설정이 제대로 반영되었는지 확인하세요.
                        </p>
                        ${store?.subdomain ? `
                            <iframe id="setupGuidePreview" src="" style="width: 100%; height: 600px; border: none; border-radius: 8px; background: white;"></iframe>
                        ` : `
                            <div style="padding: 40px; text-align: center; color: #94a3b8;">
                                도메인을 먼저 설정해야 미리보기를 사용할 수 있습니다.
                            </div>
                        `}
                    </div>
                `;
            }
            // 5단계: UI 순서 변경
            else if (stepNumber === 5) {
                contentHtml = `
                    <div style="padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px dashed #d1d5db;">
                        <p style="margin-bottom: 16px; color: #374151; font-size: 14px; line-height: 1.6;">
                            가게 페이지의 섹션 순서를 변경하여 고객이 원하는 정보를 먼저 볼 수 있도록 설정하세요.
                        </p>
                        <button onclick="showSection('ui-order')" class="setup-guide-item-action">
                            UI 순서 변경하러 가기
                        </button>
                    </div>
                `;
            }
            // 일반 단계
            else {
                contentHtml = items.map(item => {
                    const isItemCompleted = checkStatus[item.key];
                    const badgeClass = item.required ? 'required' : 'optional';
                    const badgeText = item.required ? '필수' : '선택';
                    
                    let actionHtml = '';
                    if (!isItemCompleted) {
                        actionHtml = `<a href="javascript:void(0)" onclick="navigateToSetupItem('${sectionId}', '${item.key}')" class="setup-guide-item-action">설정하러 가기</a>`;
                    }
                    
                    let exampleHtml = '';
                    if (item.hasExample && item.key === 'subdomain') {
                        exampleHtml = `
                            <div class="setup-guide-example">
                                <strong>예시:</strong> 예를 들어 "my-store"를 입력하면 
                                <code style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${window.location.origin}/my-store</code>
                                주소로 가게 페이지가 제공됩니다.
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="setup-guide-item ${isItemCompleted ? 'completed' : ''}">
                            <div class="setup-guide-item-checkbox">
                                ${isItemCompleted ? '✓' : ''}
                            </div>
                            <div class="setup-guide-item-label">
                                <strong>${item.label}</strong>
                            </div>
                            <span class="setup-guide-item-badge ${badgeClass}">${badgeText}</span>
                            ${actionHtml}
                            ${exampleHtml}
                        </div>
                    `;
                }).join('');
            }
            
            return `
                <div class="setup-guide-step ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
                    <div class="setup-guide-step-header">
                        <div class="setup-guide-step-title">
                            <div class="setup-guide-step-number">${stepNumber}</div>
                            <span>${title}</span>
                        </div>
                        <span class="setup-guide-step-status ${isCompleted ? 'completed' : (items.some(i => i.required) ? 'required' : 'optional')}">
                            ${isCompleted ? '완료' : (items.some(i => i.required) ? '필수 설정' : '선택 설정')}
                        </span>
                    </div>
                    <div class="setup-guide-step-content">
                        ${contentHtml}
                    </div>
                </div>
            `;
        }
        
        // 설정 항목으로 이동
        async function navigateToSetupItem(sectionId, itemKey) {
            // 해당 섹션으로 이동
            await showSection(sectionId);
            
            // 특정 항목으로 스크롤 (필요시)
            setTimeout(() => {
                const element = document.getElementById(itemKey) || document.querySelector(`[data-item="${itemKey}"]`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.focus();
                }
            }, 300);
        }
        
        // 이전 완료 상태 추적을 위한 변수
        renderSetupStep.previousCompleted = true;
        
        // 설정 가이드 자동 갱신 (설정 저장 후 호출)
        async function refreshSetupGuideIfVisible() {
            const setupGuideSection = document.getElementById('setup-guide');
            if (setupGuideSection && setupGuideSection.style.display !== 'none') {
                // 설정 가이드가 보이는 상태면 자동 갱신
                try {
                    // 도메인 설정도 최신 상태로 갱신 (캐시 무효화)
                    const currentStoreId = await getCurrentStoreId();
                    if (currentStoreId) {
                        const domainCacheKey = `domain_settings_${currentStoreId}`;
                        if (window.sessionCache) {
                            window.sessionCache.clear(domainCacheKey);
                        }
                    }
                    await renderSetupGuide();
                } catch (error) {
                    console.warn('설정 가이드 자동 갱신 실패:', error);
                }
            }
        }

        window.downloadDomainQR = async function downloadDomainQR() {
            try {
                // currentDomainQrInfo가 없거나 URL이 없으면 최신 정보 로드
                if (!currentDomainQrInfo || !currentDomainQrInfo.url) {
                    await loadDomainSettings();
                }
                
                const qrUrl = currentDomainQrInfo?.url;
                if (!qrUrl) {
                    showToast('다운로드할 QR 코드가 없습니다. 먼저 QR 코드를 생성해주세요.', 'error', '오류');
                    return;
                }

                // QR 코드 URL 해결 (상대 경로인 경우 절대 경로로 변환)
                const resolvedUrl = resolveQrUrl(qrUrl);
                console.log('QR 코드 다운로드 시도:', resolvedUrl);
                const response = await fetch(resolvedUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                if (!blob.type.startsWith('image/')) {
                    console.warn('⚠️ [DEBUG] 예상치 못한 MIME 타입:', blob.type);
                }

                const url = window.URL.createObjectURL(blob);
                const currentStoreId = await getCurrentStoreId();
                const storeName = document.getElementById('storeName')?.value || 'store';
                const cleanStoreName = storeName.replace(/[^a-zA-Z0-9가-힣]/g, '_');
                const cleanStoreId = (currentStoreId || '').replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `qr_code_${cleanStoreName}_${cleanStoreId}.png`;

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showToast('QR 코드가 PNG 파일로 다운로드되었습니다.', 'success', '다운로드 완료');

                if (currentStoreId) {
                    try {
                    await logActivity('qr', 'QR 코드 다운로드', 'QR 코드를 다운로드했습니다.', {
                        storeId: currentStoreId,
                        filename,
                        fileSize: blob.size,
                        mimeType: blob.type
                    });
                    } catch (logError) {
                        console.warn('활동 로그 기록 실패:', logError);
                    }
                }
            } catch (error) {
                console.error('❌ [DEBUG] QR 코드 다운로드 실패:', error);
                const errorMessage = error?.message || 'QR 코드 다운로드에 실패했습니다.';
                showToast(errorMessage, 'error', '다운로드 실패');
            }
        };

        function generateDomainQR() {
            // 슈퍼어드민 또는 점주 계정만 QR 생성 가능
            if (!IS_SUPERADMIN && !IS_STORE_OWNER) {
                showToast('QR 생성 권한이 없습니다.', 'error', '권한 부족');
                return;
            }
            if (domainPermissionState.qrLocked) {
                showToast('이미 생성된 QR 코드는 변경할 수 없습니다.', 'error', 'QR 잠김');
                return;
            }

            const subdomainValue = document.getElementById('subdomain')?.value.trim() || 
                                   document.getElementById('domainSubdomain')?.value.trim() || '';
            if (!subdomainValue) {
                showToast('먼저 서브도메인을 설정해주세요.', 'error', '도메인 필요');
                return;
            }

            showModal('QR 코드 생성', `서브도메인 "${subdomainValue}"에 대한 QR 코드를 생성하시겠습니까?`, [
                {
                    text: '취소',
                    class: 'btn-secondary',
                    onclick: 'closeModal()'
                },
                {
                    text: '생성',
                    class: 'btn-primary',
                    onclick: 'confirmQRGenerate()'
                }
            ]);
        }

        // QR 생성 확인 함수
        window.confirmQRGenerate = async function confirmQRGenerate() {
            closeModal();
            try {
            const currentStoreId = await getCurrentStoreId();
            if (!currentStoreId) {
                    showToast('가게를 선택해주세요.', 'error', '가게 선택 필요');
                return;
            }

                const subdomainValue = document.getElementById('subdomain')?.value.trim() || 
                                       document.getElementById('domainSubdomain')?.value.trim() || '';
            if (!subdomainValue) {
                    showToast('서브도메인을 먼저 설정해주세요.', 'error', '도메인 필요');
                return;
            }

                showToast('QR 코드 생성 중...', 'info', '처리 중');
                
                const role = IS_SUPERADMIN ? 'superadmin' : (IS_STORE_OWNER ? 'owner' : 'admin');
                
                const response = await apiRequest(`${API_BASE}/store/${currentStoreId}/qr-code`, 'POST', {
                    storeId: currentStoreId,
                    subdomain: subdomainValue,
                    role: role
                });

                if (response && response.success) {
                    // QR 생성 성공 후 캐시 무효화 (최신 데이터 반영)
                    if (currentStoreId) {
                        const cacheKey = `domain_settings_${currentStoreId}`;
                        if (window.sessionCache) {
                            window.sessionCache.clear(cacheKey);
                        }
                        // 백엔드 캐시도 무효화
                        if (window.dbServices && window.dbServices.clearCache) {
                            window.dbServices.clearCache('storeSettings', currentStoreId);
                        }
                    }
                    
                    // QR 정보 즉시 업데이트 (응답에서 직접 가져오기)
                    const qrData = response.data?.qrCode || response.qrCode || {};
                    if (qrData && qrData.url) {
                currentDomainQrInfo = {
                            url: qrData.url || '',
                            domainUrl: qrData.domainUrl || ''
                        };
                        // 즉시 UI 업데이트
                        updateDomainSummaryView(subdomainValue, currentDomainQrInfo);
                        updateDomainQrSection(subdomainValue, currentDomainQrInfo);
                        
                        // 캐시에 저장
                        if (window.sessionCache && currentStoreId) {
                            const cacheKey = `domain_settings_${currentStoreId}`;
                            window.sessionCache.set(cacheKey, {
                        subdomain: subdomainValue,
                                qrCode: currentDomainQrInfo
                            });
                    }
                    } else {
                        // 응답에 QR 정보가 없으면 도메인 설정 다시 로드
                        await loadDomainSettings();
                    }

                    showToast('QR 코드가 생성되었습니다!', 'success', '생성 완료');
                    
                    // 설정 가이드 자동 갱신
                    await refreshSetupGuideIfVisible();
                } else {
                    throw new Error(response?.message || 'QR 코드 생성 실패');
                }
            } catch (error) {
                console.error('QR 코드 생성 실패:', error);
                showToast(error.message || 'QR 코드 생성에 실패했습니다.', 'error', '생성 실패');
            }
        };
        // 현재 도메인 업데이트
        function updateCurrentDomain() {
            const currentDomain = window.location.host;
            const domainPrefix = document.getElementById('domainPrefix');
            const currentDomainElement = document.getElementById('currentDomain');
            
            if (domainPrefix) {
                domainPrefix.textContent = currentDomain + '/';
            }
            if (currentDomainElement) {
                currentDomainElement.textContent = currentDomain;
            }
        }

        function applyDomainSettingsPermissions(domainData = {}) {
            const resolvedSubdomain = domainData.subdomain || domainData.domainSettings?.subdomain || '';
            const hasSubdomain = Boolean(resolvedSubdomain);
            const hasQr = Boolean(domainData.qrCode?.url || domainData.domainSettings?.qrCode?.url);
            const qrLockedAt = domainData.qrLockedAt || domainData.domainSettings?.qrLockedAt || null;
            // QR이 실제로 존재할 때만 qrLocked를 true로 설정
            const qrLocked = hasQr && Boolean(qrLockedAt);

            domainPermissionState = {
                hasSubdomain,
                qrLocked
            };

            const subdomainInput = document.getElementById('subdomain');
            if (subdomainInput) {
                subdomainInput.dataset.hasSubdomain = hasSubdomain ? 'true' : 'false';
                subdomainInput.dataset.qrLocked = qrLocked ? 'true' : 'false';
                subdomainInput.readOnly = hasSubdomain;
            }

            const summaryDownloadBtn = document.getElementById('summaryQrDownloadBtn');
            if (summaryDownloadBtn) {
                summaryDownloadBtn.style.display = currentDomainQrInfo.url ? 'inline-flex' : 'none';
                summaryDownloadBtn.disabled = !currentDomainQrInfo.url;
            }
        }

        async function populateOwnerAccountSection() {
            if (!IS_STORE_OWNER) return;
            const emailEl = document.getElementById('ownerAccountEmail');
            const nameEl = document.getElementById('ownerAccountName');
            const primaryStoreNameEl = document.getElementById('ownerPrimaryStoreName');
            const primaryStoreSelectEl = document.getElementById('ownerPrimaryStoreSelect');
            
            if (emailEl) {
                emailEl.textContent = sessionStorage.getItem('owner_email') || '-';
            }
            if (nameEl) {
                nameEl.textContent = sessionStorage.getItem('owner_name') || '-';
            }
            
            // 점주가 연결된 가게 목록 가져오기
            try {
                const ownerId = sessionStorage.getItem('owner_id');
                if (!ownerId) return;
                
                const ownerStoresStr = sessionStorage.getItem('owner_store_list');
                const ownerStores = ownerStoresStr ? JSON.parse(ownerStoresStr) : [];
                const primaryStoreId = sessionStorage.getItem('owner_store_id') || '';
                
                // 대표 가게 선택 드롭다운 채우기
                if (primaryStoreSelectEl) {
                    primaryStoreSelectEl.innerHTML = '<option value="">가게를 선택하세요</option>';
                    ownerStores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.id;
                        option.textContent = store.name || store.id;
                        if (store.id === primaryStoreId || store.isPrimary) {
                            option.selected = true;
                        }
                        primaryStoreSelectEl.appendChild(option);
                    });
                }
                
                // 대표 가게 이름 표시
                if (primaryStoreNameEl) {
                    const primaryStore = ownerStores.find(store => store.id === primaryStoreId || store.isPrimary);
                    if (primaryStore) {
                        primaryStoreNameEl.textContent = primaryStore.name || primaryStore.id;
                    } else if (ownerStores.length > 0) {
                        primaryStoreNameEl.textContent = ownerStores[0].name || ownerStores[0].id;
                    } else {
                        primaryStoreNameEl.textContent = '대표 가게가 설정되지 않았습니다';
                    }
                }
            } catch (error) {
                console.error('점주 계정 정보 로드 실패:', error);
            }
        }
        
        async function saveOwnerPrimaryStore() {
            if (!IS_STORE_OWNER) {
                showToast('사장님 전용 기능입니다.', 'error', '권한 부족');
                return;
            }
            
            const ownerId = sessionStorage.getItem('owner_id');
            if (!ownerId) {
                showToast('점주 정보를 찾을 수 없습니다. 다시 로그인해주세요.', 'error', '권한 부족');
                return;
            }
            
            const primaryStoreSelectEl = document.getElementById('ownerPrimaryStoreSelect');
            const storeId = primaryStoreSelectEl?.value?.trim() || '';
            
            if (!storeId) {
                showToast('대표 가게를 선택해주세요.', 'error', '입력 필요');
                return;
            }
            
            try {
                await apiRequest(`${API_BASE}/owner/primary-store`, 'POST', {
                    ownerId,
                    storeId
                });
                
                // sessionStorage 업데이트
                sessionStorage.setItem('owner_store_id', storeId);
                
                // 대표 가게 이름 업데이트
                const ownerStoresStr = sessionStorage.getItem('owner_store_list');
                const ownerStores = ownerStoresStr ? JSON.parse(ownerStoresStr) : [];
                const primaryStore = ownerStores.find(store => store.id === storeId);
                
                const primaryStoreNameEl = document.getElementById('ownerPrimaryStoreName');
                if (primaryStoreNameEl && primaryStore) {
                    primaryStoreNameEl.textContent = primaryStore.name || primaryStore.id;
                }
                
                // 현재 가게 ID도 업데이트 (대표 가게로 자동 전환)
                window.currentStoreId = storeId;
                localStorage.setItem('currentStoreId', storeId);
                
                // 사이드바 업데이트
                updateCurrentStoreInfo(storeId).catch(err => {
                    console.warn('가게 정보 업데이트 실패:', err);
                });
                
                showToast('대표 가게가 설정되었습니다.', 'success', '설정 완료');
            } catch (error) {
                console.error('대표 가게 설정 실패:', error);
                showToast(error.message || '대표 가게 설정에 실패했습니다.', 'error', '설정 실패');
            }
        }
        
        // 대표 가게 설정 모달 표시
        function showPrimaryStoreSetupModal(ownerStores = null) {
            const modal = document.getElementById('primaryStoreSetupModal');
            const selectEl = document.getElementById('primaryStoreModalSelect');
            
            if (!modal || !selectEl) return;
            
            // 가게 목록이 없으면 가져오기
            if (!ownerStores) {
                const ownerStoresStr = sessionStorage.getItem('owner_store_list');
                ownerStores = ownerStoresStr ? JSON.parse(ownerStoresStr) : [];
            }
            
            // 드롭다운 채우기
            selectEl.innerHTML = '<option value="">가게를 선택하세요</option>';
            ownerStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.name || store.id;
                selectEl.appendChild(option);
            });
            
            if (ownerStores.length === 0) {
                selectEl.innerHTML = '<option value="">연결된 가게가 없습니다</option>';
                selectEl.disabled = true;
            }
            
            modal.style.display = 'flex';
        }
        
        // 대표 가게 설정 모달 닫기
        function closePrimaryStoreSetupModal() {
            const modal = document.getElementById('primaryStoreSetupModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 모달에서 대표 가게 설정
        async function savePrimaryStoreFromModal() {
            const selectEl = document.getElementById('primaryStoreModalSelect');
            const storeId = selectEl?.value?.trim() || '';
            
            if (!storeId) {
                showToast('대표 가게를 선택해주세요.', 'error', '입력 필요');
                return;
            }
            
            const ownerId = sessionStorage.getItem('owner_id');
            if (!ownerId) {
                showToast('점주 정보를 찾을 수 없습니다. 다시 로그인해주세요.', 'error', '권한 부족');
                return;
            }
            
            try {
                await apiRequest(`${API_BASE}/owner/primary-store`, 'POST', {
                    ownerId,
                    storeId
                });
                
                // sessionStorage 업데이트
                sessionStorage.setItem('owner_store_id', storeId);
                
                // 현재 가게 ID도 업데이트 (대표 가게로 자동 전환)
                window.currentStoreId = storeId;
                localStorage.setItem('currentStoreId', storeId);
                
                // 사이드바 업데이트
                updateCurrentStoreInfo(storeId).catch(err => {
                    console.warn('가게 정보 업데이트 실패:', err);
                });
                
                // 모달 닫기
                closePrimaryStoreSetupModal();
                
                showToast('대표 가게가 설정되었습니다.', 'success', '설정 완료');
            } catch (error) {
                console.error('대표 가게 설정 실패:', error);
                showToast(error.message || '대표 가게 설정에 실패했습니다.', 'error', '설정 실패');
            }
        }

        async function changeOwnerPassword() {
            if (!IS_STORE_OWNER) {
                showToast('사장님 전용 기능입니다.', 'error', '권한 부족');
                return;
            }

            const ownerId = sessionStorage.getItem('owner_id');
            if (!ownerId) {
                showToast('점주 정보를 찾을 수 없습니다. 다시 로그인해주세요.', 'error', '권한 부족');
                return;
            }

            const currentPassword = document.getElementById('ownerCurrentPassword')?.value.trim() || '';
            const newPassword = document.getElementById('ownerNewPassword')?.value.trim() || '';
            const confirmPassword = document.getElementById('ownerNewPasswordConfirm')?.value.trim() || '';

            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('현재 비밀번호와 새 비밀번호를 모두 입력해주세요.', 'error', '입력 필요');
                return;
            }

            if (newPassword.length < 8) {
                showToast('새 비밀번호는 8자 이상 입력해주세요.', 'error', '입력 필요');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('새 비밀번호가 일치하지 않습니다.', 'error', '입력 필요');
                return;
            }

            if (newPassword === currentPassword) {
                showToast('새 비밀번호는 기존 비밀번호와 달라야 합니다.', 'error', '입력 필요');
                return;
            }

            try {
                await apiRequest(`${API_BASE}/owners/${ownerId}/password`, 'POST', {
                    currentPassword,
                    newPassword,
                    confirmPassword // 백엔드에서도 확인하도록 전송
                });

                showToast('비밀번호가 변경되었습니다.', 'success', '변경 완료');
                document.getElementById('ownerCurrentPassword').value = '';
                document.getElementById('ownerNewPassword').value = '';
                document.getElementById('ownerNewPasswordConfirm').value = '';
            } catch (error) {
                console.error('비밀번호 변경 실패:', error);
                showToast(error.message || '비밀번호 변경에 실패했습니다.', 'error', '변경 실패');
            }
        }
        // 실제 존재하는 QR 코드 파일 찾기
        async function findExistingQRCode(storeId, qrCodeData, subdomain) {
            try {
                // QR 코드 파일 목록 조회
                const response = await apiRequest(`${API_BASE}/qr-codes/${storeId}`);
                if (response && response.success && response.data && response.data.length > 0) {
                    // 가장 최근 QR 코드 파일 사용
                    const latestQR = response.data[0];
                    return {
                        url: latestQR.url,
                        domainUrl: qrCodeData.domainUrl || `http://localhost:8081${subdomain || ''}`,
                        createdAt: latestQR.createdAt
                    };
                }
            } catch (error) {
                console.warn('QR 코드 파일 목록 조회 실패:', error);
            }
            
            // 폴백: 기존 데이터 사용
            return qrCodeData;
        }
        // 영업시간 모달 열기
        async function openBusinessHoursModal() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    notifyStoreSelectionRequired();
                    return;
                }

                // 현재 영업시간 로드
                await loadBusinessHoursToModal();
                
                // 모달 표시
                document.getElementById('businessHoursModal').style.display = 'flex';
                
            } catch (error) {
                console.error('영업시간 모달 열기 실패:', error);
                showToast('영업시간 모달을 열 수 없습니다.', 'error', '오류');
            }
        }

        // 영업시간 모달 닫기
        function closeBusinessHoursModal() {
            document.getElementById('businessHoursModal').style.display = 'none';
        }

        // 모달에 영업시간 로드
        async function loadBusinessHoursToModal() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) return;

                const settings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                const businessHours = settings.businessHours || {};
                
                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                
                days.forEach(day => {
                    const dayData = businessHours[day] || { enabled: false, open: '09:00', close: '22:00' };
                    
                    document.getElementById(`modal_${day}_enabled`).checked = dayData.enabled;
                    document.getElementById(`modal_${day}_open`).value = dayData.open;
                    document.getElementById(`modal_${day}_close`).value = dayData.close;
                });

                // 24시간 영업 체크
                const is24Hours = Object.values(businessHours).every(day => 
                    day.enabled && day.open === '00:00' && day.close === '23:59'
                );
                document.getElementById('is24Hours').checked = is24Hours;

            } catch (error) {
                console.error('영업시간 모달 로드 실패:', error);
            }
        }
        // 24시간 영업 토글
        function toggle24Hours() {
            const is24Hours = document.getElementById('is24Hours').checked;
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            days.forEach(day => {
                const enabledCheckbox = document.getElementById(`modal_${day}_enabled`);
                const openInput = document.getElementById(`modal_${day}_open`);
                const closeInput = document.getElementById(`modal_${day}_close`);
                
                if (is24Hours) {
                    enabledCheckbox.checked = true;
                    openInput.value = '00:00';
                    closeInput.value = '23:59';
                } else {
                    enabledCheckbox.checked = false;
                    openInput.value = '09:00';
                    closeInput.value = '22:00';
                }
            });
        }
        // 모든 요일에 적용
        function applyToAllDays() {
            const openTime = prompt('시작 시간을 입력하세요 (예: 09:00):', '09:00');
            const closeTime = prompt('종료 시간을 입력하세요 (예: 22:00):', '22:00');
            
            if (openTime && closeTime) {
                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                
                days.forEach(day => {
                    document.getElementById(`modal_${day}_enabled`).checked = true;
                    document.getElementById(`modal_${day}_open`).value = openTime;
                    document.getElementById(`modal_${day}_close`).value = closeTime;
                });
            }
        }

        // 모든 요일 초기화
        function clearAllDays() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            days.forEach(day => {
                document.getElementById(`modal_${day}_enabled`).checked = false;
                document.getElementById(`modal_${day}_open`).value = '09:00';
                document.getElementById(`modal_${day}_close`).value = '22:00';
            });
            
            document.getElementById('is24Hours').checked = false;
        }

        // 영업시간 업데이트 (실시간 미리보기)
        function updateBusinessHours() {
            // 실시간으로 영업시간 표시 업데이트
            displayBusinessHours();
        }

        // 영업시간 표시 업데이트
        async function displayBusinessHours() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    const businessHoursMessage = (IS_SUPERADMIN && allStores.length === 0)
                        ? '등록된 가게가 없습니다. 가게 관리에서 새 가게를 추가해주세요.'
                        : '가게를 선택해주세요.';
                    document.getElementById('businessHoursDisplay').innerHTML = `<p style="color: #6b7280; text-align: center;">${businessHoursMessage}</p>`;
                    return;
                }

                const settings = await apiRequest(`${API_BASE}/settings?storeId=${currentStoreId}`);
                const businessHours = settings.businessHours || {};
                
                const dayNames = ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'];
                const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                
                let html = '';
                
                dayKeys.forEach((day, index) => {
                    const dayData = businessHours[day] || { enabled: false, open: '09:00', close: '22:00' };
                    const status = dayData.enabled ? '영업' : '휴무';
                    const timeText = dayData.enabled ? `${dayData.open} ~ ${dayData.close}` : '휴무';
                    const statusColor = dayData.enabled ? '#059669' : '#dc2626';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                            <span style="font-weight: 600; color: #374151;">${dayNames[index]}</span>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="color: ${statusColor}; font-weight: 500;">${status}</span>
                                <span style="color: #6b7280; font-size: 14px;">${timeText}</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('businessHoursDisplay').innerHTML = html;
                
            } catch (error) {
                console.error('영업시간 표시 실패:', error);
                document.getElementById('businessHoursDisplay').innerHTML = '<p style="color: #dc2626; text-align: center;">영업시간을 불러올 수 없습니다.</p>';
            }
        }

        // 모달에서 영업시간 저장
        async function saveBusinessHoursFromModal() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    notifyStoreSelectionRequired();
                    return;
                }

                const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                const businessHours = {};
                
                days.forEach(day => {
                    const enabled = document.getElementById(`modal_${day}_enabled`).checked;
                    const open = document.getElementById(`modal_${day}_open`).value;
                    const close = document.getElementById(`modal_${day}_close`).value;
                    
                    businessHours[day] = {
                        enabled: enabled,
                        open: open || '09:00',
                        close: close || '22:00'
                    };
                });

                // 영업시간만 업데이트
                const updateData = {
                    businessHours: businessHours
                };
                
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', updateData);
                
                // 영업시간 표시 업데이트
                await displayBusinessHours();
                
                // 모달 닫기
                closeBusinessHoursModal();
                
                showToast('영업시간이 저장되었습니다!', 'success', '저장 완료');

                // 활동 로그 기록
                await logActivity('business_hours', '영업시간 변경', 
                    `영업시간이 변경되었습니다.\n${Object.entries(businessHours).map(([day, data]) => 
                        `${day}: ${data.enabled ? `${data.open}~${data.close}` : '휴무'}`
                    ).join('\n')}`, 
                    businessHours
                );

            } catch (error) {
                console.error('영업시간 저장 실패:', error);
                showToast('영업시간 저장에 실패했습니다.', 'error', '저장 실패');
            }
        }

        // 활동 로그 표시 (개선된 버전)
        function displayActivityLogs(logs) {
            const container = document.getElementById('activityLogsList');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="loading-message">활동 로그가 없습니다.</div>';
                return;
            }
            
            // 최신순으로 정렬
            const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const logsHtml = sortedLogs.map((log, index) => {
                const time = new Date(log.timestamp).toLocaleString('ko-KR');
                const logType = log.logType || log.type || 'unknown';
                const logId = `log-${index}`;
                
                // 사용자 친화적인 액션 표시
                const userFriendlyAction = getUserFriendlyAction(log.action, logType);
                
                // 크리티컬 작업 여부 확인
                const isCritical = isCriticalAction(log.action, logType);
                
                // 변경사항 표시 (사용자 친화적으로)
                let changesHtml = '';
                
                if (log.details) {
                    const details = typeof log.details === 'string' ? JSON.parse(log.details) : log.details;
                    changesHtml = formatUserFriendlyChanges(details, logType);
                }
                
                return `
                    <div class="log-entry ${isCritical ? 'critical' : ''}">
                        <div class="log-header">
                            <div class="log-action">${userFriendlyAction}</div>
                            <div class="log-type ${logType}">${getTypeDisplayName(logType)}</div>
                        </div>
                        <div class="log-timestamp">${time}</div>
                        ${changesHtml}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = logsHtml;
        }
        
        // 필드명을 사용자 친화적인 이름으로 변환
        // 사용자 친화적인 액션 표시
        function getUserFriendlyAction(action, type) {
            if (!action) return '알 수 없는 작업';
            
            // 크리티컬 작업들
            if (action.includes('삭제') || action.includes('delete')) {
                return '🗑️ ' + action;
            }
            if (action.includes('생성') || action.includes('create')) {
                return '✨ ' + action;
            }
            if (action.includes('수정') || action.includes('update')) {
                return '✏️ ' + action;
            }
            if (action.includes('저장') || action.includes('save')) {
                return '💾 ' + action;
            }
            if (action.includes('로그인') || action.includes('login')) {
                return '🔐 ' + action;
            }
            if (action.includes('QR') || action.includes('qr')) {
                return '📱 ' + action;
            }
            if (action.includes('AI') || action.includes('ai')) {
                return '🤖 ' + action;
            }
            
            return action;
        }
        
        // 크리티컬 작업 여부 확인
        function isCriticalAction(action, type) {
            if (!action) return false;
            
            const criticalKeywords = ['삭제', 'delete', '로그인', 'login', '일시정지', 'pause', '재개', 'resume'];
            return criticalKeywords.some(keyword => action.includes(keyword));
        }
        
        // 타입 표시명 변환
        function getTypeDisplayName(type) {
            const typeNames = {
                'store': '가게 관리',
                'settings': '설정 변경',
                'image': '이미지/동영상 관리',
                'qr': 'QR 코드',
                'ai': 'AI 생성',
                'admin': '관리자',
                'system': '시스템',
                'unknown': '기타'
            };
            return typeNames[type] || type;
        }
        // 사용자 친화적인 변경사항 포맷팅
        function formatUserFriendlyChanges(details, type) {
            if (!details) return '';
            
            let changesHtml = '';
            
            if (details.before && details.after) {
                // before/after 구조인 경우
                const changes = [];
                Object.keys(details.before).forEach(key => {
                    const beforeValue = details.before[key];
                    const afterValue = details.after[key];
                    if (beforeValue !== afterValue) {
                        changes.push({
                            field: getFieldDisplayName(key),
                            before: beforeValue,
                            after: afterValue
                        });
                    }
                });
                
                if (changes.length > 0) {
                    changesHtml = `
                        <div class="log-changes">
                            <div class="log-changes-title">변경사항</div>
                            ${changes.map(change => `
                                <div class="log-change-item">
                                    <span class="log-change-field">${change.field}</span>
                                    <div class="log-change-values">
                                        <span class="log-change-before">${escapeHtml(String(change.before || '없음'))}</span>
                                        <span class="log-arrow">→</span>
                                        <span class="log-change-after">${escapeHtml(String(change.after || '없음'))}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else if (details.changes && details.changes.length > 0) {
                // changes 배열 구조인 경우
                changesHtml = `
                    <div class="log-changes">
                        <div class="log-changes-title">변경사항</div>
                        ${details.changes.map(change => `
                            <div class="log-change-item">
                                <span class="log-change-field">${change.field}</span>
                                <div class="log-change-values">
                                    <span class="log-change-before">${escapeHtml(String(change.before || '없음'))}</span>
                                    <span class="log-arrow">→</span>
                                    <span class="log-change-after">${escapeHtml(String(change.after || '없음'))}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // 단순 details 표시 (개발자 로그 제거)
                const userFriendlyDetails = formatUserFriendlyDetails(details, type);
                if (userFriendlyDetails) {
                    changesHtml = `
                        <div class="log-changes">
                            <div class="log-details">${userFriendlyDetails}</div>
                        </div>
                    `;
                }
            }
            
            return changesHtml;
        }
        
        // 사용자 친화적인 상세 정보 포맷팅
        function formatUserFriendlyDetails(details, type) {
            if (!details) return '';
            
            // 개발자 로그 제거
            const filteredDetails = {};
            Object.keys(details).forEach(key => {
                if (!key.includes('DEBUG') && 
                    !key.includes('ERROR') && 
                    !key.includes('INFO') && 
                    !key.includes('timestamp') &&
                    !key.includes('id') &&
                    !key.includes('source')) {
                    filteredDetails[key] = details[key];
                }
            });
            
            if (Object.keys(filteredDetails).length === 0) return '';
            
            const detailsText = Object.entries(filteredDetails)
                .map(([key, value]) => {
                    const displayKey = getFieldDisplayName(key);
                    const displayValue = formatDisplayValue(value, key);
                    return `${displayKey}: ${displayValue}`;
                })
                .join(', ');
                
            return escapeHtml(detailsText);
        }
        
        // 표시값 포맷팅
        function formatDisplayValue(value, key) {
            if (typeof value === 'object') {
                return JSON.stringify(value);
            }
            if (key.includes('Url') && typeof value === 'string' && value.startsWith('http')) {
                return '링크 설정됨';
            }
            if (key.includes('Size') || key.includes('size')) {
                return `${value} bytes`;
            }
            return String(value);
        }
        function getFieldDisplayName(field) {
            const fieldNames = {
                'storeName': '가게명',
                'storeSubtitle': '하단 텍스트',
                'storePhone': '전화번호',
                'storeAddress': '주소',
                'storeLogo': '가게 로고',
                'enabled': '활성화 상태',
                'title': '제목',
                'description': '설명',
                'url': 'URL',
                'order': '순서',
                'subdomain': '서브도메인',
                'customDomain': '커스텀 도메인',
                'filename': '파일명',
                'fileSize': '파일 크기',
                'mimeType': '파일 형식'
            };
            return fieldNames[field] || field;
        }

        // 안전한 상세 정보 생성 (긴 값 제한)
        function createSafeDetails(details) {
            const safeDetails = {};
            Object.entries(details).forEach(([key, value]) => {
                if (typeof value === 'string') {
                    const strValue = String(value);
                    // URL은 80자로 제한
                    if (strValue.startsWith('http') && strValue.length > 80) {
                        safeDetails[key] = strValue.substring(0, 80) + '...';
                    }
                    // 일반적으로 긴 값은 100자로 제한
                    else if (strValue.length > 100) {
                        safeDetails[key] = strValue.substring(0, 100) + '...';
                    }
                    // 짧은 값은 그대로 표시
                    else {
                        safeDetails[key] = value;
                    }
                } else {
                    safeDetails[key] = value;
                }
            });
            return safeDetails;
        }
        
        // HTML 이스케이프 헬퍼 함수
        function escapeHtml(text) {
            return (text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        function escapeForAttribute(value) {
            return (value || '')
                .replace(/\\/g, "\\\\")
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n');
        }
        
        // 로그 내용 토글 함수
        function toggleLogContent(logId) {
            const fullEl = document.getElementById(`${logId}-full`);
            const toggleBtn = document.getElementById(`${logId}-toggle`);
            
            if (fullEl.classList.contains('expanded')) {
                // 접기
                fullEl.classList.remove('expanded');
                toggleBtn.classList.remove('expanded');
                toggleBtn.textContent = '자세히 보기';
            } else {
                // 펼치기
                fullEl.classList.add('expanded');
                toggleBtn.classList.add('expanded');
                toggleBtn.textContent = '접기';
            }
        }
        
        // 가게 목록 부제목 토글 함수
        function toggleSubtitle(storeId) {
            const shortEl = document.getElementById(`subtitle-short-${storeId}`);
            const fullEl = document.getElementById(`subtitle-full-${storeId}`);
            const toggleBtn = event.target;
            
            if (fullEl.classList.contains('expanded')) {
                // 접기
                shortEl.style.display = 'inline';
                fullEl.classList.remove('expanded');
                toggleBtn.classList.remove('expanded');
            } else {
                // 펼치기
                shortEl.style.display = 'none';
                fullEl.classList.add('expanded');
                toggleBtn.classList.add('expanded');
            }
        }
        // 사용자 정보 로드 함수 (DB 데이터 → 폼 매핑)
        async function loadUserInfo(userId) {
          try {
            console.log(`🔍 [DEBUG] 사용자 정보 로드 시작: ${userId}`);
            console.log(`🔍 [DEBUG] 요청 URL: /api/users/${userId}`);
            
            const response = await fetch(`/api/users/${userId}`, {
              headers: {
                'Cache-Control': 'no-store',
                'Pragma': 'no-cache'
              }
            });
            
            console.log(`🔍 [DEBUG] 응답 상태: ${response.status}`);
            
            if (!response.ok) {
              throw new Error(`사용자 정보를 불러올 수 없습니다. (${response.status})`);
            }
            
            const userData = await response.json();
            console.log('✅ [DEBUG] 사용자 정보 로드 성공:', userData);
            console.log('🔍 [DEBUG] 응답 데이터 상세:');
            console.log('  - name:', JSON.stringify(userData.name));
            console.log('  - subtitle:', JSON.stringify(userData.subtitle));
            console.log('  - phone:', JSON.stringify(userData.phone));
            console.log('  - address:', JSON.stringify(userData.address));
            
            // 폼 필드에 값 주입
            console.log('🔄 [DEBUG] 폼 데이터 주입 시작');
            resetFormWithUserData(userData);
            console.log('✅ [DEBUG] 폼 데이터 주입 완료');
            
            return userData;
            
          } catch (error) {
            console.error('❌ [DEBUG] 사용자 정보 로드 실패:', error);
            showStatus('사용자 정보를 불러올 수 없습니다.', 'error');
            return null;
          }
        }

        // 폼 리셋 및 데이터 주입 함수
        function resetFormWithUserData(userData) {
          console.log('🔍 [DEBUG] 폼 데이터 주입 시작:', userData);
          
          // 현재 설정에서 기본 정보 가져오기
          const currentSettings = window.currentSettings || {};
          const basicInfo = currentSettings.basic || {};
          
          // 폼 필드 매핑 (올바른 데이터 소스 사용)
          const fieldMapping = {
            'storeName': basicInfo.storeName || '',
            'storeSubtitle': basicInfo.storeSubtitle || '',
            'storePhone': basicInfo.storePhone || '',
            'storeAddress': basicInfo.storeAddress || ''
          };
          
          console.log('📋 [DEBUG] 필드 매핑:', fieldMapping);
          
          // 스냅샷 비교를 위한 결과 저장
          const snapshotResults = {};
          
          // 각 필드에 값 설정
          Object.entries(fieldMapping).forEach(([fieldId, value]) => {
            console.log(`🔍 [DEBUG] 필드 ${fieldId} 처리 중...`);
            const field = document.getElementById(fieldId);
            
            if (field) {
              const oldValue = field.value;
              field.value = value || '';
              console.log(`✅ [DEBUG] 필드 ${fieldId}: "${oldValue}" → "${field.value}"`);
              
              // 스냅샷 결과 저장
              snapshotResults[fieldId] = {
                apiValue: value,
                inputValue: field.value,
                match: value === field.value
              };
            } else {
              console.error(`❌ [DEBUG] 필드 ${fieldId}를 찾을 수 없습니다!`);
              // 모든 input 필드 확인
              const allInputs = document.querySelectorAll('input, textarea');
              console.log('🔍 [DEBUG] 페이지의 모든 input/textarea 필드들:');
              allInputs.forEach(input => {
                console.log(`  - ID: ${input.id}, Name: ${input.name}, Type: ${input.type}`);
              });
              
              snapshotResults[fieldId] = {
                apiValue: value,
                inputValue: 'FIELD_NOT_FOUND',
                match: false
              };
            }
          });
          
          // 스냅샷 결과 출력
          console.log('📊 [DEBUG] 스냅샷 비교 결과:', snapshotResults);
          
          // 일치 여부 확인
          const allMatch = Object.values(snapshotResults).every(result => result.match);
          console.log(`🎯 [DEBUG] 모든 필드 일치: ${allMatch ? '✅ 성공' : '❌ 실패'}`);
          
          console.log('✅ [DEBUG] 폼 데이터 주입 완료:', fieldMapping);
        }
        // 로딩 상태 관리
        let isLoading = false;
        let basicWizardSteps = ['basic', 'contact', 'domain', 'review'];
        let basicWizardStepIndex = 0;
        let shouldShowDomainStep = true;
        const basicWizardState = {
            storeName: '',
            storeSubtitle: '',
            storePhone: '',
            postalCode: '',
            roadAddress: '',
            extraAddress: '',
            addressDetail: ''
        };
        
        // 페이지 로드 시 초기화
        // 가이드 메시지 초기화
        function initializeGuideMessages() {
            // 할인 설정 가이드
            const discountFooter = document.getElementById('discountGuideFooter');
            if (discountFooter) {
                discountFooter.innerHTML = createGuideMessage(
                    '✨',
                    '설정이 완료되면 자동으로 저장됩니다!',
                    '고객들이 가게 페이지에서 바로 확인할 수 있어요.'
                );
            }
            
            // 픽업 안내 가이드
            const pickupFooter = document.getElementById('pickupGuideFooter');
            if (pickupFooter) {
                pickupFooter.innerHTML = createGuideMessage(
                    '📍',
                    '픽업 정보가 설정되면 자동으로 저장됩니다!',
                    '고객들이 픽업 장소를 쉽게 찾을 수 있어요.'
                );
            }
            
            // UI 순서 변경 가이드
            const sectionOrderFooter = document.getElementById('sectionOrderGuideFooter');
            if (sectionOrderFooter) {
                sectionOrderFooter.innerHTML = createGuideMessage(
                    '',
                    '드래그하거나 버튼으로 순서를 변경하세요',
                    '변경사항은 자동 저장되며 즉시 반영됩니다'
                );
            }
            
            // 섹션 순서 로드
            loadSectionOrder();
        }
        
        // 섹션 순서 로드
        function loadSectionOrder() {
            const sectionOrderList = document.getElementById('sectionOrderList');
            if (!sectionOrderList) return;
            
            // 기본 섹션 순서 (설정에서 가져오거나 기본값 사용)
            const defaultOrder = [
                { id: 'discount', title: '할인 · 픽업 안내', icon: 'discount' },
                { id: 'delivery', title: '배달 주문', icon: 'delivery' },
                { id: 'address', title: '주소 정보', icon: 'address' }
            ];
            
            // 현재 설정에서 섹션 순서 가져오기 (필터링하여 필요한 섹션만 표시)
            const currentSettings = window.currentSettings || {};
            let sectionOrder = currentSettings.sectionOrder || defaultOrder;
            
            // 기존 데이터의 픽업 섹션을 통합
            sectionOrder = sectionOrder.map(section => {
                if (section.id === 'pickup') {
                    return { id: 'discount', title: '할인 · 픽업 안내', icon: 'discount' };
                }
                if (section.id === 'discount') {
                    return { ...section, title: '할인 · 픽업 안내' };
                }
                return section;
            });

            // 중복 및 불필요한 섹션 제거 (owner-account는 UI 순서 변경 대상에서 제외)
            const seen = new Set();
            sectionOrder = sectionOrder.filter(section => {
                if (section.id === 'basic-info') return false;
                if (section.id === 'owner-account') return false; // 내 계정 섹션은 순서 변경 대상 아님
                if (seen.has(section.id)) return false;
                seen.add(section.id);
                return true;
            });
            
            // 필수 섹션이 없으면 기본값 사용
            if (sectionOrder.length === 0) {
                sectionOrder = defaultOrder;
            }
            
            // UI 생성 - 드래그앤드롭과 버튼 모두 지원
            sectionOrderList.innerHTML = sectionOrder.map((section, index) => `
                <div class="order-item" data-section-id="${section.id}">
                    <div class="drag-handle">⋮⋮</div>
                    <div class="order-content">
                        <div class="order-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="order-info">
                            <div class="order-title">${section.title}</div>
                            <div class="order-subtitle">순서: ${index + 1}</div>
                        </div>
                        <div class="order-controls">
                            <button class="btn-move-up" onclick="moveSectionUp('${section.id}')" ${index === 0 ? 'disabled' : ''}>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="18 15 12 9 6 15"/>
                                </svg>
                            </button>
                            <button class="btn-move-down" onclick="moveSectionDown('${section.id}')" ${index === sectionOrder.length - 1 ? 'disabled' : ''}>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // 드래그앤드롭 초기화
            initSectionDragAndDrop();
        }
        
        // 섹션 드래그앤드롭 초기화
        function initSectionDragAndDrop() {
            const sectionOrderList = document.getElementById('sectionOrderList');
            if (!sectionOrderList || !window.Sortable) return;
            
            // 기존 Sortable 인스턴스가 있다면 제거
            if (window.sectionSortable) {
                window.sectionSortable.destroy();
            }
            
            window.sectionSortable = new Sortable(sectionOrderList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'dragging',
                handle: '.drag-handle',
                onEnd: async function(evt) {
                    // 순서가 변경되었을 때 저장
                    await updateSectionOrderFromDrag();
                }
            });
        }
        // 드래그앤드롭으로 변경된 섹션 순서 업데이트
        async function updateSectionOrderFromDrag() {
            try {
                console.log('🔄 [DEBUG] 드래그앤드롭 섹션 순서 업데이트 시작');
                
                const sectionOrderList = document.getElementById('sectionOrderList');
                if (!sectionOrderList) {
                    console.error('❌ [DEBUG] sectionOrderList를 찾을 수 없습니다');
                    return;
                }
                
                const orderItems = sectionOrderList.querySelectorAll('.order-item');
                console.log('📋 [DEBUG] 찾은 order-item 개수:', orderItems.length);
                
                const newSectionOrder = Array.from(orderItems).map((item, index) => {
                    const sectionId = item.getAttribute('data-section-id');
                    console.log(`🔍 [DEBUG] 아이템 ${index}: sectionId=${sectionId}`);
                    
                    // 더 안전한 방법으로 제목 가져오기
                    let title = 'Unknown';
                    try {
                        const titleElement = item.querySelector('.order-title');
                        if (titleElement && titleElement.textContent) {
                            title = titleElement.textContent.trim();
                        } else {
                            // 대안: 직접 텍스트 내용 찾기
                            const textContent = item.textContent || '';
                            const titleMatch = textContent.match(/(할인 · 픽업 안내|배달 주문|주소 정보)/);
                            if (titleMatch) {
                                title = titleMatch[1];
                            }
                        }
                    } catch (e) {
                        console.warn('⚠️ [DEBUG] 제목 추출 실패:', e);
                    }
                    
                    console.log(`✅ [DEBUG] 아이템 ${index}: ${sectionId} - ${title}`);
                    
                    return { id: sectionId, title: title, icon: 'discount' };
                });
                
                console.log('📊 [DEBUG] 새로운 섹션 순서:', newSectionOrder);
                
                // 현재 설정 업데이트
                const currentSettings = window.currentSettings || {};
                currentSettings.sectionOrder = newSectionOrder;
                window.currentSettings = currentSettings;
                
                // UI 업데이트 (순서 번호 재계산)
                orderItems.forEach((item, index) => {
                    try {
                        const subtitle = item.querySelector('.order-subtitle');
                        if (subtitle) {
                            subtitle.textContent = `순서: ${index + 1}`;
                        }
                    } catch (e) {
                        console.warn('⚠️ [DEBUG] 순서 번호 업데이트 실패:', e);
                    }
                });
                
                console.log('💾 [DEBUG] 설정 저장 시작');
                // 설정 저장
                await updateSectionOrder();
                console.log('✅ [DEBUG] 드래그앤드롭 섹션 순서 업데이트 완료');
                
            } catch (error) {
                console.error('❌ [DEBUG] 드래그앤드롭 섹션 순서 업데이트 실패:', error);
                showStatus('섹션 순서 저장에 실패했습니다.', 'error');
            }
        }
        
        // 섹션 위로 이동
        function moveSectionUp(sectionId) {
            const currentSettings = window.currentSettings || {};
            let sectionOrder = currentSettings.sectionOrder || [];
            
            // 기본 섹션 순서가 없으면 생성
            if (sectionOrder.length === 0) {
                sectionOrder = [
                    { id: 'discount', title: '할인 · 픽업 안내', icon: 'discount' },
                    { id: 'delivery', title: '배달 주문', icon: 'delivery' },
                    { id: 'address', title: '주소 정보', icon: 'address' }
                ];
            }
            
            const currentIndex = sectionOrder.findIndex(section => section.id === sectionId);
            if (currentIndex > 0) {
                // 섹션 순서 변경
                const temp = sectionOrder[currentIndex];
                sectionOrder[currentIndex] = sectionOrder[currentIndex - 1];
                sectionOrder[currentIndex - 1] = temp;
                
                // 설정 업데이트
                currentSettings.sectionOrder = sectionOrder;
                window.currentSettings = currentSettings;
                
                // UI 업데이트
                loadSectionOrder();
                
                // 설정 저장
                updateSectionOrder();
            }
        }
        
        // 섹션 아래로 이동
        function moveSectionDown(sectionId) {
            const currentSettings = window.currentSettings || {};
            let sectionOrder = currentSettings.sectionOrder || [];
            
            // 기본 섹션 순서가 없으면 생성
            if (sectionOrder.length === 0) {
                sectionOrder = [
                    { id: 'discount', title: '할인 · 픽업 안내', icon: 'discount' },
                    { id: 'delivery', title: '배달 주문', icon: 'delivery' },
                    { id: 'address', title: '주소 정보', icon: 'address' }
                ];
            }
            
            const currentIndex = sectionOrder.findIndex(section => section.id === sectionId);
            if (currentIndex < sectionOrder.length - 1) {
                // 섹션 순서 변경
                const temp = sectionOrder[currentIndex];
                sectionOrder[currentIndex] = sectionOrder[currentIndex + 1];
                sectionOrder[currentIndex + 1] = temp;
                
                // 설정 업데이트
                currentSettings.sectionOrder = sectionOrder;
                window.currentSettings = currentSettings;
                
                // UI 업데이트
                loadSectionOrder();
                
                // 설정 저장
                updateSectionOrder();
            }
        }
        
        // 섹션 순서 업데이트
        async function updateSectionOrder() {
            let currentStoreId = window.currentStoreId;
            
            // currentStoreId가 없으면 getCurrentStoreId()를 사용해서 가져오기
            if (!currentStoreId) {
                try {
                    currentStoreId = await getCurrentStoreId();
                    if (currentStoreId) {
                        window.currentStoreId = currentStoreId;
                        console.log('getCurrentStoreId()로 currentStoreId 복원:', currentStoreId);
                    }
                } catch (error) {
                    console.error('getCurrentStoreId() 호출 실패:', error);
                }
            }
            
            // 여전히 currentStoreId가 없으면 현재 선택된 가게에서 가져오기
            if (!currentStoreId) {
                const selectedStoreElement = document.querySelector('.store-row.selected');
                if (selectedStoreElement) {
                    currentStoreId = selectedStoreElement.getAttribute('data-store-id');
                    window.currentStoreId = currentStoreId;
                    console.log('선택된 가게에서 currentStoreId 복원:', currentStoreId);
                }
            }
            
            // 여전히 currentStoreId가 없으면 가게 목록에서 첫 번째 가게 사용
            if (!currentStoreId) {
                const firstStoreElement = document.querySelector('.store-row');
                if (firstStoreElement) {
                    currentStoreId = firstStoreElement.getAttribute('data-store-id');
                    window.currentStoreId = currentStoreId;
                    console.log('첫 번째 가게를 사용합니다:', currentStoreId);
                }
            }
            
            if (!currentStoreId) {
                console.error('currentStoreId를 찾을 수 없습니다. 선택된 가게가 없습니다.');
                notifyStoreSelectionRequired();
                return;
            }
            
            try {
                // 현재 설정에서 섹션 순서 가져오기
                const currentSettings = window.currentSettings || {};
                const sectionOrder = currentSettings.sectionOrder || [];
                
                // 설정 업데이트
                currentSettings.sectionOrder = sectionOrder;
                window.currentSettings = currentSettings;
                
                // API 호출
                await apiRequest(`${API_BASE}/store/${currentStoreId}/settings`, 'POST', currentSettings);
                
                showStatus('UI 순서가 자동으로 저장되었습니다!', 'success');
                
                // 활동 로그 기록
                const orderTitles = sectionOrder.map(s => s.title || 'Unknown').join(', ');
                await logActivity('settings', 'UI 순서 변경', 
                    `가게 페이지 섹션 순서 변경: ${orderTitles}`, {
                    sectionOrder: sectionOrder.map(s => s.id),
                    orderTitles: orderTitles
                });
                
            } catch (error) {
                console.error('섹션 순서 저장 실패:', error);
                showStatus('섹션 순서 저장에 실패했습니다.', 'error');
            }
        }
        // QR 코드 로드
        function loadQRCode(settings) {
            const qrCode = settings.qrCode;
            
            if (qrCode && qrCode.url) {
                // QR 코드가 있으면 미리보기 표시
                document.getElementById('qrCodePreview').style.display = 'flex';
                document.getElementById('qrCodeImage').src = qrCode.url;
                
                // 생성 날짜 표시
                if (qrCode.createdAt) {
                    const date = new Date(qrCode.createdAt);
                    document.getElementById('qrCodeDate').textContent = 
                        `생성일: ${date.toLocaleDateString('ko-KR')} ${date.toLocaleTimeString('ko-KR')}`;
                }
                
                // 버튼 상태 변경
                document.getElementById('generateQrBtn').style.display = 'none';
                document.getElementById('regenerateQrBtn').style.display = 'inline-block';
                document.getElementById('downloadQrBtn').style.display = 'inline-block';
                document.getElementById('deleteQrBtn').style.display = 'inline-block';
            } else {
                // QR 코드가 없으면 생성 버튼만 표시
                document.getElementById('qrCodePreview').style.display = 'none';
                document.getElementById('generateQrBtn').style.display = 'inline-block';
                document.getElementById('regenerateQrBtn').style.display = 'none';
                document.getElementById('downloadQrBtn').style.display = 'none';
                document.getElementById('deleteQrBtn').style.display = 'none';
            }
        }
        // QR 코드 생성
        async function generateQRCode() {
            try {
                const currentStoreId = await getCurrentStoreId();
                if (!currentStoreId) {
                    showStatus('가게를 먼저 선택해주세요.', 'error');
                    return;
                }
                
                showStatus('QR 코드를 생성하고 있습니다...', 'success');
                
                // 현재 도메인 가져오기
                const baseUrl = window.location.origin;
                
                // 가게 정보 조회하여 서브도메인 확인
                let targetUrl;
                try {
                    const response = await apiRequest(`${API_BASE}/stores/${currentStoreId}`);
                    const store = normalizeStoreDetailResponse(response, currentStoreId);
                    if (store && store.subdomain) {
                        // 서브도메인이 있는 경우 서브도메인 URL 사용
                        targetUrl = `${baseUrl}/${store.subdomain}`;
                    } else {
                        // 서브도메인이 없는 경우 기존 URL 사용
                        targetUrl = `${baseUrl}/store.html?storeId=${currentStoreId}`;
                    }
                } catch (error) {
                    console.error('가게 정보 조회 실패:', error);
                    // 에러 시 기존 방식으로 fallback
                    targetUrl = `${baseUrl}/store.html?storeId=${currentStoreId}`;
                }

                const response = await apiRequest(`${API_BASE}/qr/generate`, 'POST', {
                    storeId: currentStoreId,
                    url: targetUrl
                });
                
                if (response.success) {
                    showStatus('QR 코드가 생성되었습니다!', 'success');
                    
                    // QR 코드 미리보기 업데이트
                    document.getElementById('qrCodePreview').style.display = 'flex';
                    const qrCodeUrl = response.data.qrCodeUrl.startsWith('http') ? 
                        response.data.qrCodeUrl : 
                        `${baseUrl}${response.data.qrCodeUrl}`;
                    document.getElementById('qrCodeImage').src = qrCodeUrl;
                    
                    const now = new Date();
                    document.getElementById('qrCodeDate').textContent = 
                        `생성일: ${now.toLocaleDateString('ko-KR')} ${now.toLocaleTimeString('ko-KR')}`;
                    
                    // 버튼 상태 변경
                    document.getElementById('generateQrBtn').style.display = 'none';
                    document.getElementById('regenerateQrBtn').style.display = 'inline-block';
                    document.getElementById('downloadQrBtn').style.display = 'inline-block';
                    document.getElementById('deleteQrBtn').style.display = 'inline-block';
                    
                    // 활동 로그 기록
                    await logActivity('qr', 'QR 코드 생성', `QR 코드가 생성되었습니다. (가게별 고유 URL 포함)`, {
                        storeId: currentStoreId,
                        qrCodeUrl: response.qrCode,
                        targetUrl: targetUrl
                    });
                    
                    // 설정 가이드 자동 갱신
                    await refreshSetupGuideIfVisible();
                } else {
                    showStatus('QR 코드 생성에 실패했습니다.', 'error');
                }
            } catch (error) {
                console.error('QR 코드 생성 실패:', error);
                showStatus('QR 코드 생성 중 오류가 발생했습니다.', 'error');
            }
        }
        
        // QR 코드 재생성
        async function regenerateQRCode() {
            if (!confirm('QR 코드를 재생성하시겠습니까? 기존 QR 코드는 새로운 코드로 교체됩니다.')) {
                return;
            }
            
            await generateQRCode();
        }
        // QR 코드 삭제

        // 전화번호 자동 포맷팅 함수
        function formatPhoneNumber(value) {
            // 숫자만 추출
            const numbers = value.replace(/\D/g, '');
            
            // 빈 값이면 그대로 반환
            if (!numbers) return '';
            
            // 한국 전화번호 형식에 맞게 하이픈 추가
            if (numbers.length <= 2) {
                return numbers;
            } else if (numbers.length <= 3) {
                // 02, 031 등 지역번호
                return numbers;
            } else if (numbers.length <= 6) {
                // 02-1234, 031-123 등
                if (numbers.startsWith('02')) {
                    return numbers.substring(0, 2) + '-' + numbers.substring(2);
                } else {
                    return numbers.substring(0, 3) + '-' + numbers.substring(3);
                }
            } else if (numbers.length <= 10) {
                // 02-1234-5678, 031-123-4567 등
                if (numbers.startsWith('02')) {
                    return numbers.substring(0, 2) + '-' + numbers.substring(2, 6) + '-' + numbers.substring(6);
                } else if (numbers.startsWith('010') || numbers.startsWith('011') || numbers.startsWith('016') || numbers.startsWith('017') || numbers.startsWith('018') || numbers.startsWith('019')) {
                    // 휴대폰 번호
                    return numbers.substring(0, 3) + '-' + numbers.substring(3, 7) + '-' + numbers.substring(7);
                } else {
                    // 일반 지역번호 (031, 032 등)
                    return numbers.substring(0, 3) + '-' + numbers.substring(3, 6) + '-' + numbers.substring(6);
                }
            } else if (numbers.length <= 11) {
                // 010-1234-5678 (휴대폰 11자리)
                if (numbers.startsWith('010') || numbers.startsWith('011') || numbers.startsWith('016') || numbers.startsWith('017') || numbers.startsWith('018') || numbers.startsWith('019')) {
                    return numbers.substring(0, 3) + '-' + numbers.substring(3, 7) + '-' + numbers.substring(7);
                } else {
                    // 일반 지역번호 11자리
                    return numbers.substring(0, 3) + '-' + numbers.substring(3, 7) + '-' + numbers.substring(7);
                }
            } else {
                // 11자리 초과는 앞 11자리만 사용
                const limited = numbers.substring(0, 11);
                if (limited.startsWith('010') || limited.startsWith('011') || limited.startsWith('016') || limited.startsWith('017') || limited.startsWith('018') || limited.startsWith('019')) {
                    return limited.substring(0, 3) + '-' + limited.substring(3, 7) + '-' + limited.substring(7);
                } else {
                    return limited.substring(0, 3) + '-' + limited.substring(3, 7) + '-' + limited.substring(7);
                }
            }
        }

        // 전화번호 입력 필드에 자동 포맷팅 적용
        function setupPhoneFormatting() {
            const phoneInputs = ['storePhone', 'wizardStorePhone', 'ownerRequestPhone'];
            
            phoneInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // 입력 중 포맷팅
                    input.addEventListener('input', function(e) {
                        const cursorPosition = e.target.selectionStart;
                        const oldValue = e.target.value;
                        const formatted = formatPhoneNumber(e.target.value);
                        
                        e.target.value = formatted;
                        
                        // 커서 위치 조정 (하이픈 추가로 인한 위치 변경 보정)
                        let newCursorPosition = cursorPosition;
                        const addedHyphens = (formatted.match(/-/g) || []).length - (oldValue.match(/-/g) || []).length;
                        if (addedHyphens > 0) {
                            newCursorPosition += addedHyphens;
                        }
                        
                        e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                    });
                    
                    // 포커스 아웃 시 최종 포맷팅
                    input.addEventListener('blur', function(e) {
                        e.target.value = formatPhoneNumber(e.target.value);
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            if (isLoading) return;
            isLoading = true;
            
            // 슈퍼어드민 모드 확인 및 body 클래스 추가 (CSS가 작동하도록)
            if (IS_SUPERADMIN) {
                document.body.classList.add('superadmin-mode');
            } else if (IS_STORE_OWNER) {
                document.body.classList.add('owner-mode');
            }
            
            // 초기 로드 시 전체 목록을 가져오지 않도록 설정 (필요할 때만 로드)
            window.shouldReloadAllStores = false;
            
            // 초기 로드 시 홈 페이지 표시 (빠른 로딩)
            // 모든 섹션을 명시적으로 숨기고 홈 페이지만 표시
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(section => {
                if (section.id === 'home') {
                    section.style.display = 'block';
                    section.setAttribute('style', 'display: block !important;');
                } else {
                    // 슈퍼어드민 전용 섹션 포함 모든 섹션 강제로 숨김
                    section.style.display = 'none';
                    section.setAttribute('style', 'display: none !important;');
                }
            });
            
            // 슈퍼어드민 전용 섹션들도 명시적으로 숨김 (재발 방지)
            const superadminOnlyIds = ['accounts', 'db-stats', 'activity-logs', 'superadmin'];
            superadminOnlyIds.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.style.display = 'none';
                    section.setAttribute('style', 'display: none !important;');
                }
            });
            
            // 홈 페이지 최근 가게 로드 (비동기, 로딩 바 없이)
            loadHomeRecentStores().catch(err => {
                console.error('초기 홈 최근 가게 로드 실패:', err);
            });
            
            // 가이드 메시지 초기화
            initializeGuideMessages();
            setupOwnerTabs();
            initializeDashboardControls();
            populateOwnerAccountSection();
            
            // 초기 로드 최소화: 홈 페이지만 표시하고 나머지는 필요할 때만 로드
            try {
                // 즉시 가게 ID 복원 (localStorage에서 동기적으로 읽기)
                const savedStoreId = localStorage.getItem('currentStoreId');
                if (savedStoreId) {
                    window.currentStoreId = savedStoreId;
                    sessionStorage.setItem('currentStoreId', savedStoreId);
                    console.log('✅ [초기 로드] 가게 ID 즉시 복원:', savedStoreId);
                    
                    // 점주 모드인 경우 owner_store_id도 동기화
                    if (IS_STORE_OWNER) {
                        sessionStorage.setItem('owner_store_id', savedStoreId);
                    }
                    
                    // 사이드바에 가게 ID 표시 (데이터는 백그라운드에서 로드)
                    const selectedStoreNameEl = document.querySelector('.selected-store-name');
                    if (selectedStoreNameEl) {
                        selectedStoreNameEl.textContent = '가게 정보 로딩 중...';
                    }
                }
                
                // 점주 계정일 때는 대표 가게를 확인하고 자동 선택
                if (IS_STORE_OWNER && !IS_SUPERADMIN) {
                    // 백그라운드에서 가게 목록 로드 및 대표 가게 확인
                    loadStoreList().then(() => {
                        // 대표 가게 확인
                        const ownerStoreId = sessionStorage.getItem('owner_store_id') || '';
                        const ownerStoresStr = sessionStorage.getItem('owner_store_list');
                        const ownerStores = ownerStoresStr ? JSON.parse(ownerStoresStr) : [];
                        
                        // 대표 가게 찾기 (primaryStoreId, owner_store_id, 또는 isPrimary로 확인)
                        const primaryStore = ownerStores.find(store => 
                            store.id === ownerStoreId || 
                            store.isPrimary || 
                            store.role === 'primary'
                        ) || (ownerStores.length > 0 ? ownerStores[0] : null);
                        
                        if (primaryStore && primaryStore.id) {
                            // 대표 가게가 있으면 자동 선택
                            const primaryStoreId = primaryStore.id;
                            window.currentStoreId = primaryStoreId;
                            localStorage.setItem('currentStoreId', primaryStoreId);
                            sessionStorage.setItem('owner_store_id', primaryStoreId);
                            console.log('✅ [점주 계정] 대표 가게 자동 선택:', primaryStoreId);
                            
                            // 가게 정보 업데이트
                            updateCurrentStoreInfo(primaryStoreId).catch(err => {
                                console.warn('가게 정보 업데이트 실패:', err);
                            });
                        } else if (ownerStores.length > 0) {
                            // 대표 가게가 없지만 가게가 있는 경우 - 모달로 설정 유도
                            console.warn('⚠️ [점주 계정] 대표 가게가 설정되지 않았습니다. 설정을 유도합니다.');
                            showPrimaryStoreSetupModal(ownerStores);
                        } else {
                            // 가게가 없는 경우
                            console.warn('⚠️ [점주 계정] 연결된 가게가 없습니다.');
                            if (!savedStoreId) {
                                initializeSidebarStoreInfo();
                            }
                        }
                    }).catch(error => {
                        console.error('점주 가게 목록 로드 실패:', error);
                        if (!savedStoreId) {
                            initializeSidebarStoreInfo();
                        }
                    });
                } else if (IS_SUPERADMIN && savedStoreId) {
                    // 슈퍼어드민: 저장된 가게 ID가 있으면 백그라운드에서 가게 정보만 로드
                    // 가게 목록은 가게 관리 섹션을 클릭했을 때만 로드
                    updateCurrentStoreInfo(savedStoreId).then(() => {
                        console.log('✅ [초기 로드] 슈퍼어드민 - 가게 정보 로드 완료');
                    }).catch(err => {
                        console.warn('가게 정보 로드 실패 (계속 진행):', err);
                        // 실패해도 기본 UI는 표시
                        const selectedStoreNameEl = document.querySelector('.selected-store-name');
                        if (selectedStoreNameEl) {
                            selectedStoreNameEl.textContent = '가게 정보를 불러올 수 없습니다.';
                        }
                    });
                } else if (!savedStoreId) {
                    // 저장된 가게가 없으면 사이드바 초기화
                    initializeSidebarStoreInfo();
                }
                
                // 이벤트 리스너만 설정 (데이터 로드 없음)
                setupDeliveryUrlEventListeners();
                setupPhoneFormatting();
                
                // 초기 로드 시에는 항상 홈 페이지만 표시 (데이터 로드 없음)
                // URL 해시는 무시하고 홈 페이지만 표시
                // 사용자가 직접 메뉴를 클릭했을 때만 데이터 로드
                // 이미 홈 페이지가 표시되어 있음
                
                // URL 해시가 있어도 초기 로드 시에는 무시 (재발 방지)
                // 해시를 제거하여 의도치 않은 섹션 표시 방지
                if (window.location.hash && window.location.hash !== '#home') {
                    window.location.hash = '';
                }
                
                // 해시 변경 이벤트 리스너 추가 (사용자가 직접 메뉴 클릭 시에만 반응)
                window.addEventListener('hashchange', function() {
                    const hash = window.location.hash.replace('#', '');
                    // 해시가 있고 홈이 아니면 해당 섹션 표시
                    if (hash && hash !== 'home' && hash !== '') {
                        // 이미 로드된 후에만 섹션 전환 (초기 로드 중이 아닐 때)
                        if (!isLoading) {
                            showSection(hash).catch(err => {
                                console.error('해시 변경으로 인한 섹션 표시 실패:', err);
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('초기화 오류:', error);
                showStatus('페이지 초기화에 실패했습니다.', 'error');
            } finally {
                isLoading = false;
            }
        });

        // ===== 엠버서더 관리 함수 =====
        
        // 엠버서더 목록 로드
        async function loadAmbassadors() {
            try {
                const currentStoreId = getCurrentStoreId();
                if (!currentStoreId) {
                    document.getElementById('ambassadorsList').innerHTML = '<div class="loading-state">가게를 선택해주세요.</div>';
                    return;
                }
                
                const response = await apiRequest(`${API_BASE}/ambassadors?storeId=${currentStoreId}`, 'GET');
                const ambassadors = response?.data || [];
                
                const listEl = document.getElementById('ambassadorsList');
                if (!listEl) return;
                
                if (ambassadors.length === 0) {
                    listEl.innerHTML = '<div class="loading-state">등록된 엠버서더가 없습니다. 엠버서더를 추가해주세요.</div>';
                    return;
                }
                
                // 먼저 목록만 표시 (빠른 로딩)
                listEl.innerHTML = ambassadors.map(amb => {
                    // 기본 통계는 0으로 표시하고, 통계는 별도로 비동기 로드
                    const stats = { visitCount: 0, callCount: 0, uniqueVisitors: 0, uniqueCallers: 0 };
                    return `
                    <div class="ambassador-card" data-ambassador-id="${amb.id}" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #1f2937;">${escapeHtml(amb.name || '이름 없음')}</h3>
                                ${amb.email ? `<div style="font-size: 14px; color: #6b7280; margin-top: 4px;">📧 ${escapeHtml(amb.email)}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="openAmbassadorStats(${amb.id}, '${escapeHtml(amb.name || '이름 없음')}')" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">통계</button>
                                <button onclick="openAmbassadorModal(${amb.id})" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">수정</button>
                                <button onclick="deleteAmbassador(${amb.id})" class="btn btn-danger" style="padding: 8px 16px; font-size: 14px;">삭제</button>
                            </div>
                        </div>
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div class="ambassador-visit-count" style="font-size: 24px; font-weight: 700; color: #0369a1; margin-bottom: 4px;">${stats.visitCount || 0}</div>
                                    <div style="font-size: 12px; color: #075985;">방문 수</div>
                                </div>
                                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div class="ambassador-call-count" style="font-size: 24px; font-weight: 700; color: #92400e; margin-bottom: 4px;">${stats.callCount || 0}</div>
                                    <div style="font-size: 12px; color: #78350f;">전화 연결</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 6px;">엠버서더 링크</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="ambassadorLink_${amb.id}" value="${window.location.origin}/store.html?ambassador=${amb.ambassadorKey}" readonly style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: #f9fafb;">
                                    <button onclick="event.stopPropagation(); copyAmbassadorLink(${amb.id}, event); return false;" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">복사</button>
                                </div>
                            </div>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 13px; color: #78350f; line-height: 1.5;">
                                <strong>📱 링크 접속 시 안내:</strong><br>
                                이 링크를 받은 고객은 전화번호를 입력하면 가게 페이지에 접근할 수 있습니다. 전화 버튼을 클릭하면 할인 혜택이 적용됩니다.
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
                
                // 통계는 백그라운드에서 비동기로 로드 (성능 개선)
                // 목록이 먼저 표시되고, 통계는 나중에 업데이트됨
                Promise.all(ambassadors.map(amb => 
                    apiRequest(`${API_BASE}/ambassadors/stats?storeId=${currentStoreId}&ambassadorId=${amb.id}`, 'GET', null, 1, false, {}, 5000)
                        .then(res => ({ id: amb.id, stats: res?.data || null }))
                        .catch(err => {
                            // 타임아웃 등 에러는 무시하고 기본값 반환
                            console.warn(`엠버서더 ${amb.id} 통계 조회 실패:`, err.message);
                            return { id: amb.id, stats: null };
                        })
                )).then(statsResults => {
                    const statsMap = {};
                    statsResults.forEach(result => {
                        if (result.stats && result.stats.ambassadors && result.stats.ambassadors.length > 0) {
                            statsMap[result.id] = result.stats.ambassadors[0];
                        }
                    });
                    
                    // 통계만 업데이트 (전체 재렌더링 없이)
                    ambassadors.forEach(amb => {
                        const stats = statsMap[amb.id] || { visitCount: 0, callCount: 0, uniqueVisitors: 0, uniqueCallers: 0 };
                        const card = document.querySelector(`[data-ambassador-id="${amb.id}"]`);
                        if (card) {
                            const visitCountEl = card.querySelector('.ambassador-visit-count');
                            const callCountEl = card.querySelector('.ambassador-call-count');
                            if (visitCountEl) visitCountEl.textContent = (stats.visitCount || 0).toString();
                            if (callCountEl) callCountEl.textContent = (stats.callCount || 0).toString();
                        }
                    });
                }).catch(err => {
                    console.warn('엠버서더 통계 로드 실패 (무시):', err);
                });
            } catch (error) {
                console.error('엠버서더 목록 로드 실패:', error);
                const listEl = document.getElementById('ambassadorsList');
                if (listEl) {
                    listEl.innerHTML = '<div class="loading-state" style="color: #ef4444;">엠버서더 목록을 불러오지 못했습니다.</div>';
                }
                showToast('엠버서더 목록을 불러오지 못했습니다.', 'error');
            }
        }
        
        // 엠버서더 추가/수정 모달 열기
        async function openAmbassadorModal(ambassadorId = null) {
            const modal = document.getElementById('ambassadorModal');
            if (!modal) {
                // 모달이 없으면 생성
                createAmbassadorModal();
                openAmbassadorModal(ambassadorId);
                return;
            }
            
            // 기존 데이터 로드 (수정 모드인 경우)
            if (ambassadorId) {
                try {
                    const currentStoreId = getCurrentStoreId();
                    const response = await apiRequest(`${API_BASE}/ambassadors?storeId=${currentStoreId}`, 'GET');
                    const ambassadors = response?.data || [];
                    const ambassador = ambassadors.find(a => a.id === ambassadorId);
                    
                    if (ambassador) {
                        document.getElementById('ambassadorName').value = ambassador.name || '';
                        document.getElementById('ambassadorEmail').value = ambassador.email || '';
                        document.getElementById('ambassadorModal').dataset.ambassadorId = ambassadorId;
                        document.getElementById('ambassadorModalTitle').textContent = '엠버서더 수정';
                        document.getElementById('saveAmbassadorBtn').textContent = '수정';
                    }
                } catch (error) {
                    console.error('엠버서더 정보 로드 실패:', error);
                    showToast('엠버서더 정보를 불러오지 못했습니다.', 'error');
                    return;
                }
            } else {
                // 추가 모드
                document.getElementById('ambassadorName').value = '';
                document.getElementById('ambassadorEmail').value = '';
                document.getElementById('ambassadorModal').dataset.ambassadorId = '';
                document.getElementById('ambassadorModalTitle').textContent = '엠버서더 추가';
                document.getElementById('saveAmbassadorBtn').textContent = '저장';
            }
            
            modal.style.display = 'flex';
        }
        
        // 엠버서더 모달 생성
        function createAmbassadorModal() {
            const modal = document.createElement('div');
            modal.id = 'ambassadorModal';
            modal.className = 'modal';
            modal.style.display = 'none';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="ambassadorModalTitle">엠버서더 추가</h3>
                        <button class="modal-close" onclick="closeAmbassadorModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="ambassadorName">이름 <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="ambassadorName" class="form-input" placeholder="엠버서더 이름을 입력하세요" required>
                        </div>
                        <div class="form-group">
                            <label for="ambassadorEmail">이메일</label>
                            <input type="email" id="ambassadorEmail" class="form-input" placeholder="example@email.com">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAmbassadorModal()">취소</button>
                        <button id="saveAmbassadorBtn" class="btn btn-primary" onclick="saveAmbassador()">저장</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // 엠버서더 모달 닫기
        function closeAmbassadorModal() {
            const modal = document.getElementById('ambassadorModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 엠버서더 저장
        async function saveAmbassador() {
            try {
                const currentStoreId = getCurrentStoreId();
                if (!currentStoreId) {
                    showToast('가게를 선택해주세요.', 'error');
                    return;
                }
                
                const modal = document.getElementById('ambassadorModal');
                const ambassadorId = modal?.dataset?.ambassadorId || null;
                
                const name = document.getElementById('ambassadorName').value.trim();
                if (!name) {
                    showToast('이름을 입력해주세요.', 'error');
                    return;
                }
                
                const email = document.getElementById('ambassadorEmail').value.trim() || null;
                
                if (ambassadorId) {
                    // 수정
                    await apiRequest(`${API_BASE}/ambassadors/${ambassadorId}`, 'PUT', {
                        name,
                        email
                    });
                    showToast('엠버서더 정보가 수정되었습니다.', 'success');
                } else {
                    // 추가
                    await apiRequest(`${API_BASE}/ambassadors`, 'POST', {
                        storeId: currentStoreId,
                        name,
                        email
                    });
                    showToast('엠버서더가 추가되었습니다.', 'success');
                }
                
                closeAmbassadorModal();
                loadAmbassadors();
            } catch (error) {
                console.error('엠버서더 저장 실패:', error);
                showToast(error.message || '엠버서더 저장에 실패했습니다.', 'error');
            }
        }
        
        // 엠버서더 삭제
        async function deleteAmbassador(ambassadorId) {
            if (!confirm('정말 이 엠버서더를 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                await apiRequest(`${API_BASE}/ambassadors/${ambassadorId}`, 'DELETE');
                showToast('엠버서더가 삭제되었습니다.', 'success');
                loadAmbassadors();
            } catch (error) {
                console.error('엠버서더 삭제 실패:', error);
                showToast(error.message || '엠버서더 삭제에 실패했습니다.', 'error');
            }
        }
        
        // 엠버서더 링크 복사
        function copyAmbassadorLink(ambassadorId, event) {
            // 이벤트 전파 중단 (중요: 이벤트 버블링 방지로 세션 체크 트리거 방지)
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            try {
                const linkInput = document.getElementById(`ambassadorLink_${ambassadorId}`);
                if (!linkInput) {
                    showToast('링크를 찾을 수 없습니다.', 'error');
                    return false;
                }
                
                const linkText = linkInput.value;
                if (!linkText) {
                    showToast('복사할 링크가 없습니다.', 'error');
                    return false;
                }
                
                // 입력 필드 선택
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // 모바일 지원
                
                // 클립보드 복사 시도 (동기적으로 처리)
                let copied = false;
                try {
                    // document.execCommand를 먼저 시도 (가장 안정적)
                    copied = document.execCommand('copy');
                    
                    if (copied) {
                        showToast('링크가 클립보드에 복사되었습니다.', 'success');
                        return false; // 기본 동작 방지
                    }
                } catch (err) {
                    console.warn('execCommand 복사 실패:', err);
                }
                
                // execCommand 실패 시 최신 클립보드 API 시도
                if (!copied && navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(linkText).then(() => {
                        showToast('링크가 클립보드에 복사되었습니다.', 'success');
                    }).catch((err) => {
                        console.error('클립보드 API 복사 실패:', err);
                        showToast('링크 복사에 실패했습니다. 수동으로 복사해주세요.', 'error');
                    });
                    return false;
                }
                
                // 둘 다 실패한 경우
                if (!copied) {
                    showToast('링크 복사에 실패했습니다. 수동으로 복사해주세요.', 'error');
                }
                
                return false; // 기본 동작 방지
            } catch (error) {
                console.error('링크 복사 실패:', error);
                showToast('링크 복사에 실패했습니다.', 'error');
                return false;
            }
        }
        
        // 엠버서더 통계 조회 모달 열기
        async function openAmbassadorStats(ambassadorId, ambassadorName) {
            try {
                const currentStoreId = getCurrentStoreId();
                if (!currentStoreId) {
                    showToast('가게를 선택해주세요.', 'error');
                    return;
                }
                
                // 통계 조회
                const response = await apiRequest(`${API_BASE}/ambassadors/stats?storeId=${currentStoreId}&ambassadorId=${ambassadorId}`, 'GET');
                const stats = response?.data || { ambassadors: [], phoneStats: [] };
                
                const ambassadorStats = stats.ambassadors.find(a => a.ambassadorId === ambassadorId) || {
                    visitCount: 0,
                    callCount: 0,
                    uniqueVisitors: 0,
                    uniqueCallers: 0
                };
                
                const phoneStats = stats.phoneStats || [];
                
                // 통계 모달 생성 또는 업데이트
                let modal = document.getElementById('ambassadorStatsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'ambassadorStatsModal';
                    modal.className = 'modal';
                    modal.style.display = 'none';
                    document.body.appendChild(modal);
                }
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>${escapeHtml(ambassadorName)} 통계</h3>
                            <button class="modal-close" onclick="closeAmbassadorStatsModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #7dd3fc;">
                                    <div style="font-size: 32px; font-weight: 700; color: #0369a1; margin-bottom: 8px;">${ambassadorStats.visitCount || 0}</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #075985;">총 방문 수</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #fcd34d;">
                                    <div style="font-size: 32px; font-weight: 700; color: #92400e; margin-bottom: 8px;">${ambassadorStats.callCount || 0}</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #78350f;">총 전화 연결</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #86efac;">
                                    <div style="font-size: 32px; font-weight: 700; color: #166534; margin-bottom: 8px;">${ambassadorStats.uniqueVisitors || 0}</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #14532d;">고유 방문자</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #f9a8d4;">
                                    <div style="font-size: 32px; font-weight: 700; color: #9f1239; margin-bottom: 8px;">${ambassadorStats.uniqueCallers || 0}</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #831843;">고유 전화 연결자</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 32px;">
                                <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #1f2937;">전화번호별 통계</h4>
                                ${phoneStats.length === 0 ? 
                                    '<div style="padding: 20px; text-align: center; color: #6b7280; font-size: 14px;">전화번호별 통계 데이터가 없습니다.</div>' :
                                    `<div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                                    <th style="padding: 12px; text-align: left; font-size: 14px; font-weight: 600; color: #374151;">전화번호</th>
                                                    <th style="padding: 12px; text-align: center; font-size: 14px; font-weight: 600; color: #374151;">방문 수</th>
                                                    <th style="padding: 12px; text-align: center; font-size: 14px; font-weight: 600; color: #374151;">전화 연결</th>
                                                    <th style="padding: 12px; text-align: right; font-size: 14px; font-weight: 600; color: #374151;">최근 활동</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${phoneStats.map(ps => `
                                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                                        <td style="padding: 12px; font-size: 14px; color: #1f2937; font-weight: 500;">${escapeHtml(ps.phone || '-')}</td>
                                                        <td style="padding: 12px; text-align: center; font-size: 14px; color: #0369a1; font-weight: 600;">${ps.visitCount || 0}</td>
                                                        <td style="padding: 12px; text-align: center; font-size: 14px; color: #92400e; font-weight: 600;">${ps.callCount || 0}</td>
                                                        <td style="padding: 12px; text-align: right; font-size: 14px; color: #6b7280;">${ps.lastActivity ? new Date(ps.lastActivity).toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>`
                                }
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAmbassadorStatsModal()">닫기</button>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('엠버서더 통계 조회 실패:', error);
                showToast('엠버서더 통계를 불러오지 못했습니다.', 'error');
            }
        }
        
        // 엠버서더 통계 모달 닫기
        function closeAmbassadorStatsModal() {
            const modal = document.getElementById('ambassadorStatsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>